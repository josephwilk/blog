
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Building Clojure services at scale - Joseph Wilk</title>
  <meta name="author" content="Joseph Wilk">

  
  <meta name="description" content="At SoundCloud I&rsquo;ve been experimenting over the last year with how we build the services that power a number of heavily loaded areas across our &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://blog.josephwilk.net/clojure/building-clojure-services-at-scale.html">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Joseph Wilk" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<script src="http://disqus.com/forums/josephwilk/embed.js"></script>
<link href="http://fonts.googleapis.com/css?family=Bevan" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-3020740-2']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body    class="collapse-sidebar sidebar-footer" >
  <header role="banner"><hgroup>
  <img src="/blog/images/joe_small.jpg" style="position:relative;border-radius: 8px;margin-right: 5px;border-style: solid;border-width: 1px;border-color: #DDD;" height="60" alt="Joseph Wilk">
  <span style="display:inline-block">
    <h1><a href="/">Joseph Wilk</a></h1>
    <h2>Programming bits and bobs</h2>
  </span>
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search?as_sitesearch=blog.josephwilk.net" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:blog.josephwilk.net" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
 <li><a href="/">Home</a></li>
 <li><a href="/about">About</a></li>
 <li><a href="/speaking">Speaking</a></li>
 <li><a href="/contact">Contact</a></li>
 <li><a href="/archives">Archives</a></li>
</ul>
</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Building Clojure Services at Scale</h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-09-13T11:00:00+02:00" pubdate data-updated="true">Sep 13<span>th</span>, 2013</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>At SoundCloud I&rsquo;ve been experimenting over the last year with how we build the services that power a number of heavily loaded areas across our site. All these services have been built in Clojure with bits of Java tacked on the sides. Here are some of my personal thoughts on how to build Clojure services:</p>

<h2>Netflix or Twitter</h2>

<p><img alt="choose your own adventure" src="/images/adventure.jpg"></p>

<p>At some-point when you require a sufficient level of scaling you turn to the open source work of <a href="https://github.com/twitter">Twitter</a> with <a href="http://twitter.github.io/finagle">Finagle</a> or <a href="https://github.com/Netflix">Netflix</a> with <a href="https://github.com/Netflix/Hystrix">Hystrix</a>/<a href="https://github.com/Netflix/RxJava">RxJava</a>.
Netflix libs are written in Java while Twitters are written in Scala. Both are easy to use from any JVM based language but the Finagle route will bring in an extra dependency on Scala. I&rsquo;ve heard little from people using interop between Clojure &amp; Scala and that extra Scala dependency makes me nervous. Further I like the simplicity of Netflix&rsquo;s libs and they have been putting a lot of effort into pushing support for many JVM based languages.</p>

<p>Hence with Clojure, Netflix projects are my preference. (I should add we do use Finagle with Scala at SoundCloud as well).</p>

<h2>Failure, Monitoring &amp; Composition Complexity</h2>

<div style="display:inline-block;">
<img align="left" style="margin-right:5px;" src="/images/failure.jpg" width="150px" height="150px">

In a service reliant on other services, databases, caches any other external dependencies its a guarantee at some-point some of those will fail. When working with critical services we want to gracefully provide a degraded service.
</div>




<p></p>




<div style="display:inline-block;">
<img align="left" style="margin-right:5px;" src="/images/scary-eye.png" width="150px" height="150px">
While we can think about degrading gracefully in the case of failure, ultimately we want to fix wants broken as soon as possible. An eye into the runtime system allows us to monitor exactly whats going on and take appropriate action. 
</div>




<p></p>




<div style="display:inline-block;">
<img align="left" style="margin-right:5px;" src="/images/complexity.png" width="150px" height="150px">

Your service needs to call other services. Dependent on those service results you might need to call other services which in turn might require calls to other services. Composing service calls is hard to get right without a tangle of complex code.
</div>




<p></p>


<h3>Fault Tolerance</h3>

<p>How should we build fault tolerance into our Clojure services?</p>

<h4>Single thread pool</h4>

<p>Consider you have this line within a service response:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">{</span><span class="ss">:body</span> <span class="err">@</span><span class="p">(</span><span class="nf">future</span> <span class="p">(</span><span class="nf">client/get</span> <span class="s">&quot;http://soundcloud.com/blah/wah&quot;</span><span class="p">))</span> <span class="ss">:status</span> <span class="mi">200</span><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now <code>http://soundcloud.com/blah/wah</code> goes down and those client requests start getting blocked on the request. In Clojure all <code>future</code> calls acquire a thread from the same thread pool. In our example the service is blocked up, is pilling new requests onto the blocked pool and we are in trouble.</p>

<p>My first solution to this problem was to introduce circuit breakers (<a href="https://github.com/josephwilk/circuit-breaker">https://github.com/josephwilk/circuit-breaker</a>).
I also stop using <code>@</code> to dereference futures and used <code>deref</code> <a href="http://clojuredocs.org/clojure_core/clojure.core/deref">http://clojuredocs.org/clojure_core/clojure.core/deref</a> which supports defaults and timeouts.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">defncircuitbreaker</span> <span class="ss">:blah-http</span> <span class="p">{</span><span class="ss">:timeout</span> <span class="mi">30</span> <span class="ss">:threshold</span> <span class="mi">2</span><span class="p">})</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">future-timeout</span> <span class="mi">1000</span><span class="p">)</span>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">timeout-value</span> <span class="nv">nil</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">http-get</span> <span class="p">[</span><span class="nv">url</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">with-circuit-breaker</span> <span class="ss">:blah-http</span> <span class="p">{</span>
</span><span class='line'>    <span class="ss">:connected</span> <span class="p">(</span><span class="k">fn </span><span class="p">[]</span> <span class="p">(</span><span class="nf">client/get</span> <span class="s">&quot;http://soundcloud.com/blah/wah&quot;</span><span class="p">))</span>
</span><span class='line'>    <span class="ss">:tripped</span> <span class="p">(</span><span class="k">fn </span><span class="p">[]</span> <span class="nv">nil</span><span class="p">)}))</span>
</span><span class='line'>
</span><span class='line'><span class="p">{</span><span class="ss">:body</span> <span class="p">(</span><span class="nf">http-get</span> <span class="nv">http</span><span class="ss">://www.soundcloud.com/blah/wah</span><span class="p">)</span> <span class="ss">:status</span> <span class="mi">200</span><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Problem solved, now even though the thread pool may become blocked we back off the following requests and avoid pilling more work onto the blocked thread pool.</p>

<p>This worked pretty well, but then we decided we would to try and go even further in gracefully degrading.
Why don&rsquo;t we serve from a cache on failure, slightly stale data is better than none.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">http-get</span> <span class="p">[</span><span class="nv">url</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">with-circuit-breaker</span> <span class="ss">:blah-http</span> <span class="p">{</span>
</span><span class='line'>    <span class="ss">:connected</span> <span class="p">(</span><span class="k">fn </span><span class="p">[]</span> <span class="p">(</span><span class="nf">client/get</span> <span class="s">&quot;http://soundcloud.com/blah/wah&quot;</span><span class="p">))</span>
</span><span class='line'>    <span class="ss">:tripped</span> <span class="p">(</span><span class="k">fn </span><span class="p">[]</span> <span class="p">(</span><span class="nf">memcache/get</span> <span class="nv">client</span> <span class="nv">url</span><span class="p">))}))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now consider <code>(client/get "http://soundcloud.com/blah/wah")</code> starts failing, the thread pool gets blocked up, the circuit trigger flips and <code>(memcache/get client url)</code> is now fighting to get threads from the blocked thread pool.</p>

<p>Pants.</p>

<h5>Scheduling over thread pools: Hystrix</h5>

<p><a href="https://github.com/Netflix/Hystrix">Hystrix</a> is Netflix library which I think of as circuit breakers on steroids.</p>

<p><img src ="/images/hystrix.png" height="400px" width="400px"/></p>

<pre><code>Hystrix is a latency and fault tolerance library designed to isolate points of access to remote systems, 
services and 3rd party libraries, stop cascading failure and enable resilience in complex distributed systems 
where failure is inevitable.
</code></pre>

<p>Dave Ray (<a href="http://darevay.com">http://darevay.com</a>) has been doing lots of excellent work on producing <a href="https://github.com/Netflix/Hystrix/tree/master/hystrix-contrib/hystrix-clj">Clojure bindings for Hystrix</a>:</p>

<p>Hystrix gives me 2 big wins:</p>

<h5>1. Separation of thread pools</h5>

<p>Hystrix creates a separate thread pool for each Clojure namespace, if one thread pool becomes blocked due to a failure, a circuit breaker can be triggered with a fallback that uses a different thread pool.</p>

<p>This however does come with a cost:</p>

<ol>
<li> We have a performance hit due to moving to a scheduling based method for executing Hystrix commands.</li>
<li> We cannot use Clojure&rsquo;s concurrency primitives (futures/promises/agents).</li>
</ol>


<p>Here is an example of our service rewritten with Hystrix:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">ns </span><span class="nv">example</span>
</span><span class='line'>  <span class="p">(</span><span class="ss">:require</span> <span class="p">[[</span><span class="nv">com.netflix.hystrix.core</span> <span class="ss">:as</span> <span class="nv">hystrix</span><span class="p">]]))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">hystrix/defcommand</span> <span class="nv">http-get</span>
</span><span class='line'>  <span class="p">{</span><span class="ss">:hystrix/fallback-fn</span> <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">url</span><span class="p">]</span> <span class="p">(</span><span class="nf">memcache-get</span> <span class="nv">url</span><span class="p">)}</span>
</span><span class='line'>  <span class="p">[</span><span class="nv">url</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">client/get</span> <span class="nv">url</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">hystrix/defcommand</span> <span class="nv">memcache-get</span>
</span><span class='line'>  <span class="p">{</span><span class="ss">:hystrix/fallback-fn</span> <span class="p">(</span><span class="nb">constantly </span><span class="nv">nil</span><span class="p">)}</span>
</span><span class='line'>  <span class="p">[</span><span class="nv">url</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">memcache/get</span> <span class="nv">client</span> <span class="nv">key</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">http-get</span> <span class="p">[</span><span class="nv">url</span><span class="p">]</span>
</span><span class='line'>   <span class="p">{</span><span class="ss">:body</span> <span class="p">(</span><span class="nf">http/get</span> <span class="s">&quot;http://soundcloud.com/blah/wah&quot;</span><span class="p">)</span> <span class="ss">:status</span> <span class="mi">200</span><span class="p">})</span>
</span></code></pre></td></tr></table></div></figure>


<p>Beautiful, Just adding the <code>defcommand</code> brings us fault tolerance with no other changes to the shape of our code.</p>

<p>See the Hystrix Clojure adapter for all the possible configuration: <a href="https://github.com/Netflix/Hystrix/tree/master/hystrix-contrib/hystrix-clj">https://github.com/Netflix/Hystrix/tree/master/hystrix-contrib/hystrix-clj</a></p>

<h5>2.  Monitoring</h5>

<p>Hystrix supports exposing metrics on all circuit breakers within a process. It exposes these calls through an event stream.</p>

<p>How you expose that Hystrix event stream depends slightly on which web server you are using with your Clojure app.</p>

<h4>Netty and Hystrix Event Streams (without servlets)</h4>

<p><a href="https://github.com/josephwilk/hystrix-event-stream-clj">https://github.com/josephwilk/hystrix-event-stream-clj</a></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="ss">:require</span> <span class="p">[</span><span class="nv">hystrix-event-stream-clj.core</span> <span class="nv">as</span> <span class="nv">hystrix-event</span><span class="p">])</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">defroutes</span> <span class="nv">app</span> <span class="p">(</span><span class="nf">GET</span> <span class="s">&quot;/hystrix.stream&quot;</span> <span class="p">(</span><span class="nf">hystrix-event/stream</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<h4>Jetty and Hystrix Event Streams (with servlets)</h4>

<p>If they are using Jetty you will need to change your app to add your main web app as a servlet. Then we can also add the Hystrix event stream servlet.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">ns </span><span class="nv">sc-clj-kit.hystrix.jetty</span>
</span><span class='line'>  <span class="p">(</span><span class="ss">:import</span> <span class="p">[</span><span class="nv">com.netflix.hystrix.contrib.metrics.eventstream</span> <span class="nv">HystrixMetricsStreamServlet</span><span class="p">])</span>
</span><span class='line'>  <span class="p">(</span><span class="ss">:import</span> <span class="p">[</span><span class="nv">org.eclipse.jetty.server</span> <span class="nv">Server</span><span class="p">])</span>
</span><span class='line'>  <span class="p">(</span><span class="ss">:import</span> <span class="p">[</span><span class="nv">org.eclipse.jetty.servlet</span> <span class="nv">ServletContextHandler</span><span class="p">])</span>
</span><span class='line'>  <span class="p">(</span><span class="ss">:import</span> <span class="p">[</span><span class="nv">org.eclipse.jetty.servlet</span> <span class="nv">ServletHolder</span><span class="p">])</span>
</span><span class='line'>  <span class="p">(</span><span class="ss">:import</span> <span class="p">[</span><span class="nv">org.eclipse.jetty.server.bio</span> <span class="nv">SocketConnector</span><span class="p">])</span>
</span><span class='line'>  <span class="p">(</span><span class="ss">:import</span> <span class="p">[</span><span class="nv">org.eclipse.jetty.server.ssl</span> <span class="nv">SslSocketConnector</span><span class="p">])</span>
</span><span class='line'>
</span><span class='line'>  <span class="p">(</span><span class="ss">:import</span> <span class="p">(</span><span class="nf">org.eclipse.jetty.server</span> <span class="nv">Server</span> <span class="nv">Request</span><span class="p">)</span>
</span><span class='line'>           <span class="p">(</span><span class="nf">org.eclipse.jetty.server.handler</span> <span class="nv">AbstractHandler</span><span class="p">)</span>
</span><span class='line'>           <span class="p">(</span><span class="nf">org.eclipse.jetty.server.nio</span> <span class="nv">SelectChannelConnector</span><span class="p">)</span>
</span><span class='line'>           <span class="p">(</span><span class="nf">org.eclipse.jetty.server.ssl</span> <span class="nv">SslSelectChannelConnector</span><span class="p">)</span>
</span><span class='line'>           <span class="p">(</span><span class="nf">org.eclipse.jetty.util.thread</span> <span class="nv">QueuedThreadPool</span><span class="p">)</span>
</span><span class='line'>           <span class="p">(</span><span class="nf">org.eclipse.jetty.util.ssl</span> <span class="nv">SslContextFactory</span><span class="p">)</span>
</span><span class='line'>           <span class="p">(</span><span class="nf">javax.servlet.http</span> <span class="nv">HttpServletRequest</span> <span class="nv">HttpServletResponse</span><span class="p">))</span>
</span><span class='line'>  <span class="p">(</span><span class="ss">:require</span>
</span><span class='line'>   <span class="p">[</span><span class="nv">compojure.core</span>          <span class="ss">:refer</span> <span class="ss">:all</span><span class="p">]</span>
</span><span class='line'>   <span class="p">[</span><span class="nv">ring.adapter.jetty</span>      <span class="ss">:as</span> <span class="nv">jetty</span><span class="p">]</span>
</span><span class='line'>   <span class="p">[</span><span class="nv">ring.util.servlet</span> <span class="ss">:as</span> <span class="nv">servlet</span><span class="p">]))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">run-jetty-with-hystrix-stream</span> <span class="p">[</span><span class="nv">app</span> <span class="nv">options</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="o">^</span><span class="nv">Server</span> <span class="nv">server</span> <span class="p">(</span><span class="o">#</span><span class="ss">&#39;jetty/create-server</span> <span class="p">(</span><span class="nb">dissoc </span><span class="nv">options</span> <span class="ss">:configurator</span><span class="p">))</span>
</span><span class='line'>        <span class="o">^</span><span class="nv">QueuedThreadPool</span> <span class="nv">pool</span> <span class="p">(</span><span class="nf">QueuedThreadPool.</span> <span class="o">^</span><span class="nv">Integer</span> <span class="p">(</span><span class="nf">options</span> <span class="ss">:max-threads</span> <span class="mi">50</span><span class="p">))]</span>
</span><span class='line'>    <span class="p">(</span><span class="nb">when </span><span class="p">(</span><span class="ss">:daemon?</span> <span class="nv">options</span> <span class="nv">false</span><span class="p">)</span> <span class="p">(</span><span class="nf">.setDaemon</span> <span class="nv">pool</span> <span class="nv">true</span><span class="p">))</span>
</span><span class='line'>    <span class="p">(</span><span class="nb">doto </span><span class="nv">server</span> <span class="p">(</span><span class="nf">.setThreadPool</span> <span class="nv">pool</span><span class="p">))</span>
</span><span class='line'>    <span class="p">(</span><span class="nb">when-let </span><span class="p">[</span><span class="nv">configurator</span> <span class="p">(</span><span class="ss">:configurator</span> <span class="nv">options</span><span class="p">)]</span>
</span><span class='line'>      <span class="p">(</span><span class="nf">configurator</span> <span class="nv">server</span><span class="p">))</span>
</span><span class='line'>    <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">hystrix-holder</span>  <span class="p">(</span><span class="nf">ServletHolder.</span> <span class="nv">HystrixMetricsStreamServlet</span><span class="p">)</span>
</span><span class='line'>          <span class="nv">app-holder</span> <span class="p">(</span><span class="nf">ServletHolder.</span> <span class="p">(</span><span class="nf">servlet/servlet</span> <span class="nv">app</span><span class="p">))</span>
</span><span class='line'>          <span class="nv">context</span> <span class="p">(</span><span class="nf">ServletContextHandler.</span> <span class="nv">server</span> <span class="s">&quot;/&quot;</span> <span class="nv">ServletContextHandler/SESSIONS</span><span class="p">)]</span>
</span><span class='line'>      <span class="p">(</span><span class="nf">.addServlet</span> <span class="nv">context</span> <span class="nv">hystrix-holder</span> <span class="s">&quot;/hystrix.stream&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="p">(</span><span class="nf">.addServlet</span> <span class="nv">context</span> <span class="nv">app-holder</span> <span class="s">&quot;/&quot;</span><span class="p">))</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">.start</span> <span class="nv">server</span><span class="p">)</span>
</span><span class='line'>    <span class="p">(</span><span class="nb">when </span><span class="p">(</span><span class="ss">:join?</span> <span class="nv">options</span> <span class="nv">true</span><span class="p">)</span> <span class="p">(</span><span class="nf">.join</span> <span class="nv">server</span><span class="p">))</span>
</span><span class='line'>    <span class="nv">server</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">defroutes</span> <span class="nv">app</span> <span class="p">(</span><span class="nf">GET</span> <span class="s">&quot;/hello&quot;</span> <span class="p">[]</span> <span class="p">{</span><span class="ss">:status</span> <span class="mi">200</span> <span class="ss">:body</span> <span class="s">&quot;Hello&quot;</span><span class="p">})</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">run-jetty-with-hystrix</span> <span class="nv">app</span> <span class="p">{</span><span class="ss">:port</span> <span class="nv">http-port</span> <span class="ss">:join?</span> <span class="nv">false</span><span class="p">})</span>
</span></code></pre></td></tr></table></div></figure>


<h4>Aggregation and discovery</h4>

<p>While you can monitor a single process using Hystrix in our example we have many processes serving an endpoint. To aggregate all these Hystrix metric services we use <a href="https://github.com/Netflix/Turbine">Turbine</a>.</p>

<p>Physical endpoints for a service at SoundCloud are discovered using DNS lookup. We configured Turbine to use this method to auto discover which machines are serving an endpoint.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">ns </span><span class="nv">sc-turbine.discovery</span>
</span><span class='line'>  <span class="p">(</span><span class="ss">:import</span> <span class="p">[</span><span class="nv">org.xbill.DNS</span> <span class="nv">Type</span><span class="p">]</span>
</span><span class='line'>           <span class="p">[</span><span class="nv">com.netflix.turbine.discovery</span> <span class="nv">InstanceDiscovery</span> <span class="nv">Instance</span><span class="p">])</span>
</span><span class='line'>  <span class="p">(</span><span class="ss">:require</span> <span class="p">[</span><span class="nv">clj-dns.core</span> <span class="ss">:refer</span> <span class="ss">:all</span><span class="p">]))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">gen-class</span>
</span><span class='line'>   <span class="ss">:name</span> <span class="nv">ScInstanceDiscovery</span>
</span><span class='line'>   <span class="ss">:implements</span> <span class="p">[</span><span class="nv">com.netflix.turbine.discovery.InstanceDiscovery</span><span class="p">])</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">-getInstanceList</span> <span class="p">[</span><span class="nv">this</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="nb">map </span><span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">instance</span><span class="p">]</span>
</span><span class='line'>         <span class="p">(</span><span class="nf">Instance.</span> <span class="p">(</span><span class="nb">str </span><span class="p">(</span><span class="ss">:host</span> <span class="nv">instance</span><span class="p">)</span> <span class="s">&quot;:&quot;</span> <span class="p">(</span><span class="ss">:port</span> <span class="nv">instance</span><span class="p">))</span> <span class="s">&quot;example-prod&quot;</span> <span class="nv">true</span><span class="p">))</span>
</span><span class='line'>       <span class="p">(</span><span class="nb">map </span><span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">answer</span><span class="p">]</span> <span class="p">{</span><span class="ss">:host</span> <span class="p">(</span><span class="nb">-&gt; </span><span class="nv">answer</span> <span class="nv">.getTarget</span> <span class="nv">str</span><span class="p">)</span> <span class="ss">:port</span> <span class="p">(</span><span class="nf">.getPort</span> <span class="nv">answer</span><span class="p">)})</span>
</span><span class='line'>            <span class="p">(</span><span class="ss">:answers</span> <span class="p">(</span><span class="nf">dns-lookup</span> <span class="s">&quot;&quot;</span> <span class="nv">Type/SRV</span><span class="p">)))))</span>
</span></code></pre></td></tr></table></div></figure>


<p>And the config.properties:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="nv">InstanceDiscovery.impl=ScInstanceDiscovery</span>
</span><span class='line'><span class="nv">turbine.aggregator.clusterConfig=example-prod</span>
</span><span class='line'><span class="nv">turbine.instanceUrlSuffix=/hystrix.stream</span>
</span></code></pre></td></tr></table></div></figure>


<p>Putting this all together our monitoring looks like this:</p>

<p><img src="/images/service_discovery.png"></p>

<h4>Pretty graphs: Hystrix Dashboard</h4>

<p>Finally we run the <a href="https://github.com/Netflix/Hystrix/tree/master/hystrix-dashboard">Hystrix Dashboard</a> and watch our circuit breakers live.</p>

<p><img src="/images/hystrix_dashboard.png"></p>

<p>And heres an example with triggered circuit breakers:</p>

<p><img src="/images/hystrix_dashboard_failures.jpg"></p>

<p>Since I cannot show you the dashboard running, you will have to make do with music generated from the metrics. I normalize the live Hystrix metrics to piano pitches and play the notes as the arrive from the stream.</p>

<h4>Hystrix Metrics as Sounds</h4>

<div>
<iframe width="100%" height="166" scrolling="no" frameborder="no" src="https://w.soundcloud.com/player/?url=http%3A%2F%2Fapi.soundcloud.com%2Ftracks%2F109115434&amp;color=ff6600&amp;auto_play=false&amp;show_artwork=false"></iframe>
</div>




<p></p>


<h3>Complexity &amp; Composition</h3>

<p>Working with many services, composition of service calls becomes hard to think and write about. Callbacks try to solve this but nested callbacks leave us with a mess.</p>

<p><a href="https://github.com/Netflix/RxJava">RxJava</a> tries to solve this using the Reactive Functional model. While RxJava provides lots of features I see it primarily as a way of expressing concurrent actions as a directed graph which provides a single callback on success or failure. The graph is expressed in terms or maps/reduces/filters/etc, things we are familiar with in the functional world.</p>

<p>To separate the request thread from the response thread we use RxJava with <a href="http://netty.io">Netty</a> and <a href="https://github.com/ztellman/aleph">Aleph</a>.</p>

<p>Here is a very simple example firing 2 concurrent requests and then joining the results into a single map response:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="c1">;;Hystrix integrates with RxJava and can return Observables for use with Rx.</span>
</span><span class='line'><span class="p">(</span><span class="kd">defn- </span><span class="nv">find-user-observable</span> <span class="p">[</span><span class="nv">id</span><span class="p">]</span> <span class="p">(</span><span class="nf">hystrix/observe</span> <span class="o">#</span><span class="ss">&#39;find-user</span> <span class="nv">id</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defn- </span><span class="nv">meta-data</span> <span class="p">[</span><span class="nv">user-urn</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">user-observable</span> <span class="p">(</span><span class="nb">-&gt; </span><span class="p">(</span><span class="nf">find-user-observable</span> <span class="nv">id</span><span class="p">)</span> <span class="p">(</span><span class="nf">.map</span> <span class="p">(</span><span class="err">λ</span> <span class="p">[</span><span class="nv">user</span><span class="p">]</span> <span class="nv">...</span><span class="p">)))</span>
</span><span class='line'>        <span class="nv">meta-observable</span> <span class="p">(</span><span class="nb">-&gt; </span><span class="p">(</span><span class="nf">find-user-meta-observable</span> <span class="nv">id</span><span class="p">)</span> <span class="p">(</span><span class="nf">.map</span> <span class="p">(</span><span class="err">λ</span> <span class="p">[</span><span class="nv">subscription</span><span class="p">]</span> <span class="nv">...</span><span class="p">))))</span>
</span><span class='line'>    <span class="p">(</span><span class="nb">-&gt; </span><span class="p">(</span><span class="nf">Observable/zip</span> <span class="nv">user-observable</span>
</span><span class='line'>                        <span class="nv">meta-observable</span>
</span><span class='line'>                        <span class="p">(</span><span class="err">λ</span> <span class="p">[</span><span class="o">&amp;</span> <span class="nv">maps</span><span class="p">]</span> <span class="p">{</span><span class="ss">:user</span> <span class="p">(</span><span class="nb">apply merge </span><span class="nv">maps</span><span class="p">)}))))</span>
</span></code></pre></td></tr></table></div></figure>


<p>The function <code>meta-data</code> returns an Observerable which we subscribe to and using Aleph return the resulting JSON to a channel.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn- </span><span class="nv">subscribe-request</span> <span class="p">[</span><span class="nv">channel</span> <span class="nv">request</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">id</span> <span class="p">(</span><span class="nf">get-in</span> <span class="nv">request</span> <span class="p">[</span><span class="ss">:route-params</span> <span class="ss">:id</span><span class="p">])]</span>
</span><span class='line'>    <span class="p">(</span><span class="nb">-&gt; </span><span class="p">(</span><span class="nf">meta-data</span> <span class="nv">id</span><span class="p">)</span>
</span><span class='line'>        <span class="p">(</span><span class="nf">.subscribe</span>
</span><span class='line'>          <span class="o">#</span><span class="p">(</span><span class="nf">enqueue</span> <span class="nv">channel</span> <span class="p">{</span><span class="ss">:status</span> <span class="mi">200</span> <span class="ss">:body</span> <span class="nv">%</span><span class="p">}))</span>
</span><span class='line'>          <span class="o">#</span><span class="p">(</span><span class="nf">logging/exception</span> <span class="nv">%</span><span class="p">))))))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">defroutes</span> <span class="nv">app</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">GET</span> <span class="s">&quot;/users/:id&quot;</span> <span class="p">[</span><span class="nv">id</span><span class="p">]</span> <span class="p">(</span><span class="nf">wrap-aleph-handler</span> <span class="nv">subscribe-request</span><span class="p">)))</span>
</span></code></pre></td></tr></table></div></figure>


<p>The shape of the <a href="https://github.com/Netflix/RxJava/tree/master/language-adaptors/rxjava-clojure">RxJava Clojure bindings</a> are still under development.</p>

<h4>That single thread pool again&hellip;</h4>

<p>With RxJava we are also in a situation were we cannot use Clojure&rsquo;s <code>future</code>. In order for RxJava to block optimally we don&rsquo;t want to use a single thread pool.
Hence we use Hystrix as our means of providing concurreny.</p>

<h2>Clojure services at scale</h2>

<p>I&rsquo;m very happy with the shape of these services running at SoundCloud. In production they are performing very well under heavy load with useful near realtime monitoring.
In part thanks to Netflix&rsquo;s hard work there is no reason you cannot write elegant Clojure services at scale.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Joseph Wilk</span></span>

      








  


<time datetime="2013-09-13T11:00:00+02:00" pubdate data-updated="true">Sep 13<span>th</span>, 2013</time>
      

<span class="categories">
  
    <a class='category' href='/clojure'>clojure</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://blog.josephwilk.net/clojure/building-clojure-services-at-scale.html" data-via="josephwilk" data-counturl="http://blog.josephwilk.net/clojure/building-clojure-services-at-scale.html" >Tweet</a>
  
  
  <div class="g-plusone" data-size="small"></div>
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/clojure/creating-instruments-with-overtone.html" title="Previous Post: Creating sampled instruments with Overtone">&laquo; Creating sampled instruments with Overtone</a>
      
      
        <a class="basic-alignment right" href="/clojure/sounds-of-the-human-brain.html" title="Next Post: Sounds of the human brain">Sounds of the human brain &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/clojure/overtone-driving-minecraft.html">Clojure and Overtone driving Minecraft</a>
      </li>
    
      <li class="post">
        <a href="/art/live-coding-repl-electric.html">Live Coding - Repl Electric</a>
      </li>
    
      <li class="post">
        <a href="/clojure/creative_machines.html">Creative Machines</a>
      </li>
    
      <li class="post">
        <a href="/clojure/sounds-of-the-human-brain.html">Sounds of the human brain</a>
      </li>
    
      <li class="post">
        <a href="/clojure/building-clojure-services-at-scale.html">Building Clojure services at scale</a>
      </li>
    
      <li class="post">
        <a href="/clojure/creating-instruments-with-overtone.html">Creating sampled instruments with Overtone</a>
      </li>
    
      <li class="post">
        <a href="/elixir/sets-in-elixir.html">Sets in Elixir</a>
      </li>
    
      <li class="post">
        <a href="/clojure/isolating-external-dependencies-in-clojure.html">Isolating external dependencies in Clojure</a>
      </li>
    
      <li class="post">
        <a href="/presentations/a-developers-guide-to-creating-presentations.html">A developers guide to creating presentations</a>
      </li>
    
      <li class="post">
        <a href="/software-craftmanship/the-aesthetics-of-density.html">The Aesthetics of Density</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/josephwilk">@josephwilk</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'josephwilk',
            count: 10,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - Joseph Wilk -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'josephwilk';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://blog.josephwilk.net/clojure/building-clojure-services-at-scale.html';
        var disqus_url = 'http://blog.josephwilk.net/clojure/building-clojure-services-at-scale.html';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>





  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
