
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Joseph Wilk</title>
  <meta name="author" content="Joseph Wilk">

  
  <meta name="description" content="Emacs is designed for fast, highly customisable manipulation of text.
ASCII animation requires manipulating text at a sufficient speed that it &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://josephwilk.github.io/index.html">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Joseph Wilk" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<script src="http://disqus.com/forums/josephwilk/embed.js"></script>
<link href="http://fonts.googleapis.com/css?family=Bevan" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-3020740-2']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body    class="collapse-sidebar sidebar-footer" >
  <header role="banner"><hgroup>
  <img src="/images/joe_small.jpg" style="position:relative;border-radius: 8px;margin-right: 5px;border-style: solid;border-width: 1px;border-color: #DDD;" height="60" alt="Joseph Wilk">
  <span style="display:inline-block">
    <h1><a href="/">Joseph Wilk</a></h1>
    <h2>Programming bits and bobs</h2>
  </span>
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:josephwilk.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
 <li><a href="/">Home</a></li>
 <li><a href="/about">About</a></li>
 <li><a href="/speaking">Speaking</a></li>
 <li><a href="/contact">Contact</a></li>
 <li><a href="/archives">Archives</a></li>
</ul>
</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/art/emacs-animation.html">Animations With Emacs</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-10-02T15:58:12+01:00" pubdate data-updated="true">Oct 2<span>nd</span>, 2015</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Emacs is designed for fast, highly customisable manipulation of text.
ASCII animation requires manipulating text at a sufficient speed that it appears animated. Emacs is also used by a number of performers to live code musical &amp; visual performances (and many other things). Where the audience can see the code in emacs and hear it.</p>

<p><img src="/images/live-coding-emacs.png" alt="Live Coding with Emacs" /></p>

<p>In my live coding performances as <a href="http://www.repl-electric.com">Repl Electric</a> I&rsquo;ve used emacs animations to  augment emacs with more feedback for the performer and a chance to destroy the order and structure the programmer has spent the entire performance building. Reminding us that we are looking at thoughts expressed through code that seem magical but are ultimately nothing more than text.</p>

<p>Maybe something akin to the creation and destruction of Sand Mandalas.</p>

<p><img src="/images/sandmandala.jpg" alt="Sand Mandala" /></p>

<h2>Framework for Emacs Animation</h2>

<p>Zone Mode is an Emacs plugin which provides a framework for screensaver like animations.</p>

<p><a href="http://www.emacswiki.org/emacs/ZoneMode">http://www.emacswiki.org/emacs/ZoneMode</a></p>

<p>Importantly it allows us to turn on an animation using our current code buffer as input and to terminate the animation, returning to the original code on a key press. So we can safely mangle the text knowing we can also return to safety. Well so far I&rsquo;ve always found it to be safe but there is a small risk as mentioned in the zoning warning:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='lisp'><span class='line'><span class="p">(</span><span class="nv">message</span> <span class="s">&quot;...here&#39;s hoping we didn&#39;t hose your buffer!&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>A nice property of taking our buffer as input is we are never quite sure what text will be there and hence the properties of the animation.</p>

<h3>Example: Uppercase all letters</h3>

<p>A simple function that finds non-whitespace in the buffer and tries to uppercase the char. It knows nothing about the zoning framework, its just a plain old function that operates on the active buffer.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='lisp'><span class='line'><span class="p">(</span><span class="nb">defun</span> <span class="nv">zone-upper-case-text</span> <span class="p">()</span>
</span><span class='line'>  <span class="p">(</span><span class="nv">zone-fill-out-screen</span> <span class="p">(</span><span class="nv">window-width</span><span class="p">)</span> <span class="p">(</span><span class="nv">window-height</span><span class="p">))</span>
</span><span class='line'>  <span class="p">(</span><span class="nb">random</span> <span class="no">t</span><span class="p">)</span>
</span><span class='line'>  <span class="p">(</span><span class="nv">goto-char</span> <span class="p">(</span><span class="nv">point-min</span><span class="p">))</span>
</span><span class='line'>  <span class="p">(</span><span class="nv">while</span> <span class="p">(</span><span class="nb">not</span> <span class="p">(</span><span class="nv">input-pending-p</span><span class="p">))</span>
</span><span class='line'>    <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">wbeg</span> <span class="p">(</span><span class="nv">window-start</span><span class="p">))</span>
</span><span class='line'>          <span class="p">(</span><span class="nv">wend</span> <span class="p">(</span><span class="nv">window-end</span><span class="p">)))</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">;;Keep moving the char cursor until its not whitespace</span>
</span><span class='line'>      <span class="p">(</span><span class="nv">while</span> <span class="p">(</span><span class="nv">looking-at</span> <span class="s">&quot;[ \n\f]&quot;</span><span class="p">)</span>
</span><span class='line'>        <span class="p">(</span><span class="nv">goto-char</span> <span class="p">(</span><span class="nb">+</span> <span class="nv">wbeg</span> <span class="p">(</span><span class="nb">random</span> <span class="p">(</span><span class="nb">-</span> <span class="nv">wend</span> <span class="nv">wbeg</span><span class="p">))))))</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">;;If we are at the end of the buffer go to the last char</span>
</span><span class='line'>    <span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nv">eobp</span><span class="p">)</span> <span class="p">(</span><span class="nv">goto-char</span> <span class="p">(</span><span class="nv">point-min</span><span class="p">)))</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">;;Read the char at the cursor</span>
</span><span class='line'>    <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">c</span> <span class="p">(</span><span class="nv">char-after</span> <span class="p">(</span><span class="nv">point</span><span class="p">))))</span>
</span><span class='line'>      <span class="p">(</span><span class="nv">delete-char</span> <span class="mi">1</span><span class="p">)</span>           <span class="c1">;; Remove the char</span>
</span><span class='line'>      <span class="p">(</span><span class="nv">insert-char</span> <span class="p">(</span><span class="nv">upcase</span> <span class="nv">c</span><span class="p">)))</span> <span class="c1">;; Reinsert with caps      </span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">;;Sleep</span>
</span><span class='line'>    <span class="p">(</span><span class="nv">zone-park/sit-for</span> <span class="p">(</span><span class="nv">point-min</span><span class="p">)</span> <span class="mf">0.1</span><span class="p">)))</span>
</span></code></pre></td></tr></table></div></figure>


<p>The animation in all its glory:</p>

<iframe src="https://player.vimeo.com/video/141312958" width="500" height="281" frameborder="0" webkitallowfullscreen mozallowfullscreen allowfullscreen></iframe>


<h3>Zoning Setup</h3>

<p>We can override all other zoning programs and just specify our zone-fn. When we activate zoning our animation will be run.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='lisp'><span class='line'><span class="p">(</span><span class="nv">eval-after-load</span> <span class="s">&quot;zone&quot;</span>
</span><span class='line'>  <span class="o">&#39;</span><span class="p">(</span><span class="nb">unless</span> <span class="p">(</span><span class="nv">memq</span> <span class="ss">&#39;zone-upper-case-text</span> <span class="p">(</span><span class="nb">append</span> <span class="nv">zone-programs</span> <span class="no">nil</span><span class="p">))</span>
</span><span class='line'>         <span class="p">(</span><span class="k">setq</span> <span class="nv">zone-programs</span> <span class="nv">[zone-upper-case-text]</span><span class="p">)))</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Zoning Examples:</h3>

<p>Zoning mode comes with lots of example animations that are good starting points:</p>

<p><a href="http://www.opensource.apple.com/source/emacs/emacs-51/emacs/lisp/play/zone.el">http://www.opensource.apple.com/source/emacs/emacs-51/emacs/lisp/play/zone.el</a></p>

<ul>
<li>zone-pgm-jitter</li>
<li>zone-pgm-putz-with-case</li>
<li>zone-pgm-dissolve</li>
<li>zone-pgm-whack-chars</li>
<li>zone-pgm-rotate</li>
<li>zone-pgm-rotate-LR-lockstep</li>
<li>zone-pgm-rotate-RL-lockstep</li>
<li>zone-pgm-rotate-LR-variable</li>
<li>zone-pgm-rotate-RL-variable</li>
<li>zone-pgm-drip</li>
<li>zone-pgm-drip-fretfully</li>
<li>zone-pgm-five-oclock-swan-dive</li>
<li>zone-pgm-martini-swan-dive</li>
<li>zone-pgm-paragraph-spaz</li>
<li>zone-pgm-stress</li>
</ul>


<h2>Open Sound Control Protocol Based animation</h2>

<p>OSC is a handy protocol for sending data between networked devices using url like endpoints.
Emacs has a plugin to run an OSC server (<a href="http://delysid.org/emacs/osc.html">http://delysid.org/emacs/osc.html</a>).
Hence if we have some kind of beat signal we could send a message to Emacs and in turn it could render changes based on our musics timing.</p>

<p>With my Overtone setup for Repl-Electric I have the following flow of OSC messages:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='lisp'><span class='line'><span class="nv">[Supercollider]</span> <span class="nv">-&gt;</span> <span class="nv">OSC</span> <span class="nv">-&gt;</span> <span class="nv">[Clojure]</span> <span class="nv">-&gt;</span> <span class="nv">OSC</span> <span class="nv">-&gt;</span> <span class="nv">[Emacs]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Within Emacs setup an OSC server and define two call backs which change the color of the window face number</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
</pre></td><td class='code'><pre><code class='emacs-lisp'><span class='line'><span class="p">(</span><span class="nb">require</span> <span class="ss">&#39;osc</span><span class="p">)</span>
</span><span class='line'><span class="p">(</span><span class="nb">require</span> <span class="ss">&#39;cl</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nb">defvar</span> <span class="nv">osc-server</span> <span class="no">nil</span> <span class="s">&quot;Connection to receive msgs&quot;</span><span class="p">)</span>
</span><span class='line'><span class="p">(</span><span class="nb">defvar</span> <span class="nv">flip-state</span> <span class="no">t</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nb">defun</span> <span class="nv">osc-connect</span> <span class="p">()</span>
</span><span class='line'>  <span class="s">&quot;Create an OSC server and bind our fallback functions&quot;</span>
</span><span class='line'>  <span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nb">not</span> <span class="nv">osc-server</span><span class="p">)</span>
</span><span class='line'>    <span class="p">(</span><span class="k">setq</span> <span class="nv">osc-server</span>
</span><span class='line'>          <span class="p">(</span><span class="nv">osc-make-server</span>
</span><span class='line'>           <span class="s">&quot;localhost&quot;</span> <span class="mi">4558</span>
</span><span class='line'>           <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">path</span> <span class="k">&amp;rest</span> <span class="nv">args</span><span class="p">)</span>
</span><span class='line'>             <span class="p">(</span><span class="nb">cond</span>
</span><span class='line'>              <span class="p">((</span><span class="nv">string-match</span> <span class="s">&quot;/beat&quot;</span> <span class="nv">path</span><span class="p">)</span>
</span><span class='line'>               <span class="p">(</span><span class="k">progn</span> <span class="p">(</span><span class="k">if</span> <span class="nv">flip-state</span> <span class="p">(</span><span class="nv">on-beat</span><span class="p">)</span> <span class="p">(</span><span class="nv">off-beat</span><span class="p">))</span>
</span><span class='line'>                      <span class="p">(</span><span class="k">setq</span> <span class="nv">flip-state</span> <span class="p">(</span><span class="nb">not</span> <span class="nv">flip-state</span><span class="p">))))))))))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nb">defun</span> <span class="nv">osc-make-server</span> <span class="p">(</span><span class="nv">host</span> <span class="nv">port</span> <span class="nv">default-handler</span><span class="p">)</span>
</span><span class='line'>  <span class="s">&quot;Settings for OSC server&quot;</span>
</span><span class='line'>  <span class="p">(</span><span class="nv">make-network-process</span>
</span><span class='line'>   <span class="ss">:name</span> <span class="s">&quot;emacs OSC server&quot;</span>
</span><span class='line'>   <span class="ss">:host</span> <span class="nv">host</span>
</span><span class='line'>   <span class="ss">:server</span> <span class="no">t</span>
</span><span class='line'>   <span class="ss">:service</span> <span class="nv">port</span>
</span><span class='line'>   <span class="ss">:filter</span> <span class="nf">#&#39;</span><span class="nv">osc-filter</span>
</span><span class='line'>   <span class="ss">:type</span> <span class="ss">&#39;datagram</span>
</span><span class='line'>   <span class="ss">:family</span> <span class="ss">&#39;ipv4</span>
</span><span class='line'>   <span class="ss">:plist</span> <span class="p">(</span><span class="nb">list</span> <span class="ss">:generic</span> <span class="nv">default-handler</span><span class="p">)))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nb">defun</span> <span class="nv">on-beat</span> <span class="p">()</span>
</span><span class='line'>  <span class="p">(</span><span class="nv">custom-set-faces</span>
</span><span class='line'>   <span class="o">&#39;</span><span class="p">(</span><span class="nv">window-number-face</span> <span class="p">((</span><span class="no">t</span> <span class="p">(</span><span class="ss">:foreground</span> <span class="s">&quot;deeppink&quot;</span><span class="p">))))))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nb">defun</span> <span class="nv">off-beat</span> <span class="p">()</span>
</span><span class='line'>  <span class="p">(</span><span class="nv">custom-set-faces</span>
</span><span class='line'>   <span class="o">&#39;</span><span class="p">(</span><span class="nv">window-number-face</span> <span class="p">((</span><span class="no">t</span> <span class="p">(</span><span class="ss">:foreground</span> <span class="s">&quot;#FDDD0C&quot;</span><span class="p">))))))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nv">osc-connect</span><span class="p">)</span>
</span><span class='line'><span class="p">(</span><span class="nb">provide</span> <span class="ss">&#39;osc-server</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>In Overtone/Clojure the sending signal:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defonce </span><span class="nv">emacs-client</span> <span class="p">(</span><span class="nf">osc-client</span> <span class="s">&quot;localhost&quot;</span> <span class="mi">4558</span><span class="p">))</span>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">emacs-trigger</span>    <span class="p">(</span><span class="nf">on-beat-trigger</span> <span class="mi">8</span> <span class="o">#</span><span class="p">(</span><span class="k">do </span><span class="p">(</span><span class="nf">osc-send</span> <span class="nv">emacs-client</span> <span class="s">&quot;/beat&quot;</span><span class="p">))))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Heres a little demo with the brackets and window number changing colour based on the Overtone beat.</p>

<p><img src="/images/brackets.gif" alt="Emacs rendering to the beat" /></p>

<h3>Synchronisation</h3>

<p>Given some small local lag we now have a timing signal which is threaded through all our tools. <a href="http://supercollider.github.io/">Supercollider</a>, <a href="http://overtone.github.io/">Overtone</a> and Emacs.</p>

<p>Which means our emacs animations can start to change to the beat of the music&hellip;</p>

<h2>Sound in ASCII</h2>

<p>Now that we have ways to animate and to connect audio data with emacs we can go a little further (way too far) and start to visualise the data about our sound in ASCII.</p>

<p>From Overtone or SuperCollider we can create a synth which tracks the peak and power of an audio signal. It sends us messages back with the data which we then forward on as OSC messages to Emacs.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="cp">#Triggers a Sin Wave Oscillator and sends signals about power/peak</span>
</span><span class='line'><span class="n">SynthDef</span><span class="p">(</span><span class="err">\</span><span class="n">pulse</span><span class="p">,{</span>
</span><span class='line'>  <span class="n">var</span> <span class="n">sig</span><span class="p">,</span> <span class="n">chain</span><span class="p">,</span> <span class="n">onsets</span><span class="p">;</span>
</span><span class='line'>  <span class="n">sig</span> <span class="o">=</span> <span class="n">SinOsc</span><span class="p">.</span><span class="n">ar</span><span class="p">(</span><span class="n">Rand</span><span class="p">(</span><span class="mf">220.0</span><span class="p">,</span><span class="mf">440.0</span><span class="p">))</span>
</span><span class='line'>  <span class="o">*</span><span class="n">EnvGen</span><span class="p">.</span><span class="n">ar</span><span class="p">(</span><span class="n">Env</span><span class="p">.</span><span class="n">perc</span><span class="p">(</span><span class="nl">releaseTime</span><span class="p">:</span><span class="mf">0.5</span><span class="p">),</span><span class="n">Dust</span><span class="p">.</span><span class="n">ar</span><span class="p">(</span><span class="mf">0.5</span><span class="p">))</span><span class="o">*</span><span class="mf">0.7</span><span class="p">;</span>
</span><span class='line'>  <span class="n">Out</span><span class="p">.</span><span class="n">ar</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">sig</span> <span class="o">!</span><span class="mi">2</span><span class="p">);</span>
</span><span class='line'>  <span class="c1">//</span>
</span><span class='line'>  <span class="n">chain</span> <span class="o">=</span> <span class="n">FFT</span><span class="p">({</span><span class="n">LocalBuf</span><span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="mi">1</span><span class="p">)},</span> <span class="n">sig</span><span class="p">);</span>
</span><span class='line'>  <span class="n">onsets</span> <span class="o">=</span> <span class="n">Onsets</span><span class="p">.</span><span class="n">kr</span><span class="p">(</span><span class="n">chain</span><span class="p">,</span><span class="mf">0.1</span><span class="p">,</span><span class="err">\</span><span class="n">power</span><span class="p">);</span>
</span><span class='line'>  <span class="n">SendTrig</span><span class="p">.</span><span class="n">kr</span><span class="p">(</span><span class="n">onsets</span><span class="p">);</span>
</span><span class='line'>  <span class="n">SendPeakRMS</span><span class="p">.</span><span class="n">kr</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="s">&quot;/replyAddress&quot;</span><span class="p">);</span>
</span><span class='line'><span class="p">}).</span><span class="n">add</span><span class="p">;</span>
</span><span class='line'><span class="cp">#Run the crazy synth above</span>
</span><span class='line'><span class="n">Synth</span><span class="p">(</span><span class="err">\</span><span class="n">pulse</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#Forward the data on as an OSC message</span>
</span><span class='line'><span class="cp">#to emacs</span>
</span><span class='line'><span class="o">~</span><span class="n">host</span> <span class="o">=</span> <span class="n">NetAddr</span><span class="p">(</span><span class="s">&quot;localhost&quot;</span><span class="p">,</span> <span class="mi">4859</span><span class="p">);</span>
</span><span class='line'><span class="n">p</span> <span class="o">=</span> <span class="n">OSCFunc</span><span class="p">({</span> <span class="o">|</span><span class="n">msg</span><span class="o">|</span>
</span><span class='line'>  <span class="o">~</span><span class="n">host</span><span class="p">.</span><span class="n">sendMsg</span><span class="p">(</span><span class="s">&quot;/peakpower&quot;</span><span class="p">,</span><span class="n">msg</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">msg</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
</span><span class='line'>  <span class="s">&quot;peak: %, rms: %&quot;</span><span class="p">.</span><span class="n">format</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">msg</span><span class="p">[</span><span class="mi">4</span><span class="p">]).</span><span class="n">postln</span>
</span><span class='line'><span class="p">},</span> <span class="err">&#39;</span><span class="o">/</span><span class="n">replyAddress</span><span class="err">&#39;</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>And in our emacs OSC server:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='emacs-lisp'><span class='line'><span class="p">((</span><span class="nv">string-match</span> <span class="s">&quot;/peakpower&quot;</span> <span class="nv">path</span><span class="p">)</span>
</span><span class='line'>  <span class="p">(</span><span class="k">progn</span>
</span><span class='line'>    <span class="p">(</span><span class="nv">with-current-buffer</span> <span class="s">&quot;flatiron.clj&quot;</span>
</span><span class='line'>      <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">sig</span> <span class="p">(</span><span class="nb">round</span> <span class="p">(</span><span class="nb">*</span> <span class="mf">100.0</span> <span class="p">(</span><span class="nb">first</span> <span class="nv">args</span><span class="p">)))))</span>
</span><span class='line'>        <span class="p">(</span><span class="nv">message</span> <span class="p">(</span><span class="nb">format</span> <span class="s">&quot;%f&quot;</span> <span class="p">(</span><span class="nb">first</span> <span class="nv">args</span><span class="p">)))</span>
</span><span class='line'>        <span class="p">(</span><span class="nb">dotimes</span> <span class="p">(</span><span class="nv">n</span> <span class="nv">sig</span><span class="p">)</span>
</span><span class='line'>          <span class="p">(</span><span class="nv">insert</span> <span class="s">&quot;▓&quot;</span><span class="p">))</span>
</span><span class='line'>        <span class="p">(</span><span class="nv">insert</span> <span class="s">&quot;▒░&quot;</span><span class="p">))</span>
</span><span class='line'>      <span class="p">(</span><span class="nv">insert</span> <span class="s">&quot;\n&quot;</span><span class="p">))))</span>
</span></code></pre></td></tr></table></div></figure>




<iframe src="https://player.vimeo.com/video/141159277" width="500" height="281" frameborder="0" webkitallowfullscreen mozallowfullscreen allowfullscreen></iframe>


<h2>Repl Electric Emacs animations</h2>

<p>All my Emacs animations are used to conclude the performance.
Heres lies the source code, some screenshots and tricks &amp; tips that made the animations possible.</p>

<p>Here&rsquo;s a demo of all the Repl Electric animations discussed in action:</p>

<iframe src="https://player.vimeo.com/video/141310772" width="500" height="375" frameborder="0" webkitallowfullscreen mozallowfullscreen allowfullscreen></iframe>


<h3>End of Buffer</h3>

<p><a href="https://github.com/repl-electric/view-pane/blob/master/animations/end-of-buffer.el">https://github.com/repl-electric/view-pane/blob/master/animations/end-of-buffer.el</a></p>

<p><img src="/images/endofbuffer01.png"/ alt="end-of-buffer-01"><img src="/images/endofbuffer02.png" alt="end-of-buffer-02"/><img src="/images/endofbuffer03.png" alt="end-of-buffer-03"/></p>

<p>In this animations the text gets slowly broken up with white spaces and then like the wind, blows the characters away. Sometimes words are ripped apart as they blow in the wind (if we get lucky).</p>

<p>Two main phases:</p>

<ul>
<li><p>Injection of spaces.
This starts to distort the text while keeping it readable. It provides a way to increase the effect of expanding whitespace in the next stage.</p></li>
<li><p>Transforming whitespace into lots of whitespace.
A Regex matches whitespace and replaces it with a randomly increasing amount of whitespace. Which leads to the effect of the characters of the code blowing away. I spent a while trying to improve the speed of this phase and Regexs proved to be the fastest way.</p></li>
</ul>


<p>If we move the text fast enough soft word wrapping means the text appears to re-enter from the left side of the screen and eventually disappear out of the buffer. Without soft wrapping we get a horrible jitter as emacs moves back and forth between left and right side of the buffer.</p>

<p>A couple of other tricks/tactics used:</p>

<ul>
<li>Continually incrementing integer. Useful for injecting movement or using sin/cos fn with a continuous value.</li>
<li>Perserving the syntax highlighting of the original code in an attempt to maintain some of the meaning of the code.</li>
</ul>


<h3>The Stars</h3>

<p><a href="https://github.com/repl-electric/view-pane/blob/master/animations/the-stars.el">https://github.com/repl-electric/view-pane/blob/master/animations/the-stars.el</a></p>

<p><img src="/images/thestars01.png"/></p>

<p>This was my first animation and was based heavily on <code>zone-pgm-drip-fretfully</code>.</p>

<p>It randomly picks a single character and moves it down the screen until it hits another letter or exits the screen.</p>

<p>When running Emacs + Overtone + OpenGL, Emacs starts to slow down so part of the challenge was ensuring the animation ran as fast as possible.</p>

<p>A nice property of this is that as the OpenGL shaders shutdown, the speed of the animation increases and the code destroys itself more quickly.</p>

<h3>Waves</h3>

<p><a href="https://github.com/repl-electric/view-pane/blob/master/animations/waves.el">https://github.com/repl-electric/view-pane/blob/master/animations/waves.el</a></p>

<p><img src="/images/waves01.png"/><img src="/images/waves02.png"/></p>

<p>This animations attempts to simulate the effect of waves using line wrapping and mixing deletions with insertions of different sizes to create lines that seem to move at different speeds.</p>

<h2>Breaking Tools</h2>

<p>While it may seem silly to bend Emacs to do things it was never intended to do, it&rsquo;s an important part of discovering for yourself how you want your tools to work. Not just doing what you are expected but breaking them apart and discovering for yourself how you want to use them.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/clojure/clojure-and-kinesis-at-scale.html">Clojure and Kinesis at Scale</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-09-30T15:58:12+01:00" pubdate data-updated="true">Sep 30<span>th</span>, 2015</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I&rsquo;ve been working over the last year in the data team at SoundCloud building a realtime data pipeline using Clojure and Amazon&rsquo;s Kinesis. Kinesis is Amazons equivalent to Kafka, &ldquo;Real-Time data processing on the Cloud&rdquo;. This is a summary of what was built, some lessons learnt and all the details in-between.</p>

<figure>
<img src="/images/kinesis_pipeline.png" alt="Kinesis pipeline"/>
<figcaption>Kinesis pipeline at SoundCloud</figcaption>
</figure>


<h2>Tapping Real traffic</h2>

<p>The first step was to tee the traffic from a live system to a test system without comprising its function.
The main function of the live system is logging JSON events to file (which eventually end up somewhere like HDFS).
Tailing the logs of the live system gives us access to the raw data we want to forward on to our test system.
A little Go script watches the logs, parses out the data and then forwards them in batch to test instances that will push to Kinesis. Hence we had live data flowing through the system and after launch a test setup to experiment with. <a href="https://twitter.com/brapse">Sean Braithwaite</a> was the mastermind behind this little bit of magic.</p>

<figure>
<img src="/images/canary.png" alt="Canary Kinesis pipeline"/>
<figcaption>Tapping Traffic</figcaption>
</figure>


<h2>Sending to Kinesis</h2>

<p>All Kinesis sending happens in an application called the EventGateway (also written in Clojure). This endpoint is one of the most heavily loaded services in SoundCloud (at points it has more traffic than the rest of SoundCloud combined). The Eventgateway does a couple of things but at its core it validates and broadcasts JSON messages. Hence this is where our Kinesis client slots in.</p>

<h5>Squeezing Clojure Reflection</h5>

<p>Its worth mentioning that in order for the Eventgateway service to be performant we had to remove all reflection in tight loops through type hints. It simply could not keep up without this. It became a common pattern to turn reflection warnings on while working in Clojure.</p>

<p>Project.clj</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="ss">:profiles</span> <span class="p">{</span><span class="ss">:dev</span> <span class="p">{</span><span class="ss">:global-vars</span> <span class="p">{</span><span class="nv">*warn-on-reflection*</span> <span class="nv">true</span> <span class="nv">*assert*</span> <span class="nv">false</span><span class="p">}}}</span>
</span></code></pre></td></tr></table></div></figure>


<h4>Kinesis</h4>

<p>The Eventgateway posts to Kinesis in batch using a <a href="http://docs.oracle.com/javase/7/docs/api/java/util/concurrent/ConcurrentLinkedQueue.html">ConcurrentLinkedQueue</a> and separate producers and consumers. Messages are pushed into a <code>ConcurrentLinkedQueue</code>. We rolled our own Clojure kinesis client using Amazons Java library rather than using <a href="https://github.com/mcohen01/amazonica">Amazonica</a>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="c1">;; Java Amazon libraries used</span>
</span><span class='line'><span class="p">[</span><span class="nv">com.amazonaws/aws-java-sdk</span> <span class="s">&quot;1.9.33&quot;</span>         <span class="ss">:exclusions</span> <span class="p">[</span><span class="nv">joda-time</span><span class="p">]]</span>
</span><span class='line'><span class="p">[</span><span class="nv">com.amazonaws/amazon-kinesis-client</span> <span class="s">&quot;1.1.0&quot;</span> <span class="ss">:exclusions</span> <span class="p">[</span><span class="nv">joda-time</span><span class="p">]]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Amazonica was good to get started quickly in the initial phase but there are a couple of reasons we switched to our own unique snowflake (which still looked a little like Amazonica):</p>

<ul>
<li>Amazonica did not support batch mode for Kinesis. Under initial tests it was impossible to scale this without batch.</li>
<li>Injecting our own telemetry at low levels to learn more about Kinesis running.</li>
<li>Some of its sensible defaults where not so sensible (for example default encoding the data using nippy).</li>
<li>Ultimately most of any Kinesis client/server is configuration and tuning.</li>
<li>Amazonica&rsquo;s source is hard to read with a little too much <code>alter-var-root</code> going on.</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="c1">;;Ugh. Its not just me right?</span>
</span><span class='line'><span class="p">(</span><span class="nf">alter-var-root</span>
</span><span class='line'>  <span class="o">#</span><span class="ss">&#39;amazonica.aws.kinesis/get-shard-iterator</span>
</span><span class='line'>  <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">f</span><span class="p">]</span>
</span><span class='line'>    <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="o">&amp;</span> <span class="nv">args</span><span class="p">]</span>
</span><span class='line'>      <span class="p">(</span><span class="ss">:shard-iterator</span> <span class="p">(</span><span class="nb">apply </span><span class="nv">f</span> <span class="nv">args</span><span class="p">)))))</span>
</span></code></pre></td></tr></table></div></figure>


<h4>Pushing Messages in a Queue</h4>

<p>Very simple, just adding a message to the <code>ConcurrentLinkedQueue</code>. A environment variable allows us to gradually scale up or down the percentage of traffic that is added to the queue.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">require</span> <span class="o">&#39;</span><span class="p">[</span><span class="nv">environ.core</span> <span class="ss">:refer</span> <span class="ss">:all</span><span class="p">])</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">kinesis-message-queue</span> <span class="p">(</span><span class="nf">ConcurrentLinkedQueue.</span><span class="p">))</span>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">hard-limit-queue-size</span> <span class="mi">1000</span><span class="p">)</span>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">queue-size</span> <span class="p">(</span><span class="nf">atom</span> <span class="mi">0</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nb">send </span><span class="p">[</span><span class="nv">message</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="nb">when-let </span><span class="p">[</span><span class="nv">threshold</span> <span class="p">(</span><span class="nf">env</span> <span class="ss">:kinesis-traffic</span><span class="p">)]</span>
</span><span class='line'>    <span class="p">(</span><span class="nb">when </span><span class="p">(</span><span class="nb">&gt; </span><span class="p">(</span><span class="nb">rand-int </span><span class="mi">100</span><span class="p">)</span> <span class="p">(</span><span class="nb">- </span><span class="mi">100</span> <span class="p">(</span><span class="nb">or </span><span class="p">(</span><span class="nf">Integer/valueOf</span> <span class="o">^</span><span class="nv">String</span> <span class="nv">threshold</span><span class="p">)</span> <span class="mi">0</span><span class="p">)))</span>
</span><span class='line'>    <span class="p">(</span><span class="nb">when </span><span class="p">(</span><span class="nb">&lt;= </span><span class="o">@</span><span class="nv">queue-size</span> <span class="nv">hard-limit-queue-size</span><span class="p">)</span>
</span><span class='line'>      <span class="p">(</span><span class="nf">.add</span> <span class="nv">kinesis-message-queue</span> <span class="nv">message</span><span class="p">)</span>
</span><span class='line'>      <span class="p">(</span><span class="nf">swap!</span> <span class="nv">queue-size</span> <span class="nv">inc</span><span class="p">)))))</span>
</span></code></pre></td></tr></table></div></figure>


<h5>Failure</h5>

<p>The queue pusher operates within a wider system and any failures due to Amazon being unreachable should not impede the function of the system. For the client this means:</p>

<ul>
<li>Not exceeding memory limits with a hard queue size (since ConcurrentLinkedQueue is unbound in size).</li>
<li>Backing off workers if the queue is full to prevent cpu throttling.</li>
</ul>


<p>When we cannot send messages to Kinesis we instead log them to disk, and into our normal logging pipeline (usually ending up in HDFS). Hence we coule replay at a later date if required.</p>

<h4>Sending batches to Kinesis</h4>

<p>The workers, operating in separate threads consuming messages from the <code>ConcurrentLinkedQueue</code> collecting them into a batch:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="k">loop </span><span class="p">[</span><span class="nv">batch</span> <span class="p">[]</span>
</span><span class='line'>       <span class="nv">batch-start-time</span> <span class="p">(</span><span class="nf">time/now</span><span class="p">)</span>
</span><span class='line'>       <span class="nv">poll-misses</span> <span class="mi">0</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nf">batch-ready-to-send?</span> <span class="nv">batch</span> <span class="nv">batch-start-time</span><span class="p">)</span>
</span><span class='line'>    <span class="nv">batch</span>
</span><span class='line'>    <span class="p">(</span><span class="nb">if-let </span><span class="p">[</span><span class="nv">event</span> <span class="p">(</span><span class="nf">.poll</span> <span class="nv">kinesis-message-queue</span><span class="p">)]</span>
</span><span class='line'>      <span class="p">(</span><span class="nf">do</span>
</span><span class='line'>        <span class="p">(</span><span class="nf">swap!</span> <span class="nv">queue-size</span> <span class="nv">dec</span><span class="p">)</span>
</span><span class='line'>        <span class="p">(</span><span class="nf">recur</span> <span class="p">(</span><span class="nb">conj </span><span class="nv">batch</span> <span class="nv">event</span><span class="p">)</span> <span class="nv">batch-start-time</span> <span class="mi">0</span><span class="p">))</span>
</span><span class='line'>      <span class="p">(</span><span class="nf">do</span>
</span><span class='line'>        <span class="p">(</span><span class="nf">Thread/sleep</span> <span class="p">(</span><span class="nf">exponential-backoff-sleep</span> <span class="nv">poll-misses</span><span class="p">))</span>
</span><span class='line'>        <span class="p">(</span><span class="nf">recur</span> <span class="nv">batch</span> <span class="nv">batch-start-time</span> <span class="p">(</span><span class="nb">inc </span><span class="nv">poll-misses</span><span class="p">))))))))</span>
</span></code></pre></td></tr></table></div></figure>


<p>When polling from the queue an exponential back-off if no messages are on the queue.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">exponential-backoff-sleep</span>
</span><span class='line'>  <span class="s">&quot;Exponential backoff with jitter and a max &quot;</span>
</span><span class='line'>  <span class="p">[</span><span class="nv">misses</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">max-timeout</span> <span class="mi">1000</span>
</span><span class='line'>        <span class="nv">jitter-order</span> <span class="mi">10</span><span class="p">]</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">Math/min</span>
</span><span class='line'>     <span class="nv">max-timeout</span>
</span><span class='line'>     <span class="p">(</span><span class="nf">Math/round</span> <span class="p">(</span><span class="nb">+ </span><span class="p">(</span><span class="nf">Math/exp</span> <span class="nv">misses</span><span class="p">)</span>
</span><span class='line'>                    <span class="p">(</span><span class="nb">* </span><span class="p">(</span><span class="nf">Math/random</span><span class="p">)</span>
</span><span class='line'>                       <span class="nv">jitter-order</span><span class="p">))))))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Once the batch is ready (in terms of age or size) its sent to Kinesis.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn- </span><span class="nv">send-events</span>
</span><span class='line'>  <span class="s">&quot;Perform putRecords request to send the batch to kinesis</span>
</span><span class='line'><span class="s">   returns a list of events that failed.&quot;</span>
</span><span class='line'>  <span class="p">[</span><span class="o">^</span><span class="nv">AmazonKinesisClient</span> <span class="nv">client</span> <span class="nv">stream-name</span> <span class="nv">events</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">try+</span>
</span><span class='line'>   <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">result</span> <span class="p">(</span><span class="nf">.putRecords</span> <span class="nv">client</span> <span class="p">(</span><span class="nf">events-&gt;put-records-request</span> <span class="nv">events</span> <span class="nv">stream-name</span> <span class="nv">telemetry</span><span class="p">))]</span>
</span><span class='line'>     <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">pos? </span><span class="p">(</span><span class="nf">.getFailedRecordCount</span> <span class="nv">result</span><span class="p">))</span>
</span><span class='line'>       <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">failed-events</span> <span class="p">(</span><span class="nf">failures-&gt;events</span> <span class="nv">result</span> <span class="nv">events</span><span class="p">)]</span>
</span><span class='line'>         <span class="p">(</span><span class="nf">count-failures</span> <span class="nv">telemetry</span> <span class="p">(</span><span class="nf">failures-&gt;error-codes</span> <span class="nv">result</span><span class="p">))</span>
</span><span class='line'>         <span class="nv">failed-events</span><span class="p">)</span>
</span><span class='line'>       <span class="p">[]))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Note this is where we also decided the partition key. In our case its important for the same user to be located on the same partition.
For example when consuming from Kinesis a worker is allocated a partition to work from and would miss events if they where across multiple partitions.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn- </span><span class="nv">events-&gt;put-records-request</span>
</span><span class='line'>  <span class="s">&quot;Take client and a vector of JsonNodes and produce a PutRecord&quot;</span>
</span><span class='line'>  <span class="p">[</span><span class="nv">batch</span> <span class="nv">event-stream</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">batch-list</span>  <span class="p">(</span><span class="nf">java.util.ArrayList.</span><span class="p">)</span>
</span><span class='line'>        <span class="nv">put-request</span> <span class="p">(</span><span class="nf">PutRecordsRequest.</span><span class="p">)]</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">.setStreamName</span> <span class="nv">put-request</span> <span class="nv">event-stream</span><span class="p">)</span>
</span><span class='line'>    <span class="p">(</span><span class="nb">doseq </span><span class="p">[</span><span class="o">^</span><span class="nv">ObjectNode</span> <span class="nv">event</span> <span class="nv">batch</span><span class="p">]</span>
</span><span class='line'>      <span class="p">(</span><span class="nf">.remove</span> <span class="nv">event</span> <span class="o">^</span><span class="nv">String</span> <span class="nv">failure-metadata</span><span class="p">)</span>
</span><span class='line'>      <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">request-entry</span> <span class="p">(</span><span class="nf">PutRecordsRequestEntry.</span><span class="p">)</span>
</span><span class='line'>            <span class="nv">request-data</span>  <span class="p">(</span><span class="nf">.getBytes</span> <span class="p">(</span><span class="nb">str </span><span class="nv">event</span><span class="p">))</span>
</span><span class='line'>            <span class="nv">request-buf</span>   <span class="p">(</span><span class="nf">ByteBuffer/wrap</span> <span class="nv">request-data</span> <span class="mi">0</span> <span class="p">(</span><span class="nb">alength </span><span class="nv">request-data</span><span class="p">))</span>
</span><span class='line'>            <span class="nv">partition-key</span> <span class="p">(</span><span class="ss">:user-id</span> <span class="nv">event</span><span class="p">)]</span>
</span><span class='line'>        <span class="p">(</span><span class="nb">doto </span><span class="nv">request-entry</span>
</span><span class='line'>          <span class="p">(</span><span class="nf">.setData</span>         <span class="nv">request-buf</span><span class="p">)</span>
</span><span class='line'>          <span class="p">(</span><span class="nf">.setPartitionKey</span> <span class="nv">partition-key</span><span class="p">))</span>
</span><span class='line'>        <span class="p">(</span><span class="nf">.add</span> <span class="nv">batch-list</span> <span class="nv">request-entry</span><span class="p">)))</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">.setRecords</span> <span class="nv">put-request</span> <span class="nv">batch-list</span><span class="p">)</span>
</span><span class='line'>    <span class="nv">put-request</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<h5>Failure</h5>

<p>Failure can occur on individual records within a batch or in the batch as a whole.</p>

<h6>Individual failures</h6>

<ol>
<li>These messages are re-added to the queue so we can try again. If the messages fail for some nth time they are considered invalid and rejected from Kinesis and logged as an error.</li>
</ol>


<h6>Batch level</h6>

<ol>
<li><p>Amazon had an Internal Failure. We don&rsquo;t know what went wrong. (We see this regularly in normal function).</p></li>
<li><p>Amazon Kinesis is not resolvable (<code>AmazonClientException/AmazonServiceException</code>).</p></li>
<li><p>Exceeding the read/write limits of Kinesis (<code>ProvisionedThroughputExceededException</code>).</p></li>
</ol>


<p>This is our backpressure signal, in which case at worst we need to log to disk for replay later.</p>

<h2>Consuming Messages from Kinesis</h2>

<p>With the consumption of events we have a different application stream for every worker. All workers have their own streams, and own checkpoints so they operate independently of each other. Some example of the workers we gave running:</p>

<ul>
<li>Logging Events to s3</li>
<li>Calculating listening time</li>
<li>Forwarding certain messages on to various other systems (like RabbitMQ).</li>
</ul>


<p>Launching a worker is pretty simple with the Amazon Java Kinesis library.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="ss">:import</span> <span class="p">[</span><span class="nv">com.amazonaws.services.kinesis.clientlibrary.lib.worker</span> <span class="nv">Worker</span><span class="p">])</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">-main</span> <span class="p">[</span><span class="o">&amp;</span> <span class="nv">args</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">worker-fn</span> <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">events</span><span class="p">]</span> <span class="p">(</span><span class="nb">print </span><span class="nv">events</span><span class="p">))</span>
</span><span class='line'>        <span class="nv">config</span> <span class="p">(</span><span class="nf">KinesisClientLibConfiguration.</span>   <span class="nv">worker-fn</span>  <span class="p">)</span>   <span class="c1">;;I&#39;m airbrushing over the Java classes</span>
</span><span class='line'>        <span class="nv">processor</span> <span class="p">(</span><span class="nf">reify</span> <span class="nv">IRecordProcessorFactory</span> <span class="nv">worker-fn</span><span class="p">)</span>   <span class="c1">;;Ultimately this is a lot of config wrapped in Java fun</span>
</span><span class='line'>        <span class="p">[</span><span class="o">^</span><span class="nv">Worker</span> <span class="nv">worker</span> <span class="nv">uuid</span><span class="p">]</span> <span class="p">(</span><span class="nf">Worker.</span> <span class="nv">processor</span> <span class="nv">config</span><span class="p">)]</span>
</span><span class='line'>          <span class="p">(</span><span class="nf">future</span> <span class="p">(</span><span class="nf">.run</span> <span class="nv">worker</span><span class="p">))))</span>
</span></code></pre></td></tr></table></div></figure>


<p>One of the hardest parts of setting up the a worker is getting the configuration right to ensure that the consumers are getting through the events fast enough. Events are held in Amazon for 24 hours after entry, and hence there is a minimum consumption rate.</p>

<p>Counting events in and events out with <a href="http://prometheus.io/">Prometheus</a> made it easier to get the correct consumption rates.
<img src="/images/kinesis_entry_exit_rates.png" alt="Entry/exit rates"/></p>

<p>Via the Amazon console you also get access to various graphs around read/write rates and limits:</p>

<p><img src="/images/amazon_kinesis_graphs.png"/></p>

<p>Finally you can also look at Amazon&rsquo;s Dynamodb instance for the Kinesis stream providing insight into metrics around leases, how many where revoked, stolen, never finished, etc.</p>

<p>Here is an example of one of our Kinesis workers configuration covered in scribblings of me trying to work out the right settings.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'>  <span class="p">{</span>
</span><span class='line'>   <span class="c1">;;default 1 sec, cannot be lower than 200ms</span>
</span><span class='line'>   <span class="c1">;;If we are not reading fast enough this is a good value to tweak</span>
</span><span class='line'>   <span class="ss">:idle-time-between-reads-in-millis</span> <span class="mi">1800</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">;;Clean up leases for shards that we&#39;ve finished processing (don&#39;t wait</span>
</span><span class='line'>   <span class="c1">;;until they expire)</span>
</span><span class='line'>   <span class="ss">:cleanup-leases-upon-shard-completion</span> <span class="nv">true</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">;;If the heartbeat count does not increase within the configurable timeout period,</span>
</span><span class='line'>   <span class="c1">;;other workers take over processing of that shard.</span>
</span><span class='line'>   <span class="c1">;;*IMPORTANT* If this time is shorter than time for a worker to checkpoint all nodes</span>
</span><span class='line'>   <span class="c1">;;will keep stealing each others leases producing a lot of contention.</span>
</span><span class='line'>   <span class="ss">:failover-time-millis</span> <span class="mi">80000</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">;;Max records in a single returned in a `GetRecords`. Cannot exceed 10,000</span>
</span><span class='line'>   <span class="ss">:max-records</span> <span class="mi">4500</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">;;Process records even if GetRecords returned an empty record list.</span>
</span><span class='line'>   <span class="ss">:call-process-records-even-for-empty-record-list</span> <span class="nv">false</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">;;Sleep for this duration if the parent shards have not completed processing,</span>
</span><span class='line'>   <span class="c1">;;or we encounter an exception.</span>
</span><span class='line'>   <span class="ss">:parent-shard-poll-interval-millis</span> <span class="mi">10000</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">;;By default, the KCL begins withs the most recently added record.</span>
</span><span class='line'>   <span class="c1">;;Instead always reads data from the beginning of the stream.</span>
</span><span class='line'>   <span class="ss">:initial-position-in-stream</span>  <span class="ss">:TRIM_HORIZON</span><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Monitoring</h2>

<p>Prometheus (<a href="http://prometheus.io/">http://prometheus.io/</a>) a monitoring tool built at SoundCloud was <em>core</em> to developing, scaling and monitoring all of this pipeline. Amazon does provide some useful graphs within the AWS console but more detailed feedback was very helpful even if it was removed later.</p>

<h4>Exception Logging pattern</h4>

<p>All Exceptions are counted and sent to log. This was a very useful pattern for driving out errors and spotting leaks in the interactions with Kinesis and consumption:</p>

<p>(Using a Clojure wrapper around Prometheus: <a href="https://github.com/josephwilk/prometheus-clj">https://github.com/josephwilk/prometheus-clj</a>)</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">try+</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">worker-fn</span> <span class="nv">raw-events</span><span class="p">)</span>
</span><span class='line'><span class="p">(</span><span class="nf">catch</span> <span class="nv">Exception</span> <span class="nv">e</span>
</span><span class='line'>  <span class="c1">;;Count based on exception class</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">inc-counter</span> <span class="ss">:failed-batches</span> <span class="p">{</span><span class="ss">:type</span> <span class="nv">worker-type</span> <span class="ss">:error-code</span> <span class="p">(</span><span class="nb">str </span><span class="p">(</span><span class="nf">.getClass</span> <span class="nv">e</span><span class="p">))})</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">log/error</span> <span class="nv">e</span><span class="p">)))]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Note Kinesis regularly spits out &ldquo;<code>InternalFailure</code>&rdquo; Exceptions. Thats all you get&hellip;</p>

<p><img src="/images/kinesis_failures.png" alt="Kinesis Internal failures"/></p>

<h2>A Cloud Pipeline in Pictures</h2>

<p>In my previous post about <a href="http://blog.josephwilk.net/clojure/building-clojure-services-at-scale.html">Building Clojure services at scale</a> I converted the system metrics to sound. This time I covert the metrics across all the machine into vertexes on a mesh using <a href="http://openframeworks.cc">OpenFrameworks</a>. So you start to see a visual representation in 3D of the function of the system.</p>

<p><img src="/images/soundcloud_kinesis.png" alt="" />
<img src="/images/soundcloud_kinesis2.png" alt="" />
<img src="/images/soundcloud_kinesis3.png" alt="" /></p>

<h2>Thanks</h2>

<p>This work constitues a team effort by the Data team at SoundCloud. A lot of advice, collaboration and hard work. Kudos to everyone.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/clojure/overtone-driving-minecraft.html">Clojure and Overtone Driving Minecraft</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-03-01T14:58:12+00:00" pubdate data-updated="true">Mar 1<span>st</span>, 2015</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Using Clojure we create interesting 3D shapes in Minecraft to the beat of music generated from Overtone.</p>

<p>We achieve this by embedding a Clojure REPL inside a Java Minecraft server which loads Overtone and connects to an external Supercollider instance (What Overtone uses for sound).</p>

<h3>Demo</h3>

<iframe src="//player.vimeo.com/video/120907923" width="500" height="375" frameborder="0" webkitallowfullscreen mozallowfullscreen allowfullscreen></iframe>


<p>Demo Source code: <a href="https://github.com/josephwilk/clj-minecraft/blob/master/src/cljminecraft/overtone.clj">https://github.com/josephwilk/clj-minecraft/blob/master/src/cljminecraft/overtone.clj</a></p>

<h4>Tools</h4>

<ul>
<li>Java Minecraft server Craftbukkit/Spigot: <a href="http://www.spigotmc.org/">http://www.spigotmc.org/</a></li>
<li>Minecraft client (requires purchase) <a href="https://minecraft.net">https://minecraft.net</a></li>
<li>clj-minecraft Bukkit plugin: <a href="https://github.com/josephwilk/clj-minecraft">https://github.com/josephwilk/clj-minecraft</a></li>
<li>Overtone (patched): <a href="https://github.com/josephwilk/overtone/tree/minecraft_overtone">https://github.com/josephwilk/overtone/tree/minecraft_overtone</a></li>
<li>MUD (useful helpers for Overtone): <a href="https://github.com/josephwilk/mud">https://github.com/josephwilk/mud</a></li>
<li>Supercollider: <a href="http://supercollider.sourceforge.net">http://supercollider.sourceforge.net</a></li>
</ul>


<p>(Dependent on your IDE of choice)</p>

<ul>
<li>Emacs &ndash; cider: <a href="https://github.com/clojure-emacs/cider">https://github.com/clojure-emacs/cider</a></li>
<li>Vim   &ndash; fireplace: <a href="https://github.com/tpope/vim-fireplace">https://github.com/tpope/vim-fireplace</a></li>
</ul>


<h2>Building the world</h2>

<p>We need to install Spigot which is an optimized version of the Craftbukkit Java Minecraft server and install clj-minecraft project as a plugin. Things are complicated by Bukkit no longer being registered in Maven.</p>

<p>Read through the Makefile install:</p>

<p><a href="https://github.com/josephwilk/clj-minecraft/blob/master/Makefile">https://github.com/josephwilk/clj-minecraft/blob/master/Makefile</a></p>

<p>If your happy clone and run:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>git clone git@github.com:josephwilk/clj-minecraft.git && make install</span></code></pre></td></tr></table></div></figure>


<p>Bukkit + clj-minecraft will be installed for you.</p>

<h2>Running the world</h2>

<p>You will need to edit the <code>minecraft/eula.txt</code> indicating you agree with the license. Then you can run your Minecraft server:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>java -XX:MaxPermSize=1G -jar spigot-1.8.jar</span></code></pre></td></tr></table></div></figure>


<h2>Seeing the world</h2>

<p>Buy and install a Minecraft client: <a href="https://minecraft.net">https://minecraft.net</a></p>

<p>Select >&ldquo;Multiplayer&rdquo; >&ldquo;Direct connect&rdquo; and enter the &ldquo;Server Address&rdquo; as localhost.</p>

<h1>Bring music to the world</h1>

<h3>Install and Boot Supercollider</h3>

<p><a href="http://supercollider.github.io">http://supercollider.github.io</a></p>

<p>Once installed:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#Find the Supercollider binary (scsynth)
</span><span class='line'>$ sudo find /. -name "scsynth"
</span><span class='line'>
</span><span class='line'>/Applications/SuperCollider/SuperCollider.app/Contents/Resources/scsynth
</span><span class='line'>
</span><span class='line'>#Run Supercollider server
</span><span class='line'>/Applications/SuperCollider/SuperCollider.app/Contents/Resources/scsynth -u 57110</span></code></pre></td></tr></table></div></figure>


<h3>Speaking to the Minecraft REPL</h3>

<p>clj-minecraft opens a REPL on localhost port 4005.  Using emacs and <code>cider</code> connect to this REPL instance.</p>

<p>Boot and connect Overtone:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">use</span> <span class="ss">&#39;overtone.core</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">connect-external-server</span><span class="p">)</span>  <span class="o">#</span><span class="nv">=&gt;</span> <span class="ss">:happy-hacking</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Interaction</h3>

<p>Using <code>MUD</code> we have some useful wrappers around Overtone for scheduling functions on beats.</p>

<p>To coordinate graphics and sound we schedule both within a single function.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">require</span> <span class="o">&#39;</span><span class="p">[</span><span class="nv">mud.core</span> <span class="ss">:as</span> <span class="nv">mud</span><span class="p">])</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defonce </span><span class="nv">highhat-sample</span> <span class="p">(</span><span class="nf">freesound</span> <span class="mi">53532</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">ride-trigger</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">mud/on-beat-trigger</span> <span class="mi">8</span>       <span class="c1">;; Every 8th beat</span>
</span><span class='line'>   <span class="p">(</span><span class="k">fn </span><span class="p">[]</span>
</span><span class='line'>     <span class="p">(</span><span class="nf">highhat-sample</span><span class="p">)</span>      <span class="c1">;; Play sample</span>
</span><span class='line'>     <span class="p">(</span><span class="nf">block</span> <span class="mi">2</span> <span class="mi">10</span> <span class="mi">2</span> <span class="ss">:grass</span><span class="p">)</span> <span class="c1">;; Place a block into the Minecraft world</span>
</span><span class='line'><span class="p">)))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Most functions that change the state of the Minecraft world need to be run in the main GUI thread. To achieve this we wrap any state changing function within  <code>ui-sync</code> (<a href="https://github.com/CmdrDats/clj-minecraft/blob/a3331e925b56becf88d9ef96cab225856e2f7ead/src/cljminecraft/bukkit.clj#L39-L42">https://github.com/CmdrDats/clj-minecraft/blob/a3331e925b56becf88d9ef96cab225856e2f7ead/src/cljminecraft/bukkit.clj#L39-L42</a>).</p>

<p>For example a function to place a block into the Minecraft world:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nb">import </span><span class="o">&#39;</span><span class="p">[</span><span class="nv">org.bukkit</span> <span class="nv">Location</span> <span class="nv">Material</span><span class="p">])</span>
</span><span class='line'><span class="p">(</span><span class="nf">require</span> <span class="o">&#39;</span><span class="p">[</span><span class="nv">cljminecraft.bukkit</span> <span class="ss">:as</span> <span class="nv">bk</span><span class="p">])</span>
</span><span class='line'><span class="p">(</span><span class="nf">require</span> <span class="o">&#39;</span><span class="p">[</span><span class="nv">cljminecraft.items</span> <span class="ss">:as</span> <span class="nv">i</span><span class="p">])</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">player</span> <span class="p">(</span><span class="nb">first </span><span class="p">(</span><span class="nf">.getOnlinePlayers</span> <span class="p">(</span><span class="nf">bk/server</span><span class="p">))))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">block</span>
</span><span class='line'>  <span class="s">&quot;place a block relative to current players position</span>
</span><span class='line'><span class="s">  Example:</span>
</span><span class='line'><span class="s">    (block 2 10 2 :grass)</span>
</span><span class='line'><span class="s">  &quot;</span>
</span><span class='line'>  <span class="p">[</span><span class="nv">x</span> <span class="nv">y</span> <span class="nv">z</span> <span class="nv">material</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">l</span> <span class="p">(</span><span class="nf">.getLocation</span> <span class="nv">player</span><span class="p">))</span>
</span><span class='line'>        <span class="nv">m</span> <span class="p">(</span><span class="nf">i/get-material</span> <span class="nv">material</span><span class="p">)]</span>
</span><span class='line'>    <span class="p">(</span><span class="nb">doto </span><span class="nv">l</span>
</span><span class='line'>      <span class="p">(</span><span class="nf">.setX</span> <span class="p">(</span><span class="nb">+ </span><span class="nv">x</span> <span class="p">(</span><span class="nf">.getX</span> <span class="nv">l</span><span class="p">)))</span>
</span><span class='line'>      <span class="p">(</span><span class="nf">.setY</span> <span class="p">(</span><span class="nb">+ </span><span class="nv">y</span> <span class="p">(</span><span class="nf">.getY</span> <span class="nv">l</span><span class="p">)))</span>
</span><span class='line'>      <span class="p">(</span><span class="nf">.setZ</span> <span class="p">(</span><span class="nb">+ </span><span class="nv">z</span> <span class="p">(</span><span class="nf">.getZ</span> <span class="nv">l</span><span class="p">))))</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">bk/ui-sync</span>
</span><span class='line'>     <span class="o">@</span><span class="nv">cljminecraft.core/clj-plugin</span>
</span><span class='line'>     <span class="p">(</span><span class="k">fn </span><span class="p">[]</span>
</span><span class='line'>       <span class="p">(</span><span class="nb">doto </span><span class="p">(</span><span class="nf">.getBlock</span> <span class="nv">l</span><span class="p">)</span>
</span><span class='line'>         <span class="p">(</span><span class="nf">.setData</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>         <span class="p">(</span><span class="nf">.setType</span> <span class="p">(</span><span class="nf">.getItemType</span> <span class="nv">m</span><span class="p">))</span>
</span><span class='line'>         <span class="p">(</span><span class="nf">.setData</span> <span class="p">(</span><span class="nf">.getData</span> <span class="nv">m</span><span class="p">)))))))</span>
</span></code></pre></td></tr></table></div></figure>


<p>For further documentation of whats possible, the Bukkit Java docs:
<a href="https://hub.spigotmc.org/javadocs/bukkit/">https://hub.spigotmc.org/javadocs/bukkit/</a></p>

<p>clj-minecaft has lots of helpers + examples: <a href="https://github.com/CmdrDats/clj-minecraft/tree/master/src/cljminecraft">https://github.com/CmdrDats/clj-minecraft/tree/master/src/cljminecraft</a></p>

<h2>Fun</h2>

<p>Create, play and share all the crazy things you can come up with using Clojure and Minecraft.</p>

<p><img src="/images/pig_algo_rave.png" width="450" alt="The Pig Algo Rave"/></p>

<p>For more live programming music and sound checkout my performances as Repl Electric: <a href="http://www.repl-electric.com">http://www.repl-electric.com</a></p>

<h2>Credits</h2>

<p>Built on the back of lots of great open source projects.
Thanks to the Craftbukkit/Spigot contributors, <a href="https://twitter.com/cmdrdats">@CmdrDats</a> for clj-minecraft and <a href="https://twitter.com/samaaron">@samaaron</a> for Overtone and inspiring this crazy journey with the musical <a href="http://sonic-pi.net/">Sonic Pi</a> (which supports combining music and Minecraft on the RaspberryPi).</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/art/live-coding-repl-electric.html">Live Coding - Repl Electric</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-06-13T15:58:12+01:00" pubdate data-updated="true">Jun 13<span>th</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Live coding is the act of turning a programming session into a performance. This can constitute improvisation, music, visuals, poetry, hardware, robots, dance, textiles and people. Pretty much anything with an input and output can be controlled live by programming.</p>

<p>This is not just a performance by programmers for programmers. While this is often where it starts as a live coder, the type of audience and the accessibility of the performance lies in the performers imagination. Abstraction can get us pretty much anywhere.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">the-stars</span> <span class="p">(</span><span class="nf">dark-matter</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Repl Electric</h2>

<p><img src="https://camo.githubusercontent.com/d1711cc92a1b79af187344f461be35e2ced44e3f/687474703a2f2f7333302e706f7374696d672e6f72672f7633336377783668642f53637265656e5f53686f745f323031345f30345f32385f61745f32305f31345f33352e706e67"/></p>

<p><a href="http://www.repl-electric.com">Repl Electric</a> is a project I started in order to discover more about music composition and Artificial intelligent based aids to creativity. Which in turn through the inspiration of people like <a href="http://meta-ex.com/">Meta-ex</a> lead me to live programming music.</p>

<p>Here is a performance live coding music and graphics, inspired by a performance in London:</p>

<h3>The Stars</h3>

<iframe src="//player.vimeo.com/video/95988263" width="500" height="313" frameborder="0" webkitallowfullscreen mozallowfullscreen allowfullscreen></iframe>


<h3>Open Live Coding</h3>

<p>All the tools and code used to create this performance are open for all to see on Github: <a href="https://github.com/repl-electric">https://github.com/repl-electric</a></p>

<p>Three programming languages were used to create this piece:</p>

<ul>
<li>Clojure (Sound)</li>
<li>GLSL (Visuals)</li>
<li>Emacs Lisp (Animations &amp; Navigation)</li>
</ul>


<h3>Tools</h3>

<p>Here are the tools used and a little detail around how they where used in performing &ldquo;The Stars&rdquo;:</p>

<h4>Clojure: <a href="http://clojure.org">http://clojure.org</a></h4>

<p>Clojure is a LISP language based on the JVM.</p>

<p>Clojure focuses on interactive REPL (Read, Evaluate, Print &amp; Loop) driven development. Which makes it a good choice for interactively coding music. It also turns out functional programming is a good fit for operating over music as data.</p>

<h4>Emacs Live: <a href="https://github.com/overtone/emacs-live">https://github.com/overtone/emacs-live</a></h4>

<p>Emacs live is a Emacs release with packages and defaults that are Live Coding centric. Something I use for both for my work and for my live coding.</p>

<p>To execute our code, we launch a repl instance in our project (NEVER launch inside emacs, since then if emacs crashes the repl and music dies) and connect to it from emacs using <code>cider</code> <a href="https://github.com/clojure-emacs/cider.">https://github.com/clojure-emacs/cider.</a></p>

<p>A simple trick to combine Emacs code and visualizations is to launch an OpenGL window in full screen (see Shadertone) and then put a full screen transparent terminal window running emacs over it.</p>

<p><img src="/images/terminal.png" alt="" /></p>

<p>The tumbling text effect seen at the end of the performance is an emacs animation using <code>Zone Mode</code> which supports writing your own text destructors: <a href="http://www.emacswiki.org/emacs/ZoneMode">http://www.emacswiki.org/emacs/ZoneMode</a></p>

<h4>Overtone: <a href="https://github.com/overtone/overtone">https://github.com/overtone/overtone</a></h4>

<p>Overtone is a Clojure based client to <a href="http://supercollider.sourceforge.net">SuperCollider</a>. Supercollider is an environment for real time audio synthesis and algorithmic composition.</p>

<p>Overtone provides us with:</p>

<ul>
<li>Timing (beat generation &ndash; <a href="https://github.com/repl-electric/cassiopeia/blob/master/src/cassiopeia/engine/timing.clj">example timing code</a>).</li>
<li>Building Synths (engineer sound).</li>
<li>Running samples (both your own and from <a href="https://www.freesound.org/">Freesound</a>).</li>
<li>Live Synth control (changing notes, durations, reverb, etc).</li>
<li>Hardware interaction (through midi or OSC).</li>
</ul>


<p>An example of a synth used in The Stars:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">use</span> <span class="ss">&#39;overtone.live</span><span class="p">)</span>
</span><span class='line'><span class="p">(</span><span class="nf">defsynth</span> <span class="nv">dark-ambience</span> <span class="p">[</span><span class="nv">out-bus</span> <span class="mi">0</span> <span class="nv">amp</span> <span class="mi">1</span> <span class="nv">mul</span> <span class="mf">0.2</span> <span class="nv">room-size</span> <span class="mi">70</span> <span class="nv">rev-time</span> <span class="mi">99</span> <span class="nv">freq</span> <span class="mi">60</span> <span class="nv">ring-mul</span> <span class="mi">55</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">pink</span> <span class="p">(</span><span class="nf">hpf</span><span class="ss">:ar</span> <span class="p">(</span><span class="nb">* </span><span class="p">(</span><span class="nb">* </span><span class="mf">0.005</span> <span class="p">(</span><span class="nf">pink-noise</span><span class="p">))</span> <span class="p">(</span><span class="nf">line</span><span class="ss">:kr</span> <span class="mi">0</span> <span class="mi">1</span> <span class="mi">9</span><span class="p">))</span> <span class="mi">5</span><span class="p">)</span>
</span><span class='line'>        <span class="nv">src1</span> <span class="p">(</span><span class="nf">ringz</span> <span class="p">(</span><span class="nb">* </span><span class="nv">pink</span> <span class="p">(</span><span class="nf">lf-noise1</span><span class="ss">:kr</span> <span class="mf">0.15</span><span class="p">))</span> <span class="p">(</span><span class="nb">+ </span><span class="nv">freq</span> <span class="p">(</span><span class="nb">* </span><span class="nv">ring-mul</span> <span class="mi">0</span><span class="p">))</span> <span class="nv">mul</span><span class="p">)</span>
</span><span class='line'>        <span class="nv">src2</span> <span class="p">(</span><span class="nf">ringz</span> <span class="p">(</span><span class="nb">* </span><span class="nv">pink</span> <span class="p">(</span><span class="nf">lf-noise1</span><span class="ss">:kr</span> <span class="mf">0.15</span><span class="p">))</span> <span class="p">(</span><span class="nb">+ </span><span class="nv">freq</span> <span class="p">(</span><span class="nb">* </span><span class="nv">ring-mul</span> <span class="mi">1</span><span class="p">))</span> <span class="nv">mul</span><span class="p">)</span>
</span><span class='line'>        <span class="nv">src3</span> <span class="p">(</span><span class="nf">ringz</span> <span class="p">(</span><span class="nb">* </span><span class="nv">pink</span> <span class="p">(</span><span class="nf">lf-noise1</span><span class="ss">:kr</span> <span class="mf">0.15</span><span class="p">))</span> <span class="p">(</span><span class="nb">+ </span><span class="nv">freq</span> <span class="p">(</span><span class="nb">* </span><span class="nv">ring-mul</span> <span class="mi">2</span><span class="p">))</span> <span class="nv">mul</span><span class="p">)</span>
</span><span class='line'>        <span class="nv">src</span> <span class="p">(</span><span class="nf">tanh</span> <span class="p">(</span><span class="nf">g-verb</span> <span class="p">(</span><span class="nf">sum</span> <span class="p">[</span><span class="nv">src1</span> <span class="nv">src2</span> <span class="nv">src3</span><span class="p">])</span> <span class="nv">room-size</span> <span class="nv">rev-time</span><span class="p">))]</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">out</span> <span class="nv">out-bus</span> <span class="p">(</span><span class="nb">* </span><span class="nv">amp</span> <span class="nv">src</span><span class="p">))))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">the-stars</span> <span class="p">(</span><span class="nf">dark-ambience</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<h6>Timing</h6>

<p>Timing is a complicated issue but so important its worth touching on. You have a choice with Overtone to use Java for timing or Supercollider. I use Supercollider since I have found it to be much more reliable.
Everything you need is here (<a href="https://github.com/repl-electric/cassiopeia/blob/master/src/cassiopeia/engine/timing.clj">copy and paste</a>), thanks to the hard work of <a href="https://github.com/samaaron">Sam Aaron</a>.</p>

<p>The key concept to take away is there are two types of timing, a beat counter which is forever incrementing and a beat trigger which flips back and forth between 1/0.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">require</span> <span class="o">&#39;</span><span class="p">[</span><span class="nv">cassiopeia.engine.timing</span> <span class="ss">:as</span> <span class="nv">time</span><span class="p">])</span>
</span><span class='line'>
</span><span class='line'><span class="c1">;;The beat trigger</span>
</span><span class='line'><span class="p">(</span><span class="ss">:beat</span> <span class="nv">time/main-beat</span><span class="p">)</span> <span class="c1">;=&gt; 0,1,0,1,0,1,0</span>
</span><span class='line'>
</span><span class='line'><span class="c1">;;The beat counter</span>
</span><span class='line'><span class="p">(</span><span class="ss">:count</span> <span class="nv">time/main-beat</span><span class="p">)</span> <span class="c1">;=&gt; 0,1,2,3,4,5,6,7,8,9</span>
</span></code></pre></td></tr></table></div></figure>


<p>The counter is useful for indexing buffers, the trigger is useful in controlling the gate of an envelope (which turns a sound on or off).</p>

<p>In Clojure we can still get access to the beat, in our timing code we send a message using <code>send-trig</code> on every beat. We can hook a Clojure function to callback on this beat:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">on-trigger</span> <span class="p">(</span><span class="ss">:trig-id</span> <span class="nv">time/main-beat</span><span class="p">)</span>
</span><span class='line'>  <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">beat-no</span><span class="p">]</span>
</span><span class='line'>    <span class="p">(</span><span class="nb">when </span><span class="p">(</span><span class="nb">= </span><span class="mf">0.0</span> <span class="p">(</span><span class="nf">mod</span> <span class="nv">beat-no</span> <span class="mi">32</span><span class="p">))</span>
</span><span class='line'>      <span class="c1">;;play a sample</span>
</span><span class='line'>      <span class="p">(</span><span class="nf">boom-s</span><span class="p">)))</span>
</span><span class='line'>  <span class="ss">::on-beat-trigger</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>I use this extensively to time graphic transitions with the music.</p>

<h6>Buffers</h6>

<p>Most of my live coding performance was writing to buffers which are hooked into synths. Buffers are just fixed size arrays but they are stored in Supercollider rather than in Clojure. Here is an example from The Stars where the midi notes are read from a buffer at a rate based on my beat timing signal (a 16th of the main beat here).</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">use</span> <span class="ss">&#39;overtone.live</span><span class="p">)</span>
</span><span class='line'><span class="p">(</span><span class="nf">use</span> <span class="ss">&#39;cassiopeia.engine.core</span><span class="p">)</span>
</span><span class='line'><span class="p">(</span><span class="nf">require</span> <span class="o">&#39;</span><span class="p">[</span><span class="nv">cassiopeia.engine.timing</span> <span class="ss">:as</span> <span class="nv">time</span><span class="p">])</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">defsynth</span> <span class="nv">growl</span> <span class="p">[</span><span class="nv">out-bus</span> <span class="mi">0</span> <span class="nv">note-buf</span> <span class="mi">0</span> <span class="nv">beat-bus</span> <span class="mi">0</span> <span class="nv">beat-trg-bus</span> <span class="mi">0</span> <span class="nv">amp</span> <span class="mi">1</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">cnt</span> <span class="p">(</span><span class="nf">in</span><span class="ss">:kr</span> <span class="nv">beat-bus</span><span class="p">)</span>
</span><span class='line'>        <span class="nv">trg</span> <span class="p">(</span><span class="nf">in</span><span class="ss">:kr</span> <span class="nv">beat-trg-bus</span><span class="p">)</span>
</span><span class='line'>        <span class="nv">note</span> <span class="p">(</span><span class="nf">buf-rd</span><span class="ss">:kr</span> <span class="mi">1</span> <span class="nv">note-buf</span> <span class="nv">cnt</span><span class="p">)</span>
</span><span class='line'>        <span class="nv">freq</span> <span class="p">(</span><span class="nf">midicps</span> <span class="nv">note</span><span class="p">)</span>
</span><span class='line'>        <span class="nv">vol</span> <span class="p">(</span><span class="nb">&gt; </span><span class="nv">note</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="nv">e</span> <span class="p">(</span><span class="nf">env-gen</span> <span class="p">(</span><span class="nf">perc</span> <span class="ss">:attack</span> <span class="mi">10</span> <span class="ss">:sustain</span> <span class="mi">1</span> <span class="ss">:release</span> <span class="mi">1</span><span class="p">)</span> <span class="ss">:gate</span> <span class="nv">trg</span><span class="p">)</span>
</span><span class='line'>        <span class="nv">src</span> <span class="p">(</span><span class="nf">lpf</span> <span class="p">(</span><span class="nf">mix</span> <span class="p">[(</span><span class="nf">saw</span> <span class="p">(</span><span class="nb">* </span><span class="mf">0.25</span> <span class="nv">freq</span><span class="p">))</span>
</span><span class='line'>                       <span class="p">(</span><span class="nf">sin-osc</span> <span class="p">(</span><span class="nb">* </span><span class="mf">1.01</span> <span class="nv">freq</span><span class="p">))]))</span>
</span><span class='line'>        <span class="nv">src</span> <span class="p">(</span><span class="nf">pitch-shift</span> <span class="nv">src</span> <span class="mf">0.4</span> <span class="mi">1</span> <span class="mi">0</span> <span class="mf">0.01</span><span class="p">)</span>
</span><span class='line'>        <span class="nv">src</span> <span class="p">(</span><span class="nf">pan2</span><span class="ss">:ar</span> <span class="p">(</span><span class="nb">* </span><span class="nv">vol</span> <span class="nv">amp</span> <span class="nv">e</span> <span class="nv">src</span><span class="p">))]</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">out</span> <span class="nv">out-bus</span> <span class="nv">src</span><span class="p">)))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defonce </span><span class="nv">nebular</span> <span class="p">(</span><span class="nf">buffer</span> <span class="mi">96</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">nebula</span> <span class="p">(</span><span class="nf">growl</span> <span class="ss">:note-buf</span> <span class="nv">nebula-note-buf</span> <span class="ss">:beat-trg-bus</span> <span class="p">(</span><span class="ss">:beat</span> <span class="nv">time/beat-16th</span><span class="p">)</span> <span class="ss">:beat-bus</span> <span class="p">(</span><span class="ss">:count</span> <span class="nv">time/beat-16th</span><span class="p">)))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">pattern!</span> <span class="nv">nebula-note-buf</span> <span class="p">(</span><span class="nf">degrees</span> <span class="p">[</span><span class="mi">1</span> <span class="mi">3</span> <span class="mi">7</span><span class="p">]</span> <span class="ss">:major</span> <span class="ss">:A2</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<h4>GLSL + Shadertone:  <a href="https://github.com/overtone/shadertone">https://github.com/overtone/shadertone</a></h4>

<p>Shaders generate imagery directly on your Graphics Processing Unit rather than going through your CPU. Through a language called GLSL (which is C like) we can express very simple functions which get called on every single pixel generating complex visuals. Here is a simple extract from The Stars that generates all the background small dots:</p>

<p><img src="/images/glsl-dots.png" alt="" /></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='glsl'><span class='line'><span class="k">void</span> <span class="n">main</span><span class="p">(</span><span class="k">void</span><span class="p">){</span>
</span><span class='line'>  <span class="k">vec2</span> <span class="n">current_pixel_position</span> <span class="o">=</span> <span class="n">mod</span><span class="p">(</span><span class="n">gl_FragCoord</span><span class="p">.</span><span class="n">xy</span><span class="p">,</span> <span class="k">vec2</span><span class="p">(</span><span class="mf">5.0</span><span class="p">))</span> <span class="o">-</span> <span class="k">vec2</span><span class="p">(</span><span class="mf">0.0</span><span class="p">);</span>
</span><span class='line'>  <span class="k">float</span> <span class="n">distance_squared</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">current_pixel_position</span><span class="p">,</span> <span class="n">current_pixel_position</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">vec4</span> <span class="n">black</span> <span class="o">=</span> <span class="k">vec4</span><span class="p">(</span><span class="mf">.0</span><span class="p">,</span> <span class="mf">.0</span><span class="p">,</span> <span class="mf">.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">);</span>
</span><span class='line'>  <span class="k">vec4</span> <span class="n">white</span> <span class="o">=</span> <span class="k">vec4</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">//Test the current pixel position and if it should be a circle shade it.</span>
</span><span class='line'>  <span class="k">vec4</span> <span class="n">circles</span> <span class="o">=</span> <span class="p">(</span><span class="n">distance_squared</span> <span class="o">&lt;</span> <span class="mf">0.6</span><span class="p">)</span> <span class="o">?</span> <span class="n">white</span> <span class="o">:</span> <span class="n">black</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">gl_FragColor</span> <span class="o">=</span> <span class="n">circles</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>For more examples of whats possible with Shaders checkout <a href="https://www.shadertoy.com">Shader Toy</a></p>

<p>Shadertone is the Clojure library that provides a convenient way of running shaders from Clojure and for feeding in data about our synths. It provides access in your Shader to:</p>

<ul>
<li>Overtone&rsquo;s Volume (<code>iOvertoneVolume</code>)</li>
<li>The frequency spectrum &amp; audio waveform data (Passed as a 2D texture <code>:textures [:overtone-audio]</code>)</li>
</ul>


<p>To synchronize the graphics with the music I created a special Overtone synth which does not generate any sound, it instead feeds information in realtime to my shader.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">use</span> <span class="ss">&#39;overtone.live</span><span class="p">)</span>
</span><span class='line'><span class="p">(</span><span class="nf">require</span> <span class="o">&#39;</span><span class="p">[</span><span class="nv">shadertone.core</span> <span class="ss">:as</span> <span class="nv">t</span><span class="p">])</span>
</span><span class='line'>
</span><span class='line'><span class="c1">;;A synth that exposes through taps all the lovely timing information.</span>
</span><span class='line'><span class="p">(</span><span class="nf">defsynth</span> <span class="nv">buffer-&gt;tap</span> <span class="p">[</span><span class="nv">beat-buf</span> <span class="mi">0</span> <span class="nv">beat-bus</span> <span class="mi">0</span> <span class="nv">beat-size</span> <span class="mi">16</span> <span class="nv">measure</span> <span class="mi">6</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">cnt</span> <span class="p">(</span><span class="nf">in</span><span class="ss">:kr</span> <span class="nv">beat-bus</span><span class="p">)</span>
</span><span class='line'>        <span class="nv">beat</span> <span class="p">(</span><span class="nf">buf-rd</span><span class="ss">:kr</span> <span class="mi">1</span> <span class="nv">beat-buf</span> <span class="nv">cnt</span><span class="p">)</span>
</span><span class='line'>        <span class="nv">_</span>  <span class="p">(</span><span class="nf">tap</span> <span class="s">&quot;beat&quot;</span>          <span class="mi">60</span> <span class="p">(</span><span class="nf">a2k</span> <span class="nv">beat</span><span class="p">))</span>
</span><span class='line'>        <span class="nv">_</span>  <span class="p">(</span><span class="nf">tap</span> <span class="s">&quot;beat-count&quot;</span>    <span class="mi">60</span> <span class="p">(</span><span class="nf">a2k</span> <span class="p">(</span><span class="nf">mod</span> <span class="nv">cnt</span> <span class="nv">beat-size</span><span class="p">)))</span>
</span><span class='line'>        <span class="nv">_</span>  <span class="p">(</span><span class="nf">tap</span> <span class="s">&quot;measure-count&quot;</span> <span class="mi">60</span> <span class="p">(</span><span class="nf">a2k</span> <span class="p">(</span><span class="nb">/ </span><span class="p">(</span><span class="nf">mod</span> <span class="nv">cnt</span> <span class="p">(</span><span class="nb">* </span><span class="nv">measure</span> <span class="nv">beat-size</span><span class="p">))</span> <span class="nv">measure</span><span class="p">)))])</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">out</span> <span class="mi">0</span> <span class="mi">0</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="c1">;;; Used to store our drum beat, 1 for a hit 0 and for a miss</span>
</span><span class='line'><span class="p">(</span><span class="kd">defonce </span><span class="nv">drum-sequence-buffer</span> <span class="p">(</span><span class="nf">buffer</span> <span class="mi">256</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">beats</span> <span class="p">(</span><span class="nf">buffer-&gt;tap</span> <span class="nv">drum-sequence-buffer</span> <span class="p">(</span><span class="ss">:count</span> <span class="nv">timing/main-beat</span><span class="p">)))</span>
</span><span class='line'>
</span><span class='line'><span class="c1">;;Open a OpenGL window running our shader</span>
</span><span class='line'><span class="p">(</span><span class="nf">t/start-fullscreen</span> <span class="s">&quot;resources/shaders/electric.glsl&quot;</span>
</span><span class='line'>                    <span class="ss">:user-data</span> <span class="p">{</span>
</span><span class='line'>                    <span class="s">&quot;iBeat&quot;</span>         <span class="p">(</span><span class="nf">atom</span> <span class="p">{</span><span class="ss">:synth</span> <span class="nv">beats</span> <span class="ss">:tap</span> <span class="s">&quot;beat&quot;</span><span class="p">})</span>
</span><span class='line'>                    <span class="s">&quot;iBeatCount&quot;</span>    <span class="p">(</span><span class="nf">atom</span> <span class="p">{</span><span class="ss">:synth</span> <span class="nv">beats</span> <span class="ss">:tap</span> <span class="s">&quot;beat-count&quot;</span><span class="p">})</span>
</span><span class='line'>                    <span class="s">&quot;iMeasureCount&quot;</span> <span class="p">(</span><span class="nf">atom</span> <span class="p">{</span><span class="ss">:synth</span> <span class="nv">beats</span> <span class="ss">:tap</span> <span class="s">&quot;measure-count&quot;</span><span class="p">})})</span>
</span></code></pre></td></tr></table></div></figure>


<p>Inside our shader code:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='glsl'><span class='line'><span class="k">uniform</span> <span class="k">float</span> <span class="n">iBeat</span><span class="p">;</span>
</span><span class='line'><span class="k">uniform</span> <span class="k">float</span> <span class="n">iBeatCount</span><span class="p">;</span>
</span><span class='line'><span class="k">uniform</span> <span class="k">float</span> <span class="n">iMeasureCount</span><span class="p">;</span>
</span><span class='line'><span class="p">...</span>
</span></code></pre></td></tr></table></div></figure>


<p>The other main way of controlling a shader from Clojure is using <code>atoms</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">require</span> <span class="o">&#39;</span><span class="p">[</span><span class="nv">shadertone.core</span> <span class="ss">:as</span> <span class="nv">t</span><span class="p">])</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defonce </span><span class="nv">cellular-growth</span> <span class="p">(</span><span class="nf">atom</span> <span class="mf">0.0</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">t/start-fullscreen</span> <span class="s">&quot;resources/shaders/electric.glsl&quot;</span> <span class="ss">:user-data</span> <span class="p">{</span><span class="s">&quot;iCellularGrowth&quot;</span> <span class="nv">cellular-growth</span><span class="p">})</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">swap!</span> <span class="nv">cellular-growth</span> <span class="nb">+ </span><span class="mf">0.01</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<h4>Hardware: Monome: <a href="http://monome.org">http://monome.org</a></h4>

<p>Something you don&rsquo;t see in the video is that I&rsquo;m using a 8x16 <a href="http://monome.org">Monome</a>. For this performance its primary function was a visual aid to show the beat/measure information.</p>

<p><img src="/images/monome.jpg" alt="Monome" /></p>

<p>The hardware is driven by Clojure communicating with the Monome through a serial port: <a href="https://github.com/josephwilk/monome-serial/tree/protocols">https://github.com/josephwilk/monome-serial/tree/protocols</a></p>

<h1>Live Coding</h1>

<p>Live coding music and graphics combines skills in sound engineering, 3d graphics, geometry, physics, musical theory, composition, improvisation &amp; hardware to name a few.</p>

<p>It is difficult, and requires a lot of work and practice.</p>

<p>But of all the code I&rsquo;ve written over the years this is one of the things I&rsquo;m most proud of. And i&rsquo;m only at the beginning of discovering what&rsquo;s possible.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/clojure/creative_machines.html">Creative Machines</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-02-23T13:23:00+00:00" pubdate data-updated="true">Feb 23<span>rd</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>When Alan Turing asked if a machine can be intelligent one aspect of this question focused on &ldquo;could machines be creative&rdquo;?</p>

<p>Ada Lovelace seemed convinced that originality was not a feat a computer was capable of:</p>

<blockquote><p>it can do whatever we know how to order it to perform,
it has no pretensions whatever to originate anything</p></blockquote>

<p>Before we outrightly dismiss the idea of creative machines do we even understand what creativity is?</p>

<p>Join me on a journey examining these questions while also meeting a new generation of artists born through code. Looking into their hearts and brains examining different algorithms/techniques and there effectiveness at exhibiting creativity.</p>

<p><strong>Decide for yourself, can machines be creative?</strong></p>

<p>My Strangeloop talk: Creative Machines &ndash; <a href="http://www.infoq.com/presentations/ai-machine-creativity">http://www.infoq.com/presentations/ai-machine-creativity</a></p>

<p>Slides: <script async class="speakerdeck-embed" data-id="9b2acfa020760131db422ebaf23009b5" data-ratio="1.33333333333333" src="//speakerdeck.com/assets/embed.js"></script></p>

<p>Full source code: <a href="https://github.com/josephwilk/musical-creativity">https://github.com/josephwilk/musical-creativity</a></p>

<h3>Continuing the Journey</h3>

<p>In order to continue my research into creativity and music I&rsquo;ve started the project <a href="http://www.repl-electric.com">Repl Electric</a>.
A space for humans and machines to learn and create music together.</p>

<h2>Further Reading</h2>

<ul>
<li>The Creative Mind: Myths and Mechanisms <br/> <a href="http://www.amazon.com/The-Creative-Mind-Myths-Mechanisms/dp/0415314534">http://www.amazon.com/The-Creative-Mind-Myths-Mechanisms/dp/0415314534</a></li>
<li>Explaining Creativity: The Science of Human Innovation <br/> <a href="http://www.amazon.com/gp/product/0199737576">http://www.amazon.com/gp/product/0199737576</a></li>
<li>Artificial Intelligence and Literary Creativity: Inside the Mind of Brutus, A Storytelling Machine <br/> <a href="http://www.amazon.com/Artificial-Intelligence-Literary-Creativity-Storytelling/dp/0805819878">http://www.amazon.com/Artificial-Intelligence-Literary-Creativity-Storytelling/dp/0805819878</a>)</li>
<li>Computer Models of Musical Creativity <br/> <a href="http://www.amazon.com/Computer-Models-Musical-Creativity-David/dp/0262033380">http://www.amazon.com/Computer-Models-Musical-Creativity-David/dp/0262033380</a></li>
<li>Virtual Music: Computer Synthesis of Musical Style <br/> <a href="http://www.amazon.com/Virtual-Music-Computer-Synthesis-Musical/dp/0262532611/">http://www.amazon.com/Virtual-Music-Computer-Synthesis-Musical/dp/0262532611/</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/clojure/sounds-of-the-human-brain.html">Sounds of the Human Brain</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-12-02T13:23:00+00:00" pubdate data-updated="true">Dec 2<span>nd</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>What does your brain sound like? Does it sound like &ldquo;Rise of the Valkyrie&rdquo; or more like &ldquo;Hit me baby one more time&rdquo;?</p>

<h2>Step 1: Acquire a human brain (alive)</h2>

<p><img src="/images/brain.png" width="200px"></p>

<p>We are interested in capturing the brain waves. Specifically the:</p>

<ul>
<li>Delta waves: Deepest stages of sleep.</li>
<li>Beta waves:  Normal waking consciousness.</li>
<li>Alpha waves: Relaxation and meditation (creativity).</li>
<li>Theta waves: REM sleep (dreams).</li>
<li>Gamma waves: Hyper-alertness, perception, and integration of sensory input.</li>
</ul>


<h2>Step 2: EEG machine</h2>

<p>I am using a EEG machine brought from <a href="http://www.neurosky.com">Neurosky</a> which is rated as Research grade (whatever that means).
This measures voltage fluctuations resulting from ionic current flows within the neurons of the brain. While EEG machines are not the most accurate they are now reasonably cheap.</p>

<h2>Step 3: EEG &ndash;> Overtone</h2>

<p>In order to generate music I want to import the EEG brainwave data into <a href="http://overtone.github.io">Overtone</a>.</p>

<p>We interact with the EEG machine over a serial port. The most mature library for this interface is in Python so there is a little jiggery pokery to get the data into Overtone.</p>

<p><img src="/images/brain-diagram.png"></p>

<h4>The Brainwave Poller</h4>

<p>We use <a href="https://github.com/akloster/python-mindwave">https://github.com/akloster/python-mindwave</a> to interface with the EEG machines data.</p>

<p>Writing all the data out to a <a href="http://www.gnu.org/software/libc/manual/html_node/FIFO-Special-Files.html">FIFO file</a> file as json.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">re</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">time</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">json</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">unicodedata</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="nn">gevent</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">gevent</span> <span class="kn">import</span> <span class="n">monkey</span>
</span><span class='line'>
</span><span class='line'><span class="kn">from</span> <span class="nn">pymindwave</span> <span class="kn">import</span> <span class="n">headset</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">pymindwave.pyeeg</span> <span class="kn">import</span> <span class="n">bin_power</span>
</span><span class='line'>
</span><span class='line'><span class="n">monkey</span><span class="o">.</span><span class="n">patch_all</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'><span class="c"># connect to the headset</span>
</span><span class='line'><span class="n">hs</span> <span class="o">=</span> <span class="bp">None</span>
</span><span class='line'><span class="n">hs</span> <span class="o">=</span> <span class="n">headset</span><span class="o">.</span><span class="n">Headset</span><span class="p">(</span><span class="s">&#39;/dev/tty.MindWave&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">hs</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span>
</span><span class='line'><span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'><span class="k">print</span> <span class="s">&#39;connecting to headset...&#39;</span>
</span><span class='line'><span class="n">hs</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
</span><span class='line'><span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'><span class="k">while</span> <span class="n">hs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;state&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="s">&#39;connected&#39;</span><span class="p">:</span>
</span><span class='line'>    <span class="k">print</span> <span class="n">hs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;state&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">hs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;state&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;standby&#39;</span><span class="p">:</span>
</span><span class='line'>        <span class="n">hs</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
</span><span class='line'>        <span class="k">print</span> <span class="s">&#39;retrying connecting to headset&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">raw_to_spectrum</span><span class="p">(</span><span class="n">rawdata</span><span class="p">):</span>
</span><span class='line'>    <span class="n">flen</span> <span class="o">=</span> <span class="mi">50</span>
</span><span class='line'>    <span class="n">spectrum</span><span class="p">,</span> <span class="n">relative_spectrum</span> <span class="o">=</span> <span class="n">bin_power</span><span class="p">(</span><span class="n">rawdata</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="n">flen</span><span class="p">),</span> <span class="mi">512</span><span class="p">)</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">spectrum</span>
</span><span class='line'>
</span><span class='line'><span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
</span><span class='line'>    <span class="n">t</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span class='line'>    <span class="n">waves_vector</span> <span class="o">=</span> <span class="n">hs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;waves_vector&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">meditation</span> <span class="o">=</span> <span class="n">hs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;meditation&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">attention</span> <span class="o">=</span> <span class="n">hs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;attention&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">spectrum</span> <span class="o">=</span> <span class="n">raw_to_spectrum</span><span class="p">(</span><span class="n">hs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;rawdata&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">&quot;/tmp/brain-data&quot;</span><span class="p">,</span><span class="s">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
</span><span class='line'>        <span class="n">s</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">t</span><span class="p">,</span>
</span><span class='line'>             <span class="s">&#39;meditation&#39;</span><span class="p">:</span> <span class="n">meditation</span><span class="p">,</span>
</span><span class='line'>             <span class="s">&#39;attention&#39;</span><span class="p">:</span> <span class="n">attention</span><span class="p">,</span>
</span><span class='line'>             <span class="s">&#39;raw_spectrum&#39;</span><span class="p">:</span> <span class="n">spectrum</span><span class="p">,</span>
</span><span class='line'>             <span class="s">&#39;delta_waves&#39;</span><span class="p">:</span> <span class="n">waves_vector</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
</span><span class='line'>             <span class="s">&#39;theta_waves&#39;</span><span class="p">:</span> <span class="n">waves_vector</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
</span><span class='line'>             <span class="s">&#39;alpha_waves&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">waves_vector</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">waves_vector</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
</span><span class='line'>             <span class="s">&#39;low_alpha_waves&#39;</span><span class="p">:</span> <span class="n">waves_vector</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
</span><span class='line'>             <span class="s">&#39;high_alpha_waves&#39;</span><span class="p">:</span> <span class="n">waves_vector</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
</span><span class='line'>             <span class="s">&#39;beta_waves&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">waves_vector</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">+</span><span class="n">waves_vector</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
</span><span class='line'>             <span class="s">&#39;low_beta_waves&#39;</span><span class="p">:</span> <span class="n">waves_vector</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
</span><span class='line'>             <span class="s">&#39;high_beta_waves&#39;</span><span class="p">:</span> <span class="n">waves_vector</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
</span><span class='line'>             <span class="s">&#39;gamma_waves&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">waves_vector</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">+</span><span class="n">waves_vector</span><span class="p">[</span><span class="mi">7</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
</span><span class='line'>             <span class="s">&#39;low_gamma_waves&#39;</span><span class="p">:</span> <span class="n">waves_vector</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span>
</span><span class='line'>             <span class="s">&#39;mid_gamma_waves&#39;</span><span class="p">:</span> <span class="n">waves_vector</span><span class="p">[</span><span class="mi">7</span><span class="p">]}</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">s</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</span><span class='line'>        <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</span><span class='line'>    <span class="n">gevent</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.4</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Reading from the FIFO file is simple in Clojure.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">while</span> <span class="nv">true</span>
</span><span class='line'>  <span class="p">(</span><span class="nb">with-open </span><span class="p">[</span><span class="nv">reader</span> <span class="p">(</span><span class="nf">clojure.java.io/reader</span> <span class="s">&quot;/tmp/brain-data&quot;</span><span class="p">)]</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">brainwave-&gt;music</span> <span class="p">(</span><span class="nf">json/decode</span> <span class="p">(</span><span class="nb">first </span><span class="p">(</span><span class="nb">line-seq </span><span class="nv">reader</span><span class="p">))</span> <span class="nv">true</span><span class="p">))))</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Step 3: Sonification</h2>

<p>Sonification is the process of taking data and turning it into sound. Here is an example of the data we are now receiving:</p>

<p>A single JSON brainwave packet:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'> <span class="p">{</span><span class="s">&quot;gamma_waves&quot;</span><span class="err">:</span> <span class="mi">95408</span>,
</span><span class='line'>  <span class="s">&quot;high_beta_waves&quot;</span><span class="err">:</span> <span class="mi">205681</span>,
</span><span class='line'>  <span class="s">&quot;beta_waves&quot;</span><span class="err">:</span> <span class="mi">293928</span>,
</span><span class='line'>  <span class="s">&quot;low_beta_waves&quot;</span><span class="err">:</span> <span class="mi">382176</span>,
</span><span class='line'>  <span class="s">&quot;mid_gamma_waves&quot;</span><span class="err">:</span> <span class="mi">84528</span>,
</span><span class='line'>  <span class="s">&quot;low_alpha_waves&quot;</span><span class="err">:</span> <span class="mi">172417</span>,
</span><span class='line'>  <span class="s">&quot;delta_waves&quot;</span><span class="err">:</span> <span class="mi">117933</span>,
</span><span class='line'>  <span class="s">&quot;low_gamma_waves&quot;</span><span class="err">:</span> <span class="mi">106288</span>,
</span><span class='line'>  <span class="s">&quot;alpha_waves&quot;</span><span class="err">:</span> <span class="mi">112605</span>,
</span><span class='line'>  <span class="s">&quot;theta_waves&quot;</span><span class="err">:</span> <span class="mi">635628</span>,
</span><span class='line'>  <span class="s">&quot;high_alpha_waves&quot;</span><span class="err">:</span> <span class="mi">52793</span>,
</span><span class='line'>  <span class="s">&quot;attention&quot;</span><span class="err">:</span> <span class="mi">0</span>,
</span><span class='line'>  <span class="s">&quot;meditation&quot;</span><span class="err">:</span> <span class="mi">0</span>,
</span><span class='line'>  <span class="s">&quot;timestamp&quot;</span><span class="err">:</span> <span class="mf">1.375811275696894</span><span class="nv">E9</span><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>We will focus on the beta-waves for simplicity. Beta-waves fall between 16.5–20Hz.</p>

<p><img alt="EEG beta waves" src="/images/eeg_beta.png"></p>

<p>Beta waves related to:</p>

<ul>
<li>Alertness</li>
<li>Logic</li>
<li>Critical reasoning</li>
</ul>


<p> We need to map a signal within 16.5-20Hz into the musical pitches of a sampled piano (21-108 pitches).</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">require</span> <span class="o">&#39;</span><span class="p">[</span><span class="nv">clojure.math.numeric-tower</span> <span class="ss">:as</span> <span class="nv">math</span><span class="p">])</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">linear-map</span> <span class="p">[</span><span class="nv">x0</span> <span class="nv">x1</span> <span class="nv">y0</span> <span class="nv">y1</span> <span class="nv">x</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">dydx</span> <span class="p">(</span><span class="nb">/ </span><span class="p">(</span><span class="nb">- </span><span class="nv">y1</span> <span class="nv">y0</span><span class="p">)</span> <span class="p">(</span><span class="nb">- </span><span class="nv">x1</span> <span class="nv">x0</span><span class="p">))</span>
</span><span class='line'>        <span class="nv">dx</span> <span class="p">(</span><span class="nb">- </span><span class="nv">x</span> <span class="nv">x0</span><span class="p">)]</span>
</span><span class='line'>    <span class="p">(</span><span class="nb">+ </span><span class="nv">y0</span> <span class="p">(</span><span class="nb">* </span><span class="nv">dydx</span> <span class="nv">dx</span><span class="p">))))</span>
</span><span class='line'>
</span><span class='line'><span class="c1">;; Piano range: 0..87</span>
</span><span class='line'><span class="c1">;; Beta wave range: 16500..20000</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">beta-wave-&gt;pitch</span> <span class="p">[</span><span class="nv">signal</span><span class="p">]</span> <span class="p">(</span><span class="nb">-&gt; </span><span class="p">(</span><span class="nf">linear-map</span> <span class="mi">16500</span> <span class="mi">20000</span> <span class="mi">21</span> <span class="mi">108</span> <span class="nv">signal</span><span class="p">)</span> <span class="nb">float </span><span class="nv">math/round</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">beta-wave-&gt;pitch</span> <span class="mi">16500</span><span class="p">)</span> <span class="c1">;-&gt; 21</span>
</span><span class='line'><span class="p">(</span><span class="nf">beta-wave-&gt;pitch</span> <span class="mi">20000</span><span class="p">)</span> <span class="c1">;-&gt; 108</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now we extract the beta-waves from the brainwave data and play them. We play them live as they arrive rather than worrying about scheduling notes:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">use</span> <span class="ss">&#39;overtone.live</span><span class="p">)</span>
</span><span class='line'><span class="p">(</span><span class="nf">use</span> <span class="ss">&#39;overtone.inst.sampled-piano</span><span class="p">)</span>
</span><span class='line'><span class="p">(</span><span class="nf">require</span> <span class="o">&#39;</span><span class="p">[</span><span class="nv">cheshire.core</span> <span class="ss">:as</span> <span class="nv">json</span><span class="p">])</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">while</span> <span class="nv">true</span>
</span><span class='line'>  <span class="p">(</span><span class="nb">with-open </span><span class="p">[</span><span class="nv">reader</span> <span class="p">(</span><span class="nf">clojure.java.io/reader</span> <span class="s">&quot;/tmp/brain-data&quot;</span><span class="p">)]</span>
</span><span class='line'>    <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">beta-wave</span> <span class="p">(</span><span class="nb">-&gt; </span><span class="p">(</span><span class="nb">first </span><span class="p">(</span><span class="nb">line-seq </span><span class="nv">reader</span><span class="p">))</span> <span class="p">(</span><span class="nf">json/decode</span> <span class="nv">true</span><span class="p">)</span> <span class="ss">:beta_waves</span><span class="p">)]</span>
</span><span class='line'>      <span class="p">(</span><span class="nb">println </span><span class="nv">beta-wave</span><span class="p">)</span>
</span><span class='line'>      <span class="p">(</span><span class="nf">sampled-piano</span> <span class="ss">:note</span> <span class="p">(</span><span class="nf">beta-wave-&gt;pitch</span> <span class="nv">beta-wave</span><span class="p">)</span> <span class="ss">:sustain</span> <span class="mf">0.2</span><span class="p">))))</span>
</span></code></pre></td></tr></table></div></figure>


<h1>Would you like to hear my brain?</h1>

<p>The results, please listen to my brain.</p>

<div><iframe width="100%" height="166" scrolling="no" frameborder="no" src="https://w.soundcloud.com/player/?url=http%3A%2F%2Fapi.soundcloud.com%2Ftracks%2F108320470&amp;color=ff6600&amp;auto_play=false&amp;show_artwork=false"></iframe></div>


<p>Not really music is it? With beta-waves we get a serious of high to low transitions. While we can control at what pitch the transitions occur by performing activities that shape our brain waves the transitions don&rsquo;t provide the order or structure we need to recognize this as music.</p>

<h2>Brain controlled Dubstep</h2>

<p>The only logical path left is to try and control Dubstep with our brain. Rather than generative music we can use our brain waves to control the tempo and volume of existing synthesized music.</p>

<p>Here is a Dubstep synth taken from Overtone:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">use</span> <span class="ss">&#39;overtone.live</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">defsynth</span> <span class="nv">dubstep</span> <span class="p">[</span><span class="nv">bpm</span> <span class="mi">120</span> <span class="nv">wobble</span> <span class="mi">1</span> <span class="nv">note</span> <span class="mi">50</span> <span class="nv">snare-vol</span> <span class="mi">1</span> <span class="nv">kick-vol</span> <span class="mi">1</span> <span class="nv">volume</span> <span class="mi">1</span> <span class="nv">out-bus</span> <span class="mi">0</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">trig</span> <span class="p">(</span><span class="nf">impulse</span><span class="ss">:kr</span> <span class="p">(</span><span class="nb">/ </span><span class="nv">bpm</span> <span class="mi">120</span><span class="p">))</span>
</span><span class='line'>        <span class="nv">freq</span> <span class="p">(</span><span class="nf">midicps</span> <span class="nv">note</span><span class="p">)</span>
</span><span class='line'>        <span class="nv">swr</span> <span class="p">(</span><span class="nf">demand</span> <span class="nv">trig</span> <span class="mi">0</span> <span class="p">(</span><span class="nf">dseq</span> <span class="p">[</span><span class="nv">wobble</span><span class="p">]</span> <span class="nv">INF</span><span class="p">))</span>
</span><span class='line'>        <span class="nv">sweep</span> <span class="p">(</span><span class="nf">lin-exp</span> <span class="p">(</span><span class="nf">lf-tri</span> <span class="nv">swr</span><span class="p">)</span> <span class="mi">-1</span> <span class="mi">1</span> <span class="mi">40</span> <span class="mi">3000</span><span class="p">)</span>
</span><span class='line'>        <span class="nv">wob</span> <span class="p">(</span><span class="nb">apply + </span><span class="p">(</span><span class="nf">saw</span> <span class="p">(</span><span class="nb">* </span><span class="nv">freq</span> <span class="p">[</span><span class="mf">0.99</span> <span class="mf">1.01</span><span class="p">])))</span>
</span><span class='line'>        <span class="nv">wob</span> <span class="p">(</span><span class="nf">lpf</span> <span class="nv">wob</span> <span class="nv">sweep</span><span class="p">)</span>
</span><span class='line'>        <span class="nv">wob</span> <span class="p">(</span><span class="nb">* </span><span class="mf">0.8</span> <span class="p">(</span><span class="nf">normalizer</span> <span class="nv">wob</span><span class="p">))</span>
</span><span class='line'>        <span class="nv">wob</span> <span class="p">(</span><span class="nb">+ </span><span class="nv">wob</span> <span class="p">(</span><span class="nf">bpf</span> <span class="nv">wob</span> <span class="mi">1500</span> <span class="mi">2</span><span class="p">))</span>
</span><span class='line'>        <span class="nv">wob</span> <span class="p">(</span><span class="nb">+ </span><span class="nv">wob</span> <span class="p">(</span><span class="nb">* </span><span class="mf">0.2</span> <span class="p">(</span><span class="nf">g-verb</span> <span class="nv">wob</span> <span class="mi">9</span> <span class="mf">0.7</span> <span class="mf">0.7</span><span class="p">)))</span>
</span><span class='line'>
</span><span class='line'>        <span class="nv">kickenv</span> <span class="p">(</span><span class="nf">decay</span> <span class="p">(</span><span class="nf">t2a</span> <span class="p">(</span><span class="nf">demand</span> <span class="p">(</span><span class="nf">impulse</span><span class="ss">:kr</span> <span class="p">(</span><span class="nb">/ </span><span class="nv">bpm</span> <span class="mi">30</span><span class="p">))</span> <span class="mi">0</span> <span class="p">(</span><span class="nf">dseq</span> <span class="p">[</span><span class="mi">1</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">1</span> <span class="mi">0</span> <span class="mi">1</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">1</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span><span class="p">]</span> <span class="nv">INF</span><span class="p">)))</span> <span class="mf">0.7</span><span class="p">)</span>
</span><span class='line'>        <span class="nv">kick</span> <span class="p">(</span><span class="nb">* </span><span class="p">(</span><span class="nb">* </span><span class="nv">kickenv</span> <span class="mi">7</span><span class="p">)</span> <span class="p">(</span><span class="nf">sin-osc</span> <span class="p">(</span><span class="nb">+ </span><span class="mi">40</span> <span class="p">(</span><span class="nb">* </span><span class="nv">kickenv</span> <span class="nv">kickenv</span> <span class="nv">kickenv</span> <span class="mi">200</span><span class="p">))))</span>
</span><span class='line'>        <span class="nv">kick</span> <span class="p">(</span><span class="nf">clip2</span> <span class="nv">kick</span> <span class="mi">1</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="nv">snare</span> <span class="p">(</span><span class="nb">* </span><span class="mi">3</span> <span class="p">(</span><span class="nf">pink-noise</span><span class="p">)</span> <span class="p">(</span><span class="nb">apply + </span><span class="p">(</span><span class="nb">* </span><span class="p">(</span><span class="nf">decay</span> <span class="p">(</span><span class="nf">impulse</span> <span class="p">(</span><span class="nb">/ </span><span class="nv">bpm</span> <span class="mi">240</span><span class="p">)</span> <span class="mf">0.5</span><span class="p">)</span> <span class="p">[</span><span class="mf">0.4</span> <span class="mi">2</span><span class="p">])</span> <span class="p">[</span><span class="mi">1</span> <span class="mf">0.05</span><span class="p">])))</span>
</span><span class='line'>        <span class="nv">snare</span> <span class="p">(</span><span class="nb">+ </span><span class="nv">snare</span> <span class="p">(</span><span class="nf">bpf</span> <span class="p">(</span><span class="nb">* </span><span class="mi">4</span> <span class="nv">snare</span><span class="p">)</span> <span class="mi">2000</span><span class="p">))</span>
</span><span class='line'>        <span class="nv">snare</span> <span class="p">(</span><span class="nf">clip2</span> <span class="nv">snare</span> <span class="mi">1</span><span class="p">)]</span>
</span><span class='line'>
</span><span class='line'>       <span class="p">(</span><span class="nf">out</span> <span class="nv">out-bus</span> <span class="p">(</span><span class="nb">* </span><span class="nv">volume</span> <span class="p">(</span><span class="nf">clip2</span> <span class="p">(</span><span class="nb">+ </span><span class="nv">wob</span> <span class="p">(</span><span class="nb">* </span><span class="nv">kick-vol</span> <span class="nv">kick</span><span class="p">)</span> <span class="p">(</span><span class="nb">* </span><span class="nv">snare-vol</span> <span class="nv">snare</span><span class="p">))</span> <span class="mi">1</span><span class="p">)))))</span>
</span></code></pre></td></tr></table></div></figure>


<p></p>

<p>Once the synth is running we can send it control signals which will vary any of the properties defined in the arguments to the dubstep function:</p>

<ul>
<li>bpm</li>
<li>wobble</li>
<li>note</li>
<li>snare-vol</li>
<li>kick-vol</li>
<li>volume</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">d</span> <span class="p">(</span><span class="nf">dubstep</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">ctl</span> <span class="nv">d</span> <span class="ss">:snare-vol</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'><span class="p">(</span><span class="nf">ctl</span> <span class="nv">d</span> <span class="ss">:kick-vol</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'><span class="p">(</span><span class="nf">ctl</span> <span class="nv">d</span> <span class="ss">:wooble</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'><span class="p">(</span><span class="nf">ctl</span> <span class="nv">d</span> <span class="ss">:bpm</span> <span class="mi">20</span><span class="p">)</span>
</span><span class='line'><span class="p">(</span><span class="nf">ctl</span> <span class="nv">d</span> <span class="ss">:v</span> <span class="mf">0.2</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>We again have to linearise the beta wave signal to the range of volume 0.0-1.1 and to the bpm 0-400.</p>

<p>Now all thats left to do is connect it to our brain.</p>

<p>Here&rsquo;s what brain controlled Dubstep sounds like:</p>

<div><iframe width="100%" height="166" scrolling="no" frameborder="no" src="https://w.soundcloud.com/player/?url=https%3A//api.soundcloud.com/tracks/119776808&amp;color=ff6600&amp;auto_play=false&amp;show_artwork=false"></iframe></div>


<p>And for comparison what playing Go does to your brain activity (I turned the Dubstep down while playing, concentrating with that noise is hard):</p>

<div><iframe width="100%" height="166" scrolling="no" frameborder="no" src="https://w.soundcloud.com/player/?url=https%3A//api.soundcloud.com/tracks/122704897&amp;color=ff6600&amp;auto_play=false&amp;show_artwork=false"></iframe></div>


<h1>Discovery through sound</h1>

<p>Mapping brain waves into live music is a challenging task and while we can control music through an EEG machine that control is hard since we are using the brain to do many other things. What is interesting in the path of this experiment is not in fact the music generated but the use of sound to provide a way to hear the differences in datasets.</p>

<p>Hearing the difference between play Go or sleeping, between young people or old people.</p>

<p>Sound as a means of discovering patterns is a largely untapped source.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/clojure/building-clojure-services-at-scale.html">Building Clojure Services at Scale</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-09-13T11:00:00+01:00" pubdate data-updated="true">Sep 13<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>At SoundCloud I&rsquo;ve been experimenting over the last year with how we build the services that power a number of heavily loaded areas across our site. All these services have been built in Clojure with bits of Java tacked on the sides. Here are some of my personal thoughts on how to build Clojure services:</p>

<h2>Netflix or Twitter</h2>

<p><img alt="choose your own adventure" src="/images/adventure.jpg"></p>

<p>At some-point when you require a sufficient level of scaling you turn to the open source work of <a href="https://github.com/twitter">Twitter</a> with <a href="http://twitter.github.io/finagle">Finagle</a> or <a href="https://github.com/Netflix">Netflix</a> with <a href="https://github.com/Netflix/Hystrix">Hystrix</a>/<a href="https://github.com/Netflix/RxJava">RxJava</a>.
Netflix libs are written in Java while Twitters are written in Scala. Both are easy to use from any JVM based language but the Finagle route will bring in an extra dependency on Scala. I&rsquo;ve heard little from people using interop between Clojure &amp; Scala and that extra Scala dependency makes me nervous. Further I like the simplicity of Netflix&rsquo;s libs and they have been putting a lot of effort into pushing support for many JVM based languages.</p>

<p>Hence with Clojure, Netflix projects are my preference. (I should add we do use Finagle with Scala at SoundCloud as well).</p>

<h2>Failure, Monitoring &amp; Composition Complexity</h2>

<div style="display:inline-block;">
<img align="left" style="margin-right:5px;" src="/images/failure.jpg" width="150px" height="150px">

In a service reliant on other services, databases, caches any other external dependencies its a guarantee at some-point some of those will fail. When working with critical services we want to gracefully provide a degraded service.
</div>




<p></p>




<div style="display:inline-block;">
<img align="left" style="margin-right:5px;" src="/images/scary-eye.png" width="150px" height="150px">
While we can think about degrading gracefully in the case of failure, ultimately we want to fix wants broken as soon as possible. An eye into the runtime system allows us to monitor exactly whats going on and take appropriate action. 
</div>




<p></p>




<div style="display:inline-block;">
<img align="left" style="margin-right:5px;" src="/images/complexity.png" width="150px" height="150px">

Your service needs to call other services. Dependent on those service results you might need to call other services which in turn might require calls to other services. Composing service calls is hard to get right without a tangle of complex code.
</div>




<p></p>


<h3>Fault Tolerance</h3>

<p>How should we build fault tolerance into our Clojure services?</p>

<h4>Single thread pool</h4>

<p>Consider you have this line within a service response:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">{</span><span class="ss">:body</span> <span class="err">@</span><span class="p">(</span><span class="nf">future</span> <span class="p">(</span><span class="nf">client/get</span> <span class="s">&quot;http://soundcloud.com/blah/wah&quot;</span><span class="p">))</span> <span class="ss">:status</span> <span class="mi">200</span><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now <code>http://soundcloud.com/blah/wah</code> goes down and those client requests start getting blocked on the request. In Clojure all <code>future</code> calls acquire a thread from the same thread pool. In our example the service is blocked up, is pilling new requests onto the blocked pool and we are in trouble.</p>

<p>My first solution to this problem was to introduce circuit breakers (<a href="https://github.com/josephwilk/circuit-breaker">https://github.com/josephwilk/circuit-breaker</a>).
I also stop using <code>@</code> to dereference futures and used <code>deref</code> <a href="http://clojuredocs.org/clojure_core/clojure.core/deref">http://clojuredocs.org/clojure_core/clojure.core/deref</a> which supports defaults and timeouts.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">defncircuitbreaker</span> <span class="ss">:blah-http</span> <span class="p">{</span><span class="ss">:timeout</span> <span class="mi">30</span> <span class="ss">:threshold</span> <span class="mi">2</span><span class="p">})</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">future-timeout</span> <span class="mi">1000</span><span class="p">)</span>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">timeout-value</span> <span class="nv">nil</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">http-get</span> <span class="p">[</span><span class="nv">url</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">with-circuit-breaker</span> <span class="ss">:blah-http</span> <span class="p">{</span>
</span><span class='line'>    <span class="ss">:connected</span> <span class="p">(</span><span class="k">fn </span><span class="p">[]</span> <span class="p">(</span><span class="nf">client/get</span> <span class="s">&quot;http://soundcloud.com/blah/wah&quot;</span><span class="p">))</span>
</span><span class='line'>    <span class="ss">:tripped</span> <span class="p">(</span><span class="k">fn </span><span class="p">[]</span> <span class="nv">nil</span><span class="p">)}))</span>
</span><span class='line'>
</span><span class='line'><span class="p">{</span><span class="ss">:body</span> <span class="p">(</span><span class="nf">http-get</span> <span class="nv">http</span><span class="ss">://www.soundcloud.com/blah/wah</span><span class="p">)</span> <span class="ss">:status</span> <span class="mi">200</span><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Problem solved, now even though the thread pool may become blocked we back off the following requests and avoid pilling more work onto the blocked thread pool.</p>

<p>This worked pretty well, but then we decided we would to try and go even further in gracefully degrading.
Why don&rsquo;t we serve from a cache on failure, slightly stale data is better than none.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">http-get</span> <span class="p">[</span><span class="nv">url</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">with-circuit-breaker</span> <span class="ss">:blah-http</span> <span class="p">{</span>
</span><span class='line'>    <span class="ss">:connected</span> <span class="p">(</span><span class="k">fn </span><span class="p">[]</span> <span class="p">(</span><span class="nf">client/get</span> <span class="s">&quot;http://soundcloud.com/blah/wah&quot;</span><span class="p">))</span>
</span><span class='line'>    <span class="ss">:tripped</span> <span class="p">(</span><span class="k">fn </span><span class="p">[]</span> <span class="p">(</span><span class="nf">memcache/get</span> <span class="nv">client</span> <span class="nv">url</span><span class="p">))}))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now consider <code>(client/get "http://soundcloud.com/blah/wah")</code> starts failing, the thread pool gets blocked up, the circuit trigger flips and <code>(memcache/get client url)</code> is now fighting to get threads from the blocked thread pool.</p>

<p>Pants.</p>

<h5>Scheduling over thread pools: Hystrix</h5>

<p><a href="https://github.com/Netflix/Hystrix">Hystrix</a> is Netflix library which I think of as circuit breakers on steroids.</p>

<p><img src ="/images/hystrix.png" height="400px" width="400px"/></p>

<pre><code>Hystrix is a latency and fault tolerance library designed to isolate points of access to remote systems, 
services and 3rd party libraries, stop cascading failure and enable resilience in complex distributed systems 
where failure is inevitable.
</code></pre>

<p>Dave Ray (<a href="http://darevay.com">http://darevay.com</a>) has been doing lots of excellent work on producing <a href="https://github.com/Netflix/Hystrix/tree/master/hystrix-contrib/hystrix-clj">Clojure bindings for Hystrix</a>:</p>

<p>Hystrix gives me 2 big wins:</p>

<h5>1. Separation of thread pools</h5>

<p>Hystrix creates a separate thread pool for each Clojure namespace, if one thread pool becomes blocked due to a failure, a circuit breaker can be triggered with a fallback that uses a different thread pool.</p>

<p>This however does come with a cost:</p>

<ol>
<li> We have a performance hit due to moving to a scheduling based method for executing Hystrix commands.</li>
<li> We cannot use Clojure&rsquo;s concurrency primitives (futures/promises/agents).</li>
</ol>


<p>Here is an example of our service rewritten with Hystrix:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">ns </span><span class="nv">example</span>
</span><span class='line'>  <span class="p">(</span><span class="ss">:require</span> <span class="p">[[</span><span class="nv">com.netflix.hystrix.core</span> <span class="ss">:as</span> <span class="nv">hystrix</span><span class="p">]]))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">hystrix/defcommand</span> <span class="nv">http-get</span>
</span><span class='line'>  <span class="p">{</span><span class="ss">:hystrix/fallback-fn</span> <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">url</span><span class="p">]</span> <span class="p">(</span><span class="nf">memcache-get</span> <span class="nv">url</span><span class="p">)}</span>
</span><span class='line'>  <span class="p">[</span><span class="nv">url</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">client/get</span> <span class="nv">url</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">hystrix/defcommand</span> <span class="nv">memcache-get</span>
</span><span class='line'>  <span class="p">{</span><span class="ss">:hystrix/fallback-fn</span> <span class="p">(</span><span class="nb">constantly </span><span class="nv">nil</span><span class="p">)}</span>
</span><span class='line'>  <span class="p">[</span><span class="nv">url</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">memcache/get</span> <span class="nv">client</span> <span class="nv">key</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">http-get</span> <span class="p">[</span><span class="nv">url</span><span class="p">]</span>
</span><span class='line'>   <span class="p">{</span><span class="ss">:body</span> <span class="p">(</span><span class="nf">http/get</span> <span class="s">&quot;http://soundcloud.com/blah/wah&quot;</span><span class="p">)</span> <span class="ss">:status</span> <span class="mi">200</span><span class="p">})</span>
</span></code></pre></td></tr></table></div></figure>


<p>Beautiful, Just adding the <code>defcommand</code> brings us fault tolerance with no other changes to the shape of our code.</p>

<p>See the Hystrix Clojure adapter for all the possible configuration: <a href="https://github.com/Netflix/Hystrix/tree/master/hystrix-contrib/hystrix-clj">https://github.com/Netflix/Hystrix/tree/master/hystrix-contrib/hystrix-clj</a></p>

<h5>2.  Monitoring</h5>

<p>Hystrix supports exposing metrics on all circuit breakers within a process. It exposes these calls through an event stream.</p>

<p>How you expose that Hystrix event stream depends slightly on which web server you are using with your Clojure app.</p>

<h4>Netty and Hystrix Event Streams (without servlets)</h4>

<p><a href="https://github.com/josephwilk/hystrix-event-stream-clj">https://github.com/josephwilk/hystrix-event-stream-clj</a></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="ss">:require</span> <span class="p">[</span><span class="nv">hystrix-event-stream-clj.core</span> <span class="nv">as</span> <span class="nv">hystrix-event</span><span class="p">])</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">defroutes</span> <span class="nv">app</span> <span class="p">(</span><span class="nf">GET</span> <span class="s">&quot;/hystrix.stream&quot;</span> <span class="p">(</span><span class="nf">hystrix-event/stream</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<h4>Jetty and Hystrix Event Streams (with servlets)</h4>

<p>If they are using Jetty you will need to change your app to add your main web app as a servlet. Then we can also add the Hystrix event stream servlet.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">ns </span><span class="nv">sc-clj-kit.hystrix.jetty</span>
</span><span class='line'>  <span class="p">(</span><span class="ss">:import</span> <span class="p">[</span><span class="nv">com.netflix.hystrix.contrib.metrics.eventstream</span> <span class="nv">HystrixMetricsStreamServlet</span><span class="p">])</span>
</span><span class='line'>  <span class="p">(</span><span class="ss">:import</span> <span class="p">[</span><span class="nv">org.eclipse.jetty.server</span> <span class="nv">Server</span><span class="p">])</span>
</span><span class='line'>  <span class="p">(</span><span class="ss">:import</span> <span class="p">[</span><span class="nv">org.eclipse.jetty.servlet</span> <span class="nv">ServletContextHandler</span><span class="p">])</span>
</span><span class='line'>  <span class="p">(</span><span class="ss">:import</span> <span class="p">[</span><span class="nv">org.eclipse.jetty.servlet</span> <span class="nv">ServletHolder</span><span class="p">])</span>
</span><span class='line'>  <span class="p">(</span><span class="ss">:import</span> <span class="p">[</span><span class="nv">org.eclipse.jetty.server.bio</span> <span class="nv">SocketConnector</span><span class="p">])</span>
</span><span class='line'>  <span class="p">(</span><span class="ss">:import</span> <span class="p">[</span><span class="nv">org.eclipse.jetty.server.ssl</span> <span class="nv">SslSocketConnector</span><span class="p">])</span>
</span><span class='line'>
</span><span class='line'>  <span class="p">(</span><span class="ss">:import</span> <span class="p">(</span><span class="nf">org.eclipse.jetty.server</span> <span class="nv">Server</span> <span class="nv">Request</span><span class="p">)</span>
</span><span class='line'>           <span class="p">(</span><span class="nf">org.eclipse.jetty.server.handler</span> <span class="nv">AbstractHandler</span><span class="p">)</span>
</span><span class='line'>           <span class="p">(</span><span class="nf">org.eclipse.jetty.server.nio</span> <span class="nv">SelectChannelConnector</span><span class="p">)</span>
</span><span class='line'>           <span class="p">(</span><span class="nf">org.eclipse.jetty.server.ssl</span> <span class="nv">SslSelectChannelConnector</span><span class="p">)</span>
</span><span class='line'>           <span class="p">(</span><span class="nf">org.eclipse.jetty.util.thread</span> <span class="nv">QueuedThreadPool</span><span class="p">)</span>
</span><span class='line'>           <span class="p">(</span><span class="nf">org.eclipse.jetty.util.ssl</span> <span class="nv">SslContextFactory</span><span class="p">)</span>
</span><span class='line'>           <span class="p">(</span><span class="nf">javax.servlet.http</span> <span class="nv">HttpServletRequest</span> <span class="nv">HttpServletResponse</span><span class="p">))</span>
</span><span class='line'>  <span class="p">(</span><span class="ss">:require</span>
</span><span class='line'>   <span class="p">[</span><span class="nv">compojure.core</span>          <span class="ss">:refer</span> <span class="ss">:all</span><span class="p">]</span>
</span><span class='line'>   <span class="p">[</span><span class="nv">ring.adapter.jetty</span>      <span class="ss">:as</span> <span class="nv">jetty</span><span class="p">]</span>
</span><span class='line'>   <span class="p">[</span><span class="nv">ring.util.servlet</span> <span class="ss">:as</span> <span class="nv">servlet</span><span class="p">]))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">run-jetty-with-hystrix-stream</span> <span class="p">[</span><span class="nv">app</span> <span class="nv">options</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="o">^</span><span class="nv">Server</span> <span class="nv">server</span> <span class="p">(</span><span class="o">#</span><span class="ss">&#39;jetty/create-server</span> <span class="p">(</span><span class="nb">dissoc </span><span class="nv">options</span> <span class="ss">:configurator</span><span class="p">))</span>
</span><span class='line'>        <span class="o">^</span><span class="nv">QueuedThreadPool</span> <span class="nv">pool</span> <span class="p">(</span><span class="nf">QueuedThreadPool.</span> <span class="o">^</span><span class="nv">Integer</span> <span class="p">(</span><span class="nf">options</span> <span class="ss">:max-threads</span> <span class="mi">50</span><span class="p">))]</span>
</span><span class='line'>    <span class="p">(</span><span class="nb">when </span><span class="p">(</span><span class="ss">:daemon?</span> <span class="nv">options</span> <span class="nv">false</span><span class="p">)</span> <span class="p">(</span><span class="nf">.setDaemon</span> <span class="nv">pool</span> <span class="nv">true</span><span class="p">))</span>
</span><span class='line'>    <span class="p">(</span><span class="nb">doto </span><span class="nv">server</span> <span class="p">(</span><span class="nf">.setThreadPool</span> <span class="nv">pool</span><span class="p">))</span>
</span><span class='line'>    <span class="p">(</span><span class="nb">when-let </span><span class="p">[</span><span class="nv">configurator</span> <span class="p">(</span><span class="ss">:configurator</span> <span class="nv">options</span><span class="p">)]</span>
</span><span class='line'>      <span class="p">(</span><span class="nf">configurator</span> <span class="nv">server</span><span class="p">))</span>
</span><span class='line'>    <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">hystrix-holder</span>  <span class="p">(</span><span class="nf">ServletHolder.</span> <span class="nv">HystrixMetricsStreamServlet</span><span class="p">)</span>
</span><span class='line'>          <span class="nv">app-holder</span> <span class="p">(</span><span class="nf">ServletHolder.</span> <span class="p">(</span><span class="nf">servlet/servlet</span> <span class="nv">app</span><span class="p">))</span>
</span><span class='line'>          <span class="nv">context</span> <span class="p">(</span><span class="nf">ServletContextHandler.</span> <span class="nv">server</span> <span class="s">&quot;/&quot;</span> <span class="nv">ServletContextHandler/SESSIONS</span><span class="p">)]</span>
</span><span class='line'>      <span class="p">(</span><span class="nf">.addServlet</span> <span class="nv">context</span> <span class="nv">hystrix-holder</span> <span class="s">&quot;/hystrix.stream&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="p">(</span><span class="nf">.addServlet</span> <span class="nv">context</span> <span class="nv">app-holder</span> <span class="s">&quot;/&quot;</span><span class="p">))</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">.start</span> <span class="nv">server</span><span class="p">)</span>
</span><span class='line'>    <span class="p">(</span><span class="nb">when </span><span class="p">(</span><span class="ss">:join?</span> <span class="nv">options</span> <span class="nv">true</span><span class="p">)</span> <span class="p">(</span><span class="nf">.join</span> <span class="nv">server</span><span class="p">))</span>
</span><span class='line'>    <span class="nv">server</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">defroutes</span> <span class="nv">app</span> <span class="p">(</span><span class="nf">GET</span> <span class="s">&quot;/hello&quot;</span> <span class="p">[]</span> <span class="p">{</span><span class="ss">:status</span> <span class="mi">200</span> <span class="ss">:body</span> <span class="s">&quot;Hello&quot;</span><span class="p">})</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">run-jetty-with-hystrix</span> <span class="nv">app</span> <span class="p">{</span><span class="ss">:port</span> <span class="nv">http-port</span> <span class="ss">:join?</span> <span class="nv">false</span><span class="p">})</span>
</span></code></pre></td></tr></table></div></figure>


<h4>Aggregation and discovery</h4>

<p>While you can monitor a single process using Hystrix in our example we have many processes serving an endpoint. To aggregate all these Hystrix metric services we use <a href="https://github.com/Netflix/Turbine">Turbine</a>.</p>

<p>Physical endpoints for a service at SoundCloud are discovered using DNS lookup. We configured Turbine to use this method to auto discover which machines are serving an endpoint.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">ns </span><span class="nv">sc-turbine.discovery</span>
</span><span class='line'>  <span class="p">(</span><span class="ss">:import</span> <span class="p">[</span><span class="nv">org.xbill.DNS</span> <span class="nv">Type</span><span class="p">]</span>
</span><span class='line'>           <span class="p">[</span><span class="nv">com.netflix.turbine.discovery</span> <span class="nv">InstanceDiscovery</span> <span class="nv">Instance</span><span class="p">])</span>
</span><span class='line'>  <span class="p">(</span><span class="ss">:require</span> <span class="p">[</span><span class="nv">clj-dns.core</span> <span class="ss">:refer</span> <span class="ss">:all</span><span class="p">]))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">gen-class</span>
</span><span class='line'>   <span class="ss">:name</span> <span class="nv">ScInstanceDiscovery</span>
</span><span class='line'>   <span class="ss">:implements</span> <span class="p">[</span><span class="nv">com.netflix.turbine.discovery.InstanceDiscovery</span><span class="p">])</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">-getInstanceList</span> <span class="p">[</span><span class="nv">this</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="nb">map </span><span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">instance</span><span class="p">]</span>
</span><span class='line'>         <span class="p">(</span><span class="nf">Instance.</span> <span class="p">(</span><span class="nb">str </span><span class="p">(</span><span class="ss">:host</span> <span class="nv">instance</span><span class="p">)</span> <span class="s">&quot;:&quot;</span> <span class="p">(</span><span class="ss">:port</span> <span class="nv">instance</span><span class="p">))</span> <span class="s">&quot;example-prod&quot;</span> <span class="nv">true</span><span class="p">))</span>
</span><span class='line'>       <span class="p">(</span><span class="nb">map </span><span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">answer</span><span class="p">]</span> <span class="p">{</span><span class="ss">:host</span> <span class="p">(</span><span class="nb">-&gt; </span><span class="nv">answer</span> <span class="nv">.getTarget</span> <span class="nv">str</span><span class="p">)</span> <span class="ss">:port</span> <span class="p">(</span><span class="nf">.getPort</span> <span class="nv">answer</span><span class="p">)})</span>
</span><span class='line'>            <span class="p">(</span><span class="ss">:answers</span> <span class="p">(</span><span class="nf">dns-lookup</span> <span class="s">&quot;&quot;</span> <span class="nv">Type/SRV</span><span class="p">)))))</span>
</span></code></pre></td></tr></table></div></figure>


<p>And the config.properties:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="nv">InstanceDiscovery.impl=ScInstanceDiscovery</span>
</span><span class='line'><span class="nv">turbine.aggregator.clusterConfig=example-prod</span>
</span><span class='line'><span class="nv">turbine.instanceUrlSuffix=/hystrix.stream</span>
</span></code></pre></td></tr></table></div></figure>


<p>Putting this all together our monitoring looks like this:</p>

<p><img src="/images/service_discovery.png"></p>

<h4>Pretty graphs: Hystrix Dashboard</h4>

<p>Finally we run the <a href="https://github.com/Netflix/Hystrix/tree/master/hystrix-dashboard">Hystrix Dashboard</a> and watch our circuit breakers live.</p>

<p><img src="/images/hystrix_dashboard.png"></p>

<p>And heres an example with triggered circuit breakers:</p>

<p><img src="/images/hystrix_dashboard_failures.jpg"></p>

<p>Since I cannot show you the dashboard running, you will have to make do with music generated from the metrics. I normalize the live Hystrix metrics to piano pitches and play the notes as the arrive from the stream.</p>

<h4>Hystrix Metrics as Sounds</h4>

<div>
<iframe width="100%" height="166" scrolling="no" frameborder="no" src="https://w.soundcloud.com/player/?url=http%3A%2F%2Fapi.soundcloud.com%2Ftracks%2F109115434&amp;color=ff6600&amp;auto_play=false&amp;show_artwork=false"></iframe>
</div>




<p></p>


<h3>Complexity &amp; Composition</h3>

<p>Working with many services, composition of service calls becomes hard to think and write about. Callbacks try to solve this but nested callbacks leave us with a mess.</p>

<p><a href="https://github.com/Netflix/RxJava">RxJava</a> tries to solve this using the Reactive Functional model. While RxJava provides lots of features I see it primarily as a way of expressing concurrent actions as a directed graph which provides a single callback on success or failure. The graph is expressed in terms or maps/reduces/filters/etc, things we are familiar with in the functional world.</p>

<p>To separate the request thread from the response thread we use RxJava with <a href="http://netty.io">Netty</a> and <a href="https://github.com/ztellman/aleph">Aleph</a>.</p>

<p>Here is a very simple example firing 2 concurrent requests and then joining the results into a single map response:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="c1">;;Hystrix integrates with RxJava and can return Observables for use with Rx.</span>
</span><span class='line'><span class="p">(</span><span class="kd">defn- </span><span class="nv">find-user-observable</span> <span class="p">[</span><span class="nv">id</span><span class="p">]</span> <span class="p">(</span><span class="nf">hystrix/observe</span> <span class="o">#</span><span class="ss">&#39;find-user</span> <span class="nv">id</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defn- </span><span class="nv">meta-data</span> <span class="p">[</span><span class="nv">user-urn</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">user-observable</span> <span class="p">(</span><span class="nb">-&gt; </span><span class="p">(</span><span class="nf">find-user-observable</span> <span class="nv">id</span><span class="p">)</span> <span class="p">(</span><span class="nf">.map</span> <span class="p">(</span><span class="err">λ</span> <span class="p">[</span><span class="nv">user</span><span class="p">]</span> <span class="nv">...</span><span class="p">)))</span>
</span><span class='line'>        <span class="nv">meta-observable</span> <span class="p">(</span><span class="nb">-&gt; </span><span class="p">(</span><span class="nf">find-user-meta-observable</span> <span class="nv">id</span><span class="p">)</span> <span class="p">(</span><span class="nf">.map</span> <span class="p">(</span><span class="err">λ</span> <span class="p">[</span><span class="nv">subscription</span><span class="p">]</span> <span class="nv">...</span><span class="p">))))</span>
</span><span class='line'>    <span class="p">(</span><span class="nb">-&gt; </span><span class="p">(</span><span class="nf">Observable/zip</span> <span class="nv">user-observable</span>
</span><span class='line'>                        <span class="nv">meta-observable</span>
</span><span class='line'>                        <span class="p">(</span><span class="err">λ</span> <span class="p">[</span><span class="o">&amp;</span> <span class="nv">maps</span><span class="p">]</span> <span class="p">{</span><span class="ss">:user</span> <span class="p">(</span><span class="nb">apply merge </span><span class="nv">maps</span><span class="p">)}))))</span>
</span></code></pre></td></tr></table></div></figure>


<p>The function <code>meta-data</code> returns an Observerable which we subscribe to and using Aleph return the resulting JSON to a channel.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn- </span><span class="nv">subscribe-request</span> <span class="p">[</span><span class="nv">channel</span> <span class="nv">request</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">id</span> <span class="p">(</span><span class="nf">get-in</span> <span class="nv">request</span> <span class="p">[</span><span class="ss">:route-params</span> <span class="ss">:id</span><span class="p">])]</span>
</span><span class='line'>    <span class="p">(</span><span class="nb">-&gt; </span><span class="p">(</span><span class="nf">meta-data</span> <span class="nv">id</span><span class="p">)</span>
</span><span class='line'>        <span class="p">(</span><span class="nf">.subscribe</span>
</span><span class='line'>          <span class="o">#</span><span class="p">(</span><span class="nf">enqueue</span> <span class="nv">channel</span> <span class="p">{</span><span class="ss">:status</span> <span class="mi">200</span> <span class="ss">:body</span> <span class="nv">%</span><span class="p">}))</span>
</span><span class='line'>          <span class="o">#</span><span class="p">(</span><span class="nf">logging/exception</span> <span class="nv">%</span><span class="p">))))))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">defroutes</span> <span class="nv">app</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">GET</span> <span class="s">&quot;/users/:id&quot;</span> <span class="p">[</span><span class="nv">id</span><span class="p">]</span> <span class="p">(</span><span class="nf">wrap-aleph-handler</span> <span class="nv">subscribe-request</span><span class="p">)))</span>
</span></code></pre></td></tr></table></div></figure>


<p>The shape of the <a href="https://github.com/Netflix/RxJava/tree/master/language-adaptors/rxjava-clojure">RxJava Clojure bindings</a> are still under development.</p>

<h4>That single thread pool again&hellip;</h4>

<p>With RxJava we are also in a situation were we cannot use Clojure&rsquo;s <code>future</code>. In order for RxJava to block optimally we don&rsquo;t want to use a single thread pool.
Hence we use Hystrix as our means of providing concurreny.</p>

<h2>Clojure services at scale</h2>

<p>I&rsquo;m very happy with the shape of these services running at SoundCloud. In production they are performing very well under heavy load with useful near realtime monitoring.
In part thanks to Netflix&rsquo;s hard work there is no reason you cannot write elegant Clojure services at scale.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/clojure/creating-instruments-with-overtone.html">Creating Sampled Instruments With Overtone</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-08-26T21:28:00+01:00" pubdate data-updated="true">Aug 26<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="http://overtone.github.io">Overtone</a> is an open source audio environment which uses Clojure and <a href="http://supercollider.sourceforge.net/">SuperCollider</a> (an environment and programming language for real time audio synthesis and algorithmic composition).</p>

<p>Overtone makes it very easy to define instruments based on sound samples from <a href="http://www.freesound.org">freesound</a>.
We will walk through getting samples for a flute and then using them to define the flute instrument in Overtone.</p>

<h2>The Flute</h2>

<p><img src="/images/flute.jpg"/></p>

<h3>Getting the samples</h3>

<p>Firstly we need to manually grab all the IDs from freesound. Sounds are often grouped into packs making this a little less painful.</p>

<p>We will be using the <a href="http://www.freesound.org/search/?q=flute&amp;f=grouping_pack%3A%229549_Transverse+Flute%3A+Tenuto+Vibrato+C4-C7%22&amp;s=score+desc&amp;advanced=0&amp;g=1">&ldquo;Transverse Flute: Tenuto Vibrato C4-C7&rdquo;</a> pack.</p>

<p>A little Ruby script I use to produce a map of freesound ids to notes (which are usually in the filename of the sample):</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#!/usr/bin/env ruby -w</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;rubygems&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;json&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="k">raise</span> <span class="no">Exception</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;You must pass in the pack id!&quot;</span><span class="p">)</span> <span class="k">unless</span> <span class="no">ARGV</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'><span class="n">pack_id</span> <span class="o">=</span> <span class="no">ARGV</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span>
</span><span class='line'><span class="n">note_extractor</span> <span class="o">=</span> <span class="err">λ</span><span class="p">{</span><span class="o">|</span><span class="n">filename</span><span class="o">|</span> <span class="n">filename</span><span class="o">.</span><span class="n">gsub</span><span class="p">(</span><span class="sr">/Transverse-Flute |\.wav|Tenuto|NonVibrato|-/</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">gsub</span><span class="p">(</span><span class="sr">/ NonVibrato/</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)}</span>
</span><span class='line'>
</span><span class='line'><span class="n">data</span> <span class="o">=</span> <span class="no">JSON</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="sb">`curl --silent &quot;http://www.freesound.org/api/packs/</span><span class="si">#{</span><span class="n">pack_id</span><span class="si">}</span><span class="sb">/sounds/?api_key=47efd585321048819a2328721507ee23&quot;`</span><span class="p">)</span>
</span><span class='line'><span class="n">number_of_pages</span> <span class="o">=</span> <span class="n">data</span><span class="o">[</span><span class="s2">&quot;num_pages&quot;</span><span class="o">]</span> <span class="o">||</span> <span class="mi">1</span>
</span><span class='line'>
</span><span class='line'><span class="n">number_of_pages</span><span class="o">.</span><span class="n">times</span> <span class="k">do</span> <span class="o">|</span><span class="n">page</span><span class="o">|</span>
</span><span class='line'>  <span class="n">data</span> <span class="o">=</span> <span class="no">JSON</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="sb">`curl --silent &quot;http://www.freesound.org/api/packs/</span><span class="si">#{</span><span class="n">pack_id</span><span class="si">}</span><span class="sb">/sounds/?api_key=47efd585321048819a2328721507ee23&amp;p=</span><span class="si">#{</span><span class="n">page</span> <span class="o">+</span> <span class="mi">1</span><span class="si">}</span><span class="sb">&quot;`</span><span class="p">)</span>
</span><span class='line'>  <span class="n">sound_ids</span> <span class="o">=</span> <span class="n">data</span><span class="o">[</span><span class="s2">&quot;sounds&quot;</span><span class="o">].</span><span class="n">map</span><span class="p">{</span><span class="o">|</span><span class="n">sound</span><span class="o">|</span> <span class="n">sound</span><span class="o">[</span><span class="s2">&quot;id&quot;</span><span class="o">]</span><span class="p">}</span>
</span><span class='line'>  <span class="n">note_names</span> <span class="o">=</span> <span class="n">data</span><span class="o">[</span><span class="s2">&quot;sounds&quot;</span><span class="o">].</span><span class="n">map</span><span class="p">{</span><span class="o">|</span><span class="n">sound</span><span class="o">|</span> <span class="n">note_extractor</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">sound</span><span class="o">[</span><span class="s2">&quot;original_filename&quot;</span><span class="o">]</span><span class="p">)}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">sound_ids</span><span class="o">.</span><span class="n">each_with_index</span> <span class="k">do</span> <span class="o">|</span><span class="n">sound_id</span><span class="p">,</span> <span class="n">index</span><span class="o">|</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">sound_id</span><span class="si">}</span><span class="s2"> :</span><span class="si">#{</span><span class="n">note_names</span><span class="o">[</span><span class="n">index</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Adding these to our Clojure code we have a Freesound ID to note mapping:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">FREESOUND-VIBRATO-FLUTE-SAMPLES</span>
</span><span class='line'>  <span class="s">&quot;Freesound ids for all samples in the Vibrato Transverse Flute pack&quot;</span>
</span><span class='line'>  <span class="p">{</span><span class="mi">154274</span> <span class="ss">:C7</span>  <span class="mi">154273</span> <span class="ss">:B6</span> <span class="mi">154272</span> <span class="ss">:A#6</span> <span class="mi">154271</span> <span class="ss">:A6</span> <span class="mi">154270</span> <span class="ss">:G#6</span> <span class="mi">154269</span> <span class="ss">:G6</span>  <span class="mi">154268</span> <span class="ss">:F#6</span>
</span><span class='line'>   <span class="mi">154267</span> <span class="ss">:F6</span>  <span class="mi">154266</span> <span class="ss">:E6</span> <span class="mi">154265</span> <span class="ss">:D#6</span> <span class="mi">154264</span> <span class="ss">:D6</span> <span class="mi">154263</span> <span class="ss">:C#6</span> <span class="mi">154262</span> <span class="ss">:C6</span>  <span class="mi">154261</span> <span class="ss">:B5</span>
</span><span class='line'>   <span class="mi">154260</span> <span class="ss">:A#5</span> <span class="mi">154259</span> <span class="ss">:A5</span> <span class="mi">154258</span> <span class="ss">:G#5</span> <span class="mi">154257</span> <span class="ss">:G5</span> <span class="mi">154256</span> <span class="ss">:F#5</span> <span class="mi">154255</span> <span class="ss">:F5</span>  <span class="mi">154254</span> <span class="ss">:E5</span>
</span><span class='line'>   <span class="mi">154253</span> <span class="ss">:D#5</span> <span class="mi">154252</span> <span class="ss">:D5</span> <span class="mi">154251</span> <span class="ss">:C#5</span> <span class="mi">154250</span> <span class="ss">:C5</span> <span class="mi">154249</span> <span class="ss">:B4</span>  <span class="mi">154248</span> <span class="ss">:A#4</span> <span class="mi">154247</span> <span class="ss">:A4</span>
</span><span class='line'>   <span class="mi">154246</span> <span class="ss">:G#4</span> <span class="mi">154245</span> <span class="ss">:G4</span> <span class="mi">154244</span> <span class="ss">:F#4</span> <span class="mi">154243</span> <span class="ss">:E4</span> <span class="mi">154242</span> <span class="ss">:F4</span>  <span class="mi">154241</span> <span class="ss">:D#4</span> <span class="mi">154240</span> <span class="ss">:D4</span>
</span><span class='line'>   <span class="mi">154239</span> <span class="ss">:C#4</span> <span class="mi">154238</span> <span class="ss">:C4</span><span class="p">})</span>
</span></code></pre></td></tr></table></div></figure>


<p>These samples are cached in the asset store (usually ~/.overtone/assets) so we don&rsquo;t have to keep downloading them. We define a cache key for our downloaded samples.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn- </span><span class="nv">registered-samples</span>
</span><span class='line'>  <span class="s">&quot;Fetch flute samples from the asset store if they have been manually registered&quot;</span>
</span><span class='line'>  <span class="p">[]</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">registered-assets</span> <span class="ss">::TransverseFluteTenutoVibrato</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Load all the samples into Overtone. This will automatically download the samples if they are not already present.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">flute-samples</span>
</span><span class='line'>  <span class="p">(</span><span class="nb">doall </span><span class="p">(</span><span class="nb">map </span><span class="nv">freesound-sample</span> <span class="p">(</span><span class="nb">keys </span><span class="nv">FREESOUND-VIBRATO-FLUTE-SAMPLES</span><span class="p">))))</span>
</span></code></pre></td></tr></table></div></figure>


<p>In order to play the samples we need to produce a mapping between the buffer that has the sound loaded and the midi pitch that buffer relates to.</p>

<p>First we convert a freesound-id into a midi note (pitch)</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn- </span><span class="nv">buffer-&gt;midi-note</span> <span class="p">[</span><span class="nv">buf</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="nb">-&gt; </span><span class="nv">buf</span> <span class="ss">:freesound-id</span> <span class="nv">FREESOUND-VIBRATO-FLUTE-SAMPLES</span> <span class="nb">name </span><span class="nv">note</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now we can generate the buffer id to midi note map.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn- </span><span class="nv">note-index</span>
</span><span class='line'>  <span class="s">&quot;Returns a map of midi-note values [0-127] to buffer ids.&quot;</span>
</span><span class='line'>  <span class="p">[</span><span class="nv">buffers</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="nb">reduce </span><span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nb">index </span><span class="nv">buf</span><span class="p">]</span>
</span><span class='line'>            <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">id</span> <span class="p">(</span><span class="nb">-&gt; </span><span class="nv">buf</span> <span class="ss">:id</span><span class="p">)</span>
</span><span class='line'>                  <span class="nv">note</span> <span class="p">(</span><span class="nf">buffer-&gt;midi-note</span> <span class="nv">buf</span><span class="p">)]</span>
</span><span class='line'>              <span class="p">(</span><span class="nb">assoc index </span><span class="nv">note</span> <span class="nv">id</span><span class="p">)))</span>
</span><span class='line'>          <span class="p">{}</span>
</span><span class='line'>          <span class="nv">buffers</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>And we use this to set the buffers:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="c1">;Silent buffer used to ensure all 127 buffer spaces are filled </span>
</span><span class='line'><span class="p">(</span><span class="kd">defonce </span><span class="o">^</span><span class="ss">:private</span> <span class="nv">silent-buffer</span> <span class="p">(</span><span class="nf">buffer</span> <span class="mi">0</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defonce </span><span class="nv">index-buffer</span>
</span><span class='line'>  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">tab</span> <span class="p">(</span><span class="nf">note-index</span> <span class="nv">flute-samples</span><span class="p">)</span>
</span><span class='line'>        <span class="nv">buf</span> <span class="p">(</span><span class="nf">buffer</span> <span class="mi">128</span><span class="p">)]</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">buffer-fill!</span> <span class="nv">buf</span> <span class="p">(</span><span class="ss">:id</span> <span class="nv">silent-buffer</span><span class="p">))</span>
</span><span class='line'>    <span class="p">(</span><span class="nb">doseq </span><span class="p">[[</span><span class="nv">idx</span> <span class="nv">val</span><span class="p">]</span> <span class="nv">tab</span><span class="p">]</span>
</span><span class='line'>      <span class="p">(</span><span class="nf">buffer-set!</span> <span class="nv">buf</span> <span class="nv">idx</span> <span class="nv">val</span><span class="p">))</span>
</span><span class='line'>    <span class="nv">buf</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Defining the Instrument</h2>

<p>Now we have all our samples we define a instrument in Overtone using <code>definst</code>:</p>

<p>This allows us to specify a (huge) number of options on how our samples are played.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">definst</span> <span class="nv">sampled-flute-vibrato</span>
</span><span class='line'>  <span class="p">[</span><span class="nv">note</span> <span class="mi">60</span> <span class="nv">level</span> <span class="mi">1</span> <span class="nv">rate</span> <span class="mi">1</span> <span class="nv">loop?</span> <span class="mi">0</span> <span class="nv">attack</span> <span class="mi">0</span> <span class="nv">decay</span> <span class="mi">1</span> <span class="nv">sustain</span> <span class="mi">1</span> <span class="nv">release</span> <span class="mf">0.1</span> <span class="nv">curve</span> <span class="mi">-4</span> <span class="nv">gate</span> <span class="mi">1</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">buf</span> <span class="p">(</span><span class="nf">index</span><span class="ss">:kr</span> <span class="p">(</span><span class="ss">:id</span> <span class="nv">index-buffer</span><span class="p">)</span> <span class="nv">note</span><span class="p">)</span>
</span><span class='line'>        <span class="nv">env</span> <span class="p">(</span><span class="nf">env-gen</span> <span class="p">(</span><span class="nf">adsr</span> <span class="nv">attack</span> <span class="nv">decay</span> <span class="nv">sustain</span> <span class="nv">release</span> <span class="nv">level</span> <span class="nv">curve</span><span class="p">)</span>
</span><span class='line'>                     <span class="ss">:gate</span> <span class="nv">gate</span>
</span><span class='line'>                     <span class="ss">:action</span> <span class="nv">FREE</span><span class="p">)]</span>
</span><span class='line'>    <span class="p">(</span><span class="nb">* </span><span class="nv">env</span> <span class="p">(</span><span class="nf">scaled-play-buf</span> <span class="mi">2</span> <span class="nv">buf</span> <span class="ss">:level</span> <span class="nv">level</span> <span class="ss">:loop</span> <span class="nv">loop?</span> <span class="ss">:action</span> <span class="nv">FREE</span><span class="p">))))</span>
</span></code></pre></td></tr></table></div></figure>


<p>There is quite a lot going on here. Lets focus on the configuration that effects how our sound samples are played.</p>

<h3>Defining the Envelope Generator (env-gen).</h3>

<p>An envelope generator (mapping to function <code>env-gen</code>) makes an audio signal that smoothly rises and falls. We are taking the recording of the real flute instrument as a digitized waveform, and then playing back its recordings at different speeds to produce different tones.</p>

<p>The most common form of envelope generator and the one we are using here is ADSR:</p>

<p>attack (A), decay (D), sustain (S) and release &#40;R)</p>

<p><img src="/images/ADSR.png" /></p>

<p>There are a number of other config settings in our example:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">[</span>
</span><span class='line'> <span class="nv">note</span> <span class="mi">60</span>     <span class="c1">; Default pitch</span>
</span><span class='line'> <span class="nv">level</span> <span class="mi">1</span>     <span class="c1">; Volume</span>
</span><span class='line'> <span class="nv">rate</span> <span class="mi">1</span>      <span class="c1">; Playback rate </span>
</span><span class='line'> <span class="nv">loop?</span> <span class="mi">0</span>     <span class="c1">; The note should loop after the first play</span>
</span><span class='line'> <span class="nv">attack</span> <span class="mi">0</span>    <span class="c1">; The way a sound is initiated. Fast attack (gunshot) vs Slow attack (closing a door slowly)</span>
</span><span class='line'> <span class="nv">decay</span> <span class="mi">1</span>     <span class="c1">; The time for notes to decay after the initial strike</span>
</span><span class='line'> <span class="nv">sustain</span> <span class="mi">1</span>   <span class="c1">; Once a sound has reached its peak, the length of time that the sound will sustain.</span>
</span><span class='line'> <span class="nv">release</span> <span class="mf">0.1</span> <span class="c1">; The time for notes to decay after the key is released</span>
</span><span class='line'> <span class="nv">curve</span> <span class="mi">-4</span>    <span class="c1">; Curve factor</span>
</span><span class='line'> <span class="nv">gate</span> <span class="mi">1</span>      <span class="c1">; note occurs when gate goes from nonpositive to positive. Note off occurs when it goes from positive to nonpositive</span>
</span><span class='line'><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Look to the <a href="http://supercollider.sourceforge.net/">SuperCollider</a> documentation on <a href="http://doc.sccode.org/Classes/UGen.html">UGENs</a> if you want to see all possible configuration options. Overtone is really a wrapper around the extremely powerful SuperCollider.</p>

<h2>Grand finale</h2>

<p>Finally we can start to play music in overtone using our flute:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">sampled-flute-vibrato</span> <span class="mi">60</span><span class="p">)</span> <span class="o">#</span><span class="nv">=&gt;</span> <span class="nv">pitch</span> <span class="mi">60</span>
</span><span class='line'><span class="p">(</span><span class="nf">sampled-flute-vibrato</span> <span class="mi">61</span><span class="p">)</span> <span class="o">#</span><span class="nv">=&gt;</span> <span class="nv">pitch</span> <span class="mi">61</span>
</span><span class='line'><span class="p">(</span><span class="nf">sampled-flute-vibrato</span> <span class="mi">60</span><span class="p">)</span> <span class="o">#</span><span class="nv">=&gt;</span> <span class="nv">pitch</span> <span class="mi">60</span>
</span></code></pre></td></tr></table></div></figure>


<p>Hear for yourself:</p>

<iframe width="100%" height="166" scrolling="no" frameborder="no" src="https://w.soundcloud.com/player/?url=http%3A%2F%2Fapi.soundcloud.com%2Ftracks%2F107183072&amp;color=ff6600&amp;auto_play=false&amp;show_artwork=false"></iframe>


<h2>The Code in Full</h2>

<p>Defining an instrument in Overtone:</p>

<figure class='code'><figcaption><span>Loading buffers </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">ns </span><span class="nv">overtone.samples.flute-vibrato</span>
</span><span class='line'>  <span class="p">(</span><span class="ss">:use</span> <span class="p">[</span><span class="nv">overtone.core</span><span class="p">])</span>
</span><span class='line'>  <span class="p">(</span><span class="ss">:require</span> <span class="p">[</span><span class="nv">clojure.string</span> <span class="ss">:as</span> <span class="nv">str</span><span class="p">]))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defn- </span><span class="nv">registered-samples</span>
</span><span class='line'>  <span class="s">&quot;Fetch flute samples from the asset store if they have been manually</span>
</span><span class='line'><span class="s">  registered&quot;</span>
</span><span class='line'>  <span class="p">[]</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">registered-assets</span> <span class="ss">::TransverseFluteTenutoVibrato</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">FREESOUND-VIBRATO-FLUTE-SAMPLES</span>
</span><span class='line'>  <span class="s">&quot;Freesound ids for all samples in the Vibrato Transverse Flute pack&quot;</span>
</span><span class='line'>  <span class="p">{</span><span class="mi">154274</span> <span class="ss">:C7</span>  <span class="mi">154273</span> <span class="ss">:B6</span> <span class="mi">154272</span> <span class="ss">:A#6</span> <span class="mi">154271</span> <span class="ss">:A6</span> <span class="mi">154270</span> <span class="ss">:G#6</span> <span class="mi">154269</span> <span class="ss">:G6</span>  <span class="mi">154268</span> <span class="ss">:F#6</span>
</span><span class='line'>   <span class="mi">154267</span> <span class="ss">:F6</span>  <span class="mi">154266</span> <span class="ss">:E6</span> <span class="mi">154265</span> <span class="ss">:D#6</span> <span class="mi">154264</span> <span class="ss">:D6</span> <span class="mi">154263</span> <span class="ss">:C#6</span> <span class="mi">154262</span> <span class="ss">:C6</span>  <span class="mi">154261</span> <span class="ss">:B5</span>
</span><span class='line'>   <span class="mi">154260</span> <span class="ss">:A#5</span> <span class="mi">154259</span> <span class="ss">:A5</span> <span class="mi">154258</span> <span class="ss">:G#5</span> <span class="mi">154257</span> <span class="ss">:G5</span> <span class="mi">154256</span> <span class="ss">:F#5</span> <span class="mi">154255</span> <span class="ss">:F5</span>  <span class="mi">154254</span> <span class="ss">:E5</span>
</span><span class='line'>   <span class="mi">154253</span> <span class="ss">:D#5</span> <span class="mi">154252</span> <span class="ss">:D5</span> <span class="mi">154251</span> <span class="ss">:C#5</span> <span class="mi">154250</span> <span class="ss">:C5</span> <span class="mi">154249</span> <span class="ss">:B4</span>  <span class="mi">154248</span> <span class="ss">:A#4</span> <span class="mi">154247</span> <span class="ss">:A4</span>
</span><span class='line'>   <span class="mi">154246</span> <span class="ss">:G#4</span> <span class="mi">154245</span> <span class="ss">:G4</span> <span class="mi">154244</span> <span class="ss">:F#4</span> <span class="mi">154243</span> <span class="ss">:E4</span> <span class="mi">154242</span> <span class="ss">:F4</span>  <span class="mi">154241</span> <span class="ss">:D#4</span> <span class="mi">154240</span> <span class="ss">:D4</span>
</span><span class='line'>   <span class="mi">154239</span> <span class="ss">:C#4</span> <span class="mi">154238</span> <span class="ss">:C4</span><span class="p">})</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">FLUTE-SAMPLE-IDS</span> <span class="p">(</span><span class="nb">keys </span><span class="nv">FREESOUND-VIBRATO-FLUTE-SAMPLES</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">flute-samples</span>
</span><span class='line'>  <span class="p">(</span><span class="nb">doall </span><span class="p">(</span><span class="nb">map </span><span class="nv">freesound-sample</span> <span class="nv">FLUTE-SAMPLE-IDS</span><span class="p">)))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defn- </span><span class="nv">buffer-&gt;midi-note</span> <span class="p">[</span><span class="nv">buf</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="nb">-&gt; </span><span class="nv">buf</span> <span class="ss">:freesound-id</span> <span class="nv">FREESOUND-VIBRATO-FLUTE-SAMPLES</span> <span class="nb">name </span><span class="nv">note</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defn- </span><span class="nv">note-index</span>
</span><span class='line'>  <span class="s">&quot;Returns a map of midi-note values [0-127] to buffer ids.&quot;</span>
</span><span class='line'>  <span class="p">[</span><span class="nv">buffers</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="nb">reduce </span><span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nb">index </span><span class="nv">buf</span><span class="p">]</span>
</span><span class='line'>            <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">id</span> <span class="p">(</span><span class="nb">-&gt; </span><span class="nv">buf</span> <span class="ss">:id</span><span class="p">)</span>
</span><span class='line'>                  <span class="nv">note</span> <span class="p">(</span><span class="nf">buffer-&gt;midi-note</span> <span class="nv">buf</span><span class="p">)]</span>
</span><span class='line'>              <span class="p">(</span><span class="nb">assoc index </span><span class="nv">note</span> <span class="nv">id</span><span class="p">)))</span>
</span><span class='line'>          <span class="p">{}</span>
</span><span class='line'>          <span class="nv">buffers</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="c1">;; Silent buffer used to fill in the gaps.</span>
</span><span class='line'><span class="p">(</span><span class="kd">defonce </span><span class="o">^</span><span class="ss">:private</span> <span class="nv">silent-buffer</span> <span class="p">(</span><span class="nf">buffer</span> <span class="mi">0</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defonce </span><span class="nv">index-buffer</span>
</span><span class='line'>  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">tab</span> <span class="p">(</span><span class="nf">note-index</span> <span class="nv">flute-samples</span><span class="p">)</span>
</span><span class='line'>        <span class="nv">buf</span> <span class="p">(</span><span class="nf">buffer</span> <span class="mi">128</span><span class="p">)]</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">buffer-fill!</span> <span class="nv">buf</span> <span class="p">(</span><span class="ss">:id</span> <span class="nv">silent-buffer</span><span class="p">))</span>
</span><span class='line'>    <span class="p">(</span><span class="nb">doseq </span><span class="p">[[</span><span class="nv">idx</span> <span class="nv">val</span><span class="p">]</span> <span class="nv">tab</span><span class="p">]</span>
</span><span class='line'>      <span class="p">(</span><span class="nf">buffer-set!</span> <span class="nv">buf</span> <span class="nv">idx</span> <span class="nv">val</span><span class="p">))</span>
</span><span class='line'>    <span class="nv">buf</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>Defining the instrument </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">ns </span><span class="nv">overtone.inst.sampled-flute</span>
</span><span class='line'>  <span class="p">(</span><span class="ss">:use</span> <span class="p">[</span><span class="nv">overtone.core</span><span class="p">])</span>
</span><span class='line'>  <span class="p">(</span><span class="ss">:require</span>
</span><span class='line'>   <span class="p">[</span><span class="nv">overtone.samples.flute-vibrato</span> <span class="ss">:as</span> <span class="nv">vibrato</span><span class="p">]))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">definst</span> <span class="nv">sampled-flute-vibrato</span>
</span><span class='line'>  <span class="p">[</span><span class="nv">note</span> <span class="mi">60</span> <span class="nv">level</span> <span class="mi">1</span> <span class="nv">rate</span> <span class="mi">1</span> <span class="nv">loop?</span> <span class="mi">0</span>
</span><span class='line'>   <span class="nv">attack</span> <span class="mi">0</span> <span class="nv">decay</span> <span class="mi">1</span> <span class="nv">sustain</span> <span class="mi">1</span> <span class="nv">release</span> <span class="mf">0.1</span> <span class="nv">curve</span> <span class="mi">-4</span> <span class="nv">gate</span> <span class="mi">1</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">buf</span> <span class="p">(</span><span class="nf">index</span><span class="ss">:kr</span> <span class="p">(</span><span class="ss">:id</span> <span class="nv">vibrato/index-buffer</span><span class="p">)</span> <span class="nv">note</span><span class="p">)</span>
</span><span class='line'>        <span class="nv">env</span> <span class="p">(</span><span class="nf">env-gen</span> <span class="p">(</span><span class="nf">adsr</span> <span class="nv">attack</span> <span class="nv">decay</span> <span class="nv">sustain</span> <span class="nv">release</span> <span class="nv">level</span> <span class="nv">curve</span><span class="p">)</span>
</span><span class='line'>                     <span class="ss">:gate</span> <span class="nv">gate</span>
</span><span class='line'>                     <span class="ss">:action</span> <span class="nv">FREE</span><span class="p">)]</span>
</span><span class='line'>    <span class="p">(</span><span class="nb">* </span><span class="nv">env</span> <span class="p">(</span><span class="nf">scaled-play-buf</span> <span class="mi">2</span> <span class="nv">buf</span> <span class="ss">:level</span> <span class="nv">level</span> <span class="ss">:loop</span> <span class="nv">loop?</span> <span class="ss">:action</span> <span class="nv">FREE</span><span class="p">))))</span>
</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/elixir/sets-in-elixir.html">Sets in Elixir</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-07-02T14:43:00+01:00" pubdate data-updated="true">Jul 2<span>nd</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I recently contributed the <code>Set</code> data structure to the <a href="http://elixir-lang.org/">Elixir</a> programming language.
The <code>Set</code> is implemented through a HashSet.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='elixir'><span class='line'><span class="n">s1</span> <span class="o">=</span> <span class="no">HashSet</span><span class="o">.</span><span class="n">new</span><span class="p">([</span><span class="m">1</span><span class="p">,</span> <span class="m">2</span><span class="p">,</span> <span class="m">3</span><span class="p">,</span> <span class="m">4</span><span class="p">])</span>
</span><span class='line'><span class="n">s2</span> <span class="o">=</span> <span class="no">HashSet</span><span class="o">.</span><span class="n">new</span><span class="p">([</span><span class="m">3</span><span class="p">,</span> <span class="m">4</span><span class="p">])</span>
</span><span class='line'>
</span><span class='line'><span class="no">Set</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">)</span> <span class="c1"># =&gt; HashSet&lt;[1, 2]&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Elixir&rsquo;s Set implementation is often faster than Erlangs own <a href="http://www.erlang.org/doc/man/sets.html">sets</a>. Which is pretty impressive since Elixir runs on the same Erlang VM. It does this by adapting the internal data structure based on the size of the sets.</p>

<p>Lets explore how Elixir does this while also explaining a little about Elixir:</p>

<h2>Growing Data structures</h2>

<p>For small sets the internal representation uses an ordered set (which really is just a list).</p>

<p>We refer to this as a Bucket.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='elixir'><span class='line'><span class="p">[</span><span class="m">1</span><span class="p">,</span> <span class="m">2</span><span class="p">,</span> <span class="m">3</span><span class="p">,</span> <span class="m">4</span><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Being ordered allows us to perform faster access and modification.</p>

<p>For example finding a member of a set:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='elixir'><span class='line'><span class="c1"># Only needs a single comparison to know if 1 is in the Set.</span>
</span><span class='line'><span class="c1"># Since the first element is greater than 1 we know its not in the Set.</span>
</span><span class='line'><span class="no">Set</span><span class="o">.</span><span class="n">member?</span><span class="p">(</span><span class="no">HashSet</span><span class="o">.</span><span class="n">new</span> <span class="p">[</span><span class="m">2</span><span class="p">,</span> <span class="m">3</span><span class="p">,</span> <span class="m">4</span><span class="p">,</span> <span class="m">5</span><span class="p">],</span> <span class="m">1</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Order in the list is not maintained in the data structure but in the insertion/put:</p>

<h3>Putting elements into a Bucket</h3>

<p>Before we jump into some Elixir code its important to understand that the order of functions in Elixir is important. We start from the top function and if this function matches a criteria we call it otherwise we try the function below and so on. If we find no function that matches that&rsquo;s a error and execution aborts.</p>

<p>Here is the Elixir code for inserting a member into a bucket.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='elixir'><span class='line'><span class="c1"># We have found the place to insert the new member.</span>
</span><span class='line'><span class="k">defp</span> <span class="n">bucket_put</span><span class="p">([</span><span class="n">m</span><span class="o">|</span><span class="n">_</span><span class="p">]</span><span class="o">=</span><span class="n">bucket</span><span class="p">,</span> <span class="n">member</span><span class="p">)</span> <span class="ow">when</span> <span class="n">m</span> <span class="o">&gt;</span> <span class="n">member</span> <span class="k">do </span>
</span><span class='line'><span class="k">  </span><span class="p">{</span> <span class="p">[</span><span class="n">member</span><span class="o">|</span><span class="n">bucket</span><span class="p">],</span> <span class="m">1</span> <span class="p">}</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Member is already in the set, we don&#39;t added it. (notice how member is being used to pattern match here).</span>
</span><span class='line'><span class="c1"># Its the same as writing: `defp bucket_put([m|bucket], member) when m == member do</span>
</span><span class='line'><span class="k">defp</span> <span class="n">bucket_put</span><span class="p">([</span><span class="n">member</span><span class="o">|</span><span class="n">bucket</span><span class="p">],</span> <span class="n">member</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'><span class="k">  </span><span class="p">{</span> <span class="p">[</span><span class="n">member</span><span class="o">|</span><span class="n">bucket</span><span class="p">],</span> <span class="m">0</span> <span class="p">}</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Recursive case, keep calling bucket_put as this is not the point to insert.</span>
</span><span class='line'><span class="k">defp</span> <span class="n">bucket_put</span><span class="p">([</span><span class="n">e</span><span class="o">|</span><span class="n">bucket</span><span class="p">],</span> <span class="n">member</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'><span class="k">  </span><span class="p">{</span> <span class="n">rest</span><span class="p">,</span> <span class="n">count</span> <span class="p">}</span> <span class="o">=</span> <span class="n">bucket_put</span><span class="p">(</span><span class="n">bucket</span><span class="p">,</span> <span class="n">member</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span> <span class="p">[</span><span class="n">e</span><span class="o">|</span><span class="n">rest</span><span class="p">],</span> <span class="n">count</span> <span class="p">}</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Empty set, insert the number</span>
</span><span class='line'><span class="k">defp</span> <span class="n">bucket_put</span><span class="p">([],</span> <span class="n">member</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'><span class="k">  </span><span class="p">{</span> <span class="p">[</span><span class="n">member</span><span class="p">],</span> <span class="m">1</span> <span class="p">}</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Expanding into a Trie</h2>

<p>Upon reaching a threshold the Set changes the internal representation into a Trie (What the hell is a <a href="http://en.wikipedia.org/wiki/Trie">trie</a>).</p>

<p>Why a Trie?</p>

<blockquote><p>For a Trie the time required for insert, delete and find operations is almost identical.
As a result, for situations where code is inserting, deleting and finding in equal measure, tries can handily beat binary search trees.</p></blockquote>

<p>In a Trie we don&rsquo;t store any keys or hashes, instead a elements position in the tree defines the key with which it is associated.</p>

<p>Hence we can take advantage of Erlangs fast <a href="http://www.erlang.org/doc/reference_manual/data_types.html#id65673">tuples</a> to model the trie. A multi-depth trie is just tuples inside tuples.</p>

<h3>Buckets growing into Tries</h3>

<p>Lets work through an example. For simplicity we will assume the expansion happens at the very small size of 5 elements:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='elixir'><span class='line'><span class="n">set</span> <span class="o">=</span> <span class="no">Set</span><span class="o">.</span><span class="n">new</span> <span class="p">[</span><span class="m">0</span><span class="p">,</span> <span class="m">1</span><span class="p">,</span> <span class="m">2</span><span class="p">,</span> <span class="m">3</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Apply an operation that forces the internal structure to change</span>
</span><span class='line'><span class="n">set</span> <span class="o">=</span> <span class="no">Set</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">set</span><span class="p">,</span> <span class="m">4</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<h4>Create a new Erlang Tuple</h4>

<p><img alt="bucket to trie" src="/images/trie_step1.png"/></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='elixir'><span class='line'>  <span class="ss">:erlang</span><span class="o">.</span><span class="n">make_tuple</span><span class="p">(</span><span class="n">node_size</span> <span class="o">=</span> <span class="m">4</span><span class="p">,</span> <span class="p">[])</span>
</span></code></pre></td></tr></table></div></figure>


<h4>Redistribute the bucket elements into the Tuple</h4>

<p><img alt="bucket to trie" src="/images/trie_step2.png"/></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='elixir'><span class='line'><span class="c1"># This returns the index that a set value should have in the tuple.</span>
</span><span class='line'><span class="k">defp</span> <span class="n">bucket_nth_index</span><span class="p">(</span><span class="n">set_value</span><span class="p">,</span> <span class="n">trie_depth</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'><span class="k">  </span><span class="n">node_shift</span> <span class="o">=</span> <span class="m">2</span>
</span><span class='line'>  <span class="n">node_bitmap</span> <span class="o">=</span> <span class="m">0b0011</span>
</span><span class='line'>
</span><span class='line'>  <span class="p">(</span><span class="ss">:erlang</span><span class="o">.</span><span class="n">phash2</span><span class="p">(</span><span class="n">set_value</span><span class="p">)</span> <span class="o">&gt;&gt;&gt;</span> <span class="p">(</span><span class="n">node_shift</span> <span class="o">*</span> <span class="n">trie_depth</span><span class="p">))</span> <span class="o">&amp;&amp;</span><span class="err">&amp;</span> <span class="n">node_bitmap</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Create a new node or add to an existing node.</span>
</span><span class='line'><span class="c1"># Based on the bucket_nth_index of the set member put it into a bucket at that index in the tuple.</span>
</span><span class='line'><span class="k">defp</span> <span class="n">node_relocate</span><span class="p">(</span><span class="n">node</span> <span class="o">//</span> <span class="ss">:erlang</span><span class="o">.</span><span class="n">make_tuple</span><span class="p">(</span><span class="n">node_size</span> <span class="o">=</span> <span class="m">4</span><span class="p">,</span> <span class="p">[]),</span> <span class="n">bucket</span><span class="p">,</span> <span class="n">depth</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'><span class="k">  </span><span class="ss">:lists</span><span class="o">.</span><span class="n">foldl</span> <span class="k">fn</span> <span class="n">member</span><span class="p">,</span> <span class="n">new_node</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="n">position_in_tuple</span> <span class="o">=</span> <span class="n">bucket_nth_index</span><span class="p">(</span><span class="n">member</span><span class="p">,</span> <span class="n">depth</span><span class="p">)</span>
</span><span class='line'>    <span class="n">set_elem</span><span class="p">(</span><span class="n">new_node</span><span class="p">,</span> <span class="n">position_in_tuple</span><span class="p">,</span> <span class="n">bucket_put</span><span class="p">(</span><span class="n">elem</span><span class="p">(</span><span class="n">new_node</span><span class="p">,</span> <span class="n">position_in_tuple</span><span class="p">),</span> <span class="n">member</span><span class="p">))</span>
</span><span class='line'>  <span class="k">end</span><span class="p">,</span> <span class="n">new_node</span><span class="p">,</span> <span class="n">bucket</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h4>Finally add the new set member into the Trie</h4>

<p><img alt="bucket to trie" src="/images/trie_step3.png"/></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='elixir'><span class='line'><span class="c1"># Base case. We have found the right bucket, just insert the new member into it.</span>
</span><span class='line'><span class="k">defp</span> <span class="n">node_put</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">member</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'><span class="k">  </span><span class="n">position</span> <span class="o">=</span> <span class="n">bucket_index</span><span class="p">(</span><span class="n">member</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span> <span class="n">new</span><span class="p">,</span> <span class="n">count</span> <span class="p">}</span> <span class="o">=</span> <span class="n">bucket_put</span><span class="p">(</span><span class="n">elem</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">position</span><span class="p">),</span> <span class="n">member</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span> <span class="n">set_elem</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">position</span><span class="p">,</span> <span class="n">new</span><span class="p">),</span> <span class="n">count</span> <span class="p">}</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Recursive case. Keeping trying to find the right bucket.</span>
</span><span class='line'><span class="k">defp</span> <span class="n">node_put</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">member</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'><span class="k">  </span><span class="n">position</span> <span class="o">=</span> <span class="n">bucket_index</span><span class="p">(</span><span class="n">member</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span> <span class="n">new</span><span class="p">,</span> <span class="n">count</span> <span class="p">}</span> <span class="o">=</span> <span class="n">node_put</span><span class="p">(</span><span class="n">elem</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">position</span><span class="p">),</span> <span class="n">depth</span> <span class="o">-</span> <span class="m">1</span><span class="p">,</span> <span class="n">bucket_next</span><span class="p">(</span><span class="n">hash</span><span class="p">),</span> <span class="n">member</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span> <span class="n">set_elem</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">position</span><span class="p">,</span> <span class="n">new</span><span class="p">),</span> <span class="n">count</span> <span class="p">}</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># The bucket index of this member</span>
</span><span class='line'><span class="k">defp</span> <span class="n">bucket_index</span><span class="p">(</span><span class="n">member</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'><span class="k">  </span><span class="n">node_bitmap</span> <span class="o">=</span> <span class="m">0b0011</span>
</span><span class='line'>  <span class="n">hash</span> <span class="o">=</span> <span class="ss">:erlang</span><span class="o">.</span><span class="n">phash2</span><span class="p">(</span><span class="n">member</span><span class="p">)</span>
</span><span class='line'>  <span class="n">hash</span> <span class="o">&amp;&amp;</span><span class="err">&amp;</span> <span class="n">node_bitmap</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># The bucket index of this element with depth + 1.</span>
</span><span class='line'><span class="k">defp</span> <span class="n">bucket_next</span><span class="p">(</span><span class="n">member</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'><span class="k">  </span><span class="n">node_shift</span> <span class="o">=</span> <span class="m">2</span>
</span><span class='line'>  <span class="n">hash</span> <span class="o">=</span> <span class="ss">:erlang</span><span class="o">.</span><span class="n">phash2</span><span class="p">(</span><span class="n">member</span><span class="p">)</span>
</span><span class='line'>  <span class="n">hash</span> <span class="o">&gt;&gt;&gt;</span> <span class="n">node_shift</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Notice while we have a more complicated data structure with a trie the leaves are always plain old buckets. Hence insertion with a trie is a case of finding the right bucket and then just reusing our <code>bucket_put</code> function. Beautiful and fast :)</p>

<h4>Tries expanding into deeper Tries</h4>

<p>Things get a little more complicated with multi depth tries. If you are interested digging more into the implementation you can see all the <a href="https://github.com/elixir-lang/elixir/blob/master/lib/elixir/lib/hash_set.ex">source code of HashSet</a> on Github.</p>

<h2>Contraction</h2>

<p>We can also remove elements from a set so in much the same as we expanded we have to contract the internal representation of the set.</p>

<h1>Performance Benchmarks</h1>

<p>Here is some sample data comparing Erlang sets to Elixir Sets. Smaller is better.</p>

<p><img alt="HashSet vs :sets" src="/images/sets_vs_hashset.png"/></p>

<p>The benchmark scripts are on github (<a href="https://gist.github.com/josephwilk/5808525">https://gist.github.com/josephwilk/5808525</a>) if you are interested in running them yourself.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/clojure/isolating-external-dependencies-in-clojure.html">Isolating External Dependencies in Clojure</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-06-08T12:00:00+01:00" pubdate data-updated="true">Jun 8<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Isolating external dependencies helps make testing easier. We can focus on a specific unit of code and we can avoid slow tests calling real services or databases.</p>

<p>Clojure provides many different ways of achieving isolation. Lets explore what&rsquo;s possible:</p>

<h2>Redefining functions</h2>

<p>We can redefine vars and hence functions in a limited scope with <a href="http://clojuredocs.org/clojure_core/clojure.core/with-redefs">with-redefs</a></p>

<p>The documentation suggests its usefulness in testing:</p>

<blockquote><p>Useful for mocking out functions during testing.</p></blockquote>

<p>Lets look at an example where we want to isolate a function that logs to file:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">log-fn</span> <span class="p">[]</span> <span class="o">#</span><span class="p">(</span><span class="nf">spit</span> <span class="s">&quot;report.xml&quot;</span> <span class="nv">%</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">log</span> <span class="p">[</span><span class="nv">string</span><span class="p">]</span> <span class="p">((</span><span class="nf">log-fn</span><span class="p">)</span> <span class="nv">string</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>And the test removing the dependency on the filesytem:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">with-redefs</span> <span class="p">[</span><span class="nv">log-fn</span> <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">data</span><span class="p">]</span> <span class="nv">data</span><span class="p">)]</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">log</span> <span class="s">&quot;hello&quot;</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Its important to note that <code>with-redefs</code> are visible in <em>all threads</em> and it does not play well with concurrency:</p>

<blockquote><p>with-redefs can permanently change a var if applied concurrently:</p></blockquote>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">ten-sixty-six</span> <span class="p">[]</span> <span class="mi">1066</span><span class="p">)</span>
</span><span class='line'><span class="p">(</span><span class="nb">doall </span>
</span><span class='line'>  <span class="p">(</span><span class="nf">pmap</span> <span class="o">#</span><span class="p">(</span><span class="nf">with-redefs</span> <span class="p">[</span><span class="nv">ten-sixty-six</span> <span class="p">(</span><span class="k">fn </span><span class="p">[]</span> <span class="nv">%</span><span class="p">)]</span> <span class="p">(</span><span class="nf">ten-sixty-six</span><span class="p">))</span>
</span><span class='line'>        <span class="p">(</span><span class="nb">range </span><span class="mi">20</span> <span class="mi">100</span><span class="p">)))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">ten-sixty-six</span><span class="p">)</span> <span class="c1">; =&gt; 49 Ouch!</span>
</span></code></pre></td></tr></table></div></figure>


<p>The parallel redefs conflict with each other when setting back the var to its original value.</p>

<p>Another option is <a href="http://clojuredocs.org/clojure_core/clojure.core/alter-var-root">alter-var-root</a> which globally redefines a var and hence a function. <code>alter-var-root</code> can alter functions in other namespaces.</p>

<p>Writing our test to use <code>alter-var-root</code>:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">alter-var-root</span>
</span><span class='line'> <span class="p">(</span><span class="k">var </span><span class="nv">log-fn</span><span class="p">)</span>
</span><span class='line'> <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">real-fn</span><span class="p">]</span> <span class="c1">; We are passed the function we are about to stub.</span>
</span><span class='line'>   <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">data</span><span class="p">]</span> <span class="p">(</span><span class="nb">println </span><span class="nv">data</span><span class="p">))))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Its important to note we have to reset the var if we want to restore the system to its previous state for other tests.</p>

<h3>Redefining Dynamic Vars</h3>

<p>Using dynamic vars we can rebind the value and hence we can use this as an injection point. Again if we can rebind vars we can rebind functions. Note though that we have to mark those functions as dynamic:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="c1">;The real http request</span>
</span><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="o">^</span><span class="ss">:dynamic</span> <span class="nv">http-get-request</span> <span class="p">[</span><span class="nv">url</span><span class="p">]</span> <span class="nv">http/get</span> <span class="nv">url</span><span class="p">)</span>
</span><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nb">get </span><span class="p">[</span><span class="nv">url</span><span class="p">]</span> <span class="p">(</span><span class="nf">http-get-request</span> <span class="p">[</span><span class="nv">url</span><span class="p">]))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">fake-http-get</span> <span class="p">[</span><span class="nv">url</span><span class="p">]</span> <span class="s">&quot;{}&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">fact</span> <span class="s">&quot;make a http get request&quot;</span>
</span><span class='line'>  <span class="p">(</span><span class="nb">binding </span><span class="p">[</span><span class="nv">http-get-request</span> <span class="nv">fake-http-get</span><span class="p">]</span>
</span><span class='line'>    <span class="p">(</span><span class="nb">get </span><span class="s">&quot;/some-resource&quot;</span><span class="p">))</span> <span class="nv">=&gt;</span> <span class="s">&quot;{}&quot;</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Unlike <code>alter-var-root</code> and <code>with-redefs</code> dynamic vars are bound at a thread-local level. So the stubbings would only be visible in that thread. Which makes this safe for tests being run concurrently!</p>

<h3>Atoms &amp; Refs (Global vars in disguise)</h3>

<p>While insidious, evil, malicious and ugly we could use atom or refs to contain a dependency.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">cache</span> <span class="p">(</span><span class="nf">atom</span> <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">method</span>, <span class="o">&amp;</span> <span class="nv">args</span><span class="p">]</span> <span class="p">(</span><span class="nb">apply </span><span class="p">(</span><span class="nb">resolve </span><span class="p">(</span><span class="nb">symbol </span><span class="p">(</span><span class="nb">str </span><span class="s">&quot;memcache/&quot;</span> <span class="nv">method</span><span class="p">)))</span> <span class="nv">args</span><span class="p">))))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nb">get </span><span class="p">[</span><span class="nv">key</span><span class="p">]</span> <span class="p">(</span><span class="err">@</span><span class="nv">cache</span> <span class="nb">get </span><span class="nv">key</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>And in our test:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">reset!</span> <span class="nv">cache</span> <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">method</span>, <span class="o">&amp;</span> <span class="nv">args</span><span class="p">]</span> <span class="p">(</span><span class="nb">apply </span><span class="p">(</span><span class="nb">resolve </span><span class="p">(</span><span class="nb">symbol </span><span class="p">(</span><span class="nb">str </span><span class="s">&quot;fake-cache/&quot;</span> <span class="nv">method</span><span class="p">)))</span> <span class="nv">args</span><span class="p">)))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Yuck, lets never speak of that again.</p>

<h3>Midje</h3>

<p>The <a href="https://github.com/marick/Midje">Midje</a> testing framework provides stubbing methods through <code>provided</code>. In the core of Midje this uses our previously visited <code>alter-var-root</code>.</p>

<p>Lets see how our example would look using Midje:</p>

<p>The code:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">log-fn</span> <span class="p">[]</span> <span class="o">#</span><span class="p">(</span><span class="nf">spit</span> <span class="s">&quot;report.xml&quot;</span> <span class="nv">%</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">log</span> <span class="p">[</span><span class="nv">string</span><span class="p">]</span> <span class="p">((</span><span class="nf">log-fn</span><span class="p">)</span> <span class="nv">string</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>And our test that uses <code>provided</code>:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">fact</span> <span class="s">&quot;it should spit out strings&quot;</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">log</span> <span class="s">&quot;hello&quot;</span><span class="p">)</span> <span class="nv">=&gt;</span> <span class="s">&quot;hello&quot;</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">provided</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">log-fn</span><span class="p">)</span> <span class="nv">=&gt;</span> <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">data</span><span class="p">]</span> <span class="nv">data</span><span class="p">)))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Its important to note that the <code>provided</code> is scoped in effect. It is only active during the form before the Midje &ldquo;=>&rdquo; assertion arrow.</p>

<p>Conceptually think of it like this:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">provided</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">log-fn</span><span class="p">)</span> <span class="nv">=&gt;</span> <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">data</span><span class="p">]</span> <span class="p">(</span><span class="nb">println </span><span class="nv">data</span><span class="p">))</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">captured-output</span> <span class="p">(</span><span class="nf">log</span> <span class="s">&quot;hello&quot;</span><span class="p">)))</span> <span class="nv">=&gt;</span> <span class="p">(</span><span class="nf">contains</span> <span class="s">&quot;hello&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<h4>Flexibility</h4>

<p>Midjes <code>provided</code> gives very fine grained control of when a stub is used:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">do</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">log</span> <span class="s">&quot;mad hatter&quot;</span><span class="p">)</span>   <span class="c1">;will use the stub</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">log</span> <span class="s">&quot;white rabbit&quot;</span><span class="p">)</span> <span class="c1">;will not use the stub</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'><span class="p">(</span><span class="nf">provided</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">log</span> <span class="s">&quot;mad hatter&quot;</span><span class="p">)</span> <span class="nv">=&gt;</span> <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">data</span><span class="p">]</span> <span class="p">(</span><span class="nb">println </span><span class="nv">data</span><span class="p">)))</span>
</span></code></pre></td></tr></table></div></figure>


<p>And we can go further and define argument matcher functions giving huge flexibility in when a stub should be run.</p>

<h4>Safety</h4>

<p>Midje validates your stubs and checks your not doing anything too crazy which would fundamentally break everything.</p>

<h2>Higher order functions</h2>

<p>We can isolate dependencies by passing in functions which wrap that dependency. This abstracts the details of the dependency and provides a point where we can inject our own functions which bypasses the dependency.</p>

<p>For example:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">extract-urn</span> <span class="p">[</span><span class="nv">data</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">urn-getter</span> <span class="o">#</span><span class="p">(</span><span class="ss">:urn</span> <span class="nv">data</span><span class="p">)]</span>
</span><span class='line'> <span class="p">(</span><span class="nf">do-it</span> <span class="nv">urn-getter</span><span class="p">)))</span>
</span></code></pre></td></tr></table></div></figure>


<p>In our tests:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'>  <span class="p">(</span><span class="nf">do-it</span> <span class="p">(</span><span class="k">fn </span><span class="p">[]</span> <span class="mi">10</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Simple and beautiful.</p>

<h2>Substituting namespaces</h2>

<p>We can switch the namespace that a block of functions are evaluated in. Hence we can swap in a completely new implementation (such as a fake) by changing the namespace.</p>

<p>An example faking out a key value store:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">get-it</span> <span class="p">[</span><span class="nv">arg</span> <span class="o">&amp;</span> <span class="p">[</span><span class="nv">namespace</span><span class="p">]]</span>
</span><span class='line'>  <span class="p">((</span><span class="nb">ns-resolve </span><span class="p">(</span><span class="nb">or namespace </span><span class="nv">*ns*</span><span class="p">)</span> <span class="ss">&#39;get</span><span class="p">)</span> <span class="nv">arg</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>A fake implementation of this service:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">ns </span><span class="nv">test.cache.fake</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">cache</span> <span class="p">(</span><span class="nf">atom</span> <span class="p">{}))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nb">get </span><span class="p">[</span><span class="nv">arg</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="err">@</span><span class="nv">cache</span> <span class="nv">arg</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">put</span> <span class="p">[</span><span class="nv">arg</span> <span class="nv">value</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">reset!</span> <span class="err">@</span><span class="nv">cache</span> <span class="p">(</span><span class="nb">assoc </span><span class="err">@</span><span class="nv">cache</span> <span class="nv">arg</span> <span class="nv">value</span><span class="p">)))</span>
</span></code></pre></td></tr></table></div></figure>


<p>And our test:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">fact</span> <span class="s">&quot;it should do something useful&quot;</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">get-it</span> <span class="s">&quot;1234&quot;</span> <span class="ss">&#39;test.cache.fake</span><span class="p">)</span> <span class="nv">=&gt;</span> <span class="s">&quot;1234&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Alternatively if we don&rsquo;t want the mess of injecting new namespaces into our functions we could change namespace aliases to achieve the same effect:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">ns </span><span class="nv">example</span>
</span><span class='line'>  <span class="p">(</span><span class="ss">:require</span> <span class="p">[</span><span class="nv">cache.memcache</span> <span class="ss">:as</span> <span class="nv">memcache</span><span class="p">]))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nb">when </span><span class="p">(</span><span class="nb">= </span><span class="p">(</span><span class="nf">System/getenv</span> <span class="s">&quot;ENV&quot;</span><span class="p">)</span> <span class="s">&quot;TEST&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">ns-unalias</span> <span class="ss">&#39;example</span> <span class="ss">&#39;memcache</span><span class="p">)</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">require</span> <span class="ss">&#39;test.cache.fake</span><span class="p">)</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">alias</span> <span class="ss">&#39;memcache</span> <span class="ss">&#39;test.cache.fake</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nb">get </span><span class="p">[</span><span class="nv">arg</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">memcache/get</span> <span class="nv">arg</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="c1">; ...</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nb">when </span><span class="p">(</span><span class="nb">= </span><span class="p">(</span><span class="nf">System/getenv</span> <span class="s">&quot;ENV&quot;</span><span class="p">)</span> <span class="s">&quot;TEST&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="c1">;Cleanup our rebinding of memcache alias</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">ns-unalias</span> <span class="ss">&#39;memcache</span> <span class="ss">&#39;example</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>When running our tests we mutate the behaviour of the system by setting the ENV environment variable to TEST.</p>

<h2>Runtime Polymorphism</h2>

<p>Switch behaviour based on a the type of an argument. During testing we can inject a specific type which will behave differently from the real system.</p>

<p>Clojure gives us <a href="http://clojure.org/protocols">protocols</a> and <a href="http://clojure.org/multimethods">multimethods</a> to achieve this:</p>

<h3>Protocols</h3>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="ss">:require</span> <span class="p">[[</span><span class="nv">fake-service</span> <span class="ss">:as</span> <span class="nv">fake</span><span class="p">]</span>
</span><span class='line'>           <span class="p">[</span><span class="nv">service</span>      <span class="ss">:as</span> <span class="nv">service</span><span class="p">]])</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defprotocol </span><span class="nv">Service</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">do-get</span> <span class="p">[</span><span class="nv">this</span> <span class="nv">arg</span><span class="p">]))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">deftype </span><span class="nv">FakeService</span> <span class="p">[]</span>
</span><span class='line'>  <span class="nv">Service</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">do-get</span> <span class="p">[</span><span class="nv">this</span> <span class="nv">arg</span><span class="p">]</span> <span class="p">(</span><span class="nf">fake/do-get</span> <span class="nv">arg</span><span class="p">)))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">deftype </span><span class="nv">RealService</span> <span class="p">[]</span>
</span><span class='line'>  <span class="nv">Service</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">do-get</span> <span class="p">[</span><span class="nv">this</span> <span class="nv">arg</span><span class="p">]</span> <span class="p">(</span><span class="nf">service/do-get</span> <span class="nv">arg</span><span class="p">)))</span>
</span></code></pre></td></tr></table></div></figure>


<p>And in our test:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">do-get</span> <span class="p">(</span><span class="nf">FakeService.</span><span class="p">)</span> <span class="s">&quot;cheshire&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Multimethods</h3>

<p>Similar we can use the type of arguments to indicate different behaviour.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="ss">:require</span> <span class="p">[[</span><span class="nv">fake-service</span> <span class="ss">:as</span> <span class="nv">fake</span><span class="p">]</span>
</span><span class='line'>           <span class="p">[</span><span class="nv">service</span>      <span class="ss">:as</span> <span class="nv">service</span><span class="p">]])</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defmulti </span><span class="nv">do-get</span> <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">service</span> <span class="nv">param</span><span class="p">]</span> <span class="p">[(</span><span class="ss">:Service</span> <span class="nv">service</span><span class="p">)</span> <span class="nv">param</span><span class="p">]))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defmethod </span><span class="nv">do-get</span> <span class="p">[</span><span class="ss">:FakeService</span><span class="p">]</span> <span class="p">[</span><span class="nv">service</span> <span class="nv">param</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">fake/do-get</span> <span class="nv">param</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defmethod </span><span class="nv">do-get</span> <span class="p">[</span><span class="ss">:RealService</span><span class="p">]</span> <span class="p">[</span><span class="nv">service</span> <span class="nv">param</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">service/do-get</span> <span class="nv">param</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>And in our test:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">do-get</span> <span class="p">(</span><span class="nf">FakeService.</span><span class="p">)</span> <span class="s">&quot;rabbit&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Defining functions at Runtime</h2>

<p>Using environment variables its possible to switch what functions are defined at runtime. <code>def</code> always defines a method at the top level of a namespace.</p>

<p>Here is an example inspired from Midje&rsquo;s source code:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">init!</span> <span class="p">[]</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">case</span> <span class="p">(</span><span class="nf">System/getenv</span> <span class="s">&quot;ENV&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="s">&quot;TEST&quot;</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">do</span>
</span><span class='line'>      <span class="p">(</span><span class="k">def </span><span class="nb">get </span><span class="p">[</span><span class="nv">key</span><span class="p">]</span>       <span class="p">(</span><span class="nf">fake/get</span> <span class="nv">key</span><span class="p">))</span>
</span><span class='line'>      <span class="p">(</span><span class="k">def </span><span class="nb">set </span><span class="p">[</span><span class="nb">key </span><span class="nv">value</span><span class="p">]</span> <span class="p">(</span><span class="nf">fake/set</span> <span class="nb">key </span><span class="nv">value</span><span class="p">))</span>
</span><span class='line'>    <span class="c1">;; else</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">do</span>
</span><span class='line'>      <span class="p">(</span><span class="k">def </span><span class="nb">get </span><span class="p">[</span><span class="nv">key</span><span class="p">]</span>       <span class="p">(</span><span class="nf">memcache/get</span> <span class="nv">key</span><span class="p">))</span>
</span><span class='line'>      <span class="p">(</span><span class="k">def </span><span class="nb">set </span><span class="p">[</span><span class="nb">key </span><span class="nv">value</span><span class="p">]</span> <span class="p">(</span><span class="nf">memcache/set</span> <span class="nb">key </span><span class="nv">value</span><span class="p">))))))</span>
</span></code></pre></td></tr></table></div></figure>


<p>We would run our tests with <code>ENV=test lein test</code>.</p>

<h1>How should I isolate dependencies in Clojure?</h1>

<p>Having explored what we can do, what should we do?</p>

<p>There are a number of choices and a lot depends on you&rsquo;re programming and testing style:</p>

<h3>The Purest form of isolation</h3>

<p>Passing a function, functions that wrap our dependencies means we do not have to mutate the code under test. This is the ideal form of isolating. This is where we want to be.</p>

<p>But sometimes either aesthetics or control might make us look elsewhere.</p>

<p>Functions with many parameters can become ugly and cumbersome to use.</p>

<p>Using external libraries where we cannot have design the way we want it (though we can try by wrapping the heck out of any library).</p>

<p>Finally integration tests are hard if not impossible to do with this form of dependency isolation.</p>

<h3>The Aesthetic small touch form of isolation</h3>

<p><code>var-alter-root</code> is (very) scary, but the guard rails of Midje make it an easy way to isolate dependencies. It also supports flexibility in how we stub functions based on the arguments they are called with (or completely ignore the arguments). This flexibility is extremely powerful and is a big plus for Midjes <code>provided</code>.</p>

<p>The danger ever present with this form of isolation is ignoring your tests telling you about a problem in your design.</p>

<h3>The Simple small touch form of isolation</h3>

<p>While Midje provides lots of power and flexibly it does so at the cost of slightly awkward syntax and a lot of crazy macros (I say this having stared into the heart of Midje). For example parallel functions do not work with <code>provided</code>.</p>

<p><code>with-redefs</code>, <code>binding</code> and <code>var-alter-root</code> provide flexibly to handle different testing scenarios. and no prior knowledge of an external tool is required.</p>

<p>If you don&rsquo;t need the power of Midje or fear its complexity you can happily use nothing but Clojure&rsquo;s standard library. Maybe you will even learn something about how Clojure works!</p>

<h3>The Java small touch form of isolation.</h3>

<p>Since Clojure supports java interop its always possible to fall back to using Java, OO and dependency injection. If you love Java, this is a good path.</p>

<h3>The Crazy Large touch form of isolation</h3>

<p>Namespace switching is a shortcut to having to stub out every single method. In one sweep we redefine all the functions of a namespace. This might be more useful for integration tests than unit tests.</p>

<p>That shortcut does come at a cost, we still have to maintain our fake ns every time something changes in the real namespace and our production code is left wrapped in <code>ns-resolve</code> or a ugly switch based on Environment settings. Ugly!</p>

<p>I don&rsquo;t recommend using this form of isolation regularly but in edge cases it can be very convenient, though people will still think you are crazy.</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/page/2/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/art/emacs-animation.html">Animations with Emacs</a>
      </li>
    
      <li class="post">
        <a href="/clojure/clojure-and-kinesis-at-scale.html">Clojure and Kinesis at scale</a>
      </li>
    
      <li class="post">
        <a href="/clojure/overtone-driving-minecraft.html">Clojure and Overtone driving Minecraft</a>
      </li>
    
      <li class="post">
        <a href="/art/live-coding-repl-electric.html">Live Coding - Repl Electric</a>
      </li>
    
      <li class="post">
        <a href="/clojure/creative_machines.html">Creative Machines</a>
      </li>
    
      <li class="post">
        <a href="/clojure/sounds-of-the-human-brain.html">Sounds of the human brain</a>
      </li>
    
      <li class="post">
        <a href="/clojure/building-clojure-services-at-scale.html">Building Clojure services at scale</a>
      </li>
    
      <li class="post">
        <a href="/clojure/creating-instruments-with-overtone.html">Creating sampled instruments with Overtone</a>
      </li>
    
      <li class="post">
        <a href="/elixir/sets-in-elixir.html">Sets in Elixir</a>
      </li>
    
      <li class="post">
        <a href="/clojure/isolating-external-dependencies-in-clojure.html">Isolating external dependencies in Clojure</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/josephwilk">@josephwilk</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'josephwilk',
            count: 10,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - Joseph Wilk -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'josephwilk';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>





  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
