
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Clojure and Kinesis at scale - Joseph Wilk</title>
  <meta name="author" content="Joseph Wilk">

  
  <meta name="description" content="I&rsquo;ve been working over the last year in the data team at SoundCloud building a realtime data pipeline using Clojure and Amazon&rsquo;s Kinesis &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://josephwilk.github.io/clojure/clojure-and-kinesis-at-scale.html">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Joseph Wilk" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<script src="http://disqus.com/forums/josephwilk/embed.js"></script>
<link href="http://fonts.googleapis.com/css?family=Bevan" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-3020740-2']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body    class="collapse-sidebar sidebar-footer" >
  <header role="banner"><hgroup>
  <img src="/images/joe_small.jpg" style="position:relative;border-radius: 8px;margin-right: 5px;border-style: solid;border-width: 1px;border-color: #DDD;" height="60" alt="Joseph Wilk">
  <span style="display:inline-block">
    <h1><a href="/">Joseph Wilk</a></h1>
    <h2>Programming bits and bobs</h2>
  </span>
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:josephwilk.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
 <li><a href="/">Home</a></li>
 <li><a href="/about">About</a></li>
 <li><a href="/speaking">Speaking</a></li>
 <li><a href="/contact">Contact</a></li>
 <li><a href="/archives">Archives</a></li>
</ul>
</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Clojure and Kinesis at Scale</h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-09-30T15:58:12+01:00" pubdate data-updated="true">Sep 30<span>th</span>, 2015</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>I&rsquo;ve been working over the last year in the data team at SoundCloud building a realtime data pipeline using Clojure and Amazon&rsquo;s Kinesis. Kinesis is Amazons equivalent to Kafka, &ldquo;Real-Time data processing on the Cloud&rdquo;. This is a summary of what was built, some lessons learnt and all the details in-between.</p>

<figure>
<img src="/images/kinesis_pipeline.png" alt="Kinesis pipeline"/>
<figcaption>Kinesis pipeline at SoundCloud</figcaption>
</figure>


<h2>Tapping Real traffic</h2>

<p>The first step was to tee the traffic from a live system to a test system without comprising its function.
The main function of the live system is logging JSON events to file (which eventually end up somewhere like HDFS).
Tailing the logs of the live system gives us access to the raw data we want to forward on to our test system.
A little Go script watches the logs, parses out the data and then forwards them in batch to test instances that will push to Kinesis. Hence we had live data flowing through the system and after launch a test setup to experiment with. <a href="https://twitter.com/brapse">Sean Braithwaite</a> was the mastermind behind this little bit of magic.</p>

<figure>
<img src="/images/canary.png" alt="Canary Kinesis pipeline"/>
<figcaption>Tapping Traffic</figcaption>
</figure>


<h2>Sending to Kinesis</h2>

<p>All Kinesis sending happens in an application called the EventGateway (also written in Clojure). This endpoint is one of the most heavily loaded services in SoundCloud (at points it has more traffic than the rest of SoundCloud combined). The Eventgateway does a couple of things but at its core it validates and broadcasts JSON messages. Hence this is where our Kinesis client slots in.</p>

<h5>Squeezing Clojure Reflection</h5>

<p>Its worth mentioning that in order for the Eventgateway service to be performant we had to remove all reflection in tight loops through type hints. It simply could not keep up without this. It became a common pattern to turn reflection warnings on while working in Clojure.</p>

<p>Project.clj</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="ss">:profiles</span> <span class="p">{</span><span class="ss">:dev</span> <span class="p">{</span><span class="ss">:global-vars</span> <span class="p">{</span><span class="nv">*warn-on-reflection*</span> <span class="nv">true</span> <span class="nv">*assert*</span> <span class="nv">false</span><span class="p">}}}</span>
</span></code></pre></td></tr></table></div></figure>


<h4>Kinesis</h4>

<p>The Eventgateway posts to Kinesis in batch using a <a href="http://docs.oracle.com/javase/7/docs/api/java/util/concurrent/ConcurrentLinkedQueue.html">ConcurrentLinkedQueue</a> and separate producers and consumers. Messages are pushed into a <code>ConcurrentLinkedQueue</code>. We rolled our own Clojure Kinesis client using Amazons Java library rather than using <a href="https://github.com/mcohen01/amazonica">Amazonica</a>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="c1">;; Java Amazon libraries used</span>
</span><span class='line'><span class="p">[</span><span class="nv">com.amazonaws/aws-java-sdk</span> <span class="s">&quot;1.9.33&quot;</span>         <span class="ss">:exclusions</span> <span class="p">[</span><span class="nv">joda-time</span><span class="p">]]</span>
</span><span class='line'><span class="p">[</span><span class="nv">com.amazonaws/amazon-kinesis-client</span> <span class="s">&quot;1.1.0&quot;</span> <span class="ss">:exclusions</span> <span class="p">[</span><span class="nv">joda-time</span><span class="p">]]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Amazonica was good to get started quickly in the initial phase but there are a couple of reasons we switched to our own unique snowflake (which still looked a little like Amazonica):</p>

<ul>
<li>Amazonica did not support batch mode for Kinesis. Under initial tests it was impossible to scale this without batch.</li>
<li>Injecting our own telemetry at low levels to learn more about Kinesis running.</li>
<li>Some of its sensible defaults where not so sensible (for example default encoding the data using nippy).</li>
<li>Ultimately most of any Kinesis client/server is configuration and tuning.</li>
<li>Amazonica&rsquo;s source is hard to read with a little too much <code>alter-var-root</code> going on.</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="c1">;;Ugh. Its not just me right?</span>
</span><span class='line'><span class="p">(</span><span class="nf">alter-var-root</span>
</span><span class='line'>  <span class="o">#</span><span class="ss">&#39;amazonica.aws.kinesis/get-shard-iterator</span>
</span><span class='line'>  <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">f</span><span class="p">]</span>
</span><span class='line'>    <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="o">&amp;</span> <span class="nv">args</span><span class="p">]</span>
</span><span class='line'>      <span class="p">(</span><span class="ss">:shard-iterator</span> <span class="p">(</span><span class="nb">apply </span><span class="nv">f</span> <span class="nv">args</span><span class="p">)))))</span>
</span></code></pre></td></tr></table></div></figure>


<h4>Pushing Messages in a Queue</h4>

<p>Very simple, just adding a message to the <code>ConcurrentLinkedQueue</code>. A environment variable allows us to gradually scale up or down the percentage of traffic that is added to the queue.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">require</span> <span class="o">&#39;</span><span class="p">[</span><span class="nv">environ.core</span> <span class="ss">:refer</span> <span class="ss">:all</span><span class="p">])</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">kinesis-message-queue</span> <span class="p">(</span><span class="nf">ConcurrentLinkedQueue.</span><span class="p">))</span>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">hard-limit-queue-size</span> <span class="mi">1000</span><span class="p">)</span>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">queue-size</span> <span class="p">(</span><span class="nf">atom</span> <span class="mi">0</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nb">send </span><span class="p">[</span><span class="nv">message</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="nb">when-let </span><span class="p">[</span><span class="nv">threshold</span> <span class="p">(</span><span class="nf">env</span> <span class="ss">:kinesis-traffic</span><span class="p">)]</span>
</span><span class='line'>    <span class="p">(</span><span class="nb">when </span><span class="p">(</span><span class="nb">&gt; </span><span class="p">(</span><span class="nb">rand-int </span><span class="mi">100</span><span class="p">)</span> <span class="p">(</span><span class="nb">- </span><span class="mi">100</span> <span class="p">(</span><span class="nb">or </span><span class="p">(</span><span class="nf">Integer/valueOf</span> <span class="o">^</span><span class="nv">String</span> <span class="nv">threshold</span><span class="p">)</span> <span class="mi">0</span><span class="p">)))</span>
</span><span class='line'>    <span class="p">(</span><span class="nb">when </span><span class="p">(</span><span class="nb">&lt;= </span><span class="o">@</span><span class="nv">queue-size</span> <span class="nv">hard-limit-queue-size</span><span class="p">)</span>
</span><span class='line'>      <span class="p">(</span><span class="nf">.add</span> <span class="nv">kinesis-message-queue</span> <span class="nv">message</span><span class="p">)</span>
</span><span class='line'>      <span class="p">(</span><span class="nf">swap!</span> <span class="nv">queue-size</span> <span class="nv">inc</span><span class="p">)))))</span>
</span></code></pre></td></tr></table></div></figure>


<h5>Failure</h5>

<p>The queue pusher operates within a wider system and any failures due to Amazon being unreachable should not impede the function of the system. For the client this means:</p>

<ul>
<li>Not exceeding memory limits with a hard queue size (since ConcurrentLinkedQueue is unbound in size).</li>
<li>Backing off workers if the queue is full to prevent cpu throttling.</li>
</ul>


<p>When we cannot send messages to Kinesis we instead log them to disk, and into our normal logging pipeline (usually ending up in HDFS). Hence we could replay at a later date if required.</p>

<h4>Sending batches to Kinesis</h4>

<p>The workers, operating in separate threads consuming messages from the <code>ConcurrentLinkedQueue</code> collecting them into a batch:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="k">loop </span><span class="p">[</span><span class="nv">batch</span> <span class="p">[]</span>
</span><span class='line'>       <span class="nv">batch-start-time</span> <span class="p">(</span><span class="nf">time/now</span><span class="p">)</span>
</span><span class='line'>       <span class="nv">poll-misses</span> <span class="mi">0</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nf">batch-ready-to-send?</span> <span class="nv">batch</span> <span class="nv">batch-start-time</span><span class="p">)</span>
</span><span class='line'>    <span class="nv">batch</span>
</span><span class='line'>    <span class="p">(</span><span class="nb">if-let </span><span class="p">[</span><span class="nv">event</span> <span class="p">(</span><span class="nf">.poll</span> <span class="nv">kinesis-message-queue</span><span class="p">)]</span>
</span><span class='line'>      <span class="p">(</span><span class="nf">do</span>
</span><span class='line'>        <span class="p">(</span><span class="nf">swap!</span> <span class="nv">queue-size</span> <span class="nv">dec</span><span class="p">)</span>
</span><span class='line'>        <span class="p">(</span><span class="nf">recur</span> <span class="p">(</span><span class="nb">conj </span><span class="nv">batch</span> <span class="nv">event</span><span class="p">)</span> <span class="nv">batch-start-time</span> <span class="mi">0</span><span class="p">))</span>
</span><span class='line'>      <span class="p">(</span><span class="nf">do</span>
</span><span class='line'>        <span class="p">(</span><span class="nf">Thread/sleep</span> <span class="p">(</span><span class="nf">exponential-backoff-sleep</span> <span class="nv">poll-misses</span><span class="p">))</span>
</span><span class='line'>        <span class="p">(</span><span class="nf">recur</span> <span class="nv">batch</span> <span class="nv">batch-start-time</span> <span class="p">(</span><span class="nb">inc </span><span class="nv">poll-misses</span><span class="p">))))))))</span>
</span></code></pre></td></tr></table></div></figure>


<p>When polling from the queue an exponential back-off if no messages are on the queue.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">exponential-backoff-sleep</span>
</span><span class='line'>  <span class="s">&quot;Exponential backoff with jitter and a max &quot;</span>
</span><span class='line'>  <span class="p">[</span><span class="nv">misses</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">max-timeout</span> <span class="mi">1000</span>
</span><span class='line'>        <span class="nv">jitter-order</span> <span class="mi">10</span><span class="p">]</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">Math/min</span>
</span><span class='line'>     <span class="nv">max-timeout</span>
</span><span class='line'>     <span class="p">(</span><span class="nf">Math/round</span> <span class="p">(</span><span class="nb">+ </span><span class="p">(</span><span class="nf">Math/exp</span> <span class="nv">misses</span><span class="p">)</span>
</span><span class='line'>                    <span class="p">(</span><span class="nb">* </span><span class="p">(</span><span class="nf">Math/random</span><span class="p">)</span>
</span><span class='line'>                       <span class="nv">jitter-order</span><span class="p">))))))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Once the batch is ready (in terms of age or size) its sent to Kinesis.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn- </span><span class="nv">failures-&gt;events</span> <span class="p">[</span><span class="o">^</span><span class="nv">PutRecordsResult</span> <span class="nv">put-results</span> <span class="nv">events</span><span class="p">]</span>
</span><span class='line'>  <span class="s">&quot;Find the events that are marked as failed in the PutRecordsResult&quot;</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">-&gt;&gt;</span> <span class="nv">put-results</span>
</span><span class='line'>       <span class="nv">.getRecords</span>
</span><span class='line'>       <span class="p">(</span><span class="nb">map vector </span><span class="p">(</span><span class="nf">range</span><span class="p">))</span>
</span><span class='line'>       <span class="p">(</span><span class="nb">filter </span><span class="p">(</span><span class="k">fn </span><span class="p">[[</span><span class="nv">idx</span> <span class="o">^</span><span class="nv">PutRecordsResultEntry</span> <span class="nv">e</span><span class="p">]]</span> <span class="p">(</span><span class="nf">.getErrorCode</span> <span class="nv">e</span><span class="p">)))</span>
</span><span class='line'>       <span class="p">(</span><span class="nb">map </span><span class="p">(</span><span class="k">fn </span><span class="p">[[</span><span class="nv">idx</span> <span class="nv">_</span><span class="p">]]</span> <span class="p">(</span><span class="nb">nth </span><span class="nv">events</span> <span class="nv">idx</span><span class="p">)))))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defn- </span><span class="nv">send-events</span>
</span><span class='line'>  <span class="s">&quot;Perform putRecords request to send the batch to Kinesis</span>
</span><span class='line'><span class="s">   returns a list of events that failed.&quot;</span>
</span><span class='line'>  <span class="p">[</span><span class="o">^</span><span class="nv">AmazonKinesisClient</span> <span class="nv">client</span> <span class="nv">stream-name</span> <span class="nv">events</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">try+</span>
</span><span class='line'>   <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">result</span> <span class="p">(</span><span class="nf">.putRecords</span> <span class="nv">client</span> <span class="p">(</span><span class="nf">events-&gt;put-records-request</span> <span class="nv">events</span> <span class="nv">stream-name</span><span class="p">))]</span>
</span><span class='line'>     <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">pos? </span><span class="p">(</span><span class="nf">.getFailedRecordCount</span> <span class="nv">result</span><span class="p">))</span>
</span><span class='line'>       <span class="p">(</span><span class="nf">failures-&gt;events</span> <span class="nv">result</span> <span class="nv">events</span><span class="p">))</span>
</span><span class='line'>       <span class="p">[])))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Note this is where we also decided the partition key. In our case its important for the same user to be located on the same partition.
For example when consuming from Kinesis a worker is allocated a partition to work from and would miss events if they where across multiple partitions.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn- </span><span class="nv">events-&gt;put-records-request</span>
</span><span class='line'>  <span class="s">&quot;Take client and a vector of JsonNodes and produce a PutRecord&quot;</span>
</span><span class='line'>  <span class="p">[</span><span class="nv">batch</span> <span class="nv">event-stream</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">batch-list</span>  <span class="p">(</span><span class="nf">java.util.ArrayList.</span><span class="p">)</span>
</span><span class='line'>        <span class="nv">put-request</span> <span class="p">(</span><span class="nf">PutRecordsRequest.</span><span class="p">)]</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">.setStreamName</span> <span class="nv">put-request</span> <span class="nv">event-stream</span><span class="p">)</span>
</span><span class='line'>    <span class="p">(</span><span class="nb">doseq </span><span class="p">[</span><span class="o">^</span><span class="nv">ObjectNode</span> <span class="nv">event</span> <span class="nv">batch</span><span class="p">]</span>
</span><span class='line'>      <span class="p">(</span><span class="nf">.remove</span> <span class="nv">event</span> <span class="o">^</span><span class="nv">String</span> <span class="nv">failure-metadata</span><span class="p">)</span>
</span><span class='line'>      <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">request-entry</span> <span class="p">(</span><span class="nf">PutRecordsRequestEntry.</span><span class="p">)</span>
</span><span class='line'>            <span class="nv">request-data</span>  <span class="p">(</span><span class="nf">.getBytes</span> <span class="p">(</span><span class="nb">str </span><span class="nv">event</span><span class="p">))</span>
</span><span class='line'>            <span class="nv">request-buf</span>   <span class="p">(</span><span class="nf">ByteBuffer/wrap</span> <span class="nv">request-data</span> <span class="mi">0</span> <span class="p">(</span><span class="nb">alength </span><span class="nv">request-data</span><span class="p">))</span>
</span><span class='line'>            <span class="nv">partition-key</span> <span class="p">(</span><span class="ss">:user-id</span> <span class="nv">event</span><span class="p">)]</span>
</span><span class='line'>        <span class="p">(</span><span class="nb">doto </span><span class="nv">request-entry</span>
</span><span class='line'>          <span class="p">(</span><span class="nf">.setData</span>         <span class="nv">request-buf</span><span class="p">)</span>
</span><span class='line'>          <span class="p">(</span><span class="nf">.setPartitionKey</span> <span class="nv">partition-key</span><span class="p">))</span>
</span><span class='line'>        <span class="p">(</span><span class="nf">.add</span> <span class="nv">batch-list</span> <span class="nv">request-entry</span><span class="p">)))</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">.setRecords</span> <span class="nv">put-request</span> <span class="nv">batch-list</span><span class="p">)</span>
</span><span class='line'>    <span class="nv">put-request</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<h5>Failure</h5>

<p>Failure can occur on individual records within a batch or in the batch as a whole.</p>

<h6>Individual failures</h6>

<ol>
<li>These messages are re-added to the queue so we can try again. If the messages fail for some nth time they are considered invalid and rejected from Kinesis and logged as an error.</li>
</ol>


<h6>Batch level</h6>

<ol>
<li><p>Amazon had an Internal Failure. We don&rsquo;t know what went wrong. (We see this regularly in normal function).</p></li>
<li><p>Amazon Kinesis is not resolvable (<code>AmazonClientException/AmazonServiceException</code>).</p></li>
<li><p>Exceeding the read/write limits of Kinesis (<code>ProvisionedThroughputExceededException</code>).</p></li>
</ol>


<p>This is our backpressure signal, in which case at worst we need to log to disk for replay later.</p>

<h2>Consuming Messages from Kinesis</h2>

<p>With the consumption of events we have a different application stream for every worker. All workers have their own streams, and own checkpoints so they operate independently of each other. Some example of the workers we gave running:</p>

<ul>
<li>Logging Events to s3</li>
<li>Calculating listening time</li>
<li>Forwarding certain messages on to various other systems (like RabbitMQ).</li>
</ul>


<p>Launching a worker is pretty simple with the Amazon Java Kinesis library.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="ss">:import</span> <span class="p">[</span><span class="nv">com.amazonaws.services.kinesis.clientlibrary.lib.worker</span> <span class="nv">Worker</span><span class="p">])</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">-main</span> <span class="p">[</span><span class="o">&amp;</span> <span class="nv">args</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">worker-fn</span> <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">events</span><span class="p">]</span> <span class="p">(</span><span class="nb">print </span><span class="nv">events</span><span class="p">))</span>
</span><span class='line'>        <span class="nv">config</span> <span class="p">(</span><span class="nf">KinesisClientLibConfiguration.</span>   <span class="nv">worker-fn</span><span class="p">)</span> <span class="c1">;;I&#39;m airbrushing over the Java classes</span>
</span><span class='line'>        <span class="nv">processor</span> <span class="p">(</span><span class="nf">reify</span> <span class="nv">IRecordProcessorFactory</span> <span class="nv">worker-fn</span><span class="p">)</span> <span class="c1">;;Ultimately this is a lot of config wrapped in Java fun</span>
</span><span class='line'>        <span class="p">[</span><span class="o">^</span><span class="nv">Worker</span> <span class="nv">worker</span> <span class="nv">uuid</span><span class="p">]</span> <span class="p">(</span><span class="nf">Worker.</span> <span class="nv">processor</span> <span class="nv">config</span><span class="p">)]</span>
</span><span class='line'>          <span class="p">(</span><span class="nf">future</span> <span class="p">(</span><span class="nf">.run</span> <span class="nv">worker</span><span class="p">))))</span>
</span></code></pre></td></tr></table></div></figure>


<p>One of the hardest parts of setting up the a worker is getting the configuration right to ensure that the consumers are getting through the events fast enough. Events are held in Amazon for 24 hours after entry, and hence there is a minimum consumption rate.</p>

<p>Counting events in and events out with <a href="http://prometheus.io/">Prometheus</a> made it easier to get the correct consumption rates.
<img src="/images/kinesis_entry_exit_rates.png" alt="Entry/exit rates"/></p>

<p>Via the Amazon console you also get access to various graphs around read/write rates and limits:</p>

<p><img src="/images/amazon_kinesis_graphs.png"/></p>

<p>Finally you can also look at Amazon&rsquo;s Dynamodb instance for the Kinesis stream providing insight into metrics around leases, how many where revoked, stolen, never finished, etc.</p>

<p>Here is an example of one of our Kinesis workers configuration covered in scribblings of me trying to work out the right settings.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'>  <span class="p">{</span>
</span><span class='line'>   <span class="c1">;;default 1 sec, cannot be lower than 200ms</span>
</span><span class='line'>   <span class="c1">;;If we are not reading fast enough this is a good value to tweak</span>
</span><span class='line'>   <span class="ss">:idle-time-between-reads-in-millis</span> <span class="mi">1800</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">;;Clean up leases for shards that we&#39;ve finished processing (don&#39;t wait</span>
</span><span class='line'>   <span class="c1">;;until they expire)</span>
</span><span class='line'>   <span class="ss">:cleanup-leases-upon-shard-completion</span> <span class="nv">true</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">;;If the heartbeat count does not increase within the configurable timeout period,</span>
</span><span class='line'>   <span class="c1">;;other workers take over processing of that shard.</span>
</span><span class='line'>   <span class="c1">;;*IMPORTANT* If this time is shorter than time for a worker to checkpoint all nodes</span>
</span><span class='line'>   <span class="c1">;;will keep stealing each others leases producing a lot of contention.</span>
</span><span class='line'>   <span class="ss">:failover-time-millis</span> <span class="mi">80000</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">;;Max records in a single returned in a `GetRecords`. Cannot exceed 10,000</span>
</span><span class='line'>   <span class="ss">:max-records</span> <span class="mi">4500</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">;;Process records even if GetRecords returned an empty record list.</span>
</span><span class='line'>   <span class="ss">:call-process-records-even-for-empty-record-list</span> <span class="nv">false</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">;;Sleep for this duration if the parent shards have not completed processing,</span>
</span><span class='line'>   <span class="c1">;;or we encounter an exception.</span>
</span><span class='line'>   <span class="ss">:parent-shard-poll-interval-millis</span> <span class="mi">10000</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">;;By default, the KCL begins withs the most recently added record.</span>
</span><span class='line'>   <span class="c1">;;Instead always reads data from the beginning of the stream.</span>
</span><span class='line'>   <span class="ss">:initial-position-in-stream</span>  <span class="ss">:TRIM_HORIZON</span><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Monitoring</h2>

<p>Prometheus (<a href="http://prometheus.io/">http://prometheus.io/</a>) a monitoring tool built at SoundCloud was <em>core</em> to developing, scaling and monitoring all of this pipeline. Amazon does provide some useful graphs within the AWS console but more detailed feedback was very helpful even if it was removed later.</p>

<h4>Exception Logging pattern</h4>

<p>All Exceptions are counted and sent to log. This was a very useful pattern for driving out errors and spotting leaks in the interactions with Kinesis and consumption:</p>

<p>(Using a Clojure wrapper around Prometheus: <a href="https://github.com/josephwilk/prometheus-clj">https://github.com/josephwilk/prometheus-clj</a>)</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">try+</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">worker-fn</span> <span class="nv">raw-events</span><span class="p">)</span>
</span><span class='line'><span class="p">(</span><span class="nf">catch</span> <span class="nv">Exception</span> <span class="nv">e</span>
</span><span class='line'>  <span class="c1">;;Count based on exception class</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">inc-counter</span> <span class="ss">:failed-batches</span> <span class="p">{</span><span class="ss">:type</span> <span class="nv">worker-type</span> <span class="ss">:error-code</span> <span class="p">(</span><span class="nb">str </span><span class="p">(</span><span class="nf">.getClass</span> <span class="nv">e</span><span class="p">))})</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">log/error</span> <span class="nv">e</span><span class="p">)))]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Note Kinesis regularly spits out &ldquo;<code>InternalFailure</code>&rdquo; Exceptions. Thats all you get&hellip;</p>

<p><img src="/images/kinesis_failures.png" alt="Kinesis Internal failures"/></p>

<h2>A Cloud Pipeline in Pictures</h2>

<p>In my previous post about <a href="http://blog.josephwilk.net/clojure/building-clojure-services-at-scale.html">Building Clojure services at scale</a> I converted the system metrics to sound. This time I convert the metrics across all the machine into vertexes on a mesh using <a href="http://openframeworks.cc">OpenFrameworks</a>. So you start to see a visual representation in 3D of the function of the system.</p>

<p><img src="/images/soundcloud_kinesis.png"  width="500"/>
<img src="/images/soundcloud_kinesis2.png" width="500"/>
<img src="/images/soundcloud_kinesis4.png" width="500"/>
<img src="/images/soundcloud_kinesis3.png" width="500"/></p>

<h2>Thanks</h2>

<p>This work constitues a team effort by the Data team at SoundCloud. A lot of advice, collaboration and hard work. Kudos to everyone.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Joseph Wilk</span></span>

      








  


<time datetime="2015-09-30T15:58:12+01:00" pubdate data-updated="true">Sep 30<span>th</span>, 2015</time>
      

<span class="categories">
  
    <a class='category' href='/clojure'>clojure</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://josephwilk.github.io/clojure/clojure-and-kinesis-at-scale.html" data-via="josephwilk" data-counturl="http://josephwilk.github.io/clojure/clojure-and-kinesis-at-scale.html" >Tweet</a>
  
  
  <div class="g-plusone" data-size="small"></div>
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/clojure/overtone-driving-minecraft.html" title="Previous Post: Clojure and Overtone driving Minecraft">&laquo; Clojure and Overtone driving Minecraft</a>
      
      
        <a class="basic-alignment right" href="/art/emacs-animation.html" title="Next Post: Animations with Emacs">Animations with Emacs &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/art/emacs-animation.html">Animations with Emacs</a>
      </li>
    
      <li class="post">
        <a href="/clojure/clojure-and-kinesis-at-scale.html">Clojure and Kinesis at scale</a>
      </li>
    
      <li class="post">
        <a href="/clojure/overtone-driving-minecraft.html">Clojure and Overtone driving Minecraft</a>
      </li>
    
      <li class="post">
        <a href="/art/live-coding-repl-electric.html">Live Coding - Repl Electric</a>
      </li>
    
      <li class="post">
        <a href="/clojure/creative_machines.html">Creative Machines</a>
      </li>
    
      <li class="post">
        <a href="/clojure/sounds-of-the-human-brain.html">Sounds of the human brain</a>
      </li>
    
      <li class="post">
        <a href="/clojure/building-clojure-services-at-scale.html">Building Clojure services at scale</a>
      </li>
    
      <li class="post">
        <a href="/clojure/creating-instruments-with-overtone.html">Creating sampled instruments with Overtone</a>
      </li>
    
      <li class="post">
        <a href="/elixir/sets-in-elixir.html">Sets in Elixir</a>
      </li>
    
      <li class="post">
        <a href="/clojure/isolating-external-dependencies-in-clojure.html">Isolating external dependencies in Clojure</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/josephwilk">@josephwilk</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'josephwilk',
            count: 10,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - Joseph Wilk -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'josephwilk';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://josephwilk.github.io/clojure/clojure-and-kinesis-at-scale.html';
        var disqus_url = 'http://josephwilk.github.io/clojure/clojure-and-kinesis-at-scale.html';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>





  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
