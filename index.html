
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Joseph Wilk</title>
  <meta name="author" content="Joseph Wilk">


  <meta name="description" content="Exploring patterns as a means of documenting Clojure functions to aid recall and understanding. Whats the difference in Clojure between:
partition &hellip;">


  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">


  <link rel="canonical" href="http://blog.josephwilk.net/index.html">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Joseph Wilk" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<script src="https://disqus.com/forums/josephwilk/embed.js"></script>
<link href="https://fonts.googleapis.com/css?family=Bevan" rel="stylesheet" type="text/css">
<link href="https://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="https://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-3020740-2']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body    class="collapse-sidebar sidebar-footer" >
  <header role="banner"><hgroup>
  <img src="/images/joe_small2.png" style="position:relative;border-radius: 8px;margin-right: 5px;border-style: solid;border-width: 1px;border-color: #DDD;" height="60" alt="Joseph Wilk">
  <span style="display:inline-block">
    <h1><a href="/">Joseph Wilk</a></h1>
    <h2>Things with code, creativity and computation.</h2>
  </span>
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>

</ul>


<ul class="main-navigation">
 <li><a href="/">Home</a></li>
 <li><a href="/about">About</a></li>
 <li><a href="http://art.josephwilk.net">Art</a></li>
 <li><a href="/contact">Contact</a></li>
 <li><a href="/archives">Archives</a></li>
</ul>
</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">


        <article>

      <header>

          <h1 class="entry-title"><a href="/art/emacs-as-a-musical-instrument.html">Emacs as a Musical Instrument</a></h1>
          <p class="meta">
    <time datetime="2018-05-16T14:00:00+01:00" pubdate data-updated="true">May 16<span>th</span>, 2018</time>
          </p>
      </header>

      <div class="entry-content"><p>A simple goal, to directly connect Emacs to running hardware and software synthesisers with <strong>realtime</strong> control. Emacs as a musical instrument.</p>

    <p>I already use code to control synths (as <a href="http://www.repl-electric.com/">Repl-Electric</a>) but there is a level of indirection between the code and the effect on the music. You push keys on your computer keyboard and nothing happens. Only when you run the code does the music change. I wanted to add realtime control to my performances while still remaining in code and Emacs. Bringing the performance closer to musical instruments were instant feedback is a core part of the performance experience.</p>

    <p>I could use external hardware, like a MidiFighterTwister (<a href="https://www.midifighter.com/#Twister">https://www.midifighter.com/#Twister</a>) or TouchOSC (<a href="https://hexler.net/software/touchosc">https://hexler.net/software/touchosc</a>) but I’ve found the context switch of moving between coding to twiddling dials on hardware expensive. The code is my composition process, so it makes sense for the direct control to also be there.</p>

    <h2>Playing the Emacs</h2>

    <p>Sculpting sound live with Emacs.</p>

    <div class="embed-container"><iframe src="https://player.vimeo.com/video/270101496?color=ff0179" frameborder="0" webkitallowfullscreen mozallowfullscreen allowfullscreen></iframe></div>

    <h2>Scratching Samples with Emacs</h2>

    <p>Doing crazy things with Emacs starts to open more doors in musical expression. Since we can control music hardware with Emacs, we can control the playhead position within a sample. Much like the needle of a record player.</p>

    <p>Say we map the position of your cursor in the Emacs buffer to the position of the playback head. By moving around in your buffer you can scratch the sample.</p>

    <div class="embed-container"><iframe src="https://player.vimeo.com/video/265189088?color=ff0179" frameborder="0" webkitallowfullscreen mozallowfullscreen allowfullscreen></iframe></div>

    <h2>Emacs sending Musical Controls</h2>

    <p>Sending messages to musical synths using midi and OSC.</p>

    <h3>Emacs Communicating with Open Sound Control</h3>

    <p>First we need a client within Emacs which will send OSC (<a href="https://en.wikipedia.org/wiki/Open_Sound_Control">https://en.wikipedia.org/wiki/Open_Sound_Control</a>) using UDP packets. There is thankfully already an Emacs package for this: osc: <a href="https://delysid.org/emacs/osc.html">https://delysid.org/emacs/osc.html</a></p>

    <p>Creating a client and sending OSC messages:</p>

    <figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
    <span class='line-number'>2</span>
    <span class='line-number'>3</span>
    <span class='line-number'>4</span>
    <span class='line-number'>5</span>
    <span class='line-number'>6</span>
    <span class='line-number'>7</span>
    <span class='line-number'>8</span>
    <span class='line-number'>9</span>
    <span class='line-number'>10</span>
    <span class='line-number'>11</span>
    <span class='line-number'>12</span>
    <span class='line-number'>13</span>
    <span class='line-number'>14</span>
    <span class='line-number'>15</span>
    <span class='line-number'>16</span>
    <span class='line-number'>17</span>
    <span class='line-number'>18</span>
    </pre></td><td class='code'><pre><code class='elisp'><span class='line'><span></span><span class="p">(</span><span class="nb">require</span> <span class="ss">&#39;osc</span><span class="p">)</span>
    </span><span class='line'><span class="p">(</span><span class="k">defvar</span> <span class="nv">osc-client</span> <span class="no">nil</span> <span class="s">&quot;Connection to send OSC From Emacs&quot;</span><span class="p">)</span>
    </span><span class='line'>
    </span><span class='line'><span class="p">(</span><span class="nb">defun</span> <span class="nv">osc-make-client</span> <span class="p">(</span><span class="nv">host</span> <span class="nv">port</span><span class="p">)</span>
    </span><span class='line'>  <span class="p">(</span><span class="nf">make-network-process</span>
    </span><span class='line'>   <span class="nb">:name</span> <span class="s">&quot;OSC client&quot;</span>
    </span><span class='line'>   <span class="nb">:host</span> <span class="nv">host</span>
    </span><span class='line'>   <span class="nb">:service</span> <span class="nv">port</span>
    </span><span class='line'>   <span class="nb">:type</span> <span class="ss">&#39;datagram</span>
    </span><span class='line'>   <span class="nb">:family</span> <span class="ss">&#39;ipv4</span><span class="p">))</span>
    </span><span class='line'>
    </span><span class='line'><span class="p">(</span><span class="nb">defun</span> <span class="nv">osc-connect</span> <span class="p">()</span>
    </span><span class='line'>  <span class="p">(</span><span class="k">if</span> <span class="nv">osc-client</span>   <span class="p">(</span><span class="nf">delete-process</span> <span class="nv">osc-client</span><span class="p">))</span>
    </span><span class='line'>  <span class="p">(</span><span class="k">setq</span> <span class="nv">osc-client</span> <span class="p">(</span><span class="nv">osc-make-client</span> <span class="s">&quot;localhost&quot;</span> <span class="mi">4561</span><span class="p">)))</span>
    </span><span class='line'>
    </span><span class='line'><span class="p">(</span><span class="nv">osc-connect</span><span class="p">)</span>
    </span><span class='line'>
    </span><span class='line'><span class="p">(</span><span class="nv">osc-send-message</span> <span class="nv">osc-client</span> <span class="nv">ADDRESS</span> <span class="nv">*ARGUMENTS</span><span class="p">)</span>
    </span></code></pre></td></tr></table></div></figure>


    <h3>Emacs Communicating with Midi</h3>

    <p>A lot of musical hardware and software only supports midi. We are sending OSC 😕. Hence we need a quick way of converting our OSC message to a midi message. Why don’t you send midi from Emacs directly? It&rsquo;s not a new thought (<a href="https://www.emacswiki.org/emacs/EmacsMidi">https://www.emacswiki.org/emacs/EmacsMidi</a>), but I’ve seen no examples of getting it working. My answer here is path of least resistance, and I don’t feel like implementing the midi standard in Elisp.</p>

    <p>Luis Lloret (<a href="https://github.com/llloret">https://github.com/llloret</a>) has create the lovely C++ lib <code>osmid</code> (<a href="https://github.com/llloret/osmid">https://github.com/llloret/osmid</a>) for converting between midi and OSC. And its FAST.</p>

    <p>It compiles into two binary servers:</p>

    <ul>
    <li>m2o &ndash; midi to OSC</li>
    <li>o2m &ndash; OSC to midi</li>
    </ul>


    <p>We launch the o2m server in a shell which will be listening on port <code>4561</code> and will forward on OSC messages as midi.</p>

    <figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
    </pre></td><td class='code'><pre><code class='elisp'><span class='line'><span></span><span class="nv">osmid/o2m</span> <span class="nv">-b</span> <span class="nv">-i</span> <span class="mi">4561</span> <span class="nv">-O</span> <span class="mi">4562</span> <span class="nv">-m</span> <span class="mi">6</span>
    </span></code></pre></td></tr></table></div></figure>


    <p>Midi has a fixed argument format while OSC is very flexible. Hence this a little jiggery pokery in get the source OSC message mapping to the midi arguments.</p>

    <p>OSC message format:</p>

    <figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
    </pre></td><td class='code'><pre><code class='elisp'><span class='line'><span></span><span class="p">(</span><span class="nv">osc-send-message</span> <span class="nv">osc-client</span> <span class="nv">MIDI_HOST</span> <span class="nv">MIDI_CHANNEL</span> <span class="nv">MIDI_CONTROL_CODE</span> <span class="nv">MIDI_VALUE</span><span class="p">)</span>
    </span></code></pre></td></tr></table></div></figure>


    <p>For MIDI_HOST I’m using the <code>Inter-application communication</code> (IAC) driver on Mac. This registers <code>IAC Bus 1</code> as a midi device. I’m also sending a <code>control change</code> message, shaping the parameters rather than triggering notes. This could be any of the supported midi messages (<code>note_on</code>, <code>note_off</code>, <code>pitch_bend</code>, <code>poly_pressure</code>, etc).</p>

    <p>Example of OSC to midi message:</p>

    <figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
    </pre></td><td class='code'><pre><code class='elisp'><span class='line'><span></span><span class="p">(</span><span class="nv">osc-send-message</span> <span class="nv">osc-client</span> <span class="s">&quot;/IAC Bus 1/control_change&quot;</span> <span class="mi">9</span> <span class="mi">100</span> <span class="mi">127</span><span class="p">)</span>
    </span></code></pre></td></tr></table></div></figure>


    <p>The channel <code>9</code> and control code <code>100</code> seem magical. I’m routing those to synths via Ableton Live.</p>

    <p><img src="/images/midi-routing.png"/></p>

    <p>Any DAW would support this or you could send direct to a synth and not use <code>IAC</code>. Your MIDI_HOST would be the name your midi device registers as.</p>

    <h2>Emacs GUI for Musical Controls</h2>

    <p>We have the backend for sending live midi controls to hardware. Now we need some interface within Emacs to trigger it.</p>

    <h3>Modelling Encoders in Emacs</h3>

    <p>The design is based on the idea of dial encoders commonly found in music hardware.</p>

    <p><img src="/images/pots.jpg"/></p>

    <p>Our dials in code are float numbers. To turn our dials we borrow the idea from the Chrome inspector of scrolling through possible numeric values with the arrow keys.</p>

    <p><img src="/images/chromeinspector.png"/></p>

    <p>In our case every increment/decrement will send a live message to our synths.</p>

    <p>We need to extract from the active Emacs buffer the thing we are trying to control. Finding the:</p>

    <ul>
    <li>Synth (the musical instrument)</li>
    <li>Parameter (ie. amp, pan, lfo, filter)</li>
    <li>Value 0-127 (whatever value we want to set param)</li>
    </ul>


    <p>Example changing the filter param:</p>

    <figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
    <span class='line-number'>2</span>
    <span class='line-number'>3</span>
    <span class='line-number'>4</span>
    <span class='line-number'>5</span>
    </pre></td><td class='code'><pre><code class='elisp'><span class='line'><span></span><span class="nv">zerocoast_cc</span> <span class="nv">lfo:</span> <span class="mf">0.49</span><span class="o">,</span> <span class="nv">filter:</span> <span class="nv">&lt;0.80&gt;</span>
    </span><span class='line'>
    </span><span class='line'><span class="c1">;;; Synth =&gt; zerocoast</span>
    </span><span class='line'><span class="c1">;;; Parameter =&gt; filter</span>
    </span><span class='line'><span class="c1">;;; Value =&gt; 101.6 (127*0.80)</span>
    </span></code></pre></td></tr></table></div></figure>


    <p>Here comes a lot of Elisp and some hairy regexes.</p>

    <h4>Emacs Code</h4>

    <p>Thingatpt (<a href="https://www.emacswiki.org/emacs/ThingAtPoint">https://www.emacswiki.org/emacs/ThingAtPoint</a>) which is part of the standard lib is extremely useful here.</p>

    <figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
    <span class='line-number'>2</span>
    <span class='line-number'>3</span>
    <span class='line-number'>4</span>
    <span class='line-number'>5</span>
    <span class='line-number'>6</span>
    <span class='line-number'>7</span>
    <span class='line-number'>8</span>
    <span class='line-number'>9</span>
    <span class='line-number'>10</span>
    <span class='line-number'>11</span>
    <span class='line-number'>12</span>
    <span class='line-number'>13</span>
    <span class='line-number'>14</span>
    <span class='line-number'>15</span>
    <span class='line-number'>16</span>
    <span class='line-number'>17</span>
    <span class='line-number'>18</span>
    <span class='line-number'>19</span>
    <span class='line-number'>20</span>
    <span class='line-number'>21</span>
    <span class='line-number'>22</span>
    <span class='line-number'>23</span>
    <span class='line-number'>24</span>
    <span class='line-number'>25</span>
    <span class='line-number'>26</span>
    <span class='line-number'>27</span>
    <span class='line-number'>28</span>
    <span class='line-number'>29</span>
    <span class='line-number'>30</span>
    <span class='line-number'>31</span>
    <span class='line-number'>32</span>
    <span class='line-number'>33</span>
    <span class='line-number'>34</span>
    <span class='line-number'>35</span>
    <span class='line-number'>36</span>
    <span class='line-number'>37</span>
    <span class='line-number'>38</span>
    <span class='line-number'>39</span>
    <span class='line-number'>40</span>
    <span class='line-number'>41</span>
    <span class='line-number'>42</span>
    <span class='line-number'>43</span>
    <span class='line-number'>44</span>
    <span class='line-number'>45</span>
    <span class='line-number'>46</span>
    <span class='line-number'>47</span>
    <span class='line-number'>48</span>
    <span class='line-number'>49</span>
    <span class='line-number'>50</span>
    <span class='line-number'>51</span>
    <span class='line-number'>52</span>
    <span class='line-number'>53</span>
    <span class='line-number'>54</span>
    </pre></td><td class='code'><pre><code class='elisp'><span class='line'><span></span><span class="p">(</span><span class="nb">require</span> <span class="ss">&#39;thingatpt</span><span class="p">)</span>
    </span><span class='line'>
    </span><span class='line'><span class="c1">;;The patterns for matching the beginning and</span>
    </span><span class='line'><span class="c1">;;end of something that looks like a float</span>
    </span><span class='line'>
    </span><span class='line'><span class="p">(</span><span class="nf">put</span> <span class="ss">&#39;float</span> <span class="ss">&#39;end-op</span>       <span class="p">(</span><span class="nb">lambda</span> <span class="p">()</span> <span class="p">(</span><span class="nf">re-search-forward</span> <span class="s">&quot;[0-9-]*\.[0-9-]*&quot;</span> <span class="no">nil</span> <span class="no">t</span><span class="p">)))</span>
    </span><span class='line'><span class="p">(</span><span class="nf">put</span> <span class="ss">&#39;float</span> <span class="ss">&#39;beginning-op</span> <span class="p">(</span><span class="nb">lambda</span> <span class="p">()</span> <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nf">re-search-backward</span> <span class="s">&quot;[^0-9-\.]&quot;</span> <span class="no">nil</span> <span class="no">t</span><span class="p">)</span> <span class="p">(</span><span class="nf">forward-char</span><span class="p">))))</span>
    </span><span class='line'>
    </span><span class='line'><span class="p">(</span><span class="nb">defun</span> <span class="nv">change-number-at-point</span> <span class="p">(</span><span class="nv">fn-float-op</span><span class="p">)</span>
    </span><span class='line'>  <span class="s">&quot;Check if the thing under the cursor looks like a</span>
    </span><span class='line'><span class="s">  float and if so change it with `fn-float-op`.</span>
    </span><span class='line'><span class="s">  `fn-float-op` is passed the name of the synth,</span>
    </span><span class='line'><span class="s">  parameter and float value.&quot;</span>
    </span><span class='line'>
    </span><span class='line'>  <span class="p">(</span><span class="k">let*</span> <span class="p">((</span><span class="nv">bounds</span> <span class="p">(</span><span class="nv">bounds-of-thing-at-point</span> <span class="ss">&#39;float</span><span class="p">))</span>
    </span><span class='line'>         <span class="p">(</span><span class="nv">float-val</span> <span class="p">(</span><span class="nf">buffer-substring</span> <span class="p">(</span><span class="nf">car</span> <span class="nv">bounds</span><span class="p">)</span> <span class="p">(</span><span class="nf">cdr</span> <span class="nv">bounds</span><span class="p">)))</span>
    </span><span class='line'>         <span class="p">(</span><span class="nv">cursor-point</span> <span class="p">(</span><span class="nf">point</span><span class="p">)))</span>
    </span><span class='line'>    <span class="p">(</span><span class="nf">goto-char</span> <span class="p">(</span><span class="nf">car</span> <span class="nv">bounds</span><span class="p">))</span>
    </span><span class='line'>    <span class="p">(</span><span class="nf">re-search-backward</span> <span class="s">&quot;^\\([^\n]+\\): &quot;</span> <span class="p">(</span><span class="nf">line-beginning-position</span><span class="p">)</span> <span class="no">t</span><span class="p">)</span>
    </span><span class='line'>    <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">synth-str</span> <span class="p">(</span><span class="nv">match-string</span> <span class="mi">1</span> <span class="no">nil</span><span class="p">)))</span>
    </span><span class='line'>      <span class="p">(</span><span class="nf">goto-char</span> <span class="p">(</span><span class="nf">car</span> <span class="nv">bounds</span><span class="p">))</span>
    </span><span class='line'>      <span class="p">(</span><span class="nf">delete-char</span> <span class="p">(</span><span class="nf">length</span> <span class="nv">float-val</span><span class="p">))</span>
    </span><span class='line'>      <span class="p">(</span><span class="k">let*</span> <span class="p">((</span><span class="nv">parts</span> <span class="p">(</span><span class="nv">split-string</span> <span class="p">(</span><span class="nv">string-trim</span> <span class="nv">synth-str</span><span class="p">)</span> <span class="s">&quot; &quot;</span><span class="p">))</span>
    </span><span class='line'>             <span class="p">(</span><span class="nv">synth-and-param</span> <span class="p">(</span><span class="k">if</span> <span class="nv">m</span>
    </span><span class='line'>                                  <span class="p">(</span><span class="nf">concat</span>
    </span><span class='line'>                                    <span class="p">(</span><span class="nv">replace-regexp-in-string</span>
    </span><span class='line'>                                     <span class="s">&quot;^#&quot;</span> <span class="s">&quot;&quot;</span> <span class="p">(</span><span class="nv">first</span> <span class="nv">parts</span><span class="p">))</span>
    </span><span class='line'>                                     <span class="s">&quot;/&quot;</span>
    </span><span class='line'>                                     <span class="p">(</span><span class="nv">first</span> <span class="p">(</span><span class="nf">reverse</span> <span class="nv">parts</span><span class="p">)))</span>
    </span><span class='line'>                                 <span class="no">nil</span><span class="p">)))</span>
    </span><span class='line'>        <span class="p">(</span><span class="nf">insert</span>
    </span><span class='line'>         <span class="p">(</span><span class="nf">format</span> <span class="s">&quot;%.2f&quot;</span>
    </span><span class='line'>                 <span class="p">(</span><span class="nf">funcall</span> <span class="nv">fn-float-op</span>
    </span><span class='line'>                   <span class="p">(</span><span class="nf">string-to-number</span> <span class="nv">float-val</span><span class="p">)</span>
    </span><span class='line'>                   <span class="nv">synth-and-param</span><span class="p">)))))</span>
    </span><span class='line'>    <span class="p">(</span><span class="nf">goto-char</span> <span class="nv">cursor-point</span><span class="p">)))</span>
    </span><span class='line'>
    </span><span class='line'><span class="p">(</span><span class="nb">defun</span> <span class="nv">inc-float-at-point</span> <span class="p">()</span>
    </span><span class='line'>  <span class="s">&quot;Increase a float value and send OSC message.&quot;</span>
    </span><span class='line'>  <span class="p">(</span><span class="k">interactive</span><span class="p">)</span>
    </span><span class='line'>  <span class="p">(</span><span class="nv">change-number-at-point</span>
    </span><span class='line'>    <span class="p">(</span><span class="nb">lambda</span> <span class="p">(</span><span class="nv">float-val</span> <span class="nv">synth-and-param</span><span class="p">)</span>
    </span><span class='line'>      <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">new-float</span> <span class="p">(</span><span class="nf">min</span> <span class="mf">1.00</span> <span class="p">(</span><span class="nf">+</span> <span class="nv">float-val</span> <span class="mf">0.01</span><span class="p">))))</span>
    </span><span class='line'>        <span class="p">(</span><span class="nv">route-osc-message</span> <span class="nv">synth-and-param</span> <span class="nv">new-float</span><span class="p">)</span>
    </span><span class='line'>        <span class="nv">new-float</span><span class="p">))))</span>
    </span><span class='line'>
    </span><span class='line'><span class="p">(</span><span class="nb">defun</span> <span class="nv">dec-float-at-point</span> <span class="p">()</span>
    </span><span class='line'>  <span class="s">&quot;Decrease a float value and send OSC message.&quot;</span>
    </span><span class='line'>  <span class="p">(</span><span class="k">interactive</span><span class="p">)</span>
    </span><span class='line'>  <span class="p">(</span><span class="nv">change-number-at-point</span>
    </span><span class='line'>    <span class="p">(</span><span class="nb">lambda</span> <span class="p">(</span><span class="nv">float-val</span> <span class="nv">synth-and-param</span><span class="p">)</span>
    </span><span class='line'>      <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">new-float</span> <span class="p">(</span><span class="nf">max</span> <span class="mf">0.00</span> <span class="p">(</span><span class="nf">-</span> <span class="nv">float-val</span> <span class="mf">0.01</span><span class="p">))))</span>
    </span><span class='line'>        <span class="p">(</span><span class="nv">route-osc-message</span> <span class="nv">synth-and-param</span> <span class="nv">new-float</span><span class="p">)</span>
    </span><span class='line'>        <span class="nv">new-float</span><span class="p">))))</span>
    </span></code></pre></td></tr></table></div></figure>


    <p>We map our <code>synth-and-param</code> to the correct midi port and channel.</p>

    <figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
    <span class='line-number'>2</span>
    <span class='line-number'>3</span>
    <span class='line-number'>4</span>
    <span class='line-number'>5</span>
    <span class='line-number'>6</span>
    <span class='line-number'>7</span>
    <span class='line-number'>8</span>
    </pre></td><td class='code'><pre><code class='elisp'><span class='line'><span></span><span class="p">(</span><span class="nb">defun</span> <span class="nv">route</span><span class="err">—</span><span class="nv">osc-msg</span> <span class="p">(</span><span class="nv">synth-and-param</span> <span class="nv">float-val</span><span class="p">)</span>
    </span><span class='line'>  <span class="p">(</span><span class="nb">when</span> <span class="nv">synth-and-param</span>
    </span><span class='line'>    <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">midi-val</span> <span class="p">(</span><span class="nf">round</span> <span class="p">(</span><span class="nf">*</span> <span class="mf">127.0</span> <span class="nv">float-val</span><span class="p">)))</span>
    </span><span class='line'>          <span class="p">(</span><span class="nv">host</span> <span class="s">&quot;/IAC Bus 1/control_change&quot;</span><span class="p">))</span>
    </span><span class='line'>      <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nv">not</span> <span class="nv">osc-client</span><span class="p">)</span> <span class="p">(</span><span class="nv">osc-connect</span><span class="p">))</span>
    </span><span class='line'>      <span class="p">(</span><span class="k">cond</span>
    </span><span class='line'>       <span class="p">((</span><span class="nf">string-match</span> <span class="nv">synth-and-param</span> <span class="s">&quot;zerocoast/filter&quot;</span><span class="p">)</span>
    </span><span class='line'>         <span class="p">(</span><span class="nv">osc-send-message</span> <span class="nv">osc-client</span> <span class="nv">host</span> <span class="mi">9</span> <span class="mi">100</span> <span class="nv">midi-val</span><span class="p">)))))))))</span>
    </span></code></pre></td></tr></table></div></figure>


    <p>Finally the keybindings that trigger our instrument mode:</p>

    <figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
    <span class='line-number'>2</span>
    </pre></td><td class='code'><pre><code class='elisp'><span class='line'><span></span><span class="p">(</span><span class="nv">global-set-key</span> <span class="p">[(</span><span class="nv">meta</span> <span class="nv">up</span><span class="p">)]</span>    <span class="ss">&#39;inc-float-at-point</span><span class="p">)</span>
    </span><span class='line'><span class="p">(</span><span class="nv">global-set-key</span> <span class="p">[(</span><span class="nv">meta</span> <span class="nv">down</span><span class="p">)]</span>  <span class="ss">&#39;dec-float-at-point</span><span class="p">)</span>
    </span></code></pre></td></tr></table></div></figure>


    <h3>Encoder ASCII Art</h3>

    <p>We are almost done. For fun I’ve added a visually aid to the position of the float encoder. Midi messages are generally limited to 0-127 values, so if we map that to 0-100% we can create a visual representation of the current setting.</p>

    <figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
    <span class='line-number'>2</span>
    <span class='line-number'>3</span>
    <span class='line-number'>4</span>
    <span class='line-number'>5</span>
    <span class='line-number'>6</span>
    <span class='line-number'>7</span>
    <span class='line-number'>8</span>
    <span class='line-number'>9</span>
    <span class='line-number'>10</span>
    <span class='line-number'>11</span>
    <span class='line-number'>12</span>
    <span class='line-number'>13</span>
    <span class='line-number'>14</span>
    <span class='line-number'>15</span>
    <span class='line-number'>16</span>
    <span class='line-number'>17</span>
    <span class='line-number'>18</span>
    <span class='line-number'>19</span>
    <span class='line-number'>20</span>
    <span class='line-number'>21</span>
    <span class='line-number'>22</span>
    <span class='line-number'>23</span>
    <span class='line-number'>24</span>
    <span class='line-number'>25</span>
    <span class='line-number'>26</span>
    <span class='line-number'>27</span>
    <span class='line-number'>28</span>
    <span class='line-number'>29</span>
    <span class='line-number'>30</span>
    <span class='line-number'>31</span>
    <span class='line-number'>32</span>
    <span class='line-number'>33</span>
    <span class='line-number'>34</span>
    <span class='line-number'>35</span>
    <span class='line-number'>36</span>
    <span class='line-number'>37</span>
    <span class='line-number'>38</span>
    <span class='line-number'>39</span>
    <span class='line-number'>40</span>
    <span class='line-number'>41</span>
    <span class='line-number'>42</span>
    <span class='line-number'>43</span>
    <span class='line-number'>44</span>
    <span class='line-number'>45</span>
    <span class='line-number'>46</span>
    <span class='line-number'>47</span>
    <span class='line-number'>48</span>
    <span class='line-number'>49</span>
    <span class='line-number'>50</span>
    <span class='line-number'>51</span>
    <span class='line-number'>52</span>
    <span class='line-number'>53</span>
    <span class='line-number'>54</span>
    </pre></td><td class='code'><pre><code class='elisp'><span class='line'><span></span><span class="p">(</span><span class="nb">defun</span> <span class="nv">code-&gt;pots</span> <span class="p">(</span><span class="nv">beg</span> <span class="nv">end</span><span class="p">)</span>
    </span><span class='line'>  <span class="s">&quot;Add a ASCII encoder bar to anything that looks like a tweakable float&quot;</span>
    </span><span class='line'>
    </span><span class='line'>  <span class="p">(</span><span class="k">interactive</span> <span class="s">&quot;r&quot;</span><span class="p">)</span>
    </span><span class='line'>  <span class="p">(</span><span class="k">save-excursion</span>
    </span><span class='line'>    <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">inhibit-read-only</span> <span class="no">t</span><span class="p">))</span>
    </span><span class='line'>      <span class="p">(</span><span class="nf">remove-text-properties</span> <span class="nv">beg</span> <span class="nv">end</span> <span class="o">&#39;</span><span class="p">(</span><span class="nv">read-only</span> <span class="no">t</span><span class="p">))</span>
    </span><span class='line'>      <span class="p">(</span><span class="nf">goto-char</span> <span class="nv">end</span><span class="p">)</span>
    </span><span class='line'>      <span class="p">(</span><span class="k">setq</span> <span class="nv">i</span> <span class="mi">0</span><span class="p">)</span>
    </span><span class='line'>      <span class="p">(</span><span class="k">while</span> <span class="p">(</span><span class="nf">re-search-backward</span> <span class="s">&quot;_cc .+:\s*\\([0-9]*.[0-9]+\\)\s*\n&quot;</span> <span class="nv">beg</span> <span class="no">t</span><span class="p">)</span>
    </span><span class='line'>        <span class="p">(</span><span class="k">setq</span> <span class="nv">i</span> <span class="p">(</span><span class="nf">+</span> <span class="mi">1</span> <span class="nv">i</span><span class="p">))</span>
    </span><span class='line'>        <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">full</span>     <span class="p">(</span><span class="nf">round</span> <span class="p">(</span><span class="nf">*</span> <span class="nv">MAX-LENGTH</span> <span class="p">(</span><span class="nf">string-to-number</span> <span class="p">(</span><span class="nv">match-string</span> <span class="mi">1</span><span class="p">))))))</span>
    </span><span class='line'>          <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">empty</span>  <span class="p">(</span><span class="nf">-</span> <span class="nv">MAX-LENGTH</span> <span class="nv">full</span><span class="p">)))</span>
    </span><span class='line'>            <span class="p">(</span><span class="nf">goto-char</span> <span class="p">(</span><span class="nf">match-beginning</span> <span class="mi">0</span><span class="p">))</span>
    </span><span class='line'>            <span class="p">(</span><span class="nf">end-of-line</span><span class="p">)</span>
    </span><span class='line'>            <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">start-pnt</span> <span class="p">(</span><span class="nf">point</span><span class="p">))</span>
    </span><span class='line'>                  <span class="p">(</span><span class="nv">pad</span> <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nf">&gt;=</span> <span class="nv">empty</span> <span class="mi">0</span><span class="p">)</span>
    </span><span class='line'>                           <span class="p">(</span><span class="nf">make-string</span> <span class="nv">empty</span> <span class="sc">?╌</span><span class="p">)</span>
    </span><span class='line'>                         <span class="s">&quot;&quot;</span><span class="p">)))</span>
    </span><span class='line'>              <span class="p">(</span><span class="nf">insert</span> <span class="p">(</span><span class="nf">concat</span> <span class="s">&quot; #╟&quot;</span>
    </span><span class='line'>                              <span class="p">(</span><span class="nf">make-string</span> <span class="nv">full</span> <span class="sc">?▓</span><span class="p">)</span>
    </span><span class='line'>                              <span class="s">&quot;▒░&quot;</span>
    </span><span class='line'>                              <span class="nv">pad</span>
    </span><span class='line'>                              <span class="s">&quot;╢&quot;</span><span class="p">))</span>
    </span><span class='line'>              <span class="p">(</span><span class="nf">put-text-property</span> <span class="nv">start-pnt</span> <span class="p">(</span><span class="nf">point</span><span class="p">)</span> <span class="ss">&#39;read-only</span> <span class="no">t</span><span class="p">)))))</span>
    </span><span class='line'>      <span class="p">(</span><span class="nv">align-regexp</span> <span class="nv">beg</span> <span class="p">(</span><span class="nf">+</span> <span class="p">(</span><span class="nf">*</span> <span class="nv">i</span> <span class="mi">106</span><span class="p">)</span> <span class="nv">end</span><span class="p">)</span> <span class="s">&quot;\\(\\s-*\\)#&quot;</span><span class="p">))))</span>
    </span><span class='line'>
    </span><span class='line'><span class="p">(</span><span class="nb">defun</span> <span class="nv">pots-update</span> <span class="p">(</span><span class="nv">new-float</span> <span class="nv">old-float</span><span class="p">)</span>
    </span><span class='line'>  <span class="s">&quot;Update ASCII encoder bar for float being changed&quot;</span>
    </span><span class='line'>
    </span><span class='line'>  <span class="p">(</span><span class="k">interactive</span><span class="p">)</span>
    </span><span class='line'>  <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nv">not</span> <span class="p">(</span><span class="nf">=</span> <span class="nv">new-float</span> <span class="nv">old-float</span><span class="p">))</span>
    </span><span class='line'>      <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">old-full</span> <span class="p">(</span><span class="nf">round</span> <span class="p">(</span><span class="nf">*</span> <span class="mf">100.0</span> <span class="nv">old-float</span><span class="p">)))</span>
    </span><span class='line'>            <span class="p">(</span><span class="nv">full</span>     <span class="p">(</span><span class="nf">round</span> <span class="p">(</span><span class="nf">*</span> <span class="mf">100.0</span> <span class="nv">new-float</span><span class="p">))))</span>
    </span><span class='line'>        <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">empty</span>  <span class="p">(</span><span class="nf">-</span> <span class="nv">MAX-LENGTH</span> <span class="nv">full</span><span class="p">))</span>
    </span><span class='line'>              <span class="p">(</span><span class="nv">movement</span> <span class="p">(</span><span class="nf">-</span> <span class="nv">full</span> <span class="nv">old-full</span><span class="p">))</span>
    </span><span class='line'>              <span class="p">(</span><span class="nv">bmovement</span> <span class="p">(</span><span class="nf">-</span> <span class="nv">old-full</span> <span class="nv">full</span><span class="p">)))</span>
    </span><span class='line'>          <span class="p">(</span><span class="k">save-excursion</span>
    </span><span class='line'>            <span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nf">re-search-forward</span> <span class="s">&quot;#╟&quot;</span> <span class="p">(</span><span class="nf">line-end-position</span><span class="p">)</span> <span class="no">t</span><span class="p">)</span>
    </span><span class='line'>              <span class="p">(</span><span class="nf">goto-char</span> <span class="p">(</span><span class="nf">match-end</span> <span class="mi">0</span><span class="p">))</span>
    </span><span class='line'>              <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">inhibit-read-only</span> <span class="no">t</span><span class="p">)</span>
    </span><span class='line'>                    <span class="p">(</span><span class="nv">start-pnt</span> <span class="p">(</span><span class="nf">point</span><span class="p">)))</span>
    </span><span class='line'>                <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nf">&gt;</span> <span class="nv">new-number</span> <span class="nv">old-float</span><span class="p">)</span>
    </span><span class='line'>                    <span class="p">(</span><span class="k">progn</span> <span class="c1">;;forwards</span>
    </span><span class='line'>                      <span class="p">(</span><span class="nf">forward-char</span> <span class="nv">old-full</span><span class="p">)</span>
    </span><span class='line'>                      <span class="p">(</span><span class="nf">insert</span> <span class="p">(</span><span class="nf">make-string</span> <span class="nv">movement</span> <span class="sc">?▓</span><span class="p">))</span>
    </span><span class='line'>                      <span class="p">(</span><span class="nf">forward-char</span> <span class="mi">2</span><span class="p">)</span>
    </span><span class='line'>                      <span class="p">(</span><span class="nf">delete-char</span> <span class="nv">movement</span><span class="p">))</span>
    </span><span class='line'>                  <span class="p">(</span><span class="k">progn</span> <span class="c1">;;backwards</span>
    </span><span class='line'>                    <span class="p">(</span><span class="nf">forward-char</span> <span class="p">(</span><span class="nf">-</span> <span class="nv">old-full</span> <span class="nv">bmovement</span><span class="p">))</span>
    </span><span class='line'>                    <span class="p">(</span><span class="nf">delete-char</span> <span class="nv">bmovement</span><span class="p">)</span>
    </span><span class='line'>                    <span class="p">(</span><span class="nf">forward-char</span> <span class="mi">2</span><span class="p">)</span>
    </span><span class='line'>                    <span class="p">(</span><span class="nf">insert</span> <span class="p">(</span><span class="nf">make-string</span> <span class="nv">bmovement</span> <span class="sc">?╌</span><span class="p">))))</span>
    </span><span class='line'>                <span class="p">(</span><span class="nf">put-text-property</span> <span class="nv">start-pnt</span> <span class="p">(</span><span class="nf">point</span><span class="p">)</span> <span class="ss">&#39;read-only</span> <span class="no">t</span><span class="p">))))))))</span>
    </span></code></pre></td></tr></table></div></figure>


    <p>The Ascii dials:</p>

    <figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
    <span class='line-number'>2</span>
    <span class='line-number'>3</span>
    </pre></td><td class='code'><pre><code class='elisp'><span class='line'><span></span><span class="nv">zerocoast_cc</span> <span class="nv">amp:</span> <span class="mf">0.18</span> <span class="err">#╟▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▒░╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╢</span>
    </span><span class='line'>
    </span><span class='line'><span class="nv">zerocoast_cc</span> <span class="nv">amp:</span> <span class="mf">1.00</span> <span class="err">#╟▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▒░╢</span>
    </span></code></pre></td></tr></table></div></figure>


    <h2>Binding into a Performance</h2>

    <p>All this work was used in my recent performance:</p>

    <p>“You Fall into Your Screen”: <a href="https://vimeo.com/replelectric/you-fall-into-your-screen">https://vimeo.com/replelectric/you-fall-into-your-screen</a></p>

    <p>I’m using Emacs to simultaneous control Synths and Unity3D in much the same way discussed in this post. It feels pretty amazing to augment the performance with this live control.</p>
    </div>


        </article>



    <article>

  <header>

      <h1 class="entry-title"><a href="/clojure/functions-explained-through-patterns.html">Functions Explained Through Patterns</a></h1>


      <p class="meta">












<time datetime="2017-02-07T14:00:00+00:00" pubdate data-updated="true">Feb 7<span>th</span>, 2017</time>

      </p>

  </header>


  <div class="entry-content"><p>Exploring patterns as a means of documenting Clojure functions to aid recall and understanding.</p>

<p>Whats the difference in Clojure between:
<code>partition</code> and <code>partition-all</code>?
<code>interpose</code> and <code>interleave</code>?
<code>cons</code> and <code>conj</code>?</p>

<h2>Documenting Functions</h2>

<p>All non-side effecting functions create or alter a pattern. To explain a function&rsquo;s pattern we use a number of descriptions.</p>

<ul>
<li>A function signature:</li>
</ul>


<p><code>(nthrest coll n)</code></p>

<ul>
<li>A textual description:</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Returns a lazy seq of the elements of coll separated by sep.
</span><span class='line'>Returns a stateful transducer when no collection is provided.</span></code></pre></td></tr></table></div></figure>


<ul>
<li>Examples showing application of the function:</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">interpose</span> <span class="mf">1.0</span> <span class="p">[</span><span class="mf">0.3</span> <span class="mf">0.4</span><span class="p">])</span>
</span><span class='line'><span class="c1">;;=&gt; [0.3 1.0 0.4 1.0]</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Exploration vs Recall</h2>

<p>As someone with a brain far more orientated to visuals than text I struggled to remember and understand many Clojure functions: <code>nthrest</code>, <code>conj</code> <code>cons</code>, etc.
The documentation of patterns in the Clojure documentation is all text. Even with the documentation brought into the editor I struggle. Example from <a href="https://github.com/clojure-emacs/cider">Cider</a> &amp; Emacs:</p>

<p><img src="/images/emacs-cider.png"></p>

<p>Clojure has a strong focus on REPL driven development. If you don&rsquo;t understand a function use an interactive REPL to explore examples.</p>

<p>Critically this favours <strong>discovery over recall</strong>. I can never remember the difference between <code>conj</code> and <code>cons</code>, but I can find out through the REPL.</p>

<p>To help aid memory and understanding I&rsquo;ve turn the examples of the collection orientated functions in Clojure into visual patterns. I won&rsquo;t try and make any general case on visuals vs text (Its a fuzzy research area: <a href="http://studiokayama.com/text-vs-visuals/">http://studiokayama.com/text-vs-visuals/</a>).</p>

<h2>Patterns for the visual brain</h2>

<p>Applying functions to collections of data using: <a href="https://github.com/josephwilk/functions-as-patterns">https://github.com/josephwilk/functions-as-patterns</a></p>

<h2><code>(butlast coll)</code></h2>

<pre><code>Return a seq of all but the last item in coll, in linear time
</code></pre>

<div>
<span><span style="font-size: 2em;">(</span><code>butlast <img  style="vertical-align:middle" src="https://raw.githubusercontent.com/josephwilk/functions-as-patterns/master/doc/clojure.core%24butlast_arg0.png"> <span style="font-size: 2em;">)</span></code></span>
</div>


<div><code>;;=></code></div>


<div style="padding-bottom: 40px;">
<span><img src="https://raw.githubusercontent.com/josephwilk/functions-as-patterns/master/doc/clojure.core%24butlast_post.png"></span>
</div>


<h2><code>(concat x y)</code></h2>

<pre><code>Returns a lazy seq representing the concatenation of the elements
in the supplied colls.
</code></pre>

<div>
<span><span style="font-size: 2em;">(</span><code>concat <img  style="vertical-align:middle" src="https://raw.githubusercontent.com/josephwilk/functions-as-patterns/master/doc/clojure.core%24concat_arg0.png"> <img  style="vertical-align:middle" src="https://raw.githubusercontent.com/josephwilk/functions-as-patterns/master/doc/clojure.core%24concat_arg1.png"> <span style="font-size: 2em;">)</span></code></span>
</div>


<div><code>;;=></code></div>


<div style="padding-bottom: 40px;">
<span><img src="https://raw.githubusercontent.com/josephwilk/functions-as-patterns/master/doc/clojure.core%24concat_post.png"></span>
</div>


<h2><code>(conj coll x) (conj coll x &amp; xs)</code></h2>

<pre><code>conj[oin]. Returns a new collection with the xs
'added'. (conj nil item) returns (item).  The 'addition' may
happen at different 'places' depending on the concrete type.
</code></pre>

<h5><code>conj vector</code></h5>

<div>
<span><span style="font-size: 2em;">(</span><code>conj <img  style="vertical-align:middle" src="https://raw.githubusercontent.com/josephwilk/functions-as-patterns/master/doc/clojure.core%24conj_arg0_vec.png"> <img  style="vertical-align:middle" src="https://raw.githubusercontent.com/josephwilk/functions-as-patterns/master/doc/clojure.core%24conj_arg1_vec.png"> <span style="font-size: 2em;">)</span></code></span>
</div>


<div><code>;;=></code></div>


<div style="padding-bottom: 40px;">
<span><img src="https://raw.githubusercontent.com/josephwilk/functions-as-patterns/master/doc/clojure.core%24conj_post_vec.png"></span>
</div>


<h5><code>conj list</code></h5>

<div>
<span><span style="font-size: 2em;">(</span><code>conj <img  style="vertical-align:middle" src="https://raw.githubusercontent.com/josephwilk/functions-as-patterns/master/doc/clojure.core%24conj_arg0_list.png"> <img  style="vertical-align:middle" src="https://raw.githubusercontent.com/josephwilk/functions-as-patterns/master/doc/clojure.core%24conj_arg1_list.png"> <span style="font-size: 2em;">)</span></code></span>
</div>


<div><code>;;=></code></div>


<div style="padding-bottom: 40px;">
<span><img src="https://raw.githubusercontent.com/josephwilk/functions-as-patterns/master/doc/clojure.core%24conj_post_list.png"></span>
</div>


<h2><code>(cons x seq)</code></h2>

<pre><code>Returns a new seq where x is the first element and seq is
the rest.
</code></pre>

<div>
<span><span style="font-size: 2em;">(</span><code>cons <img  style="vertical-align:middle" src="https://raw.githubusercontent.com/josephwilk/functions-as-patterns/master/doc/clojure.core%24cons_arg0.png"> <img  style="vertical-align:middle" src="https://raw.githubusercontent.com/josephwilk/functions-as-patterns/master/doc/clojure.core%24cons_arg1.png"> <span style="font-size: 2em;">)</span></code></span>
</div>


<div><code>;;=></code></div>


<div style="padding-bottom: 40px;">
<span><img src="https://raw.githubusercontent.com/josephwilk/functions-as-patterns/master/doc/clojure.core%24cons_post.png"></span>
</div>

<h2><code>(dedupe coll)</code></h2>

<pre><code>Returns a lazy sequence removing consecutive duplicates in coll.
Returns a transducer when no collection is provided.</code></pre>

<div>
<span><span style="font-size: 2em;">(</span><code>dedupe <img  style="vertical-align:middle" src="https://raw.githubusercontent.com/josephwilk/functions-as-patterns/master/doc/clojure.core%24dedupe_arg0.png"> <span style="font-size: 2em;">)</span></code></span>
</div>

<div><code>;;=></code></div>


<div style="padding-bottom: 40px;">
<span><img src="https://raw.githubusercontent.com/josephwilk/functions-as-patterns/master/doc/clojure.core%24dedupe_post.png"></span>
</div>



<h2><code>(distinct coll)</code></h2>

<pre><code>Returns a lazy sequence of the elements of coll with duplicates removed.
Returns a stateful transducer when no collection is provided.
</code></pre>

<div>
<span><span style="font-size: 2em;">(</span><code>distinct <img  style="vertical-align:middle" src="https://raw.githubusercontent.com/josephwilk/functions-as-patterns/master/doc/clojure.core%24distinct_arg0.png"> <span style="font-size: 2em;">)</span></code></span>
</div>


<div><code>;;=></code></div>


<div style="padding-bottom: 40px;">
<span><img src="https://raw.githubusercontent.com/josephwilk/functions-as-patterns/master/doc/clojure.core%24distinct_post.png"></span>
</div>


<h2><code>(drop-last n coll)</code></h2>

<pre><code>Return a lazy sequence of all but the last n (default 1) items in coll
</code></pre>

<div>
<span><span style="font-size: 2em;">(</span><code>drop-last 2 <img  style="vertical-align:middle" src="https://raw.githubusercontent.com/josephwilk/functions-as-patterns/master/doc/clojure.core%24drop_last_arg1.png"> <span style="font-size: 2em;">)</span></code></span>
</div>


<div><code>;;=></code></div>


<div style="padding-bottom: 40px;">
<span><img src="https://raw.githubusercontent.com/josephwilk/functions-as-patterns/master/doc/clojure.core%24drop_last_post.png"></span>
</div>


<h2><code>(flatten coll)</code></h2>

<pre><code>Takes any nested combination of sequential things (lists, vectors,
etc.) and returns their contents as a single, flat foldable
collection.
</code></pre>

<div>
<span><span style="font-size: 2em;">(</span><code>flatten <img  style="vertical-align:middle" src="https://raw.githubusercontent.com/josephwilk/functions-as-patterns/master/doc/clojure.core%24flatten_arg0.png"> <span style="font-size: 2em;">)</span></code></span>
</div>


<div><code>;;=></code></div>


<div style="padding-bottom: 40px;">
<span><img src="https://raw.githubusercontent.com/josephwilk/functions-as-patterns/master/doc/clojure.core%24flatten_post.png"></span>
</div>


<h2><code>(interpose coll coll)</code></h2>

<pre><code>Returns a lazy seq of the elements of coll separated by sep.
Returns a stateful transducer when no collection is provided.
</code></pre>

<div style="padding-bottom: 10px;">
<span><span style="font-size: 2em;">(</span><code>interpose <img  style="vertical-align:middle" src="https://raw.githubusercontent.com/josephwilk/functions-as-patterns/master/doc/clojure.core%24interpose_arg0.png"> <img  style="vertical-align:middle" src="https://raw.githubusercontent.com/josephwilk/functions-as-patterns/master/doc/clojure.core%24interpose_arg1.png"><span style="font-size: 2em;">)</span></code></span>
</div>


<div><code>;;=></code></div>


<div style="padding-bottom: 40px;">
<span><img src="https://raw.githubusercontent.com/josephwilk/functions-as-patterns/master/doc/clojure.core%24interpose_post.png"></span>
</div>


<h2><code>(interleave coll coll)</code></h2>

<pre><code>Returns a lazy seq of the first item in each coll, then the second etc.
</code></pre>

<div>
<span><span style="font-size: 2em;">(</span><code>interleave <img  style="vertical-align:middle" src="https://raw.githubusercontent.com/josephwilk/functions-as-patterns/master/doc/clojure.core%24interleave_arg0.png"> <img  style="vertical-align:middle" src="https://raw.githubusercontent.com/josephwilk/functions-as-patterns/master/doc/clojure.core%24interleave_arg1.png"><span style="font-size: 2em;">)</span></code></span>
</div>


<div><code>;;=></code></div>


<div style="padding-bottom: 40px;">
<span><img src="https://raw.githubusercontent.com/josephwilk/functions-as-patterns/master/doc/clojure.core%24interleave_post.png"></span>
</div>


<h2><code>(nthnext coll n)</code></h2>

<pre><code>Returns the nth next of coll, (seq coll) when n is 0.
</code></pre>

<div>
<span><span style="font-size: 2em;">(</span><code>nthnext <img  style="vertical-align:middle" src="https://raw.githubusercontent.com/josephwilk/functions-as-patterns/master/doc/clojure.core%24nthnext_arg0.png"> 2<span style="font-size: 2em;">)</span></code></span>
</div>


<div><code>;;=></code></div>


<div style="padding-bottom: 40px;">
<span><img src="https://raw.githubusercontent.com/josephwilk/functions-as-patterns/master/doc/clojure.core%24nthnext_post.png"></span>
</div>


<h2><code>(nthrest coll n)</code></h2>

<pre><code>Returns the nth rest of coll, coll when n is 0.
</code></pre>

<div>
<span><span style="font-size: 2em;">(</span><code>nthrest <img  style="vertical-align:middle" src="https://raw.githubusercontent.com/josephwilk/functions-as-patterns/master/doc/clojure.core%24nthrest_arg0.png"> 2 <span style="font-size: 2em;">)</span></code></span>
</div>


<div><code>;;=></code></div>


<div style="padding-bottom: 40px;">
<span><img src="https://raw.githubusercontent.com/josephwilk/functions-as-patterns/master/doc/clojure.core%24nthrest_post.png"></span>
</div>


<h2><code>(partition n coll)</code></h2>

<pre><code>Returns a lazy sequence of lists of n items each, at offsets step apart.
If step is not supplied, defaults to n, i.e. the partitions do not overlap.
If a pad collection is supplied, use its elements as necessary to complete
last partition upto n items. In case there are not enough padding elements,
return a partition with less than n items.
</code></pre>

<div>
<span><span style="font-size: 2em;">(</span><code>partition 3 <img  style="vertical-align:middle" src="https://raw.githubusercontent.com/josephwilk/functions-as-patterns/master/doc/clojure.core%24partition_arg1.png"> <span style="font-size: 2em;">)</span></code></span>
</div>


<div><code>;;=></code></div>


<div style="padding-bottom: 40px;">
<span><img src="https://raw.githubusercontent.com/josephwilk/functions-as-patterns/master/doc/clojure.core%24partition_post.png"></span>
</div>


<h2><code>(partition-all n coll)</code></h2>

<pre><code>Returns a lazy sequence of lists like partition, but may include
partitions with fewer than n items at the end.  Returns a stateful
transducer when no collection is provided.
</code></pre>

<div>
<span><span style="font-size: 2em;">(</span><code>partition-all 3 <img  style="vertical-align:middle" src="https://raw.githubusercontent.com/josephwilk/functions-as-patterns/master/doc/clojure.core%24partition_all_arg1.png"> <span style="font-size: 2em;">)</span></code></span>
</div>


<div><code>;;=></code></div>


<div style="padding-bottom: 40px;">
<span><img src="https://raw.githubusercontent.com/josephwilk/functions-as-patterns/master/doc/clojure.core%24partition_all_post.png"></span>
</div>


<h2><code>(replace smap coll)</code></h2>

<pre><code>Given a map of replacement pairs and a vector/collection, returns a vector/seq
with any elements = a key in smap replaced with the corresponding val in smap.
Returns a transducer when no collection is provided.
</code></pre>

<div>
<span><span style="font-size: 2em;">(</span><code>replace <img  style="vertical-align:middle" src="https://raw.githubusercontent.com/josephwilk/functions-as-patterns/master/doc/clojure.core%24replace_arg0.png"> [0 3 4] <span style="font-size: 2em;">)</span></code></span>
</div>


<div><code>;;=></code></div>


<div style="padding-bottom: 40px;">
<span><img src="https://raw.githubusercontent.com/josephwilk/functions-as-patterns/master/doc/clojure.core%24replace_post.png"></span>
</div>


<h2><code>(rest coll)</code></h2>

<pre><code>Returns a possibly empty seq of the items after the first. Calls seq on its
argument.
</code></pre>

<div>
<span><span style="font-size: 2em;">(</span><code>rest <img  style="vertical-align:middle" src="https://raw.githubusercontent.com/josephwilk/functions-as-patterns/master/doc/clojure.core%24rest_arg0.png"> <span style="font-size: 2em;">)</span></code></span>
</div>


<div><code>;;=></code></div>


<div style="padding-bottom: 40px;">
<span><img src="https://raw.githubusercontent.com/josephwilk/functions-as-patterns/master/doc/clojure.core%24rest_post.png"></span>
</div>


<h2><code>(reverse coll)</code></h2>

<pre><code>Returns a seq of the items in coll in reverse order. Not lazy.
</code></pre>

<div>
<span><span style="font-size: 2em;">(</span><code>reverse <img  style="vertical-align:middle" src="https://raw.githubusercontent.com/josephwilk/functions-as-patterns/master/doc/clojure.core%24reverse_arg0.png"> <span style="font-size: 2em;">)</span></code></span>
</div>


<div><code>;;=></code></div>


<div style="padding-bottom: 40px;">
<span><img src="https://raw.githubusercontent.com/josephwilk/functions-as-patterns/master/doc/clojure.core%24reverse_post.png"></span>
</div>


<h2><code>(shuffle coll)</code></h2>

<pre><code>Return a random permutation of coll.
</code></pre>

<div>
<span><span style="font-size: 2em;">(</span><code>shuffle <img style="vertical-align:middle" src="https://raw.githubusercontent.com/josephwilk/functions-as-patterns/master/doc/clojure.core%24shuffle_arg0.png"> <span style="font-size: 2em;">)</span></code></span>
</div>


<div><code>;;=></code></div>


<div style="padding-bottom: 40px;">
<span><img src="https://raw.githubusercontent.com/josephwilk/functions-as-patterns/master/doc/clojure.core%24shuffle_post.png"></span>
</div>


<h2><code>(sort coll)</code></h2>

<pre><code>Returns a sorted sequence of the items in coll. If no comparator is
supplied, uses compare.  comparator must implement
java.util.Comparator.  Guaranteed to be stable: equal elements will
not be reordered.  If coll is a Java array, it will be modified.  To
avoid this, sort a copy of the array.
</code></pre>

<div>
<span><span style="font-size: 2em;">(</span><code>sort <img style="vertical-align:middle" src="https://raw.githubusercontent.com/josephwilk/functions-as-patterns/master/doc/clojure.core%24sort_arg0.png"> <span style="font-size: 2em;">)</span></code></span>
</div>


<div><code>;;=></code></div>


<div style="padding-bottom: 40px;">
<span><img src="https://raw.githubusercontent.com/josephwilk/functions-as-patterns/master/doc/clojure.core%24sort_post.png"></span>
</div>


<h2><code>(take-nth n coll)</code></h2>

<pre><code>Returns a lazy seq of every nth item in coll.
</code></pre>

<div>
<span><span style="font-size: 2em;">(</span><code>take-nth 3 <img style="vertical-align:middle" src="https://raw.githubusercontent.com/josephwilk/functions-as-patterns/master/doc/clojure.core%24take_nth_arg1.png"> <span style="font-size: 2em;">)</span></code></span>
</div>


<div><code>;;=></code></div>


<div style="padding-bottom: 40px;">
<span><img src="https://raw.githubusercontent.com/josephwilk/functions-as-patterns/master/doc/clojure.core%24take_nth_post.png"></span>
</div>


<h2><code>(split-at n coll)</code></h2>

<pre><code>Returns a vector of [(take n coll) (drop n coll)]
</code></pre>

<div>
<span><span style="font-size: 2em;">(</span><code>split-at 2 <img  style="vertical-align:middle" src="https://raw.githubusercontent.com/josephwilk/functions-as-patterns/master/doc/clojure.core%24split_at_arg1.png"> <span style="font-size: 2em;">)</span></code></span>
</div>


<div><code>;;=></code></div>


<div style="padding-bottom: 40px;">
<span><img src="https://raw.githubusercontent.com/josephwilk/functions-as-patterns/master/doc/clojure.core%24split_at_post.png"></span>
</div>


<h2>Conclusions</h2>

<p>As someone who performs live coding to an audience I perhaps have a different value on recall vs exploration. Hundreds of eyes staring at you tends to have that effect.
While some examples are stronger through patterns than others, at least for myself the use of a visual aid as part of development and documentation is beneficial. Its the only way I can the remember the oddity of <code>conj</code>.</p>

<p>Within my REPL interaction I use the <a href="https://github.com/josephwilk/functions-as-patterns">functions-as-patterns</a> toolkit, providing a higher level representation of the patterns and data. I can understand a drum pattern faster through colour than I can through a 1 &amp; 0 data structure.</p>

<p>In creating the cheatsheet the value of the comparison of functions through patterns also became clear. I discovered almost identical functions such as <code>nthnext</code> and <code>nthrest</code> which only differed in a special case (with an empty sequence).</p>

<h3>Problems of turning data into colour</h3>

<p>While this visual cheatsheet is useful there are caveats:</p>

<h4>Semantic&rsquo;s of arguments</h4>

<p>Its not always clear if an argument is an index or a value. If we look at the <code>replace</code> function example:</p>

<p><code>(replace (take 5 (hues-of-color)) [0 3 4])</code></p>

<p>0,3 &amp; 4 are references to indices within the first argument. Ideally it would be nice to replace those with the relevant colour.
However the functions-as-patterns library cannot tell these are not values, it assumes everything is a value. Hence you end up with <code>[0 3 4]</code> drawn in shades of black:</p>

<p><img src="https://raw.githubusercontent.com/josephwilk/functions-as-patterns/master/doc/clojure.core%24replace_arg1.png"></p>

<h4>Pattern of emptyness</h4>

<p>I&rsquo;ve not tried to visually represent, <code>empty</code> or <code>nil</code>. Some functions are defined by the difference in handling the empty case. The patterns might mis-lead you to think <code>nthnext</code> and <code>nthrest</code> are identical when they are not.</p>

<h4>What type is a square?</h4>

<p>Clojure has multiple types of sequences, <code>char-arrays</code>, <code>lists</code>, <code>vectors</code>, <code>lazy-seq</code> ,etc. To keep the visual pattern simple I&rsquo;ve not represented these types.</p>

<h4>Functions applying functions</h4>

<p>I&rsquo;ve purposely skipped the <code>map</code>/<code>reduce</code>/<code>remove</code>/<code>filter</code> functions as they tend to mix two patterns together. That of the core function and the applied function. The value of the patterns gets lost.</p>

<h4>Brains seek patterns.</h4>

<p>Do you see a pattern in the randomness? A single example might reveal a false pattern. Many examples would be required to re-enforce the randomness of the resulting patterns. Example <code>shuffle</code>.</p>

<h4>Ordering</h4>

<p>Colours don’t always imply a logical order. Example <code>sort</code>.</p>

<h2>Sources</h2>

<p>Inspired by the work of Alex McLean (<a href="https://github.com/yaxu">@yaxu</a>) using visual patterns to explain the live coding language Tidal: <a href="https://www.academia.edu/467099/TIDAL_PATTERN_LANGUAGE_FOR_LIVE_CODING_OF_MUSIC">Tidal Pattern Language for Live Coding of Music</a></p>
</div>




    </article>


    <article>

  <header>

      <h1 class="entry-title"><a href="/art/audio-fingerprint-smudges.html">Audio Fingerprint Smudges</a></h1>


      <p class="meta">












<time datetime="2016-12-31T12:00:00+00:00" pubdate data-updated="true">Dec 31<span>st</span>, 2016</time>

      </p>

  </header>


  <div class="entry-content"><p>Procedurally generating music, scoring generations based on an audio service (like SoundCloud) identifying it as an existing song/artist. The more famous the track/artist the better.</p>




<p>Machines identifying audio tend to:</p>




<ul>
<li>Reduce the audio features to their essence (facilitating fast lookup or accuracy on a sliding scale).</li>
<li>Rely on computer vision techniques to create audio fingerprints.</li>
<li>Account for differing audio quality and ambient background noise.</li>
<li>Use a training set of sane music to teach the algorithm to recognise music.</li>
</ul>




<p><small>Audiofinger print generated by <a href="https://github.com/acoustid/chromaprint">Chromaprint</a>:</small><br/>
<img src="/images/heavenflac.png" alt="Example audio fingerprint generated by Chromaprint for: Heaven by UNKLE" /></p>




<p>We use these propeties to guide us in creating new music for machines that explores the smudged edges around machine listening. Highlighting how differently humans and machines identify music. And for fun.</p>




<p>To try and match our generative audio to songs we will use a number of music services and some open-source audio fingerprinting tools. Most commercial audio fingerprinting algorithms are secret and patented up to the eyeballs. So there is a lot of trial and errors. Some services used to evalute a song match:</p>




<ul>
<li>Soundcloud (copyright detection)</li>
<li>Youtube (copyright detection)</li>
<li>Shazam (audio lookup)</li>
<li>Chromaprint (Open-source audio fingerpinter)</li>
</ul>




<h2>Music for Machines</h2>




<p>All generated tracks have comments exactly when a song was detected.</p>




<p><strong>Warning: The audio clips are designed for machines and not your weak human ears <img class="emoji" alt="ear" width="25" src="https://assets-cdn.github.com/images/icons/emoji/unicode/1f442.png">. Hence keep your volume low before listening</strong></p>




<p>Audio generations by <a href="https://twitter.com/Finger_smudger">@Finger_smudger</a></p>




<h3>Generation #1 &ndash; 1467636802259</h3>




<p>Artists/Songs identified:</p>




<ul>
<li>Sophonic Media &ndash; Make It Shine</li>
<li>Pachanga Boys &ndash; Time</li>
<li>Johan Vilborg &ndash; Second Wind (Illuminor Remix)</li>
<li>Oelki &ndash; Galileo</li>
<li>Lipps, Inc &ndash; Funkytown</li>
<li>Spaceanddisco &ndash; Nights</li>
<li>Matt Fax &ndash; Voyage orignal mix Bullistik</li>
<li>Katty Perry &ndash; Birthday (Cash Cash Remix)</li>
</ul>




<iframe width="100%" height="200" scrolling="no" frameborder="no" src="https://w.soundcloud.com/player/?url=https%3A//api.soundcloud.com/tracks/272121435&amp;auto_play=false&amp;hide_related=false&amp;show_comments=true&amp;show_user=true&amp;show_reposts=false&amp;visual=true"></iframe>


<br/><br/>




<h3>Generation #1.1 &ndash; 1469483772764</h3>




<p>Artists/Songs identified:</p>




<ul>
<li>George Michael &ndash; A Different Corner</li>
<li>Dezt &ndash; Last Year</li>
<li>Axiuw &ndash; Be Yourself (Original Mix)</li>
<li>Duran Duran &ndash; Thank You</li>
</ul>




<iframe width="100%" height="200" scrolling="no" frameborder="no" src="https://w.soundcloud.com/player/?url=https%3A//api.soundcloud.com/tracks/275449291&amp;auto_play=false&amp;hide_related=false&amp;show_comments=true&amp;show_user=true&amp;show_reposts=false&amp;visual=true"></iframe>


<br/><br/>




<h3>Generation #2.0 &ndash; 1470683054969</h3>




<p>Artist/Songs identified:</p>




<ul>
<li>Dimension &ndash; Mangata</li>
<li>Michael Jackson &ndash; You Are Not Alone (tempo 60 bpm / B major)</li>
</ul>




<iframe width="100%" height="200" scrolling="no" frameborder="no" src="https://w.soundcloud.com/player/?url=https%3A//api.soundcloud.com/tracks/277511054&amp;auto_play=false&amp;hide_related=false&amp;show_comments=true&amp;show_user=true&amp;show_reposts=false&amp;visual=true"></iframe>


<br/><br/>




<h3>Generation #2.0 &ndash; 1470700413305</h3>




<p>Artist/Songs identified:</p>




<ul>
<li>T-Pain Vs Chuckie Feat. Pitbull &ndash; Its Not You (Its Me)</li>
<li>Pink Floyd &ndash; Cymbaline</li>
</ul>




<iframe width="100%" height="200" scrolling="no" frameborder="no" src="https://w.soundcloud.com/player/?url=https%3A//api.soundcloud.com/tracks/277510353&amp;auto_play=false&amp;hide_related=false&amp;show_comments=true&amp;show_user=true&amp;show_reposts=false&amp;visual=true"></iframe>


<br/><br/>




<h2>Machines listening with ambient background noise</h2>




<p>While I experimented with lots of different services the above examples were most successful when using Shazam for identification. This focuses on operating in noisy environments and identifying a sound as quickly as possible based only on partial song information. This tolerance makes it easy to get Shazam to mis-match audio to songs.</p>




<p>The other services also had a nasty habit of banning new accounts uploading what appeared to be copyrighted infringing content (who would have thought!). Which makes the whole mass procedural generation somewhat challenging.</p>




<p>Shazam has a <a href="https://www.shazam.com/">desktop app</a> which will run detection on audio for 8 hours continuously. So over that time we generate a large set of audio and pick the winners from each generation.</p>




<h3>Overtone synths &amp; score generation</h3>




<p>Using <a href="https://github.com/overtone/overtone">Overtone</a> and Clojure a single audio generation works by:</p>




<ol>
<li><p>Dynamically generating Overtone synths using generative testing framework <a href="https://github.com/clojure/test.check">test.check</a>.
Using QuickCheck style generators is a cheap way of exploring a permutation space given grammar rules, like those of a synth definition in Overtone. Supports selection of:

<ul>
<li>Audio wave (potentially many combined)</li>
<li>Envelope type</li>
<li>Effects (reverb/echo/pitchshift/delays)</li>
<li>Filters (low pass/high pass)<br/>
The various properties of the audio units are selected randomly.</li>
</ul></p>
</li>
<li><p>Dynamically generating a score varying:

<ul>
<li>Clock tempo</li>
<li>Note lengths</li>
<li>Root note / scale</li>
<li>Octaves</li>
</ul>
</p>
</li>
<li><p>Dynamically generating synth control parameters:

<ul>
<li>Distortion</li>
<li>Changing audio wave (sin/saw/triangle/square/etc)</li>
</ul>
</p>
</li>
<li><p>Running for 3 minutes with a random chance of mutation to score and parameters.</p></li>

<li>Store state of a generation for future evolution. We store the state and mutations as edn: <a href="https://gist.githubusercontent.com/josephwilk/410f68a857f81e8073815999bf1a4b4f/raw/78319023141b18dfe90ab1183ecc13b30c4def33/1470683054969.edn">Example state for one generation</a></p></li>

<li><p>Each generation scored based on number of Shazam matches (scraped from Notification alerts on OS X).</p></li>
<li><p>Each generation scored by popularity of artists matched (manually <img src="https://assets-cdn.github.com/images/icons/emoji/unicode/1f62c.png" width="25" alt="grimace" class="emoji">).</p></li>
</ol>


<br/>




<p>To avoid any background noise or messing with microphones we use <a href="https://github.com/mattingalls/Soundflower">SoundFlower</a> with the following setup:</p>


<p> Overtone main audio -><img src="https://assets-cdn.github.com/images/icons/emoji/unicode/1f508.png" alt="speaker" class="emoji"> Soundflower input device<br/>
Soundflower output device -><img src="https://assets-cdn.github.com/images/icons/emoji/unicode/1f508.png" alt="speaker" class="emoji"> Shazam Desktop.</p>




<h2>Conclusion</h2>




<p>There is a clear difference in the strength of accuracy when it comes to fingerprinting audio for copyright infringement. It&#8217;s noticeable that Soundcloud or YouTube are matching when  processing the entire track (even though it will check for partial matches) while Shazam focuses on as small a segment as possible LIVE. Open-source alternatives (like Chromaprint) while useful, provided little help tricking the commercial services.</p>




<p>Coming back to Shazam, what actually made the tracks match remains somewhat of a mystery. If we look at one example &#8220;Michael Jackson - You Are Not Alone&#8221; our generative score was not even in the same scale or tempo! We can identify things that made it hard to match, for example adding drums patterns killed off all matches. More layers of audio, more permutations to explore.</p>




<p>One thing is clear, the way machines learn and the specialisation on a single application rules out a whole subset of sound that is unlikely to enter the realm of music. Hence for the creators of the algorithms, a mismatch of this type is of little relevance.</p>




<p>This lost ghost music is perhaps just for the machines.</p>




<h2>Source code</h2>




<ul>
<li><p><strong>Finger Smudge</strong>: <a href="https://github.com/josephwilk/finger-smudge">https://github.com/josephwilk/finger-smudge</a>.
Core engine behind generating audio and container for all failed and future audio fingerprint smudge experiments:</p></li>
<li><p><strong>Synthatron</strong>: <a href="https://github.com/josephwilk/synthatron">https://github.com/josephwilk/synthatron</a>.
Overtone Synth generator using <code>test.check</code>:</p></li>
</ul>

</div>




    </article>


    <article>

  <header>

      <h1 class="entry-title"><a href="/art/overtone-shader-visuals.html">Visuals With Overtone and Shadertone</a></h1>


      <p class="meta">












<time datetime="2016-01-08T14:58:00+00:00" pubdate data-updated="true">Jan 8<span>th</span>, 2016</time>

      </p>

  </header>


  <div class="entry-content"><p>Exploring techniques for creating live coded performances with Overtone and <a href="https://www.opengl.org/wiki/Fragment_Shader">OpenGL Fragment Shaders</a>. Much learnt from my work performing as <a href="https://vimeo.com/replelectric">Repl Electric</a>. All my shader source code for these performances is open: <a href="https://github.com/repl-electric/cassiopeia/tree/master/resources/shaders">https://github.com/repl-electric/cassiopeia/tree/master/resources/shaders</a></p>




<p><img src="/images/end-of-buffer.png" alt="shaders"/></p>




<p>To bring OpenGl to Clojure I use <a href="https://github.com/overtone/shadertone">Shadertone</a> written by <a href="https://github.com/rogerallen">rogerallen</a>. This utilises LWJGL (Java Light Weight Java Game Library <a href="https://www.lwjgl.org">https://www.lwjgl.org</a>).</p>




<h3>The Bridge between Clojure and Shaders</h3>




<p>A vital feature of Shadertone is a map between Clojure atoms and shader Uniforms. What is a shader Uniform? Well think of it as a read-only global variable in your shader. A Clojure watcher ensures any updates to your Clojure atom persist into your Uniform. A little clunky but all uniforms start with the letter <code>i</code>.</p>




<p>The shader:</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">uniform</span> <span class="kt">float</span> <span class="n">iExample</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>




<p>And in Clojure</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">example-weight</span> <span class="p">(</span><span class="nf">atom</span> <span class="mf">0.5</span><span class="p">))</span>
</span><span class='line'><span class="p">(</span><span class="nf">shadertone/start-fullscreen</span> <span class="s">&quot;resources/shaders/example.glsl&quot;</span>
</span><span class='line'>  <span class="ss">:user-data</span> <span class="p">{</span><span class="s">&quot;iExample&quot;</span> <span class="nv">example-weight</span><span class="p">})</span>
</span><span class='line'>
</span><span class='line'><span class="c1">;;iExample Uniform will also be updated.</span>
</span><span class='line'><span class="p">(</span><span class="nf">reset!</span> <span class="nv">example-weight</span> <span class="mf">0.2</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>




<h2>Live editing shaders</h2>




<p>When a shader file is edited Shadertone is watching the file (using <a href="https://github.com/ibdknox/watchtower">watchtower</a>) and will reload/recompile the changed file. This results in a slight freeze as the new code is run (This might be down to my graphics card).
Hence most of the time I prefer alternatives to live editing the shader to create smoother transitions.</p>




<h2>Injecting movement</h2>




<p>To make static images move we need a continuously changing value.</p>




<p>Shadertone gives us <code>iGlobalTime</code> using the number of seconds since the shader was started:</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">uniform</span> <span class="n">iGlobalTime</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">){</span>
</span><span class='line'>  <span class="c1">//Use the continuously changing time signal as the value for a color.  </span>
</span><span class='line'>  <span class="n">gl_FragColor</span> <span class="o">=</span> <span class="n">vec4</span><span class="p">(</span><span class="n">sin</span><span class="p">(</span><span class="n">iGlobalTime</span><span class="p">)</span><span class="o">*</span><span class="mf">0.5</span><span class="o">+</span><span class="mf">0.5</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<p>Putting a continuously changing value through a function like sin/cos is the
bread and butter of creating animations with shaders.</p>




<h2>Randomness</h2>




<p>We often need a cheap and fast way to generate random floats in Shaders. Without persistent state and preservation of a seed it can be difficult. One solution is to use a noise image and the current pixel coordinates as an index into the image for a  float value.</p>




<p>Shadertone supports loading custom textures into your shaders:</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">shadetone/start</span> <span class="s">&quot;shaders/example.glsl&quot;</span>
</span><span class='line'>         <span class="ss">:textures</span> <span class="p">[</span><span class="s">&quot;/josephwilk/textures/noise.png&quot;</span><span class="p">])</span>
</span></code></pre></td></tr></table></div></figure>




<p>The noise texture:</p>




<p><img src="http://raw.githubusercontent.com/josephwilk/shaderview/master/bin/data/textures/tex10.png" /></p>




<p>And finally the shader:</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="c1">//Turning the current pixel coordinates (uv) into a random float. </span>
</span><span class='line'><span class="n">vec2</span> <span class="n">uv</span> <span class="o">=</span> <span class="n">gl_FragCoord</span><span class="p">.</span><span class="n">xy</span> <span class="o">/</span> <span class="n">iResolution</span><span class="p">.</span><span class="n">xy</span><span class="p">;</span>
</span><span class='line'><span class="k">return</span> <span class="nf">texture2D</span><span class="p">(</span><span class="n">iChannel0</span><span class="p">,</span> <span class="n">vec2</span><span class="p">(</span><span class="n">uv</span><span class="p">)</span><span class="o">/</span><span class="mf">256.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>




<h2>Composing visual effects</h2>




<p>I attach a weight to each function or visual phase of the shader. Through this we can select which visual effect is visible or combine multiple effects. Its a bit messy, since I have all my functions in a single shader file. I&rsquo;ve not explored including of external files with shaders.</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">uniform</span> <span class="kt">float</span> <span class="n">iCircularWeight</span><span class="p">;</span>
</span><span class='line'><span class="n">uniform</span> <span class="kt">float</span> <span class="n">iPopulationWeight</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="n">vec4</span> <span class="nf">circular</span><span class="p">(){...}</span>
</span><span class='line'><span class="n">vec4</span> <span class="nf">population</span><span class="p">(){..}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">){</span>
</span><span class='line'>  <span class="n">vec4</span> <span class="n">circleResult</span>     <span class="o">=</span> <span class="n">vec4</span><span class="p">(</span><span class="mf">0.0</span><span class="p">);</span>
</span><span class='line'>  <span class="n">vec4</span> <span class="n">populationResult</span> <span class="o">=</span> <span class="n">vec4</span><span class="p">(</span><span class="mf">0.0</span><span class="p">);</span>
</span><span class='line'>  <span class="k">if</span><span class="p">(</span><span class="n">iCircularWeight</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">){</span>
</span><span class='line'>    <span class="n">circleResult</span> <span class="o">=</span> <span class="n">circular</span><span class="p">()</span> <span class="o">*</span> <span class="n">iCircularWeight</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="k">if</span><span class="p">(</span><span class="n">iPopulationWeight</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">){</span>
</span><span class='line'>    <span class="n">populationResult</span> <span class="o">=</span> <span class="n">population</span><span class="p">()</span> <span class="o">*</span> <span class="n">iPopulationWeight</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="n">gl_FragColor</span> <span class="o">=</span> <span class="p">(</span><span class="n">populationResult</span> <span class="o">+</span> <span class="n">circleResult</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<p>And within Clojure:</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">circular-w</span> <span class="p">(</span><span class="nf">atom</span> <span class="mf">1.0</span><span class="p">))</span>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">population-w</span> <span class="p">(</span><span class="nf">atom</span> <span class="mf">1.0</span><span class="p">))</span>
</span><span class='line'><span class="p">(</span><span class="nf">shadertone/start-fullscreen</span> <span class="s">&quot;resources/shaders/example.glsl&quot;</span>
</span><span class='line'>  <span class="ss">:user-data</span> <span class="p">{</span><span class="s">&quot;iCircularWeight&quot;</span> <span class="nv">circular-w</span>
</span><span class='line'>              <span class="s">&quot;iPopulationWeight&quot;</span> <span class="nv">population-w</span><span class="p">})</span>
</span><span class='line'><span class="p">(</span><span class="nf">reset!</span> <span class="nv">circular-weight</span> <span class="mf">1.0</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>




<h2>Synchronisation</h2>




<p>Shadertone uses the seconds since start (<code>iGlobalTime</code>) while Overtone via Supercollider uses the soundcard&rsquo;s clock. Hence there is no guarantee these two sources will be in sync.</p>




<p>Replacing iGlobalTime is the only option. We create a special synth called <code>data-probes</code> which sole function is to transfer data from the Supercollider world to the Clojure world. Overtone provides a Supercollider to Clojure binding called a <code>tap</code>. We add a tap into our Overtone synth which is polling our global timing signal (this powers all synths and is how we co-ordinate everything).</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">defsynth</span> <span class="nv">data-probes</span> <span class="p">[</span><span class="nv">timing-signal-bus</span> <span class="mi">0</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">beat-count</span> <span class="p">(</span><span class="nf">in</span><span class="ss">:kr</span> <span class="nv">timing-signal-bus</span><span class="p">)</span>
</span><span class='line'>        <span class="nv">_</span>  <span class="p">(</span><span class="nf">tap</span> <span class="s">&quot;global-beat-count&quot;</span> <span class="mi">60</span><span class="p">(</span><span class="nf">a2k</span> <span class="nv">beat-count</span><span class="p">))</span>
</span><span class='line'>      <span class="p">(</span><span class="nf">out</span> <span class="mi">0</span> <span class="mi">0</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">active-data-probes</span> <span class="p">(</span><span class="nf">data-probes</span> <span class="p">(</span><span class="ss">:count</span> <span class="nv">time/beat-1th</span><span class="p">)))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">shadertone/start-fullscreen</span> <span class="s">&quot;resources/shaders/example.glsl&quot;</span>
</span><span class='line'>  <span class="ss">:user-data</span>
</span><span class='line'>  <span class="c1">;;An atom wrapping the tap and the running synth instance</span>
</span><span class='line'>   <span class="s">&quot;global-beat-count&quot;</span> <span class="p">{</span><span class="s">&quot;iGlobalBeatCount&quot;</span> <span class="p">(</span><span class="nf">atom</span> <span class="p">{</span><span class="ss">:synth</span> <span class="nv">active-data-probes</span> <span class="ss">:tap</span> <span class="s">&quot;global-beat-count&quot;</span><span class="p">})})</span>
</span></code></pre></td></tr></table></div></figure>




<p>Using our <code>iGlobalBeatCount</code> in our shader now means anything requiring a continuously increasing value flows to our beat.</p>




<h2>Shaders &amp; global mutable state</h2>




<p>Persistent mutable state between executions is not possible in OpenGL Shaders. Uniforms are read-only.</p>




<p>Lets look at an example. On a drum hit I want the color of a visual to change and <em>persist</em> until the next drum hit.
The drum signal is 1 for a hit 0 for silence:</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">[</span><span class="mi">1</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">1</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">1</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>




<p>The current value based on the global clock is passed into the Shader as the iBeat Uniform.</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">uniform</span> <span class="kt">float</span> <span class="n">iBeat</span><span class="p">;</span>
</span><span class='line'><span class="kt">float</span> <span class="n">color</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="n">vec4</span> <span class="n">function</span> <span class="nf">showColor</span><span class="p">(){</span>
</span><span class='line'>  <span class="k">if</span><span class="p">(</span><span class="n">iBeat</span> <span class="o">==</span> <span class="mf">1.0</span><span class="p">){</span>
</span><span class='line'>    <span class="n">color</span> <span class="o">+=</span> <span class="mf">1.0</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">vec4</span><span class="p">(</span><span class="n">color</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<p>Will return:</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">vec4</span><span class="p">(</span><span class="mf">1.0</span><span class="p">);</span>
</span><span class='line'><span class="n">vec4</span><span class="p">(</span><span class="mf">0.0</span><span class="p">);</span>
</span><span class='line'><span class="n">vec4</span><span class="p">(</span><span class="mf">0.0</span><span class="p">);</span>
</span><span class='line'><span class="n">vec4</span><span class="p">(</span><span class="mf">0.0</span><span class="p">);</span>
</span><span class='line'><span class="n">vec4</span><span class="p">(</span><span class="mf">1.0</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>




<p>What we were after is actually:</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">vec4</span><span class="p">(</span><span class="mf">1.0</span><span class="p">);</span>
</span><span class='line'><span class="n">vec4</span><span class="p">(</span><span class="mf">1.0</span><span class="p">);</span>
</span><span class='line'><span class="n">vec4</span><span class="p">(</span><span class="mf">1.0</span><span class="p">);</span>
</span><span class='line'><span class="n">vec4</span><span class="p">(</span><span class="mf">1.0</span><span class="p">);</span>
</span><span class='line'><span class="n">vec4</span><span class="p">(</span><span class="mf">2.0</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>




<p>My solution is to move to Clojure where mutable state using atoms is simple.</p>




<p>Our timing is guided by Supercollider and a global clock. The value of our kick buffer at anyone time is only known inside the synth and hence inside Supercollider. But if we want to have mutable state we need access to this value in Clojure. So we create a custom synth that taps the value of the kick buffer based on the global clock signal.</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">defsynth</span> <span class="nv">drum-data-probe</span> <span class="p">[</span><span class="nv">kick-drum-buffer</span> <span class="nv">timing-signal-bus</span> <span class="mi">0</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">beat-count</span> <span class="p">(</span><span class="nf">in</span><span class="ss">:kr</span> <span class="nv">timing-signal-bus</span><span class="p">)</span>
</span><span class='line'>    <span class="nv">drum-beat</span> <span class="p">(</span><span class="nf">buf-rd</span><span class="ss">:kr</span> <span class="mi">1</span> <span class="nv">kick-drum-buffer</span> <span class="nv">beat-count</span><span class="p">)</span>
</span><span class='line'>    <span class="nv">_</span>  <span class="p">(</span><span class="nf">tap</span> <span class="s">&quot;drum-beat&quot;</span> <span class="mi">60</span> <span class="p">(</span><span class="nf">a2k</span> <span class="nv">drum-beat</span><span class="p">))])</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">out</span> <span class="mi">0</span> <span class="mi">0</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defonce </span><span class="nv">kick-drum-buffer</span> <span class="p">(</span><span class="nf">buffer</span> <span class="mi">256</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="c1">;;Create the synth with the &quot;drum-beat&quot; tap</span>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">drum-data-probe</span> <span class="p">(</span><span class="nf">drum-data-probe</span> <span class="nv">kick-drum-buffer</span> <span class="p">(</span><span class="ss">:count</span> <span class="nv">time/beat-1th</span><span class="p">)))</span>
</span><span class='line'>
</span><span class='line'><span class="c1">;;Bind the running synth and the tap</span>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">kick-atom</span> <span class="p">(</span><span class="nf">atom</span> <span class="p">{</span><span class="ss">:synth</span> <span class="nv">drum-data-probe</span> <span class="ss">:tap</span> <span class="s">&quot;drum-beat&quot;</span><span class="p">}))</span>
</span><span class='line'>
</span><span class='line'><span class="c1">;;Extract the tap atom</span>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">kick-tap</span> <span class="p">(</span><span class="nf">get-in</span> <span class="p">(</span><span class="ss">:synth</span> <span class="o">@</span><span class="nv">kick-atom</span><span class="p">)</span> <span class="p">[</span><span class="ss">:taps</span> <span class="p">(</span><span class="ss">:tap</span> <span class="o">@</span><span class="nv">kick-atom</span><span class="p">)]))</span>
</span></code></pre></td></tr></table></div></figure>




<p>Now in the Clojure world its simple to watch our tap atom and hence get alerted when it changes value. Overtone is dealing with the magic of updating the atom under the covers, the watcher is a nice implementation independent way of hooking into this. We now know the value of our kick buffer in Clojure. If we use another atom as our accumulator we can update it when the tap atom changes. Finally pushing this new accumulator to the Shader.</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">active-color</span> <span class="p">(</span><span class="nf">atom</span> <span class="mf">0.0</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">add-watch</span> <span class="nv">kick-tap</span> <span class="ss">:cell-color</span>
</span><span class='line'>  <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">_</span> <span class="nv">_</span> <span class="nv">old</span> <span class="nv">new</span><span class="p">]</span>
</span><span class='line'>    <span class="p">(</span><span class="nb">when </span><span class="p">(</span><span class="nb">and </span><span class="p">(</span><span class="nb">= </span><span class="nv">old</span> <span class="mf">0.0</span><span class="p">)</span> <span class="p">(</span><span class="nb">= </span><span class="mf">1.0</span> <span class="nv">new</span><span class="p">))</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">reset!</span> <span class="nv">active-color</span> <span class="p">(</span><span class="nf">mod</span> <span class="p">(</span><span class="nb">+ </span><span class="o">@</span><span class="nv">active-color</span> <span class="mf">1.0</span><span class="p">)</span> <span class="mi">100</span><span class="p">)))))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">shadertone/start-fullscreen</span> <span class="s">&quot;resources/shaders/example.glsl&quot;</span>
</span><span class='line'>  <span class="ss">:user-data</span> <span class="p">{</span><span class="ss">:iActiveColor</span> <span class="nv">active-color</span><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<p>Within the shader:</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">uniform</span> <span class="kt">float</span> <span class="n">iActiveColor</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="n">vec4</span> <span class="n">function</span> <span class="nf">showColor</span><span class="p">(){</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">vec4</span><span class="p">(</span><span class="n">iActiveColor</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<p>Thats a lot of work, but I&rsquo;m very happy with the results in my <a href="https://vimeo.com/117516352">(end-of-buffer)</a> performance.</p>




<h2>Buffer events</h2>




<p>Writing to a buffer is a common way of live coding in Overtone. Its very useful to attach some visual effect based on the settings of a buffer.</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="c1">;;Setting notes to a buffer</span>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">notes-buf</span> <span class="p">(</span><span class="nf">buffer</span> <span class="mi">256</span><span class="p">))</span>
</span><span class='line'><span class="p">(</span><span class="nf">pattern!</span> <span class="nv">notes-buf</span> <span class="p">(</span><span class="nf">degrees-seq</span> <span class="p">[</span><span class="ss">:f3</span> <span class="mi">1314</span><span class="p">]))</span>
</span></code></pre></td></tr></table></div></figure>




<p>We could put a tap into the synth and grab the current note and pass this into the shader. As I&rsquo;ve mentioned taps are expensive and they are always on while we may not always be using them.
This also gets more complicated when say we have 3 instances of the same synth running playing simultaneous to form a chord.</p>




<p>An alternative is to invent an atom which is used as a signal on every buffer write.</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="c1">;;Could also do this with OSC messages...</span>
</span><span class='line'><span class="p">(</span><span class="nf">do</span>
</span><span class='line'>  <span class="p">(</span><span class="kd">defonce </span><span class="nv">buffer-change-event-notes-buf</span> <span class="p">(</span><span class="nf">atom</span> <span class="mf">0.0</span><span class="p">))</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">pattern!</span> <span class="nv">notes-buf</span> <span class="p">(</span><span class="nf">degrees-seq</span> <span class="p">[</span><span class="ss">:f3</span> <span class="mi">1314</span><span class="p">]))</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">swap!</span> <span class="nv">buffer-change-event-notes-buf</span> <span class="nb">+ </span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>




<p>And adding a watcher</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">add-watch</span>
</span><span class='line'>  <span class="nv">buffer-change-event-notes-buf</span>
</span><span class='line'>  <span class="ss">:buffer-change-event-notes-buf</span>
</span><span class='line'>  <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="o">&amp;</span> <span class="nv">_</span><span class="p">]</span>
</span><span class='line'>    <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">n</span> <span class="p">(</span><span class="nb">int </span><span class="p">(</span><span class="nf">buffer-get</span> <span class="nv">notes-buf</span> <span class="mi">0</span><span class="p">))]</span>
</span><span class='line'>      <span class="p">(</span><span class="nf">case</span> <span class="nv">n</span>
</span><span class='line'>        <span class="mi">29</span> <span class="p">(</span><span class="nf">reset!</span> <span class="nv">color</span> <span class="mf">0.4</span><span class="p">)</span>
</span><span class='line'>           <span class="p">(</span><span class="nf">reset!</span> <span class="nv">color</span> <span class="mf">0.0</span><span class="p">)))))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">buffer-atoms</span> <span class="p">(</span><span class="nf">atom</span> <span class="p">{}))</span>
</span><span class='line'><span class="p">(</span><span class="nf">pattern!</span> <span class="nv">notes-buf</span><span class="p">)</span>
</span><span class='line'><span class="p">(</span><span class="nf">reset!</span> <span class="nv">buffer-atoms</span> <span class="p">(</span><span class="nb">assoc </span><span class="o">@</span><span class="nv">buffer-atoms</span> <span class="p">(</span><span class="ss">:id</span> <span class="nv">notes-buf</span><span class="p">)</span> <span class="p">(</span><span class="nb">inc </span><span class="p">(</span><span class="o">@</span><span class="nv">buffer-atoms</span> <span class="p">(</span><span class="ss">:id</span> <span class="nv">notes-buf</span><span class="p">)))))</span>
</span></code></pre></td></tr></table></div></figure>




<p>I use this trick in (end-of-buffer) to use the bass note to control the level of distortion of the visuals (<a href="https://github.com/repl-electric/cassiopeia/blob/master/src/cassiopeia/destination/flatiron.clj#L84-L99">source</a>). Its wonderful to focus on the notes and feel the visuals following you automatically.</p>




<h2>Midi notes to visuals</h2>




<p>I often want to map a midi note to a visual effect. All my notes are mapped to buffers. Much like we did with the drums I can use a tap to get access to the current note being played in a buffer. Skipping over the details, when we have a midi note we send it as an float (to support crazy 42.333 like notes) to the shader via an atom.</p>




<p>We then map it to a nice range value to effect visuals:</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">uniform</span> <span class="kt">float</span> <span class="n">iLeadNote</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//midi note: 42 =&gt; F#2  </span>
</span><span class='line'><span class="c1">//midi note: 78 =&gt; F#5</span>
</span><span class='line'><span class="kt">float</span> <span class="n">noteMapped</span> <span class="o">=</span> <span class="n">smoothstep</span><span class="p">(</span><span class="mf">42.0</span><span class="p">,</span> <span class="mf">78.0</span><span class="p">,</span> <span class="n">iLeadNote</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//noteMapped now spans =&gt; 0..1</span>
</span></code></pre></td></tr></table></div></figure>




<p>A cheap way to scale effects based on the height of the note.</p>




<h2>Gradual transitions</h2>




<p>Often I want a smooth fading it or out of a shader function. Say for example fading to black. Pretty simple, just fire a thread which sleeps and ticks an atom. The atom is fed into the Shader.</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">uniform</span> <span class="kt">float</span> <span class="n">iColor</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">){</span>
</span><span class='line'>  <span class="n">gl_color</span> <span class="o">=</span> <span class="n">vec4</span><span class="p">(</span><span class="n">iColor</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<p>Since I use this a lot I created a helper fn in <a href="https://github.com/josephwilk/mud/blob/4866f9db8077f8d4244fdd94b42bc0fef0e69f40/src/mud/core.clj#L90">MUD</a>:</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">color</span> <span class="p">(</span><span class="nf">atom</span> <span class="mf">1.0</span><span class="p">))</span>
</span><span class='line'><span class="c1">;;         atom / target /  rate</span>
</span><span class='line'><span class="p">(</span><span class="nf">overtime!</span> <span class="nv">color</span>   <span class="mf">0.0</span>      <span class="mf">0.001</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>




<h2>Text</h2>




<p>In end-of-buffer I spell the word Repl Electric out of floating lights. We are bound to only a few data structures with fragment Shaders. I used a simple 3x3 matrix mapping each part of a character. Then using this to decided the position of the lights.</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">const</span> <span class="n">mat3</span> <span class="n">LETTER_R</span>        <span class="o">=</span> <span class="n">mat3</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
</span><span class='line'>                                  <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
</span><span class='line'>                                  <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span><span class='line'><span class="k">const</span> <span class="n">mat3</span> <span class="n">LETTER_E</span>        <span class="o">=</span> <span class="n">mat3</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
</span><span class='line'>                                  <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
</span><span class='line'>                                  <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="n">vec4</span> <span class="nf">letter</span><span class="p">(</span><span class="n">mat3</span> <span class="n">letter</span><span class="p">,</span> <span class="n">vec2</span> <span class="n">offset</span><span class="p">,</span> <span class="n">vec2</span> <span class="n">uv</span><span class="p">){</span>
</span><span class='line'>  <span class="n">vec2</span> <span class="n">point</span> <span class="o">=</span> <span class="n">vec2</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
</span><span class='line'>  <span class="n">vec4</span> <span class="n">helloPoint</span> <span class="o">=</span> <span class="n">vec4</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
</span><span class='line'>  <span class="n">vec3</span> <span class="n">xPos</span> <span class="o">=</span> <span class="n">vec3</span><span class="p">(</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.03</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">);</span>
</span><span class='line'>  <span class="n">vec3</span> <span class="n">yPos</span> <span class="o">=</span> <span class="n">vec3</span><span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.03</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">y</span><span class="o">++</span><span class="p">){</span>
</span><span class='line'>    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">x</span><span class="o">++</span><span class="p">){</span>
</span><span class='line'>      <span class="k">if</span><span class="p">(</span><span class="n">letter</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="n">x</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">){</span><span class="c1">// Show this part of the letter</span>
</span><span class='line'>        <span class="n">point</span> <span class="o">=</span> <span class="n">vec2</span><span class="p">(</span><span class="n">xPos</span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="o">+</span><span class="n">offset</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">offset</span><span class="p">.</span><span class="n">y</span><span class="o">+</span><span class="n">yPos</span><span class="p">[</span><span class="n">y</span><span class="p">]);</span>
</span><span class='line'>        <span class="n">helloPoint</span> <span class="o">+=</span> <span class="n">buildCell</span><span class="p">(</span><span class="n">uv</span><span class="p">,</span> <span class="n">point</span><span class="p">,</span> <span class="n">STATIC_LETTERS</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">helloPoint</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">letter</span><span class="p">(</span><span class="n">LETTER_R</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="n">uv</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>




<p>And the visual.</p>




<p><img src="/images/font-example.png" alt="Font example"/></p>




<h2>Visuals effected by frequencies</h2>




<p>Shadertone provides a 2x512 array with the frequency spectrum (FFT) and audio waveform data. It does this by loading the data into a 2D Texture. The audio data is taken from tapping the main Overtone audio bus.</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="c1">;;Tell Shadertone to fill iChannel0 with audio data</span>
</span><span class='line'><span class="p">(</span><span class="nf">shadetone/start</span> <span class="s">&quot;shaders/example.glsl&quot;</span> <span class="ss">:textures</span> <span class="p">[</span><span class="ss">:overtone-audio</span><span class="p">])</span>
</span></code></pre></td></tr></table></div></figure>




<p>It&rsquo;s always a challenge to utilise this without creating something jerky or causing motion sickness. Hence I tend to use the waveform or FFT as a distorter rather than a base for animations.</p>




<p>It also helps to concentrate on specific ranges of frequencies of the waveform data to create a stronger connection between a synth and the visuals.</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="nb">float </span><span class="nv">sound</span> <span class="nb">= </span><span class="nv">texture2D</span><span class="p">(</span><span class="nf">iChannel0</span>, <span class="nv">vec2</span><span class="p">(</span><span class="nf">max</span><span class="p">(</span><span class="nf">uv.x</span>,<span class="mf">0.9</span><span class="p">)</span>,<span class="nv">.75</span><span class="p">))</span><span class="nv">.x</span><span class="c1">;</span>
</span><span class='line'>
</span><span class='line'><span class="nv">//uv.xy</span> <span class="nv">=&gt;</span> <span class="nv">current</span> <span class="nv">x</span>,<span class="nv">y</span> <span class="nv">coordinates</span> <span class="nv">of</span> <span class="nv">pixel.</span>
</span><span class='line'>
</span><span class='line'><span class="nv">//First</span> <span class="nv">argument</span> <span class="nv">is</span> <span class="nv">an</span> <span class="nb">index into </span><span class="nv">the</span> <span class="mi">512</span> <span class="nv">values</span> <span class="nv">of</span> <span class="nv">the</span> <span class="nv">waveform.</span>
</span><span class='line'><span class="nv">//By</span> <span class="nv">limiting</span> <span class="nv">the</span> <span class="nb">first </span><span class="nv">argument</span> <span class="nv">we</span> <span class="nv">can</span> <span class="nv">ignore</span> <span class="nv">certain</span> <span class="nv">ranges.</span>
</span><span class='line'>
</span><span class='line'><span class="nv">//Second</span> <span class="nv">argument</span> <span class="nv">selects</span><span class="err">:</span>
</span><span class='line'><span class="nv">//</span>    <span class="mf">0.25</span> <span class="nv">=&gt;</span> <span class="nv">FFT</span>
</span><span class='line'><span class="nv">//</span>    <span class="mf">0.75</span> <span class="nv">=&gt;</span> <span class="nv">audio</span> <span class="nv">waveform</span>
</span></code></pre></td></tr></table></div></figure>




<p>Here is an example where I use the audio waveform to distort the scale &amp; jaggedness of a series of circle shapes.</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">const</span> <span class="kt">float</span> <span class="n">tau</span> <span class="o">=</span> <span class="mf">6.28318530717958647692</span><span class="p">;</span>
</span><span class='line'><span class="n">vec3</span> <span class="n">wave</span> <span class="o">=</span> <span class="n">vec3</span><span class="p">(</span><span class="mf">0.0</span><span class="p">);</span>
</span><span class='line'><span class="kt">float</span> <span class="n">width</span> <span class="o">=</span> <span class="mf">4.0</span><span class="o">/</span><span class="mi">500</span><span class="p">;</span>
</span><span class='line'><span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">60</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
</span><span class='line'>  <span class="kt">float</span> <span class="n">sound</span> <span class="o">=</span> <span class="n">texture2D</span><span class="p">(</span><span class="n">iChannel0</span><span class="p">,</span> <span class="n">vec2</span><span class="p">(</span><span class="n">uv</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="mf">.75</span><span class="p">)).</span><span class="n">x</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="kt">float</span> <span class="n">a</span> <span class="o">=</span> <span class="mf">0.1</span><span class="o">*</span><span class="kt">float</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="n">tau</span><span class="o">/</span><span class="kt">float</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>
</span><span class='line'>  <span class="n">vec3</span> <span class="n">phase</span> <span class="o">=</span> <span class="n">smoothstep</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span><span class="mf">.5</span><span class="p">,</span> <span class="n">vec3</span><span class="p">(</span><span class="n">cos</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="n">cos</span><span class="p">(</span><span class="n">a</span><span class="o">-</span><span class="n">tau</span><span class="o">/</span><span class="mf">3.0</span><span class="p">),</span> <span class="n">cos</span><span class="p">(</span><span class="n">a</span><span class="o">-</span><span class="n">tau</span><span class="o">*</span><span class="mf">2.0</span><span class="o">/</span><span class="mf">3.0</span><span class="p">)));</span>
</span><span class='line'>  <span class="n">wave</span> <span class="o">+=</span> <span class="n">phase</span> <span class="o">*</span> <span class="n">smoothstep</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">abs</span><span class="p">(</span><span class="n">uv</span><span class="p">.</span><span class="n">y</span> <span class="o">-</span> <span class="p">((</span><span class="n">sound</span><span class="o">*</span><span class="mf">0.9</span><span class="p">)</span><span class="o">+</span><span class="mf">0.2</span><span class="p">)));</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">//This shift of uv.x means our index into the sound data also </span>
</span><span class='line'>  <span class="c1">//moves along, examining a different part of the audio wave. </span>
</span><span class='line'>  <span class="n">uv</span><span class="p">.</span><span class="n">x</span> <span class="o">+=</span> <span class="mf">0.4</span><span class="o">/</span><span class="kt">float</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>
</span><span class='line'>  <span class="n">uv</span><span class="p">.</span><span class="n">y</span> <span class="o">-=</span> <span class="mf">0.05</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="n">wave</span> <span class="o">*=</span> <span class="mf">10.0</span><span class="o">/</span><span class="kt">float</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>
</span><span class='line'><span class="k">return</span> <span class="nf">vec4</span><span class="p">(</span><span class="n">wave</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>




<p>And the resulting visual:</p>




<p><img src="/images/fft-example.png" alt="FFT example"/></p>




<h2>Final thoughts on Live coding visuals</h2>




<p>Through Clojure&rsquo;s binding of atoms with Fragment shaders we have the power to live code visuals and music. Though it comes at a cost of complexity having to wrap lots of functions in order to have powerfully connected visuals. Fragment shaders are extremely terse, and can be pushed to replicate many advanced effects <em>but</em> they are also performance intense, and often taking a non-shader route will be much more performant.</p>




<h4>Stability</h4>




<p>My knowledge of LWJGL is small, but crashes in the fragment shaders often occur leaving the JVM wedged. This has happened to me quite a lot practicing, but never in a performance. Its worth reflecting that something (be it fixable) leaves a risk of a freeze in a performance.</p>




<h4>Combining State &amp; Shaders</h4>




<p>I&rsquo;ve started to explore what a shader application might look like if it was a server and provided a state machine so the live coding language does have this complexity. In turn producing a freer and more spontaneous interaction. This project is <a href="https://github.com/josephwilk/shaderview">Shaderview</a> and steals all the good ideas of Shadertone while adding some new features like <a href="http://www.vertexshaderart.com">vertex shader art</a>. I&rsquo;ll be writing up more about Shaderview soon.</p>

</div>




    </article>


    <article>

  <header>

      <h1 class="entry-title"><a href="/art/emacs-animation.html">Animations With Emacs</a></h1>


      <p class="meta">












<time datetime="2015-10-02T15:58:00+01:00" pubdate data-updated="true">Oct 2<span>nd</span>, 2015</time>

      </p>

  </header>


  <div class="entry-content"><p>Emacs is designed for fast, highly customisable manipulation of text.
ASCII animation requires manipulating text at a sufficient speed that it appears animated. Emacs is also used by a number of performers to live code musical &amp; visual performances (and many other things). Where the audience can see the code in emacs and hear it.</p>




<p><img src="/images/live-coding-emacs.png" alt="Live Coding with Emacs" /></p>




<p>In my live coding performances as <a href="http://www.repl-electric.com">Repl Electric</a> I&rsquo;ve used emacs animations to  augment emacs with more feedback for the performer and a chance to destroy the order and structure the programmer has spent the entire performance building. Reminding us that we are looking at thoughts expressed through code that seem magical but are ultimately nothing more than text.</p>




<p>Maybe something akin to the creation and destruction of Sand Mandalas.</p>




<p><img src="/images/sandmandala.jpg" alt="Sand Mandala" /></p>




<h2>Framework for Emacs Animation</h2>




<p>Zone Mode is an Emacs plugin which provides a framework for screensaver like animations.</p>




<p><a href="http://www.emacswiki.org/emacs/ZoneMode">http://www.emacswiki.org/emacs/ZoneMode</a></p>




<p>Importantly it allows us to turn on an animation using our current code buffer as input and to terminate the animation, returning to the original code on a key press. So we can safely mangle the text knowing we can also return to safety. Well so far I&rsquo;ve always found it to be safe but there is a small risk as mentioned in the zoning warning:</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='lisp'><span class='line'><span class="p">(</span><span class="nv">message</span> <span class="s">&quot;...here&#39;s hoping we didn&#39;t hose your buffer!&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>




<p>A nice property of taking our buffer as input is we are never quite sure what text will be there and hence the properties of the animation.</p>




<h3>Example: Uppercase all letters</h3>




<p>A simple function that finds non-whitespace in the buffer and tries to uppercase the char. It knows nothing about the zoning framework, its just a plain old function that operates on the active buffer.</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='lisp'><span class='line'><span class="p">(</span><span class="nb">defun</span> <span class="nv">zone-upper-case-text</span> <span class="p">()</span>
</span><span class='line'>  <span class="p">(</span><span class="nv">zone-fill-out-screen</span> <span class="p">(</span><span class="nv">window-width</span><span class="p">)</span> <span class="p">(</span><span class="nv">window-height</span><span class="p">))</span>
</span><span class='line'>  <span class="p">(</span><span class="nb">random</span> <span class="no">t</span><span class="p">)</span>
</span><span class='line'>  <span class="p">(</span><span class="nv">goto-char</span> <span class="p">(</span><span class="nv">point-min</span><span class="p">))</span>
</span><span class='line'>  <span class="p">(</span><span class="nv">while</span> <span class="p">(</span><span class="nb">not</span> <span class="p">(</span><span class="nv">input-pending-p</span><span class="p">))</span>
</span><span class='line'>    <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">wbeg</span> <span class="p">(</span><span class="nv">window-start</span><span class="p">))</span>
</span><span class='line'>          <span class="p">(</span><span class="nv">wend</span> <span class="p">(</span><span class="nv">window-end</span><span class="p">)))</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">;;Keep moving the char cursor until its not whitespace</span>
</span><span class='line'>      <span class="p">(</span><span class="nv">while</span> <span class="p">(</span><span class="nv">looking-at</span> <span class="s">&quot;[ \n\f]&quot;</span><span class="p">)</span>
</span><span class='line'>        <span class="p">(</span><span class="nv">goto-char</span> <span class="p">(</span><span class="nb">+</span> <span class="nv">wbeg</span> <span class="p">(</span><span class="nb">random</span> <span class="p">(</span><span class="nb">-</span> <span class="nv">wend</span> <span class="nv">wbeg</span><span class="p">))))))</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">;;If we are at the end of the buffer go to the last char</span>
</span><span class='line'>    <span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nv">eobp</span><span class="p">)</span> <span class="p">(</span><span class="nv">goto-char</span> <span class="p">(</span><span class="nv">point-min</span><span class="p">)))</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">;;Read the char at the cursor</span>
</span><span class='line'>    <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">c</span> <span class="p">(</span><span class="nv">char-after</span> <span class="p">(</span><span class="nv">point</span><span class="p">))))</span>
</span><span class='line'>      <span class="p">(</span><span class="nv">delete-char</span> <span class="mi">1</span><span class="p">)</span>           <span class="c1">;; Remove the char</span>
</span><span class='line'>      <span class="p">(</span><span class="nv">insert-char</span> <span class="p">(</span><span class="nv">upcase</span> <span class="nv">c</span><span class="p">)))</span> <span class="c1">;; Reinsert with caps      </span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">;;Sleep</span>
</span><span class='line'>    <span class="p">(</span><span class="nv">zone-park/sit-for</span> <span class="p">(</span><span class="nv">point-min</span><span class="p">)</span> <span class="mf">0.1</span><span class="p">)))</span>
</span></code></pre></td></tr></table></div></figure>




<p>The animation in all its glory:</p>




<iframe src="https://player.vimeo.com/video/141312958" width="500" height="281" frameborder="0" webkitallowfullscreen mozallowfullscreen allowfullscreen></iframe>




<h3>Zoning Setup</h3>




<p>We can override all other zoning programs and just specify our zone-fn. When we activate zoning our animation will be run.</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='lisp'><span class='line'><span class="p">(</span><span class="nv">eval-after-load</span> <span class="s">&quot;zone&quot;</span>
</span><span class='line'>  <span class="o">&#39;</span><span class="p">(</span><span class="nb">unless</span> <span class="p">(</span><span class="nv">memq</span> <span class="ss">&#39;zone-upper-case-text</span> <span class="p">(</span><span class="nb">append</span> <span class="nv">zone-programs</span> <span class="no">nil</span><span class="p">))</span>
</span><span class='line'>         <span class="p">(</span><span class="k">setq</span> <span class="nv">zone-programs</span> <span class="nv">[zone-upper-case-text]</span><span class="p">)))</span>
</span></code></pre></td></tr></table></div></figure>




<h3>Zoning Examples:</h3>




<p>Zoning mode comes with lots of example animations that are good starting points:</p>




<p><a href="http://www.opensource.apple.com/source/emacs/emacs-51/emacs/lisp/play/zone.el">http://www.opensource.apple.com/source/emacs/emacs-51/emacs/lisp/play/zone.el</a></p>




<ul>
<li>zone-pgm-jitter</li>
<li>zone-pgm-putz-with-case</li>
<li>zone-pgm-dissolve</li>
<li>zone-pgm-whack-chars</li>
<li>zone-pgm-rotate</li>
<li>zone-pgm-rotate-LR-lockstep</li>
<li>zone-pgm-rotate-RL-lockstep</li>
<li>zone-pgm-rotate-LR-variable</li>
<li>zone-pgm-rotate-RL-variable</li>
<li>zone-pgm-drip</li>
<li>zone-pgm-drip-fretfully</li>
<li>zone-pgm-five-oclock-swan-dive</li>
<li>zone-pgm-martini-swan-dive</li>
<li>zone-pgm-paragraph-spaz</li>
<li>zone-pgm-stress</li>
</ul>




<h2>Open Sound Control Protocol Based animation</h2>




<p>OSC is a handy protocol for sending data between networked devices using url like endpoints.
Emacs has a plugin to run an OSC server (<a href="http://delysid.org/emacs/osc.html">http://delysid.org/emacs/osc.html</a>).
Hence if we have some kind of beat signal we could send a message to Emacs and in turn it could render changes based on our musics timing.</p>




<p>With my Overtone setup for Repl-Electric I have the following flow of OSC messages:</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='lisp'><span class='line'><span class="nv">[Supercollider]</span> <span class="nv">-&gt;</span> <span class="nv">OSC</span> <span class="nv">-&gt;</span> <span class="nv">[Clojure]</span> <span class="nv">-&gt;</span> <span class="nv">OSC</span> <span class="nv">-&gt;</span> <span class="nv">[Emacs]</span>
</span></code></pre></td></tr></table></div></figure>




<p>Within Emacs setup an OSC server and define two call backs which change the color of the window face number</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
</pre></td><td class='code'><pre><code class='emacs-lisp'><span class='line'><span class="p">(</span><span class="nb">require</span> <span class="ss">&#39;osc</span><span class="p">)</span>
</span><span class='line'><span class="p">(</span><span class="nb">require</span> <span class="ss">&#39;cl</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nb">defvar</span> <span class="nv">osc-server</span> <span class="no">nil</span> <span class="s">&quot;Connection to receive msgs&quot;</span><span class="p">)</span>
</span><span class='line'><span class="p">(</span><span class="nb">defvar</span> <span class="nv">flip-state</span> <span class="no">t</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nb">defun</span> <span class="nv">osc-connect</span> <span class="p">()</span>
</span><span class='line'>  <span class="s">&quot;Create an OSC server and bind our fallback functions&quot;</span>
</span><span class='line'>  <span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nb">not</span> <span class="nv">osc-server</span><span class="p">)</span>
</span><span class='line'>    <span class="p">(</span><span class="k">setq</span> <span class="nv">osc-server</span>
</span><span class='line'>          <span class="p">(</span><span class="nv">osc-make-server</span>
</span><span class='line'>           <span class="s">&quot;localhost&quot;</span> <span class="mi">4558</span>
</span><span class='line'>           <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">path</span> <span class="k">&amp;rest</span> <span class="nv">args</span><span class="p">)</span>
</span><span class='line'>             <span class="p">(</span><span class="nb">cond</span>
</span><span class='line'>              <span class="p">((</span><span class="nv">string-match</span> <span class="s">&quot;/beat&quot;</span> <span class="nv">path</span><span class="p">)</span>
</span><span class='line'>               <span class="p">(</span><span class="k">progn</span> <span class="p">(</span><span class="k">if</span> <span class="nv">flip-state</span> <span class="p">(</span><span class="nv">on-beat</span><span class="p">)</span> <span class="p">(</span><span class="nv">off-beat</span><span class="p">))</span>
</span><span class='line'>                      <span class="p">(</span><span class="k">setq</span> <span class="nv">flip-state</span> <span class="p">(</span><span class="nb">not</span> <span class="nv">flip-state</span><span class="p">))))))))))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nb">defun</span> <span class="nv">osc-make-server</span> <span class="p">(</span><span class="nv">host</span> <span class="nv">port</span> <span class="nv">default-handler</span><span class="p">)</span>
</span><span class='line'>  <span class="s">&quot;Settings for OSC server&quot;</span>
</span><span class='line'>  <span class="p">(</span><span class="nv">make-network-process</span>
</span><span class='line'>   <span class="ss">:name</span> <span class="s">&quot;emacs OSC server&quot;</span>
</span><span class='line'>   <span class="ss">:host</span> <span class="nv">host</span>
</span><span class='line'>   <span class="ss">:server</span> <span class="no">t</span>
</span><span class='line'>   <span class="ss">:service</span> <span class="nv">port</span>
</span><span class='line'>   <span class="ss">:filter</span> <span class="nf">#&#39;</span><span class="nv">osc-filter</span>
</span><span class='line'>   <span class="ss">:type</span> <span class="ss">&#39;datagram</span>
</span><span class='line'>   <span class="ss">:family</span> <span class="ss">&#39;ipv4</span>
</span><span class='line'>   <span class="ss">:plist</span> <span class="p">(</span><span class="nb">list</span> <span class="ss">:generic</span> <span class="nv">default-handler</span><span class="p">)))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nb">defun</span> <span class="nv">on-beat</span> <span class="p">()</span>
</span><span class='line'>  <span class="p">(</span><span class="nv">custom-set-faces</span>
</span><span class='line'>   <span class="o">&#39;</span><span class="p">(</span><span class="nv">window-number-face</span> <span class="p">((</span><span class="no">t</span> <span class="p">(</span><span class="ss">:foreground</span> <span class="s">&quot;deeppink&quot;</span><span class="p">))))))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nb">defun</span> <span class="nv">off-beat</span> <span class="p">()</span>
</span><span class='line'>  <span class="p">(</span><span class="nv">custom-set-faces</span>
</span><span class='line'>   <span class="o">&#39;</span><span class="p">(</span><span class="nv">window-number-face</span> <span class="p">((</span><span class="no">t</span> <span class="p">(</span><span class="ss">:foreground</span> <span class="s">&quot;#FDDD0C&quot;</span><span class="p">))))))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nv">osc-connect</span><span class="p">)</span>
</span><span class='line'><span class="p">(</span><span class="nb">provide</span> <span class="ss">&#39;osc-server</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>




<p>In Overtone/Clojure the sending signal:</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defonce </span><span class="nv">emacs-client</span> <span class="p">(</span><span class="nf">osc-client</span> <span class="s">&quot;localhost&quot;</span> <span class="mi">4558</span><span class="p">))</span>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">emacs-trigger</span>    <span class="p">(</span><span class="nf">on-beat-trigger</span> <span class="mi">8</span> <span class="o">#</span><span class="p">(</span><span class="k">do </span><span class="p">(</span><span class="nf">osc-send</span> <span class="nv">emacs-client</span> <span class="s">&quot;/beat&quot;</span><span class="p">))))</span>
</span></code></pre></td></tr></table></div></figure>




<p>Heres a little demo with the brackets and window number changing colour based on the Overtone beat.</p>




<p><img src="/images/brackets.gif" alt="Emacs rendering to the beat" /></p>




<h3>Synchronisation</h3>




<p>Given some small local lag we now have a timing signal which is threaded through all our tools. <a href="http://supercollider.github.io/">Supercollider</a>, <a href="http://overtone.github.io/">Overtone</a> and Emacs.</p>




<p>Which means our emacs animations can start to change to the beat of the music&hellip;</p>




<h2>Sound in ASCII</h2>




<p>Now that we have ways to animate and to connect audio data with emacs we can go a little further (way too far) and start to visualise the data about our sound in ASCII.</p>




<p>From Overtone or SuperCollider we can create a synth which tracks the peak and power of an audio signal. It sends us messages back with the data which we then forward on as OSC messages to Emacs.</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="cp">#Triggers a Sin Wave Oscillator and sends signals about power/peak</span>
</span><span class='line'><span class="n">SynthDef</span><span class="p">(</span><span class="err">\</span><span class="n">pulse</span><span class="p">,{</span>
</span><span class='line'>  <span class="n">var</span> <span class="n">sig</span><span class="p">,</span> <span class="n">chain</span><span class="p">,</span> <span class="n">onsets</span><span class="p">;</span>
</span><span class='line'>  <span class="n">sig</span> <span class="o">=</span> <span class="n">SinOsc</span><span class="p">.</span><span class="n">ar</span><span class="p">(</span><span class="n">Rand</span><span class="p">(</span><span class="mf">220.0</span><span class="p">,</span><span class="mf">440.0</span><span class="p">))</span>
</span><span class='line'>  <span class="o">*</span><span class="n">EnvGen</span><span class="p">.</span><span class="n">ar</span><span class="p">(</span><span class="n">Env</span><span class="p">.</span><span class="n">perc</span><span class="p">(</span><span class="nl">releaseTime</span><span class="p">:</span><span class="mf">0.5</span><span class="p">),</span><span class="n">Dust</span><span class="p">.</span><span class="n">ar</span><span class="p">(</span><span class="mf">0.5</span><span class="p">))</span><span class="o">*</span><span class="mf">0.7</span><span class="p">;</span>
</span><span class='line'>  <span class="n">Out</span><span class="p">.</span><span class="n">ar</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">sig</span> <span class="o">!</span><span class="mi">2</span><span class="p">);</span>
</span><span class='line'>  <span class="c1">//</span>
</span><span class='line'>  <span class="n">chain</span> <span class="o">=</span> <span class="n">FFT</span><span class="p">({</span><span class="n">LocalBuf</span><span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="mi">1</span><span class="p">)},</span> <span class="n">sig</span><span class="p">);</span>
</span><span class='line'>  <span class="n">onsets</span> <span class="o">=</span> <span class="n">Onsets</span><span class="p">.</span><span class="n">kr</span><span class="p">(</span><span class="n">chain</span><span class="p">,</span><span class="mf">0.1</span><span class="p">,</span><span class="err">\</span><span class="n">power</span><span class="p">);</span>
</span><span class='line'>  <span class="n">SendTrig</span><span class="p">.</span><span class="n">kr</span><span class="p">(</span><span class="n">onsets</span><span class="p">);</span>
</span><span class='line'>  <span class="n">SendPeakRMS</span><span class="p">.</span><span class="n">kr</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="s">&quot;/replyAddress&quot;</span><span class="p">);</span>
</span><span class='line'><span class="p">}).</span><span class="n">add</span><span class="p">;</span>
</span><span class='line'><span class="cp">#Run the crazy synth above</span>
</span><span class='line'><span class="n">Synth</span><span class="p">(</span><span class="err">\</span><span class="n">pulse</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#Forward the data on as an OSC message</span>
</span><span class='line'><span class="cp">#to emacs</span>
</span><span class='line'><span class="o">~</span><span class="n">host</span> <span class="o">=</span> <span class="n">NetAddr</span><span class="p">(</span><span class="s">&quot;localhost&quot;</span><span class="p">,</span> <span class="mi">4859</span><span class="p">);</span>
</span><span class='line'><span class="n">p</span> <span class="o">=</span> <span class="n">OSCFunc</span><span class="p">({</span> <span class="o">|</span><span class="n">msg</span><span class="o">|</span>
</span><span class='line'>  <span class="o">~</span><span class="n">host</span><span class="p">.</span><span class="n">sendMsg</span><span class="p">(</span><span class="s">&quot;/peakpower&quot;</span><span class="p">,</span><span class="n">msg</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">msg</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
</span><span class='line'>  <span class="s">&quot;peak: %, rms: %&quot;</span><span class="p">.</span><span class="n">format</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">msg</span><span class="p">[</span><span class="mi">4</span><span class="p">]).</span><span class="n">postln</span>
</span><span class='line'><span class="p">},</span> <span class="err">&#39;</span><span class="o">/</span><span class="n">replyAddress</span><span class="err">&#39;</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>




<p>And in our emacs OSC server:</p>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='emacs-lisp'><span class='line'><span class="p">((</span><span class="nv">string-match</span> <span class="s">&quot;/peakpower&quot;</span> <span class="nv">path</span><span class="p">)</span>
</span><span class='line'>  <span class="p">(</span><span class="k">progn</span>
</span><span class='line'>    <span class="p">(</span><span class="nv">with-current-buffer</span> <span class="s">&quot;flatiron.clj&quot;</span>
</span><span class='line'>      <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">sig</span> <span class="p">(</span><span class="nb">round</span> <span class="p">(</span><span class="nb">*</span> <span class="mf">100.0</span> <span class="p">(</span><span class="nb">first</span> <span class="nv">args</span><span class="p">)))))</span>
</span><span class='line'>        <span class="p">(</span><span class="nv">message</span> <span class="p">(</span><span class="nb">format</span> <span class="s">&quot;%f&quot;</span> <span class="p">(</span><span class="nb">first</span> <span class="nv">args</span><span class="p">)))</span>
</span><span class='line'>        <span class="p">(</span><span class="nb">dotimes</span> <span class="p">(</span><span class="nv">n</span> <span class="nv">sig</span><span class="p">)</span>
</span><span class='line'>          <span class="p">(</span><span class="nv">insert</span> <span class="s">&quot;▓&quot;</span><span class="p">))</span>
</span><span class='line'>        <span class="p">(</span><span class="nv">insert</span> <span class="s">&quot;▒░&quot;</span><span class="p">))</span>
</span><span class='line'>      <span class="p">(</span><span class="nv">insert</span> <span class="s">&quot;\n&quot;</span><span class="p">))))</span>
</span></code></pre></td></tr></table></div></figure>




<iframe src="https://player.vimeo.com/video/141159277" width="500" height="281" frameborder="0" webkitallowfullscreen mozallowfullscreen allowfullscreen></iframe>




<h2>Repl Electric Emacs animations</h2>




<p>All my Emacs animations are used to conclude the performance.
Heres lies the source code, some screenshots and tricks &amp; tips that made the animations possible.</p>




<p>Here&rsquo;s a demo of all the Repl Electric animations discussed in action:</p>




<iframe src="https://player.vimeo.com/video/141310772" width="500" height="375" frameborder="0" webkitallowfullscreen mozallowfullscreen allowfullscreen></iframe>




<h3>End of Buffer</h3>




<p><a href="https://github.com/repl-electric/view-pane/blob/master/animations/end-of-buffer.el">https://github.com/repl-electric/view-pane/blob/master/animations/end-of-buffer.el</a></p>




<p><img src="/images/endofbuffer01.png"/ alt="end-of-buffer-01"><img src="/images/endofbuffer02.png" alt="end-of-buffer-02"/><img src="/images/endofbuffer03.png" alt="end-of-buffer-03"/></p>




<p>In this animations the text gets slowly broken up with white spaces and then like the wind, blows the characters away. Sometimes words are ripped apart as they blow in the wind (if we get lucky).</p>




<p>Two main phases:</p>




<ul>
<li><p>Injection of spaces.
This starts to distort the text while keeping it readable. It provides a way to increase the effect of expanding whitespace in the next stage.</p></li>
<li><p>Transforming whitespace into lots of whitespace.
A Regex matches whitespace and replaces it with a randomly increasing amount of whitespace. Which leads to the effect of the characters of the code blowing away. I spent a while trying to improve the speed of this phase and Regexs proved to be the fastest way.</p></li>
</ul>




<p>If we move the text fast enough soft word wrapping means the text appears to re-enter from the left side of the screen and eventually disappear out of the buffer. Without soft wrapping we get a horrible jitter as emacs moves back and forth between left and right side of the buffer.</p>




<p>A couple of other tricks/tactics used:</p>




<ul>
<li>Continually incrementing integer. Useful for injecting movement or using sin/cos fn with a continuous value.</li>
<li>Perserving the syntax highlighting of the original code in an attempt to maintain some of the meaning of the code.</li>
</ul>




<h3>The Stars</h3>




<p><a href="https://github.com/repl-electric/view-pane/blob/master/animations/the-stars.el">https://github.com/repl-electric/view-pane/blob/master/animations/the-stars.el</a></p>




<p><img src="/images/thestars01.png"/></p>




<p>This was my first animation and was based heavily on <code>zone-pgm-drip-fretfully</code>.</p>




<p>It randomly picks a single character and moves it down the screen until it hits another letter or exits the screen.</p>




<p>When running Emacs + Overtone + OpenGL, Emacs starts to slow down so part of the challenge was ensuring the animation ran as fast as possible.</p>




<p>A nice property of this is that as the OpenGL shaders shutdown, the speed of the animation increases and the code destroys itself more quickly.</p>




<h3>Waves</h3>




<p><a href="https://github.com/repl-electric/view-pane/blob/master/animations/waves.el">https://github.com/repl-electric/view-pane/blob/master/animations/waves.el</a></p>




<p><img src="/images/waves01.png"/><img src="/images/waves02.png"/></p>




<p>This animations attempts to simulate the effect of waves using line wrapping and mixing deletions with insertions of different sizes to create lines that seem to move at different speeds.</p>




<h2>Breaking Tools</h2>




<p>While it may seem silly to bend Emacs to do things it was never intended to do, it&rsquo;s an important part of discovering for yourself how you want your tools to work. Not just doing what you are expected but breaking them apart and discovering for yourself how you want to use them.</p>

</div>




    </article>


    <article>

  <header>

      <h1 class="entry-title"><a href="/clojure/clojure-and-kinesis-at-scale.html">Clojure and Kinesis at Scale</a></h1>


      <p class="meta">












<time datetime="2015-09-30T15:58:12+01:00" pubdate data-updated="true">Sep 30<span>th</span>, 2015</time>

      </p>

  </header>


  <div class="entry-content"><p>I&rsquo;ve been working over the last year in the data team at SoundCloud building a realtime data pipeline using Clojure and Amazon&rsquo;s Kinesis. Kinesis is Amazons equivalent to Kafka, &ldquo;Real-Time data processing on the Cloud&rdquo;. This is a summary of what was built, some lessons learnt and all the details in-between.</p>

<figure>
<img src="/images/kinesis_pipeline.png" alt="Kinesis pipeline"/>
<figcaption>Fig1: Overall System flow</figcaption>
</figure>


<h2>Tapping Real traffic</h2>

<p>The first step was to tee the traffic from a live system to a test system without comprising its function.
The main function of the live system is logging JSON events to file (which eventually end up somewhere like HDFS).
Tailing the logs of the live system gives us access to the raw data we want to forward on to our test system.
A little Go watches the logs, parses out the data and then forwards them in batch to test instances that will push to kinesis. Hence we had live data flowing through the system and after launch a test setup to experiment with. <a href="https://twitter.com/brapse">Sean Braithwaite</a> was the mastermind behind this little bit of magic.</p>

<figure>
<img src="/images/canary.png" alt="Canary Kinesis pipeline"/>
<figcaption>Tapping Traffic</figcaption>
</figure>


<h2>Sending to Kinesis</h2>

<p>All kinesis sending happens in an application called the EventGateway (also written in Clojure). This endpoint is one of the heaviestly loaded services in SoundCloud (at points it has more traffic than the rest of SoundCloud combined). The Eventgateway does a couple of things but at its core it validates and broadcasts JSON messages. Hence this is where our Kinesis client slots in.</p>

<h5>Squeezing Clojure Reflection</h5>

<p>Its worth mentioning that in order for the Eventgateway service to be performant we had to remove all reflection in tight loops through type hints. It simply could not keep up without this. It became a common pattern to turn reflection warnings on while working in Clojure.</p>

<p>Project.clj</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="ss">:profiles</span> <span class="p">{</span><span class="ss">:dev</span> <span class="p">{</span><span class="ss">:global-vars</span> <span class="p">{</span><span class="nv">*warn-on-reflection*</span> <span class="nv">true</span> <span class="nv">*assert*</span> <span class="nv">false</span><span class="p">}}}</span>
</span></code></pre></td></tr></table></div></figure>


<h4>Kinesis</h4>

<p>The Eventgateway posts to Kinesis in batch using a <a href="http://docs.oracle.com/javase/7/docs/api/java/util/concurrent/ConcurrentLinkedQueue.html">ConcurrentLinkedQueue</a> and separate producers and consumers. Messages are pushed into a <code>ConcurrentLinkedQueue</code>. We rolled our own Clojure kinesis client using Amazons Java library rather than using <a href="https://github.com/mcohen01/amazonica">Amazonica</a>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="c1">;; Java Amazon libraries used</span>
</span><span class='line'><span class="p">[</span><span class="nv">com.amazonaws/aws-java-sdk</span> <span class="s">&quot;1.9.33&quot;</span>         <span class="ss">:exclusions</span> <span class="p">[</span><span class="nv">joda-time</span><span class="p">]]</span>
</span><span class='line'><span class="p">[</span><span class="nv">com.amazonaws/amazon-kinesis-client</span> <span class="s">&quot;1.1.0&quot;</span> <span class="ss">:exclusions</span> <span class="p">[</span><span class="nv">joda-time</span><span class="p">]]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Amazonica was good to get started quickly in the initial phase but there are a couple of reasons we switched to our own unique snowflake (which still looked a little like Amazonica):</p>

<ul>
<li>Amazonica did not support batch mode for Kinesis. Under initial tests it was impossible to scale this without batch.</li>
<li>Injecting our own telemetry at low levels to learn more about Kinesis running.</li>
<li>Some of its sensible defaults where not so sensible (for example default encoding the data using nippy).</li>
<li>Ultimately most of any Kinesis client/server is configuration and tuning.</li>
<li>Amazonica&rsquo;s source is hard to read with a little too much <code>alter-var-root</code> going on.</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="c1">;;Ugh. Its not just me right?</span>
</span><span class='line'><span class="p">(</span><span class="nf">alter-var-root</span>
</span><span class='line'>  <span class="o">#</span><span class="ss">&#39;amazonica.aws.kinesis/get-shard-iterator</span>
</span><span class='line'>  <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">f</span><span class="p">]</span>
</span><span class='line'>    <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="o">&amp;</span> <span class="nv">args</span><span class="p">]</span>
</span><span class='line'>      <span class="p">(</span><span class="ss">:shard-iterator</span> <span class="p">(</span><span class="nb">apply </span><span class="nv">f</span> <span class="nv">args</span><span class="p">)))))</span>
</span></code></pre></td></tr></table></div></figure>


<h4>Pushing Messages in a Queue</h4>

<p>Very simple, just adding a message to the <code>ConcurrentLinkedQueue</code>. A environment variable allows us to gradually scale up or down the percentage of traffic that is added to the queue.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">require</span> <span class="o">&#39;</span><span class="p">[</span><span class="nv">environ.core</span> <span class="ss">:refer</span> <span class="ss">:all</span><span class="p">])</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">kinesis-message-queue</span> <span class="p">(</span><span class="nf">ConcurrentLinkedQueue.</span><span class="p">))</span>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">hard-limit-queue-size</span> <span class="mi">1000</span><span class="p">)</span>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">queue-size</span> <span class="p">(</span><span class="nf">atom</span> <span class="mi">0</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nb">send </span><span class="p">[</span><span class="nv">message</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="nb">when-let </span><span class="p">[</span><span class="nv">threshold</span> <span class="p">(</span><span class="nf">env</span> <span class="ss">:kinesis-traffic</span><span class="p">)]</span>
</span><span class='line'>    <span class="p">(</span><span class="nb">when </span><span class="p">(</span><span class="nb">&gt; </span><span class="p">(</span><span class="nb">rand-int </span><span class="mi">100</span><span class="p">)</span> <span class="p">(</span><span class="nb">- </span><span class="mi">100</span> <span class="p">(</span><span class="nb">or </span><span class="p">(</span><span class="nf">Integer/valueOf</span> <span class="o">^</span><span class="nv">String</span> <span class="nv">threshold</span><span class="p">)</span> <span class="mi">0</span><span class="p">)))</span>
</span><span class='line'>    <span class="p">(</span><span class="nb">when </span><span class="p">(</span><span class="nb">&lt;= </span><span class="o">@</span><span class="nv">queue-size</span> <span class="nv">hard-limit-queue-size</span><span class="p">)</span>
</span><span class='line'>      <span class="p">(</span><span class="nf">.add</span> <span class="nv">kinesis-message-queue</span> <span class="nv">message</span><span class="p">)</span>
</span><span class='line'>      <span class="p">(</span><span class="nf">swap!</span> <span class="nv">queue-size</span> <span class="nv">inc</span><span class="p">)))))</span>
</span></code></pre></td></tr></table></div></figure>


<h5>Failure</h5>

<p>The queue pusher operates within a wider system and any failures due to Amazon being unreachable should not impede the function of the system. For the client this means:</p>

<ul>
<li>Not exceeding memory limits with a hard queue size (since ConcurrentLinkedQueue is unbound in size).</li>
<li>Backing off workers if the queue is full to prevent cpu throttling.</li>
</ul>


<p>When we cannot send messages to kinesis we instead log them to disk, and into our normal logging pipeline (usually ending up in HDFS). Hence we coule replay at a later date if required.</p>

<h4>Sending batches to Kinesis</h4>

<p>The workers, operating in separate threads consuming messages from the <code>ConcurrentLinkedQueue</code> collecting them into a batch:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="k">loop </span><span class="p">[</span><span class="nv">batch</span> <span class="p">[]</span>
</span><span class='line'>       <span class="nv">batch-start-time</span> <span class="p">(</span><span class="nf">time/now</span><span class="p">)</span>
</span><span class='line'>       <span class="nv">poll-misses</span> <span class="mi">0</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nf">batch-ready-to-send?</span> <span class="nv">batch</span> <span class="nv">batch-start-time</span><span class="p">)</span>
</span><span class='line'>    <span class="nv">batch</span>
</span><span class='line'>    <span class="p">(</span><span class="nb">if-let </span><span class="p">[</span><span class="nv">event</span> <span class="p">(</span><span class="nf">.poll</span> <span class="nv">kinesis-message-queue</span><span class="p">)]</span>
</span><span class='line'>      <span class="p">(</span><span class="nf">do</span>
</span><span class='line'>        <span class="p">(</span><span class="nf">swap!</span> <span class="nv">queue-size</span> <span class="nv">dec</span><span class="p">)</span>
</span><span class='line'>        <span class="p">(</span><span class="nf">recur</span> <span class="p">(</span><span class="nb">conj </span><span class="nv">batch</span> <span class="nv">event</span><span class="p">)</span> <span class="nv">batch-start-time</span> <span class="mi">0</span><span class="p">))</span>
</span><span class='line'>      <span class="p">(</span><span class="nf">do</span>
</span><span class='line'>        <span class="p">(</span><span class="nf">Thread/sleep</span> <span class="p">(</span><span class="nf">exponential-backoff-sleep</span> <span class="nv">poll-misses</span><span class="p">))</span>
</span><span class='line'>        <span class="p">(</span><span class="nf">recur</span> <span class="nv">batch</span> <span class="nv">batch-start-time</span> <span class="p">(</span><span class="nb">inc </span><span class="nv">poll-misses</span><span class="p">))))))))</span>
</span></code></pre></td></tr></table></div></figure>


<p>When polling from the queue an exponential back-off if no messages are on the queue.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">exponential-backoff-sleep</span>
</span><span class='line'>  <span class="s">&quot;Exponential backoff with jitter and a max &quot;</span>
</span><span class='line'>  <span class="p">[</span><span class="nv">misses</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">max-timeout</span> <span class="mi">1000</span>
</span><span class='line'>        <span class="nv">jitter-order</span> <span class="mi">10</span><span class="p">]</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">Math/min</span>
</span><span class='line'>     <span class="nv">max-timeout</span>
</span><span class='line'>     <span class="p">(</span><span class="nf">Math/round</span> <span class="p">(</span><span class="nb">+ </span><span class="p">(</span><span class="nf">Math/exp</span> <span class="nv">misses</span><span class="p">)</span>
</span><span class='line'>                    <span class="p">(</span><span class="nb">* </span><span class="p">(</span><span class="nf">Math/random</span><span class="p">)</span>
</span><span class='line'>                       <span class="nv">jitter-order</span><span class="p">))))))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Once the batch is ready (in terms of age or size) its sent to Kinesis.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn- </span><span class="nv">send-events</span>
</span><span class='line'>  <span class="s">&quot;Perform putRecords request to send the batch to kinesis</span>
</span><span class='line'><span class="s">   returns a list of events that failed.&quot;</span>
</span><span class='line'>  <span class="p">[</span><span class="o">^</span><span class="nv">AmazonKinesisClient</span> <span class="nv">client</span> <span class="nv">stream-name</span> <span class="nv">events</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">try+</span>
</span><span class='line'>   <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">result</span> <span class="p">(</span><span class="nf">.putRecords</span> <span class="nv">client</span> <span class="p">(</span><span class="nf">events-&gt;put-records-request</span> <span class="nv">events</span> <span class="nv">stream-name</span> <span class="nv">telemetry</span><span class="p">))]</span>
</span><span class='line'>     <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">pos? </span><span class="p">(</span><span class="nf">.getFailedRecordCount</span> <span class="nv">result</span><span class="p">))</span>
</span><span class='line'>       <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">failed-events</span> <span class="p">(</span><span class="nf">failures-&gt;events</span> <span class="nv">result</span> <span class="nv">events</span><span class="p">)]</span>
</span><span class='line'>         <span class="p">(</span><span class="nf">count-failures</span> <span class="nv">telemetry</span> <span class="p">(</span><span class="nf">failures-&gt;error-codes</span> <span class="nv">result</span><span class="p">))</span>
</span><span class='line'>         <span class="nv">failed-events</span><span class="p">)</span>
</span><span class='line'>       <span class="p">[]))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Note this is where we also decided the partition key. In our case its important for the same user to be located on the same partition.
For example when consuming from Kinesis a worker is allocated a partition to work from and would miss events if they where across multiple partitions.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn- </span><span class="nv">events-&gt;put-records-request</span>
</span><span class='line'>  <span class="s">&quot;Take client and a vector of JsonNodes and produce a PutRecord&quot;</span>
</span><span class='line'>  <span class="p">[</span><span class="nv">batch</span> <span class="nv">event-stream</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">batch-list</span>  <span class="p">(</span><span class="nf">java.util.ArrayList.</span><span class="p">)</span>
</span><span class='line'>        <span class="nv">put-request</span> <span class="p">(</span><span class="nf">PutRecordsRequest.</span><span class="p">)]</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">.setStreamName</span> <span class="nv">put-request</span> <span class="nv">event-stream</span><span class="p">)</span>
</span><span class='line'>    <span class="p">(</span><span class="nb">doseq </span><span class="p">[</span><span class="o">^</span><span class="nv">ObjectNode</span> <span class="nv">event</span> <span class="nv">batch</span><span class="p">]</span>
</span><span class='line'>      <span class="p">(</span><span class="nf">.remove</span> <span class="nv">event</span> <span class="o">^</span><span class="nv">String</span> <span class="nv">failure-metadata</span><span class="p">)</span>
</span><span class='line'>      <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">request-entry</span> <span class="p">(</span><span class="nf">PutRecordsRequestEntry.</span><span class="p">)</span>
</span><span class='line'>            <span class="nv">request-data</span>  <span class="p">(</span><span class="nf">.getBytes</span> <span class="p">(</span><span class="nb">str </span><span class="nv">event</span><span class="p">))</span>
</span><span class='line'>            <span class="nv">request-buf</span>   <span class="p">(</span><span class="nf">ByteBuffer/wrap</span> <span class="nv">request-data</span> <span class="mi">0</span> <span class="p">(</span><span class="nb">alength </span><span class="nv">request-data</span><span class="p">))</span>
</span><span class='line'>            <span class="nv">partition-key</span> <span class="p">(</span><span class="ss">:user-id</span> <span class="nv">event</span><span class="p">)]</span>
</span><span class='line'>        <span class="p">(</span><span class="nb">doto </span><span class="nv">request-entry</span>
</span><span class='line'>          <span class="p">(</span><span class="nf">.setData</span>         <span class="nv">request-buf</span><span class="p">)</span>
</span><span class='line'>          <span class="p">(</span><span class="nf">.setPartitionKey</span> <span class="nv">partition-key</span><span class="p">))</span>
</span><span class='line'>        <span class="p">(</span><span class="nf">.add</span> <span class="nv">batch-list</span> <span class="nv">request-entry</span><span class="p">)))</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">.setRecords</span> <span class="nv">put-request</span> <span class="nv">batch-list</span><span class="p">)</span>
</span><span class='line'>    <span class="nv">put-request</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<h5>Failure</h5>

<p>Failure can occur on individual records within a batch or in the batch as a whole.</p>

<h6>Individual failures</h6>

<ol>
<li>These messages are re-added to the queue so we can try again. If the messages fail for some nth time they are considered invalid and rejected from kinesis and logged as an error.</li>
</ol>


<h6>Batch level</h6>

<ol>
<li><p>Amazon had an Internal Failure. We don&rsquo;t know what went wrong. (We see this regularly in normal function).</p></li>
<li><p>Amazon Kinesis is not resolvable (AmazonClientException/AmazonServiceException).</p></li>
<li><p>Exceeding the read/write limits of Kinesis (ProvisionedThroughputExceededException).</p></li>
</ol>


<p>This is our backpressure signal, in which case at worst we need to log to disk for replay later</p>

<h2>Consuming Messages from Kinesis</h2>

<p>With the consumption of events we have a different application stream for every worker. All workers have their own streams, and own checkpoints so they operate independently of each other. Some example of the workers we gave running:</p>

<ul>
<li>Logging Events to s3</li>
<li>Calculating listening time</li>
<li>Forwarding certain messages on to various other systems (like RabbitMQ).</li>
</ul>


<p>Launching a worker is pretty simple with the Amazon Java Kinesis library.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="ss">:import</span> <span class="p">[</span><span class="nv">com.amazonaws.services.kinesis.clientlibrary.lib.worker</span> <span class="nv">Worker</span><span class="p">])</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">-main</span> <span class="p">[</span><span class="o">&amp;</span> <span class="nv">args</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">worker-fn</span> <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">events</span><span class="p">]</span> <span class="p">(</span><span class="nb">print </span><span class="nv">events</span><span class="p">))</span>
</span><span class='line'>        <span class="nv">config</span> <span class="p">(</span><span class="nf">KinesisClientLibConfiguration.</span>   <span class="nv">worker-fn</span>  <span class="p">)</span>   <span class="c1">;;I&#39;m airbrushing over the Java classes</span>
</span><span class='line'>        <span class="nv">processor</span> <span class="p">(</span><span class="nf">reify</span> <span class="nv">IRecordProcessorFactory</span> <span class="nv">worker-fn</span><span class="p">)</span>   <span class="c1">;;Ultimately this is a lot of config wrapped in Java fun</span>
</span><span class='line'>        <span class="p">[</span><span class="o">^</span><span class="nv">Worker</span> <span class="nv">worker</span> <span class="nv">uuid</span><span class="p">]</span> <span class="p">(</span><span class="nf">Worker.</span> <span class="nv">processor</span> <span class="nv">config</span><span class="p">)]</span>
</span><span class='line'>          <span class="p">(</span><span class="nf">future</span> <span class="p">(</span><span class="nf">.run</span> <span class="nv">worker</span><span class="p">))))</span>
</span></code></pre></td></tr></table></div></figure>


<p>One of the hardest parts of setting up the a worker is getting the configuration right to ensure that the consumers are getting through the events fast enough. Events are held in Amazon for 24 hours after entry, and hence there is a minimum consumption rate.</p>

<p>Counting events in and events out with <a href="http://prometheus.io/">Prometheus</a> made it easier to get the correct consumption rates.
<img src="/images/kinesis_entry_exit_rates.png" alt="Entry/exit rates"/></p>

<p>Via the Amazon console you also get access to various graphs around read/write rates and limits:</p>

<p><img src="/images/amazon_kinesis_graphs.png"/></p>

<p>Finally you can also look at Amazon&rsquo;s Dynamodb instance for the Kinesis stream providing insight into metrics around leases, how many where revoked, stolen, never finished, etc.</p>

<p>Here is an example of one of our Kinesis workers configuration covered in scribblings of me trying to work out the right settings.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'>  <span class="p">{</span>
</span><span class='line'>   <span class="c1">;;default 1 sec, cannot be lower than 200ms</span>
</span><span class='line'>   <span class="c1">;;If we are not reading fast enough this is a good value to tweak</span>
</span><span class='line'>   <span class="ss">:idle-time-between-reads-in-millis</span> <span class="mi">500</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">;;Clean up leases for shards that we&#39;ve finished processing (don&#39;t wait</span>
</span><span class='line'>   <span class="c1">;;until they expire)</span>
</span><span class='line'>   <span class="ss">:cleanup-leases-upon-shard-completion</span> <span class="nv">true</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">;;If the heartbeat count does not increase within the configurable timeout period,</span>
</span><span class='line'>   <span class="c1">;;other workers take over processing of that shard.</span>
</span><span class='line'>   <span class="c1">;;*IMPORTANT* If this time is shorter than time for a worker to checkpoint all nodes</span>
</span><span class='line'>   <span class="c1">;;will keep stealing each others leases producing a lot of contention.</span>
</span><span class='line'>   <span class="ss">:failover-time-millis</span> <span class="nv">...</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">;;Max records in a single returned in a `GetRecords`. Cannot exceed 10,000</span>
</span><span class='line'>   <span class="ss">:max-records</span> <span class="mi">4500</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">;;Process records even if GetRecords returned an empty record list.</span>
</span><span class='line'>   <span class="ss">:call-process-records-even-for-empty-record-list</span> <span class="nv">false</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">;;Sleep for this duration if the parent shards have not completed processing,</span>
</span><span class='line'>   <span class="c1">;;or we encounter an exception.</span>
</span><span class='line'>   <span class="ss">:parent-shard-poll-interval-millis</span> <span class="mi">10000</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">;;By default, the KCL begins withs the most recently added record.</span>
</span><span class='line'>   <span class="c1">;;Instead always reads data from the beginning of the stream.</span>
</span><span class='line'>   <span class="ss">:initial-position-in-stream</span>  <span class="ss">:TRIM_HORIZON</span><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Monitoring</h2>

<p>Prometheus (<a href="http://prometheus.io/">http://prometheus.io/</a>) a monitoring tool built at SoundCloud was <em>core</em> to developing, scaling and monitoring all of this pipeline. Amazon does provide some useful graphs within the AWS console but more detailed feedback was very helpful even if it was removed later.</p>

<h4>Exception Logging pattern</h4>

<p>All Exceptions are counted and sent to log. This was a very useful pattern for driving out errors and spotting leaks in the interactions with Kinesis and consumption:</p>

<p>(Using a Clojure wrapper around Prometheus: <a href="https://github.com/josephwilk/prometheus-clj">https://github.com/josephwilk/prometheus-clj</a>)</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">try+</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">worker-fn</span> <span class="nv">raw-events</span><span class="p">)</span>
</span><span class='line'><span class="p">(</span><span class="nf">catch</span> <span class="nv">Exception</span> <span class="nv">e</span>
</span><span class='line'>  <span class="c1">;;Count based on exception class</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">inc-counter</span> <span class="ss">:failed-batches</span> <span class="p">{</span><span class="ss">:type</span> <span class="nv">worker-type</span> <span class="ss">:error-code</span> <span class="p">(</span><span class="nb">str </span><span class="p">(</span><span class="nf">.getClass</span> <span class="nv">e</span><span class="p">))})</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">log/error</span> <span class="nv">e</span><span class="p">)))]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Note Kinesis regularly spits out &ldquo;InternalFailure&rdquo; Exceptions. Thats all you get&hellip;</p>

<p><img src="/images/kinesis_failures.png" alt="Kinesis Internal failures"/></p>

<h2>A Cloud Pipeline in Pictures</h2>

<p>In my previous post about <a href="http://blog.josephwilk.net/clojure/building-clojure-services-at-scale.html">Building Clojure services at scale</a> I converted the system metrics to sound. With so many machines processing so many events its easy to loose track of the amount of work being done in the cloud.
To make this feel more real I captured metrics across all the machines involved and created 3d renderings using <a href="http://openframeworks.cc">OpenFrameworks</a> and meshes of the systems function:</p>

<p><img src="/images/soundcloud_kinesis.png" alt="" />
<img src="/images/soundcloud_kinesis2.png" alt="" /></p>

<h2>Thanks</h2>

<p>This work constitues a team effort by the Data team at SoundCloud. A lot of advice, collaboration and hard work. Kudos to everyone.</p>
</div>




    </article>


    <article>

  <header>

      <h1 class="entry-title"><a href="/clojure/overtone-driving-minecraft.html">Clojure and Overtone Driving Minecraft</a></h1>


      <p class="meta">












<time datetime="2015-03-01T14:58:12+00:00" pubdate data-updated="true">Mar 1<span>st</span>, 2015</time>

      </p>

  </header>


  <div class="entry-content"><p>Using Clojure we create interesting 3D shapes in Minecraft to the beat of music generated from Overtone.</p>

<p>We achieve this by embedding a Clojure REPL inside a Java Minecraft server which loads Overtone and connects to an external Supercollider instance (What Overtone uses for sound).</p>

<h3>Demo</h3>

<iframe src="http://player.vimeo.com/video/120907923" width="500" height="375" frameborder="0" webkitallowfullscreen mozallowfullscreen allowfullscreen></iframe>


<p>Demo Source code: <a href="https://github.com/josephwilk/clj-minecraft/blob/master/src/cljminecraft/overtone.clj">https://github.com/josephwilk/clj-minecraft/blob/master/src/cljminecraft/overtone.clj</a></p>

<h4>Tools</h4>

<ul>
<li>Java Minecraft server Craftbukkit/Spigot: <a href="http://www.spigotmc.org/">http://www.spigotmc.org/</a></li>
<li>Minecraft client (requires purchase) <a href="https://minecraft.net">https://minecraft.net</a></li>
<li>clj-minecraft Bukkit plugin: <a href="https://github.com/josephwilk/clj-minecraft">https://github.com/josephwilk/clj-minecraft</a></li>
<li>Overtone (patched): <a href="https://github.com/josephwilk/overtone/tree/minecraft_overtone">https://github.com/josephwilk/overtone/tree/minecraft_overtone</a></li>
<li>MUD (useful helpers for Overtone): <a href="https://github.com/josephwilk/mud">https://github.com/josephwilk/mud</a></li>
<li>Supercollider: <a href="http://supercollider.sourceforge.net">http://supercollider.sourceforge.net</a></li>
</ul>


<p>(Dependent on your IDE of choice)</p>

<ul>
<li>Emacs &ndash; cider: <a href="https://github.com/clojure-emacs/cider">https://github.com/clojure-emacs/cider</a></li>
<li>Vim   &ndash; fireplace: <a href="https://github.com/tpope/vim-fireplace">https://github.com/tpope/vim-fireplace</a></li>
</ul>


<h2>Building the world</h2>

<p>We need to install Spigot which is an optimized version of the Craftbukkit Java Minecraft server and install clj-minecraft project as a plugin. Things are complicated by Bukkit no longer being registered in Maven.</p>

<p>Read through the Makefile install:</p>

<p><a href="https://github.com/josephwilk/clj-minecraft/blob/master/Makefile">https://github.com/josephwilk/clj-minecraft/blob/master/Makefile</a></p>

<p>If your happy clone and run:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>git clone git@github.com:josephwilk/clj-minecraft.git && make install</span></code></pre></td></tr></table></div></figure>


<p>Bukkit + clj-minecraft will be installed for you.</p>

<h2>Running the world</h2>

<p>You will need to edit the <code>minecraft/eula.txt</code> indicating you agree with the license. Then you can run your Minecraft server:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>java -XX:MaxPermSize=1G -jar spigot-1.8.jar</span></code></pre></td></tr></table></div></figure>


<h2>Seeing the world</h2>

<p>Buy and install a Minecraft client: <a href="https://minecraft.net">https://minecraft.net</a></p>

<p>Select >&ldquo;Multiplayer&rdquo; >&ldquo;Direct connect&rdquo; and enter the &ldquo;Server Address&rdquo; as localhost.</p>

<h1>Bring music to the world</h1>

<h3>Install and Boot Supercollider</h3>

<p><a href="http://supercollider.github.io">http://supercollider.github.io</a></p>

<p>Once installed:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#Find the Supercollider binary (scsynth)
</span><span class='line'>$ sudo find /. -name "scsynth"
</span><span class='line'>
</span><span class='line'>/Applications/SuperCollider/SuperCollider.app/Contents/Resources/scsynth
</span><span class='line'>
</span><span class='line'>#Run Supercollider server
</span><span class='line'>/Applications/SuperCollider/SuperCollider.app/Contents/Resources/scsynth -u 57110</span></code></pre></td></tr></table></div></figure>


<h3>Speaking to the Minecraft REPL</h3>

<p>clj-minecraft opens a REPL on localhost port 4005.  Using emacs and <code>cider</code> connect to this REPL instance.</p>

<p>Boot and connect Overtone:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">use</span> <span class="ss">&#39;overtone.core</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">connect-external-server</span><span class="p">)</span>  <span class="o">#</span><span class="nv">=&gt;</span> <span class="ss">:happy-hacking</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Interaction</h3>

<p>Using <code>MUD</code> we have some useful wrappers around Overtone for scheduling functions on beats.</p>

<p>To coordinate graphics and sound we schedule both within a single function.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">require</span> <span class="o">&#39;</span><span class="p">[</span><span class="nv">mud.core</span> <span class="ss">:as</span> <span class="nv">mud</span><span class="p">])</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defonce </span><span class="nv">highhat-sample</span> <span class="p">(</span><span class="nf">freesound</span> <span class="mi">53532</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">ride-trigger</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">mud/on-beat-trigger</span> <span class="mi">8</span>       <span class="c1">;; Every 8th beat</span>
</span><span class='line'>   <span class="p">(</span><span class="k">fn </span><span class="p">[]</span>
</span><span class='line'>     <span class="p">(</span><span class="nf">highhat-sample</span><span class="p">)</span>      <span class="c1">;; Play sample</span>
</span><span class='line'>     <span class="p">(</span><span class="nf">block</span> <span class="mi">2</span> <span class="mi">10</span> <span class="mi">2</span> <span class="ss">:grass</span><span class="p">)</span> <span class="c1">;; Place a block into the Minecraft world</span>
</span><span class='line'><span class="p">)))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Most functions that change the state of the Minecraft world need to be run in the main GUI thread. To achieve this we wrap any state changing function within  <code>ui-sync</code> (<a href="https://github.com/CmdrDats/clj-minecraft/blob/a3331e925b56becf88d9ef96cab225856e2f7ead/src/cljminecraft/bukkit.clj#L39-L42">https://github.com/CmdrDats/clj-minecraft/blob/a3331e925b56becf88d9ef96cab225856e2f7ead/src/cljminecraft/bukkit.clj#L39-L42</a>).</p>

<p>For example a function to place a block into the Minecraft world:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nb">import </span><span class="o">&#39;</span><span class="p">[</span><span class="nv">org.bukkit</span> <span class="nv">Location</span> <span class="nv">Material</span><span class="p">])</span>
</span><span class='line'><span class="p">(</span><span class="nf">require</span> <span class="o">&#39;</span><span class="p">[</span><span class="nv">cljminecraft.bukkit</span> <span class="ss">:as</span> <span class="nv">bk</span><span class="p">])</span>
</span><span class='line'><span class="p">(</span><span class="nf">require</span> <span class="o">&#39;</span><span class="p">[</span><span class="nv">cljminecraft.items</span> <span class="ss">:as</span> <span class="nv">i</span><span class="p">])</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">player</span> <span class="p">(</span><span class="nb">first </span><span class="p">(</span><span class="nf">.getOnlinePlayers</span> <span class="p">(</span><span class="nf">bk/server</span><span class="p">))))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">block</span>
</span><span class='line'>  <span class="s">&quot;place a block relative to current players position</span>
</span><span class='line'><span class="s">  Example:</span>
</span><span class='line'><span class="s">    (block 2 10 2 :grass)</span>
</span><span class='line'><span class="s">  &quot;</span>
</span><span class='line'>  <span class="p">[</span><span class="nv">x</span> <span class="nv">y</span> <span class="nv">z</span> <span class="nv">material</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">l</span> <span class="p">(</span><span class="nf">.getLocation</span> <span class="nv">player</span><span class="p">))</span>
</span><span class='line'>        <span class="nv">m</span> <span class="p">(</span><span class="nf">i/get-material</span> <span class="nv">material</span><span class="p">)]</span>
</span><span class='line'>    <span class="p">(</span><span class="nb">doto </span><span class="nv">l</span>
</span><span class='line'>      <span class="p">(</span><span class="nf">.setX</span> <span class="p">(</span><span class="nb">+ </span><span class="nv">x</span> <span class="p">(</span><span class="nf">.getX</span> <span class="nv">l</span><span class="p">)))</span>
</span><span class='line'>      <span class="p">(</span><span class="nf">.setY</span> <span class="p">(</span><span class="nb">+ </span><span class="nv">y</span> <span class="p">(</span><span class="nf">.getY</span> <span class="nv">l</span><span class="p">)))</span>
</span><span class='line'>      <span class="p">(</span><span class="nf">.setZ</span> <span class="p">(</span><span class="nb">+ </span><span class="nv">z</span> <span class="p">(</span><span class="nf">.getZ</span> <span class="nv">l</span><span class="p">))))</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">bk/ui-sync</span>
</span><span class='line'>     <span class="o">@</span><span class="nv">cljminecraft.core/clj-plugin</span>
</span><span class='line'>     <span class="p">(</span><span class="k">fn </span><span class="p">[]</span>
</span><span class='line'>       <span class="p">(</span><span class="nb">doto </span><span class="p">(</span><span class="nf">.getBlock</span> <span class="nv">l</span><span class="p">)</span>
</span><span class='line'>         <span class="p">(</span><span class="nf">.setData</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>         <span class="p">(</span><span class="nf">.setType</span> <span class="p">(</span><span class="nf">.getItemType</span> <span class="nv">m</span><span class="p">))</span>
</span><span class='line'>         <span class="p">(</span><span class="nf">.setData</span> <span class="p">(</span><span class="nf">.getData</span> <span class="nv">m</span><span class="p">)))))))</span>
</span></code></pre></td></tr></table></div></figure>


<p>For further documentation of whats possible, the Bukkit Java docs:
<a href="https://hub.spigotmc.org/javadocs/bukkit/">https://hub.spigotmc.org/javadocs/bukkit/</a></p>

<p>clj-minecaft has lots of helpers + examples: <a href="https://github.com/CmdrDats/clj-minecraft/tree/master/src/cljminecraft">https://github.com/CmdrDats/clj-minecraft/tree/master/src/cljminecraft</a></p>

<h2>Fun</h2>

<p>Create, play and share all the crazy things you can come up with using Clojure and Minecraft.</p>

<p><img src="/images/pig_algo_rave.png" width="450" alt="The Pig Algo Rave"/></p>

<p>For more live programming music and sound checkout my performances as Repl Electric: <a href="http://www.repl-electric.com">http://www.repl-electric.com</a></p>

<h2>Credits</h2>

<p>Built on the back of lots of great open source projects.
Thanks to the Craftbukkit/Spigot contributors, <a href="https://twitter.com/cmdrdats">@CmdrDats</a> for clj-minecraft and <a href="https://twitter.com/samaaron">@samaaron</a> for Overtone and inspiring this crazy journey with the musical <a href="http://sonic-pi.net/">Sonic Pi</a> (which supports combining music and Minecraft on the RaspberryPi).</p>
</div>




    </article>


    <article>

  <header>

      <h1 class="entry-title"><a href="/art/live-coding-repl-electric.html">Live Coding - Repl Electric</a></h1>


      <p class="meta">












<time datetime="2014-06-13T15:58:12+01:00" pubdate data-updated="true">Jun 13<span>th</span>, 2014</time>

      </p>

  </header>


  <div class="entry-content"><p>Live coding is the act of turning a programming session into a performance. This can constitute improvisation, music, visuals, poetry, hardware, robots, dance, textiles and people. Pretty much anything with an input and output can be controlled live by programming.</p>

<p>This is not just a performance by programmers for programmers. While this is often where it starts as a live coder, the type of audience and the accessibility of the performance lies in the performers imagination. Abstraction can get us pretty much anywhere.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">the-stars</span> <span class="p">(</span><span class="nf">dark-matter</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Repl Electric</h2>

<p><img src="https://camo.githubusercontent.com/d1711cc92a1b79af187344f461be35e2ced44e3f/687474703a2f2f7333302e706f7374696d672e6f72672f7633336377783668642f53637265656e5f53686f745f323031345f30345f32385f61745f32305f31345f33352e706e67"/></p>

<p><a href="http://www.repl-electric.com">Repl Electric</a> is a project I started in order to discover more about music composition and Artificial intelligent based aids to creativity. Which in turn through the inspiration of people like <a href="http://meta-ex.com/">Meta-ex</a> lead me to live programming music.</p>

<p>Here is a performance live coding music and graphics, inspired by a performance in London:</p>

<h3>The Stars</h3>

<iframe src="http://player.vimeo.com/video/95988263" width="500" height="313" frameborder="0" webkitallowfullscreen mozallowfullscreen allowfullscreen></iframe>


<h3>Open Live Coding</h3>

<p>All the tools and code used to create this performance are open for all to see on Github: <a href="https://github.com/repl-electric">https://github.com/repl-electric</a></p>

<p>Three programming languages were used to create this piece:</p>

<ul>
<li>Clojure (Sound)</li>
<li>GLSL (Visuals)</li>
<li>Emacs Lisp (Animations &amp; Navigation)</li>
</ul>


<h3>Tools</h3>

<p>Here are the tools used and a little detail around how they where used in performing &ldquo;The Stars&rdquo;:</p>

<h4>Clojure: <a href="http://clojure.org">http://clojure.org</a></h4>

<p>Clojure is a LISP language based on the JVM.</p>

<p>Clojure focuses on interactive REPL (Read, Evaluate, Print &amp; Loop) driven development. Which makes it a good choice for interactively coding music. It also turns out functional programming is a good fit for operating over music as data.</p>

<h4>Emacs Live: <a href="https://github.com/overtone/emacs-live">https://github.com/overtone/emacs-live</a></h4>

<p>Emacs live is a Emacs release with packages and defaults that are Live Coding centric. Something I use for both for my work and for my live coding.</p>

<p>To execute our code, we launch a repl instance in our project (NEVER launch inside emacs, since then if emacs crashes the repl and music dies) and connect to it from emacs using <code>cider</code> <a href="https://github.com/clojure-emacs/cider.">https://github.com/clojure-emacs/cider.</a></p>

<p>A simple trick to combine Emacs code and visualizations is to launch an OpenGL window in full screen (see Shadertone) and then put a full screen transparent terminal window running emacs over it.</p>

<p><img src="/images/terminal.png" alt="" /></p>

<p>The tumbling text effect seen at the end of the performance is an emacs animation using <code>Zone Mode</code> which supports writing your own text destructors: <a href="http://www.emacswiki.org/emacs/ZoneMode">http://www.emacswiki.org/emacs/ZoneMode</a></p>

<h4>Overtone: <a href="https://github.com/overtone/overtone">https://github.com/overtone/overtone</a></h4>

<p>Overtone is a Clojure based client to <a href="http://supercollider.sourceforge.net">SuperCollider</a>. Supercollider is an environment for real time audio synthesis and algorithmic composition.</p>

<p>Overtone provides us with:</p>

<ul>
<li>Timing (beat generation &ndash; <a href="https://github.com/repl-electric/cassiopeia/blob/master/src/cassiopeia/engine/timing.clj">example timing code</a>).</li>
<li>Building Synths (engineer sound).</li>
<li>Running samples (both your own and from <a href="https://www.freesound.org/">Freesound</a>).</li>
<li>Live Synth control (changing notes, durations, reverb, etc).</li>
<li>Hardware interaction (through midi or OSC).</li>
</ul>


<p>An example of a synth used in The Stars:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">use</span> <span class="ss">&#39;overtone.live</span><span class="p">)</span>
</span><span class='line'><span class="p">(</span><span class="nf">defsynth</span> <span class="nv">dark-ambience</span> <span class="p">[</span><span class="nv">out-bus</span> <span class="mi">0</span> <span class="nv">amp</span> <span class="mi">1</span> <span class="nv">mul</span> <span class="mf">0.2</span> <span class="nv">room-size</span> <span class="mi">70</span> <span class="nv">rev-time</span> <span class="mi">99</span> <span class="nv">freq</span> <span class="mi">60</span> <span class="nv">ring-mul</span> <span class="mi">55</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">pink</span> <span class="p">(</span><span class="nf">hpf</span><span class="ss">:ar</span> <span class="p">(</span><span class="nb">* </span><span class="p">(</span><span class="nb">* </span><span class="mf">0.005</span> <span class="p">(</span><span class="nf">pink-noise</span><span class="p">))</span> <span class="p">(</span><span class="nf">line</span><span class="ss">:kr</span> <span class="mi">0</span> <span class="mi">1</span> <span class="mi">9</span><span class="p">))</span> <span class="mi">5</span><span class="p">)</span>
</span><span class='line'>        <span class="nv">src1</span> <span class="p">(</span><span class="nf">ringz</span> <span class="p">(</span><span class="nb">* </span><span class="nv">pink</span> <span class="p">(</span><span class="nf">lf-noise1</span><span class="ss">:kr</span> <span class="mf">0.15</span><span class="p">))</span> <span class="p">(</span><span class="nb">+ </span><span class="nv">freq</span> <span class="p">(</span><span class="nb">* </span><span class="nv">ring-mul</span> <span class="mi">0</span><span class="p">))</span> <span class="nv">mul</span><span class="p">)</span>
</span><span class='line'>        <span class="nv">src2</span> <span class="p">(</span><span class="nf">ringz</span> <span class="p">(</span><span class="nb">* </span><span class="nv">pink</span> <span class="p">(</span><span class="nf">lf-noise1</span><span class="ss">:kr</span> <span class="mf">0.15</span><span class="p">))</span> <span class="p">(</span><span class="nb">+ </span><span class="nv">freq</span> <span class="p">(</span><span class="nb">* </span><span class="nv">ring-mul</span> <span class="mi">1</span><span class="p">))</span> <span class="nv">mul</span><span class="p">)</span>
</span><span class='line'>        <span class="nv">src3</span> <span class="p">(</span><span class="nf">ringz</span> <span class="p">(</span><span class="nb">* </span><span class="nv">pink</span> <span class="p">(</span><span class="nf">lf-noise1</span><span class="ss">:kr</span> <span class="mf">0.15</span><span class="p">))</span> <span class="p">(</span><span class="nb">+ </span><span class="nv">freq</span> <span class="p">(</span><span class="nb">* </span><span class="nv">ring-mul</span> <span class="mi">2</span><span class="p">))</span> <span class="nv">mul</span><span class="p">)</span>
</span><span class='line'>        <span class="nv">src</span> <span class="p">(</span><span class="nf">tanh</span> <span class="p">(</span><span class="nf">g-verb</span> <span class="p">(</span><span class="nf">sum</span> <span class="p">[</span><span class="nv">src1</span> <span class="nv">src2</span> <span class="nv">src3</span><span class="p">])</span> <span class="nv">room-size</span> <span class="nv">rev-time</span><span class="p">))]</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">out</span> <span class="nv">out-bus</span> <span class="p">(</span><span class="nb">* </span><span class="nv">amp</span> <span class="nv">src</span><span class="p">))))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">the-stars</span> <span class="p">(</span><span class="nf">dark-ambience</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<h6>Timing</h6>

<p>Timing is a complicated issue but so important its worth touching on. You have a choice with Overtone to use Java for timing or Supercollider. I use Supercollider since I have found it to be much more reliable.
Everything you need is here (<a href="https://github.com/repl-electric/cassiopeia/blob/master/src/cassiopeia/engine/timing.clj">copy and paste</a>), thanks to the hard work of <a href="https://github.com/samaaron">Sam Aaron</a>.</p>

<p>The key concept to take away is there are two types of timing, a beat counter which is forever incrementing and a beat trigger which flips back and forth between 1/0.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">require</span> <span class="o">&#39;</span><span class="p">[</span><span class="nv">cassiopeia.engine.timing</span> <span class="ss">:as</span> <span class="nv">time</span><span class="p">])</span>
</span><span class='line'>
</span><span class='line'><span class="c1">;;The beat trigger</span>
</span><span class='line'><span class="p">(</span><span class="ss">:beat</span> <span class="nv">time/main-beat</span><span class="p">)</span> <span class="c1">;=&gt; 0,1,0,1,0,1,0</span>
</span><span class='line'>
</span><span class='line'><span class="c1">;;The beat counter</span>
</span><span class='line'><span class="p">(</span><span class="ss">:count</span> <span class="nv">time/main-beat</span><span class="p">)</span> <span class="c1">;=&gt; 0,1,2,3,4,5,6,7,8,9</span>
</span></code></pre></td></tr></table></div></figure>


<p>The counter is useful for indexing buffers, the trigger is useful in controlling the gate of an envelope (which turns a sound on or off).</p>

<p>In Clojure we can still get access to the beat, in our timing code we send a message using <code>send-trig</code> on every beat. We can hook a Clojure function to callback on this beat:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">on-trigger</span> <span class="p">(</span><span class="ss">:trig-id</span> <span class="nv">time/main-beat</span><span class="p">)</span>
</span><span class='line'>  <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">beat-no</span><span class="p">]</span>
</span><span class='line'>    <span class="p">(</span><span class="nb">when </span><span class="p">(</span><span class="nb">= </span><span class="mf">0.0</span> <span class="p">(</span><span class="nf">mod</span> <span class="nv">beat-no</span> <span class="mi">32</span><span class="p">))</span>
</span><span class='line'>      <span class="c1">;;play a sample</span>
</span><span class='line'>      <span class="p">(</span><span class="nf">boom-s</span><span class="p">)))</span>
</span><span class='line'>  <span class="ss">::on-beat-trigger</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>I use this extensively to time graphic transitions with the music.</p>

<h6>Buffers</h6>

<p>Most of my live coding performance was writing to buffers which are hooked into synths. Buffers are just fixed size arrays but they are stored in Supercollider rather than in Clojure. Here is an example from The Stars where the midi notes are read from a buffer at a rate based on my beat timing signal (a 16th of the main beat here).</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">use</span> <span class="ss">&#39;overtone.live</span><span class="p">)</span>
</span><span class='line'><span class="p">(</span><span class="nf">use</span> <span class="ss">&#39;cassiopeia.engine.core</span><span class="p">)</span>
</span><span class='line'><span class="p">(</span><span class="nf">require</span> <span class="o">&#39;</span><span class="p">[</span><span class="nv">cassiopeia.engine.timing</span> <span class="ss">:as</span> <span class="nv">time</span><span class="p">])</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">defsynth</span> <span class="nv">growl</span> <span class="p">[</span><span class="nv">out-bus</span> <span class="mi">0</span> <span class="nv">note-buf</span> <span class="mi">0</span> <span class="nv">beat-bus</span> <span class="mi">0</span> <span class="nv">beat-trg-bus</span> <span class="mi">0</span> <span class="nv">amp</span> <span class="mi">1</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">cnt</span> <span class="p">(</span><span class="nf">in</span><span class="ss">:kr</span> <span class="nv">beat-bus</span><span class="p">)</span>
</span><span class='line'>        <span class="nv">trg</span> <span class="p">(</span><span class="nf">in</span><span class="ss">:kr</span> <span class="nv">beat-trg-bus</span><span class="p">)</span>
</span><span class='line'>        <span class="nv">note</span> <span class="p">(</span><span class="nf">buf-rd</span><span class="ss">:kr</span> <span class="mi">1</span> <span class="nv">note-buf</span> <span class="nv">cnt</span><span class="p">)</span>
</span><span class='line'>        <span class="nv">freq</span> <span class="p">(</span><span class="nf">midicps</span> <span class="nv">note</span><span class="p">)</span>
</span><span class='line'>        <span class="nv">vol</span> <span class="p">(</span><span class="nb">&gt; </span><span class="nv">note</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="nv">e</span> <span class="p">(</span><span class="nf">env-gen</span> <span class="p">(</span><span class="nf">perc</span> <span class="ss">:attack</span> <span class="mi">10</span> <span class="ss">:sustain</span> <span class="mi">1</span> <span class="ss">:release</span> <span class="mi">1</span><span class="p">)</span> <span class="ss">:gate</span> <span class="nv">trg</span><span class="p">)</span>
</span><span class='line'>        <span class="nv">src</span> <span class="p">(</span><span class="nf">lpf</span> <span class="p">(</span><span class="nf">mix</span> <span class="p">[(</span><span class="nf">saw</span> <span class="p">(</span><span class="nb">* </span><span class="mf">0.25</span> <span class="nv">freq</span><span class="p">))</span>
</span><span class='line'>                       <span class="p">(</span><span class="nf">sin-osc</span> <span class="p">(</span><span class="nb">* </span><span class="mf">1.01</span> <span class="nv">freq</span><span class="p">))]))</span>
</span><span class='line'>        <span class="nv">src</span> <span class="p">(</span><span class="nf">pitch-shift</span> <span class="nv">src</span> <span class="mf">0.4</span> <span class="mi">1</span> <span class="mi">0</span> <span class="mf">0.01</span><span class="p">)</span>
</span><span class='line'>        <span class="nv">src</span> <span class="p">(</span><span class="nf">pan2</span><span class="ss">:ar</span> <span class="p">(</span><span class="nb">* </span><span class="nv">vol</span> <span class="nv">amp</span> <span class="nv">e</span> <span class="nv">src</span><span class="p">))]</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">out</span> <span class="nv">out-bus</span> <span class="nv">src</span><span class="p">)))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defonce </span><span class="nv">nebular</span> <span class="p">(</span><span class="nf">buffer</span> <span class="mi">96</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">nebula</span> <span class="p">(</span><span class="nf">growl</span> <span class="ss">:note-buf</span> <span class="nv">nebula-note-buf</span> <span class="ss">:beat-trg-bus</span> <span class="p">(</span><span class="ss">:beat</span> <span class="nv">time/beat-16th</span><span class="p">)</span> <span class="ss">:beat-bus</span> <span class="p">(</span><span class="ss">:count</span> <span class="nv">time/beat-16th</span><span class="p">)))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">pattern!</span> <span class="nv">nebula-note-buf</span> <span class="p">(</span><span class="nf">degrees</span> <span class="p">[</span><span class="mi">1</span> <span class="mi">3</span> <span class="mi">7</span><span class="p">]</span> <span class="ss">:major</span> <span class="ss">:A2</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<h4>GLSL + Shadertone:  <a href="https://github.com/overtone/shadertone">https://github.com/overtone/shadertone</a></h4>

<p>Shaders generate imagery directly on your Graphics Processing Unit rather than going through your CPU. Through a language called GLSL (which is C like) we can express very simple functions which get called on every single pixel generating complex visuals. Here is a simple extract from The Stars that generates all the background small dots:</p>

<p><img src="/images/glsl-dots.png" alt="" /></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='glsl'><span class='line'><span class="k">void</span> <span class="n">main</span><span class="p">(</span><span class="k">void</span><span class="p">){</span>
</span><span class='line'>  <span class="k">vec2</span> <span class="n">current_pixel_position</span> <span class="o">=</span> <span class="n">mod</span><span class="p">(</span><span class="n">gl_FragCoord</span><span class="p">.</span><span class="n">xy</span><span class="p">,</span> <span class="k">vec2</span><span class="p">(</span><span class="mf">5.0</span><span class="p">))</span> <span class="o">-</span> <span class="k">vec2</span><span class="p">(</span><span class="mf">0.0</span><span class="p">);</span>
</span><span class='line'>  <span class="k">float</span> <span class="n">distance_squared</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">current_pixel_position</span><span class="p">,</span> <span class="n">current_pixel_position</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">vec4</span> <span class="n">black</span> <span class="o">=</span> <span class="k">vec4</span><span class="p">(</span><span class="mf">.0</span><span class="p">,</span> <span class="mf">.0</span><span class="p">,</span> <span class="mf">.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">);</span>
</span><span class='line'>  <span class="k">vec4</span> <span class="n">white</span> <span class="o">=</span> <span class="k">vec4</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">//Test the current pixel position and if it should be a circle shade it.</span>
</span><span class='line'>  <span class="k">vec4</span> <span class="n">circles</span> <span class="o">=</span> <span class="p">(</span><span class="n">distance_squared</span> <span class="o">&lt;</span> <span class="mf">0.6</span><span class="p">)</span> <span class="o">?</span> <span class="n">white</span> <span class="o">:</span> <span class="n">black</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">gl_FragColor</span> <span class="o">=</span> <span class="n">circles</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>For more examples of whats possible with Shaders checkout <a href="https://www.shadertoy.com">Shader Toy</a></p>

<p>Shadertone is the Clojure library that provides a convenient way of running shaders from Clojure and for feeding in data about our synths. It provides access in your Shader to:</p>

<ul>
<li>Overtone&rsquo;s Volume (<code>iOvertoneVolume</code>)</li>
<li>The frequency spectrum &amp; audio waveform data (Passed as a 2D texture <code>:textures [:overtone-audio]</code>)</li>
</ul>


<p>To synchronize the graphics with the music I created a special Overtone synth which does not generate any sound, it instead feeds information in realtime to my shader.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">use</span> <span class="ss">&#39;overtone.live</span><span class="p">)</span>
</span><span class='line'><span class="p">(</span><span class="nf">require</span> <span class="o">&#39;</span><span class="p">[</span><span class="nv">shadertone.core</span> <span class="ss">:as</span> <span class="nv">t</span><span class="p">])</span>
</span><span class='line'>
</span><span class='line'><span class="c1">;;A synth that exposes through taps all the lovely timing information.</span>
</span><span class='line'><span class="p">(</span><span class="nf">defsynth</span> <span class="nv">buffer-&gt;tap</span> <span class="p">[</span><span class="nv">beat-buf</span> <span class="mi">0</span> <span class="nv">beat-bus</span> <span class="mi">0</span> <span class="nv">beat-size</span> <span class="mi">16</span> <span class="nv">measure</span> <span class="mi">6</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">cnt</span> <span class="p">(</span><span class="nf">in</span><span class="ss">:kr</span> <span class="nv">beat-bus</span><span class="p">)</span>
</span><span class='line'>        <span class="nv">beat</span> <span class="p">(</span><span class="nf">buf-rd</span><span class="ss">:kr</span> <span class="mi">1</span> <span class="nv">beat-buf</span> <span class="nv">cnt</span><span class="p">)</span>
</span><span class='line'>        <span class="nv">_</span>  <span class="p">(</span><span class="nf">tap</span> <span class="s">&quot;beat&quot;</span>          <span class="mi">60</span> <span class="p">(</span><span class="nf">a2k</span> <span class="nv">beat</span><span class="p">))</span>
</span><span class='line'>        <span class="nv">_</span>  <span class="p">(</span><span class="nf">tap</span> <span class="s">&quot;beat-count&quot;</span>    <span class="mi">60</span> <span class="p">(</span><span class="nf">a2k</span> <span class="p">(</span><span class="nf">mod</span> <span class="nv">cnt</span> <span class="nv">beat-size</span><span class="p">)))</span>
</span><span class='line'>        <span class="nv">_</span>  <span class="p">(</span><span class="nf">tap</span> <span class="s">&quot;measure-count&quot;</span> <span class="mi">60</span> <span class="p">(</span><span class="nf">a2k</span> <span class="p">(</span><span class="nb">/ </span><span class="p">(</span><span class="nf">mod</span> <span class="nv">cnt</span> <span class="p">(</span><span class="nb">* </span><span class="nv">measure</span> <span class="nv">beat-size</span><span class="p">))</span> <span class="nv">measure</span><span class="p">)))])</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">out</span> <span class="mi">0</span> <span class="mi">0</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="c1">;;; Used to store our drum beat, 1 for a hit 0 and for a miss</span>
</span><span class='line'><span class="p">(</span><span class="kd">defonce </span><span class="nv">drum-sequence-buffer</span> <span class="p">(</span><span class="nf">buffer</span> <span class="mi">256</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">beats</span> <span class="p">(</span><span class="nf">buffer-&gt;tap</span> <span class="nv">drum-sequence-buffer</span> <span class="p">(</span><span class="ss">:count</span> <span class="nv">timing/main-beat</span><span class="p">)))</span>
</span><span class='line'>
</span><span class='line'><span class="c1">;;Open a OpenGL window running our shader</span>
</span><span class='line'><span class="p">(</span><span class="nf">t/start-fullscreen</span> <span class="s">&quot;resources/shaders/electric.glsl&quot;</span>
</span><span class='line'>                    <span class="ss">:user-data</span> <span class="p">{</span>
</span><span class='line'>                    <span class="s">&quot;iBeat&quot;</span>         <span class="p">(</span><span class="nf">atom</span> <span class="p">{</span><span class="ss">:synth</span> <span class="nv">beats</span> <span class="ss">:tap</span> <span class="s">&quot;beat&quot;</span><span class="p">})</span>
</span><span class='line'>                    <span class="s">&quot;iBeatCount&quot;</span>    <span class="p">(</span><span class="nf">atom</span> <span class="p">{</span><span class="ss">:synth</span> <span class="nv">beats</span> <span class="ss">:tap</span> <span class="s">&quot;beat-count&quot;</span><span class="p">})</span>
</span><span class='line'>                    <span class="s">&quot;iMeasureCount&quot;</span> <span class="p">(</span><span class="nf">atom</span> <span class="p">{</span><span class="ss">:synth</span> <span class="nv">beats</span> <span class="ss">:tap</span> <span class="s">&quot;measure-count&quot;</span><span class="p">})})</span>
</span></code></pre></td></tr></table></div></figure>


<p>Inside our shader code:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='glsl'><span class='line'><span class="k">uniform</span> <span class="k">float</span> <span class="n">iBeat</span><span class="p">;</span>
</span><span class='line'><span class="k">uniform</span> <span class="k">float</span> <span class="n">iBeatCount</span><span class="p">;</span>
</span><span class='line'><span class="k">uniform</span> <span class="k">float</span> <span class="n">iMeasureCount</span><span class="p">;</span>
</span><span class='line'><span class="p">...</span>
</span></code></pre></td></tr></table></div></figure>


<p>The other main way of controlling a shader from Clojure is using <code>atoms</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">require</span> <span class="o">&#39;</span><span class="p">[</span><span class="nv">shadertone.core</span> <span class="ss">:as</span> <span class="nv">t</span><span class="p">])</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defonce </span><span class="nv">cellular-growth</span> <span class="p">(</span><span class="nf">atom</span> <span class="mf">0.0</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">t/start-fullscreen</span> <span class="s">&quot;resources/shaders/electric.glsl&quot;</span> <span class="ss">:user-data</span> <span class="p">{</span><span class="s">&quot;iCellularGrowth&quot;</span> <span class="nv">cellular-growth</span><span class="p">})</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">swap!</span> <span class="nv">cellular-growth</span> <span class="nb">+ </span><span class="mf">0.01</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<h4>Hardware: Monome: <a href="http://monome.org">http://monome.org</a></h4>

<p>Something you don&rsquo;t see in the video is that I&rsquo;m using a 8x16 <a href="http://monome.org">Monome</a>. For this performance its primary function was a visual aid to show the beat/measure information.</p>

<p><img src="/images/monome.jpg" alt="Monome" /></p>

<p>The hardware is driven by Clojure communicating with the Monome through a serial port: <a href="https://github.com/josephwilk/monome-serial/tree/protocols">https://github.com/josephwilk/monome-serial/tree/protocols</a></p>

<h1>Live Coding</h1>

<p>Live coding music and graphics combines skills in sound engineering, 3d graphics, geometry, physics, musical theory, composition, improvisation &amp; hardware to name a few.</p>

<p>It is difficult, and requires a lot of work and practice.</p>

<p>But of all the code I&rsquo;ve written over the years this is one of the things I&rsquo;m most proud of. And i&rsquo;m only at the beginning of discovering what&rsquo;s possible.</p>
</div>




    </article>


    <article>

  <header>

      <h1 class="entry-title"><a href="/clojure/creative_machines.html">Creative Machines</a></h1>


      <p class="meta">












<time datetime="2014-02-23T13:23:00+00:00" pubdate data-updated="true">Feb 23<span>rd</span>, 2014</time>

      </p>

  </header>


  <div class="entry-content"><p>When Alan Turing asked if a machine can be intelligent one aspect of this question focused on &ldquo;could machines be creative&rdquo;?</p>

<p>Ada Lovelace seemed convinced that originality was not a feat a computer was capable of:</p>

<blockquote><p>it can do whatever we know how to order it to perform,
it has no pretensions whatever to originate anything</p></blockquote>

<p>Before we outrightly dismiss the idea of creative machines do we even understand what creativity is?</p>

<p>Join me on a journey examining these questions while also meeting a new generation of artists born through code. Looking into their hearts and brains examining different algorithms/techniques and there effectiveness at exhibiting creativity.</p>

<p><strong>Decide for yourself, can machines be creative?</strong></p>

<p>My Strangeloop talk: Creative Machines &ndash; <a href="http://www.infoq.com/presentations/ai-machine-creativity">http://www.infoq.com/presentations/ai-machine-creativity</a></p>

<p>Slides: <script async class="speakerdeck-embed" data-id="9b2acfa020760131db422ebaf23009b5" data-ratio="1.33333333333333" src="//speakerdeck.com/assets/embed.js"></script></p>

<p>Full source code: <a href="https://github.com/josephwilk/musical-creativity">https://github.com/josephwilk/musical-creativity</a></p>

<h3>Continuing the Journey</h3>

<p>In order to continue my research into creativity and music I&rsquo;ve started the project <a href="http://www.repl-electric.com">Repl Electric</a>.
A space for humans and machines to learn and create music together.</p>

<h2>Further Reading</h2>

<ul>
<li>The Creative Mind: Myths and Mechanisms <br/> <a href="http://www.amazon.com/The-Creative-Mind-Myths-Mechanisms/dp/0415314534">http://www.amazon.com/The-Creative-Mind-Myths-Mechanisms/dp/0415314534</a></li>
<li>Explaining Creativity: The Science of Human Innovation <br/> <a href="http://www.amazon.com/gp/product/0199737576">http://www.amazon.com/gp/product/0199737576</a></li>
<li>Artificial Intelligence and Literary Creativity: Inside the Mind of Brutus, A Storytelling Machine <br/> <a href="http://www.amazon.com/Artificial-Intelligence-Literary-Creativity-Storytelling/dp/0805819878">http://www.amazon.com/Artificial-Intelligence-Literary-Creativity-Storytelling/dp/0805819878</a>)</li>
<li>Computer Models of Musical Creativity <br/> <a href="http://www.amazon.com/Computer-Models-Musical-Creativity-David/dp/0262033380">http://www.amazon.com/Computer-Models-Musical-Creativity-David/dp/0262033380</a></li>
<li>Virtual Music: Computer Synthesis of Musical Style <br/> <a href="http://www.amazon.com/Virtual-Music-Computer-Synthesis-Musical/dp/0262532611/">http://www.amazon.com/Virtual-Music-Computer-Synthesis-Musical/dp/0262532611/</a></li>
</ul>

</div>




    </article>


    <article>

  <header>

      <h1 class="entry-title"><a href="/clojure/sounds-of-the-human-brain.html">Sounds of the Human Brain</a></h1>


      <p class="meta">












<time datetime="2013-12-02T13:23:00+00:00" pubdate data-updated="true">Dec 2<span>nd</span>, 2013</time>

      </p>

  </header>


  <div class="entry-content"><p>What does your brain sound like? Does it sound like &ldquo;Rise of the Valkyrie&rdquo; or more like &ldquo;Hit me baby one more time&rdquo;?</p>

<h2>Step 1: Acquire a human brain (alive)</h2>

<p><img src="/images/brain.png" width="200px"></p>

<p>We are interested in capturing the brain waves. Specifically the:</p>

<ul>
<li>Delta waves: Deepest stages of sleep.</li>
<li>Beta waves:  Normal waking consciousness.</li>
<li>Alpha waves: Relaxation and meditation (creativity).</li>
<li>Theta waves: REM sleep (dreams).</li>
<li>Gamma waves: Hyper-alertness, perception, and integration of sensory input.</li>
</ul>


<h2>Step 2: EEG machine</h2>

<p>I am using a EEG machine brought from <a href="http://www.neurosky.com">Neurosky</a> which is rated as Research grade (whatever that means).
This measures voltage fluctuations resulting from ionic current flows within the neurons of the brain. While EEG machines are not the most accurate they are now reasonably cheap.</p>

<h2>Step 3: EEG &ndash;> Overtone</h2>

<p>In order to generate music I want to import the EEG brainwave data into <a href="http://overtone.github.io">Overtone</a>.</p>

<p>We interact with the EEG machine over a serial port. The most mature library for this interface is in Python so there is a little jiggery pokery to get the data into Overtone.</p>

<p><img src="/images/brain-diagram.png"></p>

<h4>The Brainwave Poller</h4>

<p>We use <a href="https://github.com/akloster/python-mindwave">https://github.com/akloster/python-mindwave</a> to interface with the EEG machines data.</p>

<p>Writing all the data out to a <a href="http://www.gnu.org/software/libc/manual/html_node/FIFO-Special-Files.html">FIFO file</a> file as json.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">re</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">time</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">json</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">unicodedata</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="nn">gevent</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">gevent</span> <span class="kn">import</span> <span class="n">monkey</span>
</span><span class='line'>
</span><span class='line'><span class="kn">from</span> <span class="nn">pymindwave</span> <span class="kn">import</span> <span class="n">headset</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">pymindwave.pyeeg</span> <span class="kn">import</span> <span class="n">bin_power</span>
</span><span class='line'>
</span><span class='line'><span class="n">monkey</span><span class="o">.</span><span class="n">patch_all</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'><span class="c"># connect to the headset</span>
</span><span class='line'><span class="n">hs</span> <span class="o">=</span> <span class="bp">None</span>
</span><span class='line'><span class="n">hs</span> <span class="o">=</span> <span class="n">headset</span><span class="o">.</span><span class="n">Headset</span><span class="p">(</span><span class="s">&#39;/dev/tty.MindWave&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">hs</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span>
</span><span class='line'><span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'><span class="k">print</span> <span class="s">&#39;connecting to headset...&#39;</span>
</span><span class='line'><span class="n">hs</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
</span><span class='line'><span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'><span class="k">while</span> <span class="n">hs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;state&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="s">&#39;connected&#39;</span><span class="p">:</span>
</span><span class='line'>    <span class="k">print</span> <span class="n">hs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;state&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">hs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;state&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;standby&#39;</span><span class="p">:</span>
</span><span class='line'>        <span class="n">hs</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
</span><span class='line'>        <span class="k">print</span> <span class="s">&#39;retrying connecting to headset&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">raw_to_spectrum</span><span class="p">(</span><span class="n">rawdata</span><span class="p">):</span>
</span><span class='line'>    <span class="n">flen</span> <span class="o">=</span> <span class="mi">50</span>
</span><span class='line'>    <span class="n">spectrum</span><span class="p">,</span> <span class="n">relative_spectrum</span> <span class="o">=</span> <span class="n">bin_power</span><span class="p">(</span><span class="n">rawdata</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="n">flen</span><span class="p">),</span> <span class="mi">512</span><span class="p">)</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">spectrum</span>
</span><span class='line'>
</span><span class='line'><span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
</span><span class='line'>    <span class="n">t</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span class='line'>    <span class="n">waves_vector</span> <span class="o">=</span> <span class="n">hs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;waves_vector&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">meditation</span> <span class="o">=</span> <span class="n">hs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;meditation&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">attention</span> <span class="o">=</span> <span class="n">hs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;attention&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">spectrum</span> <span class="o">=</span> <span class="n">raw_to_spectrum</span><span class="p">(</span><span class="n">hs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;rawdata&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">&quot;/tmp/brain-data&quot;</span><span class="p">,</span><span class="s">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
</span><span class='line'>        <span class="n">s</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">t</span><span class="p">,</span>
</span><span class='line'>             <span class="s">&#39;meditation&#39;</span><span class="p">:</span> <span class="n">meditation</span><span class="p">,</span>
</span><span class='line'>             <span class="s">&#39;attention&#39;</span><span class="p">:</span> <span class="n">attention</span><span class="p">,</span>
</span><span class='line'>             <span class="s">&#39;raw_spectrum&#39;</span><span class="p">:</span> <span class="n">spectrum</span><span class="p">,</span>
</span><span class='line'>             <span class="s">&#39;delta_waves&#39;</span><span class="p">:</span> <span class="n">waves_vector</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
</span><span class='line'>             <span class="s">&#39;theta_waves&#39;</span><span class="p">:</span> <span class="n">waves_vector</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
</span><span class='line'>             <span class="s">&#39;alpha_waves&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">waves_vector</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">waves_vector</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
</span><span class='line'>             <span class="s">&#39;low_alpha_waves&#39;</span><span class="p">:</span> <span class="n">waves_vector</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
</span><span class='line'>             <span class="s">&#39;high_alpha_waves&#39;</span><span class="p">:</span> <span class="n">waves_vector</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
</span><span class='line'>             <span class="s">&#39;beta_waves&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">waves_vector</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">+</span><span class="n">waves_vector</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
</span><span class='line'>             <span class="s">&#39;low_beta_waves&#39;</span><span class="p">:</span> <span class="n">waves_vector</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
</span><span class='line'>             <span class="s">&#39;high_beta_waves&#39;</span><span class="p">:</span> <span class="n">waves_vector</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
</span><span class='line'>             <span class="s">&#39;gamma_waves&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">waves_vector</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">+</span><span class="n">waves_vector</span><span class="p">[</span><span class="mi">7</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
</span><span class='line'>             <span class="s">&#39;low_gamma_waves&#39;</span><span class="p">:</span> <span class="n">waves_vector</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span>
</span><span class='line'>             <span class="s">&#39;mid_gamma_waves&#39;</span><span class="p">:</span> <span class="n">waves_vector</span><span class="p">[</span><span class="mi">7</span><span class="p">]}</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">s</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</span><span class='line'>        <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</span><span class='line'>    <span class="n">gevent</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.4</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Reading from the FIFO file is simple in Clojure.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">while</span> <span class="nv">true</span>
</span><span class='line'>  <span class="p">(</span><span class="nb">with-open </span><span class="p">[</span><span class="nv">reader</span> <span class="p">(</span><span class="nf">clojure.java.io/reader</span> <span class="s">&quot;/tmp/brain-data&quot;</span><span class="p">)]</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">brainwave-&gt;music</span> <span class="p">(</span><span class="nf">json/decode</span> <span class="p">(</span><span class="nb">first </span><span class="p">(</span><span class="nb">line-seq </span><span class="nv">reader</span><span class="p">))</span> <span class="nv">true</span><span class="p">))))</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Step 3: Sonification</h2>

<p>Sonification is the process of taking data and turning it into sound. Here is an example of the data we are now receiving:</p>

<p>A single JSON brainwave packet:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'> <span class="p">{</span><span class="s">&quot;gamma_waves&quot;</span><span class="err">:</span> <span class="mi">95408</span>,
</span><span class='line'>  <span class="s">&quot;high_beta_waves&quot;</span><span class="err">:</span> <span class="mi">205681</span>,
</span><span class='line'>  <span class="s">&quot;beta_waves&quot;</span><span class="err">:</span> <span class="mi">293928</span>,
</span><span class='line'>  <span class="s">&quot;low_beta_waves&quot;</span><span class="err">:</span> <span class="mi">382176</span>,
</span><span class='line'>  <span class="s">&quot;mid_gamma_waves&quot;</span><span class="err">:</span> <span class="mi">84528</span>,
</span><span class='line'>  <span class="s">&quot;low_alpha_waves&quot;</span><span class="err">:</span> <span class="mi">172417</span>,
</span><span class='line'>  <span class="s">&quot;delta_waves&quot;</span><span class="err">:</span> <span class="mi">117933</span>,
</span><span class='line'>  <span class="s">&quot;low_gamma_waves&quot;</span><span class="err">:</span> <span class="mi">106288</span>,
</span><span class='line'>  <span class="s">&quot;alpha_waves&quot;</span><span class="err">:</span> <span class="mi">112605</span>,
</span><span class='line'>  <span class="s">&quot;theta_waves&quot;</span><span class="err">:</span> <span class="mi">635628</span>,
</span><span class='line'>  <span class="s">&quot;high_alpha_waves&quot;</span><span class="err">:</span> <span class="mi">52793</span>,
</span><span class='line'>  <span class="s">&quot;attention&quot;</span><span class="err">:</span> <span class="mi">0</span>,
</span><span class='line'>  <span class="s">&quot;meditation&quot;</span><span class="err">:</span> <span class="mi">0</span>,
</span><span class='line'>  <span class="s">&quot;timestamp&quot;</span><span class="err">:</span> <span class="mf">1.375811275696894</span><span class="nv">E9</span><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>We will focus on the beta-waves for simplicity. Beta-waves fall between 16.5–20Hz.</p>

<p><img alt="EEG beta waves" src="/images/eeg_beta.png"></p>

<p>Beta waves related to:</p>

<ul>
<li>Alertness</li>
<li>Logic</li>
<li>Critical reasoning</li>
</ul>


<p> We need to map a signal within 16.5-20Hz into the musical pitches of a sampled piano (21-108 pitches).</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">require</span> <span class="o">&#39;</span><span class="p">[</span><span class="nv">clojure.math.numeric-tower</span> <span class="ss">:as</span> <span class="nv">math</span><span class="p">])</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">linear-map</span> <span class="p">[</span><span class="nv">x0</span> <span class="nv">x1</span> <span class="nv">y0</span> <span class="nv">y1</span> <span class="nv">x</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">dydx</span> <span class="p">(</span><span class="nb">/ </span><span class="p">(</span><span class="nb">- </span><span class="nv">y1</span> <span class="nv">y0</span><span class="p">)</span> <span class="p">(</span><span class="nb">- </span><span class="nv">x1</span> <span class="nv">x0</span><span class="p">))</span>
</span><span class='line'>        <span class="nv">dx</span> <span class="p">(</span><span class="nb">- </span><span class="nv">x</span> <span class="nv">x0</span><span class="p">)]</span>
</span><span class='line'>    <span class="p">(</span><span class="nb">+ </span><span class="nv">y0</span> <span class="p">(</span><span class="nb">* </span><span class="nv">dydx</span> <span class="nv">dx</span><span class="p">))))</span>
</span><span class='line'>
</span><span class='line'><span class="c1">;; Piano range: 0..87</span>
</span><span class='line'><span class="c1">;; Beta wave range: 16500..20000</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">beta-wave-&gt;pitch</span> <span class="p">[</span><span class="nv">signal</span><span class="p">]</span> <span class="p">(</span><span class="nb">-&gt; </span><span class="p">(</span><span class="nf">linear-map</span> <span class="mi">16500</span> <span class="mi">20000</span> <span class="mi">21</span> <span class="mi">108</span> <span class="nv">signal</span><span class="p">)</span> <span class="nb">float </span><span class="nv">math/round</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">beta-wave-&gt;pitch</span> <span class="mi">16500</span><span class="p">)</span> <span class="c1">;-&gt; 21</span>
</span><span class='line'><span class="p">(</span><span class="nf">beta-wave-&gt;pitch</span> <span class="mi">20000</span><span class="p">)</span> <span class="c1">;-&gt; 108</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now we extract the beta-waves from the brainwave data and play them. We play them live as they arrive rather than worrying about scheduling notes:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">use</span> <span class="ss">&#39;overtone.live</span><span class="p">)</span>
</span><span class='line'><span class="p">(</span><span class="nf">use</span> <span class="ss">&#39;overtone.inst.sampled-piano</span><span class="p">)</span>
</span><span class='line'><span class="p">(</span><span class="nf">require</span> <span class="o">&#39;</span><span class="p">[</span><span class="nv">cheshire.core</span> <span class="ss">:as</span> <span class="nv">json</span><span class="p">])</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">while</span> <span class="nv">true</span>
</span><span class='line'>  <span class="p">(</span><span class="nb">with-open </span><span class="p">[</span><span class="nv">reader</span> <span class="p">(</span><span class="nf">clojure.java.io/reader</span> <span class="s">&quot;/tmp/brain-data&quot;</span><span class="p">)]</span>
</span><span class='line'>    <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">beta-wave</span> <span class="p">(</span><span class="nb">-&gt; </span><span class="p">(</span><span class="nb">first </span><span class="p">(</span><span class="nb">line-seq </span><span class="nv">reader</span><span class="p">))</span> <span class="p">(</span><span class="nf">json/decode</span> <span class="nv">true</span><span class="p">)</span> <span class="ss">:beta_waves</span><span class="p">)]</span>
</span><span class='line'>      <span class="p">(</span><span class="nb">println </span><span class="nv">beta-wave</span><span class="p">)</span>
</span><span class='line'>      <span class="p">(</span><span class="nf">sampled-piano</span> <span class="ss">:note</span> <span class="p">(</span><span class="nf">beta-wave-&gt;pitch</span> <span class="nv">beta-wave</span><span class="p">)</span> <span class="ss">:sustain</span> <span class="mf">0.2</span><span class="p">))))</span>
</span></code></pre></td></tr></table></div></figure>


<h1>Would you like to hear my brain?</h1>

<p>The results, please listen to my brain.</p>

<div><iframe width="100%" height="166" scrolling="no" frameborder="no" src="https://w.soundcloud.com/player/?url=http%3A%2F%2Fapi.soundcloud.com%2Ftracks%2F108320470&amp;color=ff6600&amp;auto_play=false&amp;show_artwork=false"></iframe></div>


<p>Not really music is it? With beta-waves we get a serious of high to low transitions. While we can control at what pitch the transitions occur by performing activities that shape our brain waves the transitions don&rsquo;t provide the order or structure we need to recognize this as music.</p>

<h2>Brain controlled Dubstep</h2>

<p>The only logical path left is to try and control Dubstep with our brain. Rather than generative music we can use our brain waves to control the tempo and volume of existing synthesized music.</p>

<p>Here is a Dubstep synth taken from Overtone:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">use</span> <span class="ss">&#39;overtone.live</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">defsynth</span> <span class="nv">dubstep</span> <span class="p">[</span><span class="nv">bpm</span> <span class="mi">120</span> <span class="nv">wobble</span> <span class="mi">1</span> <span class="nv">note</span> <span class="mi">50</span> <span class="nv">snare-vol</span> <span class="mi">1</span> <span class="nv">kick-vol</span> <span class="mi">1</span> <span class="nv">volume</span> <span class="mi">1</span> <span class="nv">out-bus</span> <span class="mi">0</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">trig</span> <span class="p">(</span><span class="nf">impulse</span><span class="ss">:kr</span> <span class="p">(</span><span class="nb">/ </span><span class="nv">bpm</span> <span class="mi">120</span><span class="p">))</span>
</span><span class='line'>        <span class="nv">freq</span> <span class="p">(</span><span class="nf">midicps</span> <span class="nv">note</span><span class="p">)</span>
</span><span class='line'>        <span class="nv">swr</span> <span class="p">(</span><span class="nf">demand</span> <span class="nv">trig</span> <span class="mi">0</span> <span class="p">(</span><span class="nf">dseq</span> <span class="p">[</span><span class="nv">wobble</span><span class="p">]</span> <span class="nv">INF</span><span class="p">))</span>
</span><span class='line'>        <span class="nv">sweep</span> <span class="p">(</span><span class="nf">lin-exp</span> <span class="p">(</span><span class="nf">lf-tri</span> <span class="nv">swr</span><span class="p">)</span> <span class="mi">-1</span> <span class="mi">1</span> <span class="mi">40</span> <span class="mi">3000</span><span class="p">)</span>
</span><span class='line'>        <span class="nv">wob</span> <span class="p">(</span><span class="nb">apply + </span><span class="p">(</span><span class="nf">saw</span> <span class="p">(</span><span class="nb">* </span><span class="nv">freq</span> <span class="p">[</span><span class="mf">0.99</span> <span class="mf">1.01</span><span class="p">])))</span>
</span><span class='line'>        <span class="nv">wob</span> <span class="p">(</span><span class="nf">lpf</span> <span class="nv">wob</span> <span class="nv">sweep</span><span class="p">)</span>
</span><span class='line'>        <span class="nv">wob</span> <span class="p">(</span><span class="nb">* </span><span class="mf">0.8</span> <span class="p">(</span><span class="nf">normalizer</span> <span class="nv">wob</span><span class="p">))</span>
</span><span class='line'>        <span class="nv">wob</span> <span class="p">(</span><span class="nb">+ </span><span class="nv">wob</span> <span class="p">(</span><span class="nf">bpf</span> <span class="nv">wob</span> <span class="mi">1500</span> <span class="mi">2</span><span class="p">))</span>
</span><span class='line'>        <span class="nv">wob</span> <span class="p">(</span><span class="nb">+ </span><span class="nv">wob</span> <span class="p">(</span><span class="nb">* </span><span class="mf">0.2</span> <span class="p">(</span><span class="nf">g-verb</span> <span class="nv">wob</span> <span class="mi">9</span> <span class="mf">0.7</span> <span class="mf">0.7</span><span class="p">)))</span>
</span><span class='line'>
</span><span class='line'>        <span class="nv">kickenv</span> <span class="p">(</span><span class="nf">decay</span> <span class="p">(</span><span class="nf">t2a</span> <span class="p">(</span><span class="nf">demand</span> <span class="p">(</span><span class="nf">impulse</span><span class="ss">:kr</span> <span class="p">(</span><span class="nb">/ </span><span class="nv">bpm</span> <span class="mi">30</span><span class="p">))</span> <span class="mi">0</span> <span class="p">(</span><span class="nf">dseq</span> <span class="p">[</span><span class="mi">1</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">1</span> <span class="mi">0</span> <span class="mi">1</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">1</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span><span class="p">]</span> <span class="nv">INF</span><span class="p">)))</span> <span class="mf">0.7</span><span class="p">)</span>
</span><span class='line'>        <span class="nv">kick</span> <span class="p">(</span><span class="nb">* </span><span class="p">(</span><span class="nb">* </span><span class="nv">kickenv</span> <span class="mi">7</span><span class="p">)</span> <span class="p">(</span><span class="nf">sin-osc</span> <span class="p">(</span><span class="nb">+ </span><span class="mi">40</span> <span class="p">(</span><span class="nb">* </span><span class="nv">kickenv</span> <span class="nv">kickenv</span> <span class="nv">kickenv</span> <span class="mi">200</span><span class="p">))))</span>
</span><span class='line'>        <span class="nv">kick</span> <span class="p">(</span><span class="nf">clip2</span> <span class="nv">kick</span> <span class="mi">1</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="nv">snare</span> <span class="p">(</span><span class="nb">* </span><span class="mi">3</span> <span class="p">(</span><span class="nf">pink-noise</span><span class="p">)</span> <span class="p">(</span><span class="nb">apply + </span><span class="p">(</span><span class="nb">* </span><span class="p">(</span><span class="nf">decay</span> <span class="p">(</span><span class="nf">impulse</span> <span class="p">(</span><span class="nb">/ </span><span class="nv">bpm</span> <span class="mi">240</span><span class="p">)</span> <span class="mf">0.5</span><span class="p">)</span> <span class="p">[</span><span class="mf">0.4</span> <span class="mi">2</span><span class="p">])</span> <span class="p">[</span><span class="mi">1</span> <span class="mf">0.05</span><span class="p">])))</span>
</span><span class='line'>        <span class="nv">snare</span> <span class="p">(</span><span class="nb">+ </span><span class="nv">snare</span> <span class="p">(</span><span class="nf">bpf</span> <span class="p">(</span><span class="nb">* </span><span class="mi">4</span> <span class="nv">snare</span><span class="p">)</span> <span class="mi">2000</span><span class="p">))</span>
</span><span class='line'>        <span class="nv">snare</span> <span class="p">(</span><span class="nf">clip2</span> <span class="nv">snare</span> <span class="mi">1</span><span class="p">)]</span>
</span><span class='line'>
</span><span class='line'>       <span class="p">(</span><span class="nf">out</span> <span class="nv">out-bus</span> <span class="p">(</span><span class="nb">* </span><span class="nv">volume</span> <span class="p">(</span><span class="nf">clip2</span> <span class="p">(</span><span class="nb">+ </span><span class="nv">wob</span> <span class="p">(</span><span class="nb">* </span><span class="nv">kick-vol</span> <span class="nv">kick</span><span class="p">)</span> <span class="p">(</span><span class="nb">* </span><span class="nv">snare-vol</span> <span class="nv">snare</span><span class="p">))</span> <span class="mi">1</span><span class="p">)))))</span>
</span></code></pre></td></tr></table></div></figure>


<p></p>

<p>Once the synth is running we can send it control signals which will vary any of the properties defined in the arguments to the dubstep function:</p>

<ul>
<li>bpm</li>
<li>wobble</li>
<li>note</li>
<li>snare-vol</li>
<li>kick-vol</li>
<li>volume</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">d</span> <span class="p">(</span><span class="nf">dubstep</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">ctl</span> <span class="nv">d</span> <span class="ss">:snare-vol</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'><span class="p">(</span><span class="nf">ctl</span> <span class="nv">d</span> <span class="ss">:kick-vol</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'><span class="p">(</span><span class="nf">ctl</span> <span class="nv">d</span> <span class="ss">:wooble</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'><span class="p">(</span><span class="nf">ctl</span> <span class="nv">d</span> <span class="ss">:bpm</span> <span class="mi">20</span><span class="p">)</span>
</span><span class='line'><span class="p">(</span><span class="nf">ctl</span> <span class="nv">d</span> <span class="ss">:v</span> <span class="mf">0.2</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>We again have to linearise the beta wave signal to the range of volume 0.0-1.1 and to the bpm 0-400.</p>

<p>Now all thats left to do is connect it to our brain.</p>

<p>Here&rsquo;s what brain controlled Dubstep sounds like:</p>

<div><iframe width="100%" height="166" scrolling="no" frameborder="no" src="https://w.soundcloud.com/player/?url=https%3A//api.soundcloud.com/tracks/119776808&amp;color=ff6600&amp;auto_play=false&amp;show_artwork=false"></iframe></div>


<p>And for comparison what playing Go does to your brain activity (I turned the Dubstep down while playing, concentrating with that noise is hard):</p>

<div><iframe width="100%" height="166" scrolling="no" frameborder="no" src="https://w.soundcloud.com/player/?url=https%3A//api.soundcloud.com/tracks/122704897&amp;color=ff6600&amp;auto_play=false&amp;show_artwork=false"></iframe></div>


<h1>Discovery through sound</h1>

<p>Mapping brain waves into live music is a challenging task and while we can control music through an EEG machine that control is hard since we are using the brain to do many other things. What is interesting in the path of this experiment is not in fact the music generated but the use of sound to provide a way to hear the differences in datasets.</p>

<p>Hearing the difference between play Go or sleeping, between young people or old people.</p>

<p>Sound as a means of discovering patterns is a largely untapped source.</p>
</div>




    </article>

  <div class="pagination">

      <a class="prev" href="/page/2/">&larr; Older</a>

    <a href="/blog/archives">Blog Archives</a>

  </div>
</div>
<aside class="sidebar">

    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
  <li class="post">
    <a href="/art/emacs-as-a-musical-instrument.html">Emacs as a musical instrument</a>
  </li>


      <li class="post">
        <a href="/clojure/functions-explained-through-patterns.html">Functions Explained Through Patterns</a>
      </li>

      <li class="post">
        <a href="/art/audio-fingerprint-smudges.html">Audio Fingerprint Smudges</a>
      </li>

      <li class="post">
        <a href="/art/overtone-shader-visuals.html">Visuals with Overtone and Shadertone</a>
      </li>

      <li class="post">
        <a href="/art/emacs-animation.html">Animations with Emacs</a>
      </li>

      <li class="post">
        <a href="/clojure/clojure-and-kinesis-at-scale.html">Clojure and Kinesis at scale</a>
      </li>

      <li class="post">
        <a href="/clojure/overtone-driving-minecraft.html">Clojure and Overtone driving Minecraft</a>
      </li>

      <li class="post">
        <a href="/art/live-coding-repl-electric.html">Live Coding - Repl Electric</a>
      </li>

      <li class="post">
        <a href="/clojure/creative_machines.html">Creative Machines</a>
      </li>

      <li class="post">
        <a href="/clojure/sounds-of-the-human-brain.html">Sounds of the human brain</a>
      </li>

      <li class="post">
        <a href="/clojure/building-clojure-services-at-scale.html">Building Clojure services at scale</a>
      </li>

  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>

  <a href="https://github.com/josephwilk">@josephwilk</a> on GitHub

  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'josephwilk',
            count: 10,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>






</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2017 - Joseph Wilk -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>


<script type="text/javascript">
      var disqus_shortname = 'josephwilk';


        var disqus_script = 'count.js';

    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>








</body>
</html>
