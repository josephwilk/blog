
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Joseph Wilk</title>
  <meta name="author" content="Joseph Wilk">


  <meta name="description" content="Overtone is an open source audio environment which uses Clojure and SuperCollider (an environment and programming language for real time audio &hellip;">


  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">


  <link rel="canonical" href="http://blog.josephwilk.net/page/2/index.html">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Joseph Wilk" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<script src="http://disqus.com/forums/josephwilk/embed.js"></script>
<link href="http://fonts.googleapis.com/css?family=Bevan" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">


  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-3020740-2']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body    class="collapse-sidebar sidebar-footer" >
  <header role="banner"><hgroup>
  <img src="/images/joe_small2.png" style="position:relative;border-radius: 8px;margin-right: 5px;border-style: solid;border-width: 1px;border-color: #DDD;" height="60" alt="Joseph Wilk">
  <span style="display:inline-block">
    <h1><a href="/">Joseph Wilk</a></h1>
    <h2>Things with code, creativity and computation.</h2>
  </span>
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>

</ul>


<ul class="main-navigation">
 <li><a href="/">Home</a></li>
 <li><a href="/about">About</a></li>
 <li><a href="/speaking">Speaking</a></li>
 <li><a href="http://art.josephwilk.net">Art</a></li>
 <li><a href="/contact">Contact</a></li>
 <li><a href="/archives">Archives</a></li>
</ul>
</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">


            <article>

          <header>

              <h1 class="entry-title"><a href="/clojure/building-clojure-services-at-scale.html">Building Clojure Services at Scale</a></h1>


              <p class="meta">












        <time datetime="2013-09-13T11:00:00+01:00" pubdate data-updated="true">Sep 13<span>th</span>, 2013</time>

              </p>

          </header>


          <div class="entry-content"><p>At SoundCloud I&rsquo;ve been experimenting over the last year with how we build the services that power a number of heavily loaded areas across our site. All these services have been built in Clojure with bits of Java tacked on the sides. Here are some of my personal thoughts on how to build Clojure services:</p>

        <h2>Netflix or Twitter</h2>

        <p><img alt="choose your own adventure" src="/images/adventure.jpg"></p>

        <p>At some-point when you require a sufficient level of scaling you turn to the open source work of <a href="https://github.com/twitter">Twitter</a> with <a href="http://twitter.github.io/finagle">Finagle</a> or <a href="https://github.com/Netflix">Netflix</a> with <a href="https://github.com/Netflix/Hystrix">Hystrix</a>/<a href="https://github.com/Netflix/RxJava">RxJava</a>.
        Netflix libs are written in Java while Twitters are written in Scala. Both are easy to use from any JVM based language but the Finagle route will bring in an extra dependency on Scala. I&rsquo;ve heard little from people using interop between Clojure &amp; Scala and that extra Scala dependency makes me nervous. Further I like the simplicity of Netflix&rsquo;s libs and they have been putting a lot of effort into pushing support for many JVM based languages.</p>

        <p>Hence with Clojure, Netflix projects are my preference. (I should add we do use Finagle with Scala at SoundCloud as well).</p>

        <h2>Failure, Monitoring &amp; Composition Complexity</h2>

        <div style="display:inline-block;">
        <img align="left" style="margin-right:5px;" src="/images/failure.jpg" width="150px" height="150px">

        In a service reliant on other services, databases, caches any other external dependencies its a guarantee at some-point some of those will fail. When working with critical services we want to gracefully provide a degraded service.
        </div>




        <p></p>




        <div style="display:inline-block;">
        <img align="left" style="margin-right:5px;" src="/images/scary-eye.png" width="150px" height="150px">
        While we can think about degrading gracefully in the case of failure, ultimately we want to fix wants broken as soon as possible. An eye into the runtime system allows us to monitor exactly whats going on and take appropriate action.
        </div>




        <p></p>




        <div style="display:inline-block;">
        <img align="left" style="margin-right:5px;" src="/images/complexity.png" width="150px" height="150px">

        Your service needs to call other services. Dependent on those service results you might need to call other services which in turn might require calls to other services. Composing service calls is hard to get right without a tangle of complex code.
        </div>




        <p></p>


        <h3>Fault Tolerance</h3>

        <p>How should we build fault tolerance into our Clojure services?</p>

        <h4>Single thread pool</h4>

        <p>Consider you have this line within a service response:</p>

        <figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
        </pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">{</span><span class="ss">:body</span> <span class="err">@</span><span class="p">(</span><span class="nf">future</span> <span class="p">(</span><span class="nf">client/get</span> <span class="s">&quot;http://soundcloud.com/blah/wah&quot;</span><span class="p">))</span> <span class="ss">:status</span> <span class="mi">200</span><span class="p">}</span>
        </span></code></pre></td></tr></table></div></figure>


        <p>Now <code>http://soundcloud.com/blah/wah</code> goes down and those client requests start getting blocked on the request. In Clojure all <code>future</code> calls acquire a thread from the same thread pool. In our example the service is blocked up, is pilling new requests onto the blocked pool and we are in trouble.</p>

        <p>My first solution to this problem was to introduce circuit breakers (<a href="https://github.com/josephwilk/circuit-breaker">https://github.com/josephwilk/circuit-breaker</a>).
        I also stop using <code>@</code> to dereference futures and used <code>deref</code> <a href="http://clojuredocs.org/clojure_core/clojure.core/deref">http://clojuredocs.org/clojure_core/clojure.core/deref</a> which supports defaults and timeouts.</p>

        <figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
        <span class='line-number'>2</span>
        <span class='line-number'>3</span>
        <span class='line-number'>4</span>
        <span class='line-number'>5</span>
        <span class='line-number'>6</span>
        <span class='line-number'>7</span>
        <span class='line-number'>8</span>
        <span class='line-number'>9</span>
        <span class='line-number'>10</span>
        <span class='line-number'>11</span>
        </pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">defncircuitbreaker</span> <span class="ss">:blah-http</span> <span class="p">{</span><span class="ss">:timeout</span> <span class="mi">30</span> <span class="ss">:threshold</span> <span class="mi">2</span><span class="p">})</span>
        </span><span class='line'>
        </span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">future-timeout</span> <span class="mi">1000</span><span class="p">)</span>
        </span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">timeout-value</span> <span class="nv">nil</span><span class="p">)</span>
        </span><span class='line'>
        </span><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">http-get</span> <span class="p">[</span><span class="nv">url</span><span class="p">]</span>
        </span><span class='line'>  <span class="p">(</span><span class="nf">with-circuit-breaker</span> <span class="ss">:blah-http</span> <span class="p">{</span>
        </span><span class='line'>    <span class="ss">:connected</span> <span class="p">(</span><span class="k">fn </span><span class="p">[]</span> <span class="p">(</span><span class="nf">client/get</span> <span class="s">&quot;http://soundcloud.com/blah/wah&quot;</span><span class="p">))</span>
        </span><span class='line'>    <span class="ss">:tripped</span> <span class="p">(</span><span class="k">fn </span><span class="p">[]</span> <span class="nv">nil</span><span class="p">)}))</span>
        </span><span class='line'>
        </span><span class='line'><span class="p">{</span><span class="ss">:body</span> <span class="p">(</span><span class="nf">http-get</span> <span class="nv">http</span><span class="ss">://www.soundcloud.com/blah/wah</span><span class="p">)</span> <span class="ss">:status</span> <span class="mi">200</span><span class="p">}</span>
        </span></code></pre></td></tr></table></div></figure>


        <p>Problem solved, now even though the thread pool may become blocked we back off the following requests and avoid pilling more work onto the blocked thread pool.</p>

        <p>This worked pretty well, but then we decided we would to try and go even further in gracefully degrading.
        Why don&rsquo;t we serve from a cache on failure, slightly stale data is better than none.</p>

        <figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
        <span class='line-number'>2</span>
        <span class='line-number'>3</span>
        <span class='line-number'>4</span>
        </pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">http-get</span> <span class="p">[</span><span class="nv">url</span><span class="p">]</span>
        </span><span class='line'>  <span class="p">(</span><span class="nf">with-circuit-breaker</span> <span class="ss">:blah-http</span> <span class="p">{</span>
        </span><span class='line'>    <span class="ss">:connected</span> <span class="p">(</span><span class="k">fn </span><span class="p">[]</span> <span class="p">(</span><span class="nf">client/get</span> <span class="s">&quot;http://soundcloud.com/blah/wah&quot;</span><span class="p">))</span>
        </span><span class='line'>    <span class="ss">:tripped</span> <span class="p">(</span><span class="k">fn </span><span class="p">[]</span> <span class="p">(</span><span class="nf">memcache/get</span> <span class="nv">client</span> <span class="nv">url</span><span class="p">))}))</span>
        </span></code></pre></td></tr></table></div></figure>


        <p>Now consider <code>(client/get "http://soundcloud.com/blah/wah")</code> starts failing, the thread pool gets blocked up, the circuit trigger flips and <code>(memcache/get client url)</code> is now fighting to get threads from the blocked thread pool.</p>

        <p>Pants.</p>

        <h5>Scheduling over thread pools: Hystrix</h5>

        <p><a href="https://github.com/Netflix/Hystrix">Hystrix</a> is Netflix library which I think of as circuit breakers on steroids.</p>

        <p><img src ="/images/hystrix.png" height="400px" width="400px"/></p>

        <pre><code>Hystrix is a latency and fault tolerance library designed to isolate points of access to remote systems,
        services and 3rd party libraries, stop cascading failure and enable resilience in complex distributed systems
        where failure is inevitable.
        </code></pre>

        <p>Dave Ray (<a href="http://darevay.com">http://darevay.com</a>) has been doing lots of excellent work on producing <a href="https://github.com/Netflix/Hystrix/tree/master/hystrix-contrib/hystrix-clj">Clojure bindings for Hystrix</a>:</p>

        <p>Hystrix gives me 2 big wins:</p>

        <h5>1. Separation of thread pools</h5>

        <p>Hystrix creates a separate thread pool for each Clojure namespace, if one thread pool becomes blocked due to a failure, a circuit breaker can be triggered with a fallback that uses a different thread pool.</p>

        <p>This however does come with a cost:</p>

        <ol>
        <li> We have a performance hit due to moving to a scheduling based method for executing Hystrix commands.</li>
        <li> We cannot use Clojure&rsquo;s concurrency primitives (futures/promises/agents).</li>
        </ol>


        <p>Here is an example of our service rewritten with Hystrix:</p>

        <figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
        <span class='line-number'>2</span>
        <span class='line-number'>3</span>
        <span class='line-number'>4</span>
        <span class='line-number'>5</span>
        <span class='line-number'>6</span>
        <span class='line-number'>7</span>
        <span class='line-number'>8</span>
        <span class='line-number'>9</span>
        <span class='line-number'>10</span>
        <span class='line-number'>11</span>
        <span class='line-number'>12</span>
        <span class='line-number'>13</span>
        <span class='line-number'>14</span>
        <span class='line-number'>15</span>
        </pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">ns </span><span class="nv">example</span>
        </span><span class='line'>  <span class="p">(</span><span class="ss">:require</span> <span class="p">[[</span><span class="nv">com.netflix.hystrix.core</span> <span class="ss">:as</span> <span class="nv">hystrix</span><span class="p">]]))</span>
        </span><span class='line'>
        </span><span class='line'><span class="p">(</span><span class="nf">hystrix/defcommand</span> <span class="nv">http-get</span>
        </span><span class='line'>  <span class="p">{</span><span class="ss">:hystrix/fallback-fn</span> <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">url</span><span class="p">]</span> <span class="p">(</span><span class="nf">memcache-get</span> <span class="nv">url</span><span class="p">)}</span>
        </span><span class='line'>  <span class="p">[</span><span class="nv">url</span><span class="p">]</span>
        </span><span class='line'>  <span class="p">(</span><span class="nf">client/get</span> <span class="nv">url</span><span class="p">))</span>
        </span><span class='line'>
        </span><span class='line'><span class="p">(</span><span class="nf">hystrix/defcommand</span> <span class="nv">memcache-get</span>
        </span><span class='line'>  <span class="p">{</span><span class="ss">:hystrix/fallback-fn</span> <span class="p">(</span><span class="nb">constantly </span><span class="nv">nil</span><span class="p">)}</span>
        </span><span class='line'>  <span class="p">[</span><span class="nv">url</span><span class="p">]</span>
        </span><span class='line'>  <span class="p">(</span><span class="nf">memcache/get</span> <span class="nv">client</span> <span class="nv">key</span><span class="p">))</span>
        </span><span class='line'>
        </span><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">http-get</span> <span class="p">[</span><span class="nv">url</span><span class="p">]</span>
        </span><span class='line'>   <span class="p">{</span><span class="ss">:body</span> <span class="p">(</span><span class="nf">http/get</span> <span class="s">&quot;http://soundcloud.com/blah/wah&quot;</span><span class="p">)</span> <span class="ss">:status</span> <span class="mi">200</span><span class="p">})</span>
        </span></code></pre></td></tr></table></div></figure>


        <p>Beautiful, Just adding the <code>defcommand</code> brings us fault tolerance with no other changes to the shape of our code.</p>

        <p>See the Hystrix Clojure adapter for all the possible configuration: <a href="https://github.com/Netflix/Hystrix/tree/master/hystrix-contrib/hystrix-clj">https://github.com/Netflix/Hystrix/tree/master/hystrix-contrib/hystrix-clj</a></p>

        <h5>2.  Monitoring</h5>

        <p>Hystrix supports exposing metrics on all circuit breakers within a process. It exposes these calls through an event stream.</p>

        <p>How you expose that Hystrix event stream depends slightly on which web server you are using with your Clojure app.</p>

        <h4>Netty and Hystrix Event Streams (without servlets)</h4>

        <p><a href="https://github.com/josephwilk/hystrix-event-stream-clj">https://github.com/josephwilk/hystrix-event-stream-clj</a></p>

        <figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
        <span class='line-number'>2</span>
        <span class='line-number'>3</span>
        </pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="ss">:require</span> <span class="p">[</span><span class="nv">hystrix-event-stream-clj.core</span> <span class="nv">as</span> <span class="nv">hystrix-event</span><span class="p">])</span>
        </span><span class='line'>
        </span><span class='line'><span class="p">(</span><span class="nf">defroutes</span> <span class="nv">app</span> <span class="p">(</span><span class="nf">GET</span> <span class="s">&quot;/hystrix.stream&quot;</span> <span class="p">(</span><span class="nf">hystrix-event/stream</span><span class="p">))</span>
        </span></code></pre></td></tr></table></div></figure>


        <h4>Jetty and Hystrix Event Streams (with servlets)</h4>

        <p>If they are using Jetty you will need to change your app to add your main web app as a servlet. Then we can also add the Hystrix event stream servlet.</p>

        <figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
        <span class='line-number'>2</span>
        <span class='line-number'>3</span>
        <span class='line-number'>4</span>
        <span class='line-number'>5</span>
        <span class='line-number'>6</span>
        <span class='line-number'>7</span>
        <span class='line-number'>8</span>
        <span class='line-number'>9</span>
        <span class='line-number'>10</span>
        <span class='line-number'>11</span>
        <span class='line-number'>12</span>
        <span class='line-number'>13</span>
        <span class='line-number'>14</span>
        <span class='line-number'>15</span>
        <span class='line-number'>16</span>
        <span class='line-number'>17</span>
        <span class='line-number'>18</span>
        <span class='line-number'>19</span>
        <span class='line-number'>20</span>
        <span class='line-number'>21</span>
        <span class='line-number'>22</span>
        <span class='line-number'>23</span>
        <span class='line-number'>24</span>
        <span class='line-number'>25</span>
        <span class='line-number'>26</span>
        <span class='line-number'>27</span>
        <span class='line-number'>28</span>
        <span class='line-number'>29</span>
        <span class='line-number'>30</span>
        <span class='line-number'>31</span>
        <span class='line-number'>32</span>
        <span class='line-number'>33</span>
        <span class='line-number'>34</span>
        <span class='line-number'>35</span>
        <span class='line-number'>36</span>
        <span class='line-number'>37</span>
        <span class='line-number'>38</span>
        <span class='line-number'>39</span>
        </pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">ns </span><span class="nv">sc-clj-kit.hystrix.jetty</span>
        </span><span class='line'>  <span class="p">(</span><span class="ss">:import</span> <span class="p">[</span><span class="nv">com.netflix.hystrix.contrib.metrics.eventstream</span> <span class="nv">HystrixMetricsStreamServlet</span><span class="p">])</span>
        </span><span class='line'>  <span class="p">(</span><span class="ss">:import</span> <span class="p">[</span><span class="nv">org.eclipse.jetty.server</span> <span class="nv">Server</span><span class="p">])</span>
        </span><span class='line'>  <span class="p">(</span><span class="ss">:import</span> <span class="p">[</span><span class="nv">org.eclipse.jetty.servlet</span> <span class="nv">ServletContextHandler</span><span class="p">])</span>
        </span><span class='line'>  <span class="p">(</span><span class="ss">:import</span> <span class="p">[</span><span class="nv">org.eclipse.jetty.servlet</span> <span class="nv">ServletHolder</span><span class="p">])</span>
        </span><span class='line'>  <span class="p">(</span><span class="ss">:import</span> <span class="p">[</span><span class="nv">org.eclipse.jetty.server.bio</span> <span class="nv">SocketConnector</span><span class="p">])</span>
        </span><span class='line'>  <span class="p">(</span><span class="ss">:import</span> <span class="p">[</span><span class="nv">org.eclipse.jetty.server.ssl</span> <span class="nv">SslSocketConnector</span><span class="p">])</span>
        </span><span class='line'>
        </span><span class='line'>  <span class="p">(</span><span class="ss">:import</span> <span class="p">(</span><span class="nf">org.eclipse.jetty.server</span> <span class="nv">Server</span> <span class="nv">Request</span><span class="p">)</span>
        </span><span class='line'>           <span class="p">(</span><span class="nf">org.eclipse.jetty.server.handler</span> <span class="nv">AbstractHandler</span><span class="p">)</span>
        </span><span class='line'>           <span class="p">(</span><span class="nf">org.eclipse.jetty.server.nio</span> <span class="nv">SelectChannelConnector</span><span class="p">)</span>
        </span><span class='line'>           <span class="p">(</span><span class="nf">org.eclipse.jetty.server.ssl</span> <span class="nv">SslSelectChannelConnector</span><span class="p">)</span>
        </span><span class='line'>           <span class="p">(</span><span class="nf">org.eclipse.jetty.util.thread</span> <span class="nv">QueuedThreadPool</span><span class="p">)</span>
        </span><span class='line'>           <span class="p">(</span><span class="nf">org.eclipse.jetty.util.ssl</span> <span class="nv">SslContextFactory</span><span class="p">)</span>
        </span><span class='line'>           <span class="p">(</span><span class="nf">javax.servlet.http</span> <span class="nv">HttpServletRequest</span> <span class="nv">HttpServletResponse</span><span class="p">))</span>
        </span><span class='line'>  <span class="p">(</span><span class="ss">:require</span>
        </span><span class='line'>   <span class="p">[</span><span class="nv">compojure.core</span>          <span class="ss">:refer</span> <span class="ss">:all</span><span class="p">]</span>
        </span><span class='line'>   <span class="p">[</span><span class="nv">ring.adapter.jetty</span>      <span class="ss">:as</span> <span class="nv">jetty</span><span class="p">]</span>
        </span><span class='line'>   <span class="p">[</span><span class="nv">ring.util.servlet</span> <span class="ss">:as</span> <span class="nv">servlet</span><span class="p">]))</span>
        </span><span class='line'>
        </span><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">run-jetty-with-hystrix-stream</span> <span class="p">[</span><span class="nv">app</span> <span class="nv">options</span><span class="p">]</span>
        </span><span class='line'>  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="o">^</span><span class="nv">Server</span> <span class="nv">server</span> <span class="p">(</span><span class="o">#</span><span class="ss">&#39;jetty/create-server</span> <span class="p">(</span><span class="nb">dissoc </span><span class="nv">options</span> <span class="ss">:configurator</span><span class="p">))</span>
        </span><span class='line'>        <span class="o">^</span><span class="nv">QueuedThreadPool</span> <span class="nv">pool</span> <span class="p">(</span><span class="nf">QueuedThreadPool.</span> <span class="o">^</span><span class="nv">Integer</span> <span class="p">(</span><span class="nf">options</span> <span class="ss">:max-threads</span> <span class="mi">50</span><span class="p">))]</span>
        </span><span class='line'>    <span class="p">(</span><span class="nb">when </span><span class="p">(</span><span class="ss">:daemon?</span> <span class="nv">options</span> <span class="nv">false</span><span class="p">)</span> <span class="p">(</span><span class="nf">.setDaemon</span> <span class="nv">pool</span> <span class="nv">true</span><span class="p">))</span>
        </span><span class='line'>    <span class="p">(</span><span class="nb">doto </span><span class="nv">server</span> <span class="p">(</span><span class="nf">.setThreadPool</span> <span class="nv">pool</span><span class="p">))</span>
        </span><span class='line'>    <span class="p">(</span><span class="nb">when-let </span><span class="p">[</span><span class="nv">configurator</span> <span class="p">(</span><span class="ss">:configurator</span> <span class="nv">options</span><span class="p">)]</span>
        </span><span class='line'>      <span class="p">(</span><span class="nf">configurator</span> <span class="nv">server</span><span class="p">))</span>
        </span><span class='line'>    <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">hystrix-holder</span>  <span class="p">(</span><span class="nf">ServletHolder.</span> <span class="nv">HystrixMetricsStreamServlet</span><span class="p">)</span>
        </span><span class='line'>          <span class="nv">app-holder</span> <span class="p">(</span><span class="nf">ServletHolder.</span> <span class="p">(</span><span class="nf">servlet/servlet</span> <span class="nv">app</span><span class="p">))</span>
        </span><span class='line'>          <span class="nv">context</span> <span class="p">(</span><span class="nf">ServletContextHandler.</span> <span class="nv">server</span> <span class="s">&quot;/&quot;</span> <span class="nv">ServletContextHandler/SESSIONS</span><span class="p">)]</span>
        </span><span class='line'>      <span class="p">(</span><span class="nf">.addServlet</span> <span class="nv">context</span> <span class="nv">hystrix-holder</span> <span class="s">&quot;/hystrix.stream&quot;</span><span class="p">)</span>
        </span><span class='line'>      <span class="p">(</span><span class="nf">.addServlet</span> <span class="nv">context</span> <span class="nv">app-holder</span> <span class="s">&quot;/&quot;</span><span class="p">))</span>
        </span><span class='line'>    <span class="p">(</span><span class="nf">.start</span> <span class="nv">server</span><span class="p">)</span>
        </span><span class='line'>    <span class="p">(</span><span class="nb">when </span><span class="p">(</span><span class="ss">:join?</span> <span class="nv">options</span> <span class="nv">true</span><span class="p">)</span> <span class="p">(</span><span class="nf">.join</span> <span class="nv">server</span><span class="p">))</span>
        </span><span class='line'>    <span class="nv">server</span><span class="p">))</span>
        </span><span class='line'>
        </span><span class='line'><span class="p">(</span><span class="nf">defroutes</span> <span class="nv">app</span> <span class="p">(</span><span class="nf">GET</span> <span class="s">&quot;/hello&quot;</span> <span class="p">[]</span> <span class="p">{</span><span class="ss">:status</span> <span class="mi">200</span> <span class="ss">:body</span> <span class="s">&quot;Hello&quot;</span><span class="p">})</span>
        </span><span class='line'>
        </span><span class='line'><span class="p">(</span><span class="nf">run-jetty-with-hystrix</span> <span class="nv">app</span> <span class="p">{</span><span class="ss">:port</span> <span class="nv">http-port</span> <span class="ss">:join?</span> <span class="nv">false</span><span class="p">})</span>
        </span></code></pre></td></tr></table></div></figure>


        <h4>Aggregation and discovery</h4>

        <p>While you can monitor a single process using Hystrix in our example we have many processes serving an endpoint. To aggregate all these Hystrix metric services we use <a href="https://github.com/Netflix/Turbine">Turbine</a>.</p>

        <p>Physical endpoints for a service at SoundCloud are discovered using DNS lookup. We configured Turbine to use this method to auto discover which machines are serving an endpoint.</p>

        <figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
        <span class='line-number'>2</span>
        <span class='line-number'>3</span>
        <span class='line-number'>4</span>
        <span class='line-number'>5</span>
        <span class='line-number'>6</span>
        <span class='line-number'>7</span>
        <span class='line-number'>8</span>
        <span class='line-number'>9</span>
        <span class='line-number'>10</span>
        <span class='line-number'>11</span>
        <span class='line-number'>12</span>
        <span class='line-number'>13</span>
        <span class='line-number'>14</span>
        </pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">ns </span><span class="nv">sc-turbine.discovery</span>
        </span><span class='line'>  <span class="p">(</span><span class="ss">:import</span> <span class="p">[</span><span class="nv">org.xbill.DNS</span> <span class="nv">Type</span><span class="p">]</span>
        </span><span class='line'>           <span class="p">[</span><span class="nv">com.netflix.turbine.discovery</span> <span class="nv">InstanceDiscovery</span> <span class="nv">Instance</span><span class="p">])</span>
        </span><span class='line'>  <span class="p">(</span><span class="ss">:require</span> <span class="p">[</span><span class="nv">clj-dns.core</span> <span class="ss">:refer</span> <span class="ss">:all</span><span class="p">]))</span>
        </span><span class='line'>
        </span><span class='line'><span class="p">(</span><span class="nf">gen-class</span>
        </span><span class='line'>   <span class="ss">:name</span> <span class="nv">ScInstanceDiscovery</span>
        </span><span class='line'>   <span class="ss">:implements</span> <span class="p">[</span><span class="nv">com.netflix.turbine.discovery.InstanceDiscovery</span><span class="p">])</span>
        </span><span class='line'>
        </span><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">-getInstanceList</span> <span class="p">[</span><span class="nv">this</span><span class="p">]</span>
        </span><span class='line'>  <span class="p">(</span><span class="nb">map </span><span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">instance</span><span class="p">]</span>
        </span><span class='line'>         <span class="p">(</span><span class="nf">Instance.</span> <span class="p">(</span><span class="nb">str </span><span class="p">(</span><span class="ss">:host</span> <span class="nv">instance</span><span class="p">)</span> <span class="s">&quot;:&quot;</span> <span class="p">(</span><span class="ss">:port</span> <span class="nv">instance</span><span class="p">))</span> <span class="s">&quot;example-prod&quot;</span> <span class="nv">true</span><span class="p">))</span>
        </span><span class='line'>       <span class="p">(</span><span class="nb">map </span><span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">answer</span><span class="p">]</span> <span class="p">{</span><span class="ss">:host</span> <span class="p">(</span><span class="nb">-&gt; </span><span class="nv">answer</span> <span class="nv">.getTarget</span> <span class="nv">str</span><span class="p">)</span> <span class="ss">:port</span> <span class="p">(</span><span class="nf">.getPort</span> <span class="nv">answer</span><span class="p">)})</span>
        </span><span class='line'>            <span class="p">(</span><span class="ss">:answers</span> <span class="p">(</span><span class="nf">dns-lookup</span> <span class="s">&quot;&quot;</span> <span class="nv">Type/SRV</span><span class="p">)))))</span>
        </span></code></pre></td></tr></table></div></figure>


        <p>And the config.properties:</p>

        <figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
        <span class='line-number'>2</span>
        <span class='line-number'>3</span>
        </pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="nv">InstanceDiscovery.impl=ScInstanceDiscovery</span>
        </span><span class='line'><span class="nv">turbine.aggregator.clusterConfig=example-prod</span>
        </span><span class='line'><span class="nv">turbine.instanceUrlSuffix=/hystrix.stream</span>
        </span></code></pre></td></tr></table></div></figure>


        <p>Putting this all together our monitoring looks like this:</p>

        <p><img src="/images/service_discovery.png"></p>

        <h4>Pretty graphs: Hystrix Dashboard</h4>

        <p>Finally we run the <a href="https://github.com/Netflix/Hystrix/tree/master/hystrix-dashboard">Hystrix Dashboard</a> and watch our circuit breakers live.</p>

        <p><img src="/images/hystrix_dashboard.png"></p>

        <p>And heres an example with triggered circuit breakers:</p>

        <p><img src="/images/hystrix_dashboard_failures.jpg"></p>

        <p>Since I cannot show you the dashboard running, you will have to make do with music generated from the metrics. I normalize the live Hystrix metrics to piano pitches and play the notes as the arrive from the stream.</p>

        <h4>Hystrix Metrics as Sounds</h4>

        <div>
        <iframe width="100%" height="166" scrolling="no" frameborder="no" src="https://w.soundcloud.com/player/?url=http%3A%2F%2Fapi.soundcloud.com%2Ftracks%2F109115434&amp;color=ff6600&amp;auto_play=false&amp;show_artwork=false"></iframe>
        </div>




        <p></p>


        <h3>Complexity &amp; Composition</h3>

        <p>Working with many services, composition of service calls becomes hard to think and write about. Callbacks try to solve this but nested callbacks leave us with a mess.</p>

        <p><a href="https://github.com/Netflix/RxJava">RxJava</a> tries to solve this using the Reactive Functional model. While RxJava provides lots of features I see it primarily as a way of expressing concurrent actions as a directed graph which provides a single callback on success or failure. The graph is expressed in terms or maps/reduces/filters/etc, things we are familiar with in the functional world.</p>

        <p>To separate the request thread from the response thread we use RxJava with <a href="http://netty.io">Netty</a> and <a href="https://github.com/ztellman/aleph">Aleph</a>.</p>

        <p>Here is a very simple example firing 2 concurrent requests and then joining the results into a single map response:</p>

        <figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
        <span class='line-number'>2</span>
        <span class='line-number'>3</span>
        <span class='line-number'>4</span>
        <span class='line-number'>5</span>
        <span class='line-number'>6</span>
        <span class='line-number'>7</span>
        <span class='line-number'>8</span>
        <span class='line-number'>9</span>
        </pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="c1">;;Hystrix integrates with RxJava and can return Observables for use with Rx.</span>
        </span><span class='line'><span class="p">(</span><span class="kd">defn- </span><span class="nv">find-user-observable</span> <span class="p">[</span><span class="nv">id</span><span class="p">]</span> <span class="p">(</span><span class="nf">hystrix/observe</span> <span class="o">#</span><span class="ss">&#39;find-user</span> <span class="nv">id</span><span class="p">))</span>
        </span><span class='line'>
        </span><span class='line'><span class="p">(</span><span class="kd">defn- </span><span class="nv">meta-data</span> <span class="p">[</span><span class="nv">user-urn</span><span class="p">]</span>
        </span><span class='line'>  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">user-observable</span> <span class="p">(</span><span class="nb">-&gt; </span><span class="p">(</span><span class="nf">find-user-observable</span> <span class="nv">id</span><span class="p">)</span> <span class="p">(</span><span class="nf">.map</span> <span class="p">(</span><span class="err">位</span> <span class="p">[</span><span class="nv">user</span><span class="p">]</span> <span class="nv">...</span><span class="p">)))</span>
        </span><span class='line'>        <span class="nv">meta-observable</span> <span class="p">(</span><span class="nb">-&gt; </span><span class="p">(</span><span class="nf">find-user-meta-observable</span> <span class="nv">id</span><span class="p">)</span> <span class="p">(</span><span class="nf">.map</span> <span class="p">(</span><span class="err">位</span> <span class="p">[</span><span class="nv">subscription</span><span class="p">]</span> <span class="nv">...</span><span class="p">))))</span>
        </span><span class='line'>    <span class="p">(</span><span class="nb">-&gt; </span><span class="p">(</span><span class="nf">Observable/zip</span> <span class="nv">user-observable</span>
        </span><span class='line'>                        <span class="nv">meta-observable</span>
        </span><span class='line'>                        <span class="p">(</span><span class="err">位</span> <span class="p">[</span><span class="o">&amp;</span> <span class="nv">maps</span><span class="p">]</span> <span class="p">{</span><span class="ss">:user</span> <span class="p">(</span><span class="nb">apply merge </span><span class="nv">maps</span><span class="p">)}))))</span>
        </span></code></pre></td></tr></table></div></figure>


        <p>The function <code>meta-data</code> returns an Observerable which we subscribe to and using Aleph return the resulting JSON to a channel.</p>

        <figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
        <span class='line-number'>2</span>
        <span class='line-number'>3</span>
        <span class='line-number'>4</span>
        <span class='line-number'>5</span>
        <span class='line-number'>6</span>
        <span class='line-number'>7</span>
        <span class='line-number'>8</span>
        <span class='line-number'>9</span>
        </pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn- </span><span class="nv">subscribe-request</span> <span class="p">[</span><span class="nv">channel</span> <span class="nv">request</span><span class="p">]</span>
        </span><span class='line'>  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">id</span> <span class="p">(</span><span class="nf">get-in</span> <span class="nv">request</span> <span class="p">[</span><span class="ss">:route-params</span> <span class="ss">:id</span><span class="p">])]</span>
        </span><span class='line'>    <span class="p">(</span><span class="nb">-&gt; </span><span class="p">(</span><span class="nf">meta-data</span> <span class="nv">id</span><span class="p">)</span>
        </span><span class='line'>        <span class="p">(</span><span class="nf">.subscribe</span>
        </span><span class='line'>          <span class="o">#</span><span class="p">(</span><span class="nf">enqueue</span> <span class="nv">channel</span> <span class="p">{</span><span class="ss">:status</span> <span class="mi">200</span> <span class="ss">:body</span> <span class="nv">%</span><span class="p">}))</span>
        </span><span class='line'>          <span class="o">#</span><span class="p">(</span><span class="nf">logging/exception</span> <span class="nv">%</span><span class="p">))))))</span>
        </span><span class='line'>
        </span><span class='line'><span class="p">(</span><span class="nf">defroutes</span> <span class="nv">app</span>
        </span><span class='line'>  <span class="p">(</span><span class="nf">GET</span> <span class="s">&quot;/users/:id&quot;</span> <span class="p">[</span><span class="nv">id</span><span class="p">]</span> <span class="p">(</span><span class="nf">wrap-aleph-handler</span> <span class="nv">subscribe-request</span><span class="p">)))</span>
        </span></code></pre></td></tr></table></div></figure>


        <p>The shape of the <a href="https://github.com/Netflix/RxJava/tree/master/language-adaptors/rxjava-clojure">RxJava Clojure bindings</a> are still under development.</p>

        <h4>That single thread pool again&hellip;</h4>

        <p>With RxJava we are also in a situation were we cannot use Clojure&rsquo;s <code>future</code>. In order for RxJava to block optimally we don&rsquo;t want to use a single thread pool.
        Hence we use Hystrix as our means of providing concurreny.</p>

        <h2>Clojure services at scale</h2>

        <p>I&rsquo;m very happy with the shape of these services running at SoundCloud. In production they are performing very well under heavy load with useful near realtime monitoring.
        In part thanks to Netflix&rsquo;s hard work there is no reason you cannot write elegant Clojure services at scale.</p>
        </div>




            </article>

    <article>

  <header>

      <h1 class="entry-title"><a href="/clojure/creating-instruments-with-overtone.html">Creating Sampled Instruments With Overtone</a></h1>


      <p class="meta">












<time datetime="2013-08-26T21:28:00+01:00" pubdate data-updated="true">Aug 26<span>th</span>, 2013</time>

      </p>

  </header>


  <div class="entry-content"><p><a href="http://overtone.github.io">Overtone</a> is an open source audio environment which uses Clojure and <a href="http://supercollider.sourceforge.net/">SuperCollider</a> (an environment and programming language for real time audio synthesis and algorithmic composition).</p>

<p>Overtone makes it very easy to define instruments based on sound samples from <a href="http://www.freesound.org">freesound</a>.
We will walk through getting samples for a flute and then using them to define the flute instrument in Overtone.</p>

<h2>The Flute</h2>

<p><img src="/images/flute.jpg"/></p>

<h3>Getting the samples</h3>

<p>Firstly we need to manually grab all the IDs from freesound. Sounds are often grouped into packs making this a little less painful.</p>

<p>We will be using the <a href="http://www.freesound.org/search/?q=flute&amp;f=grouping_pack%3A%229549_Transverse+Flute%3A+Tenuto+Vibrato+C4-C7%22&amp;s=score+desc&amp;advanced=0&amp;g=1">&ldquo;Transverse Flute: Tenuto Vibrato C4-C7&rdquo;</a> pack.</p>

<p>A little Ruby script I use to produce a map of freesound ids to notes (which are usually in the filename of the sample):</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#!/usr/bin/env ruby -w</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;rubygems&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;json&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="k">raise</span> <span class="no">Exception</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;You must pass in the pack id!&quot;</span><span class="p">)</span> <span class="k">unless</span> <span class="no">ARGV</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'><span class="n">pack_id</span> <span class="o">=</span> <span class="no">ARGV</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span>
</span><span class='line'><span class="n">note_extractor</span> <span class="o">=</span> <span class="err">位</span><span class="p">{</span><span class="o">|</span><span class="n">filename</span><span class="o">|</span> <span class="n">filename</span><span class="o">.</span><span class="n">gsub</span><span class="p">(</span><span class="sr">/Transverse-Flute |\.wav|Tenuto|NonVibrato|-/</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">gsub</span><span class="p">(</span><span class="sr">/ NonVibrato/</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)}</span>
</span><span class='line'>
</span><span class='line'><span class="n">data</span> <span class="o">=</span> <span class="no">JSON</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="sb">`curl --silent &quot;http://www.freesound.org/api/packs/</span><span class="si">#{</span><span class="n">pack_id</span><span class="si">}</span><span class="sb">/sounds/?api_key=47efd585321048819a2328721507ee23&quot;`</span><span class="p">)</span>
</span><span class='line'><span class="n">number_of_pages</span> <span class="o">=</span> <span class="n">data</span><span class="o">[</span><span class="s2">&quot;num_pages&quot;</span><span class="o">]</span> <span class="o">||</span> <span class="mi">1</span>
</span><span class='line'>
</span><span class='line'><span class="n">number_of_pages</span><span class="o">.</span><span class="n">times</span> <span class="k">do</span> <span class="o">|</span><span class="n">page</span><span class="o">|</span>
</span><span class='line'>  <span class="n">data</span> <span class="o">=</span> <span class="no">JSON</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="sb">`curl --silent &quot;http://www.freesound.org/api/packs/</span><span class="si">#{</span><span class="n">pack_id</span><span class="si">}</span><span class="sb">/sounds/?api_key=47efd585321048819a2328721507ee23&amp;p=</span><span class="si">#{</span><span class="n">page</span> <span class="o">+</span> <span class="mi">1</span><span class="si">}</span><span class="sb">&quot;`</span><span class="p">)</span>
</span><span class='line'>  <span class="n">sound_ids</span> <span class="o">=</span> <span class="n">data</span><span class="o">[</span><span class="s2">&quot;sounds&quot;</span><span class="o">].</span><span class="n">map</span><span class="p">{</span><span class="o">|</span><span class="n">sound</span><span class="o">|</span> <span class="n">sound</span><span class="o">[</span><span class="s2">&quot;id&quot;</span><span class="o">]</span><span class="p">}</span>
</span><span class='line'>  <span class="n">note_names</span> <span class="o">=</span> <span class="n">data</span><span class="o">[</span><span class="s2">&quot;sounds&quot;</span><span class="o">].</span><span class="n">map</span><span class="p">{</span><span class="o">|</span><span class="n">sound</span><span class="o">|</span> <span class="n">note_extractor</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">sound</span><span class="o">[</span><span class="s2">&quot;original_filename&quot;</span><span class="o">]</span><span class="p">)}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">sound_ids</span><span class="o">.</span><span class="n">each_with_index</span> <span class="k">do</span> <span class="o">|</span><span class="n">sound_id</span><span class="p">,</span> <span class="n">index</span><span class="o">|</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">sound_id</span><span class="si">}</span><span class="s2"> :</span><span class="si">#{</span><span class="n">note_names</span><span class="o">[</span><span class="n">index</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Adding these to our Clojure code we have a Freesound ID to note mapping:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">FREESOUND-VIBRATO-FLUTE-SAMPLES</span>
</span><span class='line'>  <span class="s">&quot;Freesound ids for all samples in the Vibrato Transverse Flute pack&quot;</span>
</span><span class='line'>  <span class="p">{</span><span class="mi">154274</span> <span class="ss">:C7</span>  <span class="mi">154273</span> <span class="ss">:B6</span> <span class="mi">154272</span> <span class="ss">:A#6</span> <span class="mi">154271</span> <span class="ss">:A6</span> <span class="mi">154270</span> <span class="ss">:G#6</span> <span class="mi">154269</span> <span class="ss">:G6</span>  <span class="mi">154268</span> <span class="ss">:F#6</span>
</span><span class='line'>   <span class="mi">154267</span> <span class="ss">:F6</span>  <span class="mi">154266</span> <span class="ss">:E6</span> <span class="mi">154265</span> <span class="ss">:D#6</span> <span class="mi">154264</span> <span class="ss">:D6</span> <span class="mi">154263</span> <span class="ss">:C#6</span> <span class="mi">154262</span> <span class="ss">:C6</span>  <span class="mi">154261</span> <span class="ss">:B5</span>
</span><span class='line'>   <span class="mi">154260</span> <span class="ss">:A#5</span> <span class="mi">154259</span> <span class="ss">:A5</span> <span class="mi">154258</span> <span class="ss">:G#5</span> <span class="mi">154257</span> <span class="ss">:G5</span> <span class="mi">154256</span> <span class="ss">:F#5</span> <span class="mi">154255</span> <span class="ss">:F5</span>  <span class="mi">154254</span> <span class="ss">:E5</span>
</span><span class='line'>   <span class="mi">154253</span> <span class="ss">:D#5</span> <span class="mi">154252</span> <span class="ss">:D5</span> <span class="mi">154251</span> <span class="ss">:C#5</span> <span class="mi">154250</span> <span class="ss">:C5</span> <span class="mi">154249</span> <span class="ss">:B4</span>  <span class="mi">154248</span> <span class="ss">:A#4</span> <span class="mi">154247</span> <span class="ss">:A4</span>
</span><span class='line'>   <span class="mi">154246</span> <span class="ss">:G#4</span> <span class="mi">154245</span> <span class="ss">:G4</span> <span class="mi">154244</span> <span class="ss">:F#4</span> <span class="mi">154243</span> <span class="ss">:E4</span> <span class="mi">154242</span> <span class="ss">:F4</span>  <span class="mi">154241</span> <span class="ss">:D#4</span> <span class="mi">154240</span> <span class="ss">:D4</span>
</span><span class='line'>   <span class="mi">154239</span> <span class="ss">:C#4</span> <span class="mi">154238</span> <span class="ss">:C4</span><span class="p">})</span>
</span></code></pre></td></tr></table></div></figure>


<p>These samples are cached in the asset store (usually ~/.overtone/assets) so we don&rsquo;t have to keep downloading them. We define a cache key for our downloaded samples.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn- </span><span class="nv">registered-samples</span>
</span><span class='line'>  <span class="s">&quot;Fetch flute samples from the asset store if they have been manually registered&quot;</span>
</span><span class='line'>  <span class="p">[]</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">registered-assets</span> <span class="ss">::TransverseFluteTenutoVibrato</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Load all the samples into Overtone. This will automatically download the samples if they are not already present.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">flute-samples</span>
</span><span class='line'>  <span class="p">(</span><span class="nb">doall </span><span class="p">(</span><span class="nb">map </span><span class="nv">freesound-sample</span> <span class="p">(</span><span class="nb">keys </span><span class="nv">FREESOUND-VIBRATO-FLUTE-SAMPLES</span><span class="p">))))</span>
</span></code></pre></td></tr></table></div></figure>


<p>In order to play the samples we need to produce a mapping between the buffer that has the sound loaded and the midi pitch that buffer relates to.</p>

<p>First we convert a freesound-id into a midi note (pitch)</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn- </span><span class="nv">buffer-&gt;midi-note</span> <span class="p">[</span><span class="nv">buf</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="nb">-&gt; </span><span class="nv">buf</span> <span class="ss">:freesound-id</span> <span class="nv">FREESOUND-VIBRATO-FLUTE-SAMPLES</span> <span class="nb">name </span><span class="nv">note</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now we can generate the buffer id to midi note map.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn- </span><span class="nv">note-index</span>
</span><span class='line'>  <span class="s">&quot;Returns a map of midi-note values [0-127] to buffer ids.&quot;</span>
</span><span class='line'>  <span class="p">[</span><span class="nv">buffers</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="nb">reduce </span><span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nb">index </span><span class="nv">buf</span><span class="p">]</span>
</span><span class='line'>            <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">id</span> <span class="p">(</span><span class="nb">-&gt; </span><span class="nv">buf</span> <span class="ss">:id</span><span class="p">)</span>
</span><span class='line'>                  <span class="nv">note</span> <span class="p">(</span><span class="nf">buffer-&gt;midi-note</span> <span class="nv">buf</span><span class="p">)]</span>
</span><span class='line'>              <span class="p">(</span><span class="nb">assoc index </span><span class="nv">note</span> <span class="nv">id</span><span class="p">)))</span>
</span><span class='line'>          <span class="p">{}</span>
</span><span class='line'>          <span class="nv">buffers</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>And we use this to set the buffers:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="c1">;Silent buffer used to ensure all 127 buffer spaces are filled </span>
</span><span class='line'><span class="p">(</span><span class="kd">defonce </span><span class="o">^</span><span class="ss">:private</span> <span class="nv">silent-buffer</span> <span class="p">(</span><span class="nf">buffer</span> <span class="mi">0</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defonce </span><span class="nv">index-buffer</span>
</span><span class='line'>  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">tab</span> <span class="p">(</span><span class="nf">note-index</span> <span class="nv">flute-samples</span><span class="p">)</span>
</span><span class='line'>        <span class="nv">buf</span> <span class="p">(</span><span class="nf">buffer</span> <span class="mi">128</span><span class="p">)]</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">buffer-fill!</span> <span class="nv">buf</span> <span class="p">(</span><span class="ss">:id</span> <span class="nv">silent-buffer</span><span class="p">))</span>
</span><span class='line'>    <span class="p">(</span><span class="nb">doseq </span><span class="p">[[</span><span class="nv">idx</span> <span class="nv">val</span><span class="p">]</span> <span class="nv">tab</span><span class="p">]</span>
</span><span class='line'>      <span class="p">(</span><span class="nf">buffer-set!</span> <span class="nv">buf</span> <span class="nv">idx</span> <span class="nv">val</span><span class="p">))</span>
</span><span class='line'>    <span class="nv">buf</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Defining the Instrument</h2>

<p>Now we have all our samples we define a instrument in Overtone using <code>definst</code>:</p>

<p>This allows us to specify a (huge) number of options on how our samples are played.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">definst</span> <span class="nv">sampled-flute-vibrato</span>
</span><span class='line'>  <span class="p">[</span><span class="nv">note</span> <span class="mi">60</span> <span class="nv">level</span> <span class="mi">1</span> <span class="nv">rate</span> <span class="mi">1</span> <span class="nv">loop?</span> <span class="mi">0</span> <span class="nv">attack</span> <span class="mi">0</span> <span class="nv">decay</span> <span class="mi">1</span> <span class="nv">sustain</span> <span class="mi">1</span> <span class="nv">release</span> <span class="mf">0.1</span> <span class="nv">curve</span> <span class="mi">-4</span> <span class="nv">gate</span> <span class="mi">1</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">buf</span> <span class="p">(</span><span class="nf">index</span><span class="ss">:kr</span> <span class="p">(</span><span class="ss">:id</span> <span class="nv">index-buffer</span><span class="p">)</span> <span class="nv">note</span><span class="p">)</span>
</span><span class='line'>        <span class="nv">env</span> <span class="p">(</span><span class="nf">env-gen</span> <span class="p">(</span><span class="nf">adsr</span> <span class="nv">attack</span> <span class="nv">decay</span> <span class="nv">sustain</span> <span class="nv">release</span> <span class="nv">level</span> <span class="nv">curve</span><span class="p">)</span>
</span><span class='line'>                     <span class="ss">:gate</span> <span class="nv">gate</span>
</span><span class='line'>                     <span class="ss">:action</span> <span class="nv">FREE</span><span class="p">)]</span>
</span><span class='line'>    <span class="p">(</span><span class="nb">* </span><span class="nv">env</span> <span class="p">(</span><span class="nf">scaled-play-buf</span> <span class="mi">2</span> <span class="nv">buf</span> <span class="ss">:level</span> <span class="nv">level</span> <span class="ss">:loop</span> <span class="nv">loop?</span> <span class="ss">:action</span> <span class="nv">FREE</span><span class="p">))))</span>
</span></code></pre></td></tr></table></div></figure>


<p>There is quite a lot going on here. Lets focus on the configuration that effects how our sound samples are played.</p>

<h3>Defining the Envelope Generator (env-gen).</h3>

<p>An envelope generator (mapping to function <code>env-gen</code>) makes an audio signal that smoothly rises and falls. We are taking the recording of the real flute instrument as a digitized waveform, and then playing back its recordings at different speeds to produce different tones.</p>

<p>The most common form of envelope generator and the one we are using here is ADSR:</p>

<p>attack (A), decay (D), sustain (S) and release &#40;R)</p>

<p><img src="/images/ADSR.png" /></p>

<p>There are a number of other config settings in our example:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">[</span>
</span><span class='line'> <span class="nv">note</span> <span class="mi">60</span>     <span class="c1">; Default pitch</span>
</span><span class='line'> <span class="nv">level</span> <span class="mi">1</span>     <span class="c1">; Volume</span>
</span><span class='line'> <span class="nv">rate</span> <span class="mi">1</span>      <span class="c1">; Playback rate </span>
</span><span class='line'> <span class="nv">loop?</span> <span class="mi">0</span>     <span class="c1">; The note should loop after the first play</span>
</span><span class='line'> <span class="nv">attack</span> <span class="mi">0</span>    <span class="c1">; The way a sound is initiated. Fast attack (gunshot) vs Slow attack (closing a door slowly)</span>
</span><span class='line'> <span class="nv">decay</span> <span class="mi">1</span>     <span class="c1">; The time for notes to decay after the initial strike</span>
</span><span class='line'> <span class="nv">sustain</span> <span class="mi">1</span>   <span class="c1">; Once a sound has reached its peak, the length of time that the sound will sustain.</span>
</span><span class='line'> <span class="nv">release</span> <span class="mf">0.1</span> <span class="c1">; The time for notes to decay after the key is released</span>
</span><span class='line'> <span class="nv">curve</span> <span class="mi">-4</span>    <span class="c1">; Curve factor</span>
</span><span class='line'> <span class="nv">gate</span> <span class="mi">1</span>      <span class="c1">; note occurs when gate goes from nonpositive to positive. Note off occurs when it goes from positive to nonpositive</span>
</span><span class='line'><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Look to the <a href="http://supercollider.sourceforge.net/">SuperCollider</a> documentation on <a href="http://doc.sccode.org/Classes/UGen.html">UGENs</a> if you want to see all possible configuration options. Overtone is really a wrapper around the extremely powerful SuperCollider.</p>

<h2>Grand finale</h2>

<p>Finally we can start to play music in overtone using our flute:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">sampled-flute-vibrato</span> <span class="mi">60</span><span class="p">)</span> <span class="o">#</span><span class="nv">=&gt;</span> <span class="nv">pitch</span> <span class="mi">60</span>
</span><span class='line'><span class="p">(</span><span class="nf">sampled-flute-vibrato</span> <span class="mi">61</span><span class="p">)</span> <span class="o">#</span><span class="nv">=&gt;</span> <span class="nv">pitch</span> <span class="mi">61</span>
</span><span class='line'><span class="p">(</span><span class="nf">sampled-flute-vibrato</span> <span class="mi">60</span><span class="p">)</span> <span class="o">#</span><span class="nv">=&gt;</span> <span class="nv">pitch</span> <span class="mi">60</span>
</span></code></pre></td></tr></table></div></figure>


<p>Hear for yourself:</p>

<iframe width="100%" height="166" scrolling="no" frameborder="no" src="https://w.soundcloud.com/player/?url=http%3A%2F%2Fapi.soundcloud.com%2Ftracks%2F107183072&amp;color=ff6600&amp;auto_play=false&amp;show_artwork=false"></iframe>


<h2>The Code in Full</h2>

<p>Defining an instrument in Overtone:</p>

<figure class='code'><figcaption><span>Loading buffers </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">ns </span><span class="nv">overtone.samples.flute-vibrato</span>
</span><span class='line'>  <span class="p">(</span><span class="ss">:use</span> <span class="p">[</span><span class="nv">overtone.core</span><span class="p">])</span>
</span><span class='line'>  <span class="p">(</span><span class="ss">:require</span> <span class="p">[</span><span class="nv">clojure.string</span> <span class="ss">:as</span> <span class="nv">str</span><span class="p">]))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defn- </span><span class="nv">registered-samples</span>
</span><span class='line'>  <span class="s">&quot;Fetch flute samples from the asset store if they have been manually</span>
</span><span class='line'><span class="s">  registered&quot;</span>
</span><span class='line'>  <span class="p">[]</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">registered-assets</span> <span class="ss">::TransverseFluteTenutoVibrato</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">FREESOUND-VIBRATO-FLUTE-SAMPLES</span>
</span><span class='line'>  <span class="s">&quot;Freesound ids for all samples in the Vibrato Transverse Flute pack&quot;</span>
</span><span class='line'>  <span class="p">{</span><span class="mi">154274</span> <span class="ss">:C7</span>  <span class="mi">154273</span> <span class="ss">:B6</span> <span class="mi">154272</span> <span class="ss">:A#6</span> <span class="mi">154271</span> <span class="ss">:A6</span> <span class="mi">154270</span> <span class="ss">:G#6</span> <span class="mi">154269</span> <span class="ss">:G6</span>  <span class="mi">154268</span> <span class="ss">:F#6</span>
</span><span class='line'>   <span class="mi">154267</span> <span class="ss">:F6</span>  <span class="mi">154266</span> <span class="ss">:E6</span> <span class="mi">154265</span> <span class="ss">:D#6</span> <span class="mi">154264</span> <span class="ss">:D6</span> <span class="mi">154263</span> <span class="ss">:C#6</span> <span class="mi">154262</span> <span class="ss">:C6</span>  <span class="mi">154261</span> <span class="ss">:B5</span>
</span><span class='line'>   <span class="mi">154260</span> <span class="ss">:A#5</span> <span class="mi">154259</span> <span class="ss">:A5</span> <span class="mi">154258</span> <span class="ss">:G#5</span> <span class="mi">154257</span> <span class="ss">:G5</span> <span class="mi">154256</span> <span class="ss">:F#5</span> <span class="mi">154255</span> <span class="ss">:F5</span>  <span class="mi">154254</span> <span class="ss">:E5</span>
</span><span class='line'>   <span class="mi">154253</span> <span class="ss">:D#5</span> <span class="mi">154252</span> <span class="ss">:D5</span> <span class="mi">154251</span> <span class="ss">:C#5</span> <span class="mi">154250</span> <span class="ss">:C5</span> <span class="mi">154249</span> <span class="ss">:B4</span>  <span class="mi">154248</span> <span class="ss">:A#4</span> <span class="mi">154247</span> <span class="ss">:A4</span>
</span><span class='line'>   <span class="mi">154246</span> <span class="ss">:G#4</span> <span class="mi">154245</span> <span class="ss">:G4</span> <span class="mi">154244</span> <span class="ss">:F#4</span> <span class="mi">154243</span> <span class="ss">:E4</span> <span class="mi">154242</span> <span class="ss">:F4</span>  <span class="mi">154241</span> <span class="ss">:D#4</span> <span class="mi">154240</span> <span class="ss">:D4</span>
</span><span class='line'>   <span class="mi">154239</span> <span class="ss">:C#4</span> <span class="mi">154238</span> <span class="ss">:C4</span><span class="p">})</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">FLUTE-SAMPLE-IDS</span> <span class="p">(</span><span class="nb">keys </span><span class="nv">FREESOUND-VIBRATO-FLUTE-SAMPLES</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">flute-samples</span>
</span><span class='line'>  <span class="p">(</span><span class="nb">doall </span><span class="p">(</span><span class="nb">map </span><span class="nv">freesound-sample</span> <span class="nv">FLUTE-SAMPLE-IDS</span><span class="p">)))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defn- </span><span class="nv">buffer-&gt;midi-note</span> <span class="p">[</span><span class="nv">buf</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="nb">-&gt; </span><span class="nv">buf</span> <span class="ss">:freesound-id</span> <span class="nv">FREESOUND-VIBRATO-FLUTE-SAMPLES</span> <span class="nb">name </span><span class="nv">note</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defn- </span><span class="nv">note-index</span>
</span><span class='line'>  <span class="s">&quot;Returns a map of midi-note values [0-127] to buffer ids.&quot;</span>
</span><span class='line'>  <span class="p">[</span><span class="nv">buffers</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="nb">reduce </span><span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nb">index </span><span class="nv">buf</span><span class="p">]</span>
</span><span class='line'>            <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">id</span> <span class="p">(</span><span class="nb">-&gt; </span><span class="nv">buf</span> <span class="ss">:id</span><span class="p">)</span>
</span><span class='line'>                  <span class="nv">note</span> <span class="p">(</span><span class="nf">buffer-&gt;midi-note</span> <span class="nv">buf</span><span class="p">)]</span>
</span><span class='line'>              <span class="p">(</span><span class="nb">assoc index </span><span class="nv">note</span> <span class="nv">id</span><span class="p">)))</span>
</span><span class='line'>          <span class="p">{}</span>
</span><span class='line'>          <span class="nv">buffers</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="c1">;; Silent buffer used to fill in the gaps.</span>
</span><span class='line'><span class="p">(</span><span class="kd">defonce </span><span class="o">^</span><span class="ss">:private</span> <span class="nv">silent-buffer</span> <span class="p">(</span><span class="nf">buffer</span> <span class="mi">0</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defonce </span><span class="nv">index-buffer</span>
</span><span class='line'>  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">tab</span> <span class="p">(</span><span class="nf">note-index</span> <span class="nv">flute-samples</span><span class="p">)</span>
</span><span class='line'>        <span class="nv">buf</span> <span class="p">(</span><span class="nf">buffer</span> <span class="mi">128</span><span class="p">)]</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">buffer-fill!</span> <span class="nv">buf</span> <span class="p">(</span><span class="ss">:id</span> <span class="nv">silent-buffer</span><span class="p">))</span>
</span><span class='line'>    <span class="p">(</span><span class="nb">doseq </span><span class="p">[[</span><span class="nv">idx</span> <span class="nv">val</span><span class="p">]</span> <span class="nv">tab</span><span class="p">]</span>
</span><span class='line'>      <span class="p">(</span><span class="nf">buffer-set!</span> <span class="nv">buf</span> <span class="nv">idx</span> <span class="nv">val</span><span class="p">))</span>
</span><span class='line'>    <span class="nv">buf</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>Defining the instrument </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">ns </span><span class="nv">overtone.inst.sampled-flute</span>
</span><span class='line'>  <span class="p">(</span><span class="ss">:use</span> <span class="p">[</span><span class="nv">overtone.core</span><span class="p">])</span>
</span><span class='line'>  <span class="p">(</span><span class="ss">:require</span>
</span><span class='line'>   <span class="p">[</span><span class="nv">overtone.samples.flute-vibrato</span> <span class="ss">:as</span> <span class="nv">vibrato</span><span class="p">]))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">definst</span> <span class="nv">sampled-flute-vibrato</span>
</span><span class='line'>  <span class="p">[</span><span class="nv">note</span> <span class="mi">60</span> <span class="nv">level</span> <span class="mi">1</span> <span class="nv">rate</span> <span class="mi">1</span> <span class="nv">loop?</span> <span class="mi">0</span>
</span><span class='line'>   <span class="nv">attack</span> <span class="mi">0</span> <span class="nv">decay</span> <span class="mi">1</span> <span class="nv">sustain</span> <span class="mi">1</span> <span class="nv">release</span> <span class="mf">0.1</span> <span class="nv">curve</span> <span class="mi">-4</span> <span class="nv">gate</span> <span class="mi">1</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">buf</span> <span class="p">(</span><span class="nf">index</span><span class="ss">:kr</span> <span class="p">(</span><span class="ss">:id</span> <span class="nv">vibrato/index-buffer</span><span class="p">)</span> <span class="nv">note</span><span class="p">)</span>
</span><span class='line'>        <span class="nv">env</span> <span class="p">(</span><span class="nf">env-gen</span> <span class="p">(</span><span class="nf">adsr</span> <span class="nv">attack</span> <span class="nv">decay</span> <span class="nv">sustain</span> <span class="nv">release</span> <span class="nv">level</span> <span class="nv">curve</span><span class="p">)</span>
</span><span class='line'>                     <span class="ss">:gate</span> <span class="nv">gate</span>
</span><span class='line'>                     <span class="ss">:action</span> <span class="nv">FREE</span><span class="p">)]</span>
</span><span class='line'>    <span class="p">(</span><span class="nb">* </span><span class="nv">env</span> <span class="p">(</span><span class="nf">scaled-play-buf</span> <span class="mi">2</span> <span class="nv">buf</span> <span class="ss">:level</span> <span class="nv">level</span> <span class="ss">:loop</span> <span class="nv">loop?</span> <span class="ss">:action</span> <span class="nv">FREE</span><span class="p">))))</span>
</span></code></pre></td></tr></table></div></figure>

</div>




    </article>


    <article>

  <header>

      <h1 class="entry-title"><a href="/elixir/sets-in-elixir.html">Sets in Elixir</a></h1>


      <p class="meta">












<time datetime="2013-07-02T14:43:00+01:00" pubdate data-updated="true">Jul 2<span>nd</span>, 2013</time>

      </p>

  </header>


  <div class="entry-content"><p>I recently contributed the <code>Set</code> data structure to the <a href="http://elixir-lang.org/">Elixir</a> programming language.
The <code>Set</code> is implemented through a HashSet.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='elixir'><span class='line'><span class="n">s1</span> <span class="o">=</span> <span class="no">HashSet</span><span class="o">.</span><span class="n">new</span><span class="p">([</span><span class="m">1</span><span class="p">,</span> <span class="m">2</span><span class="p">,</span> <span class="m">3</span><span class="p">,</span> <span class="m">4</span><span class="p">])</span>
</span><span class='line'><span class="n">s2</span> <span class="o">=</span> <span class="no">HashSet</span><span class="o">.</span><span class="n">new</span><span class="p">([</span><span class="m">3</span><span class="p">,</span> <span class="m">4</span><span class="p">])</span>
</span><span class='line'>
</span><span class='line'><span class="no">Set</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">)</span> <span class="c1"># =&gt; HashSet&lt;[1, 2]&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Elixir&rsquo;s Set implementation is often faster than Erlangs own <a href="http://www.erlang.org/doc/man/sets.html">sets</a>. Which is pretty impressive since Elixir runs on the same Erlang VM. It does this by adapting the internal data structure based on the size of the sets.</p>

<p>Lets explore how Elixir does this while also explaining a little about Elixir:</p>

<h2>Growing Data structures</h2>

<p>For small sets the internal representation uses an ordered set (which really is just a list).</p>

<p>We refer to this as a Bucket.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='elixir'><span class='line'><span class="p">[</span><span class="m">1</span><span class="p">,</span> <span class="m">2</span><span class="p">,</span> <span class="m">3</span><span class="p">,</span> <span class="m">4</span><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Being ordered allows us to perform faster access and modification.</p>

<p>For example finding a member of a set:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='elixir'><span class='line'><span class="c1"># Only needs a single comparison to know if 1 is in the Set.</span>
</span><span class='line'><span class="c1"># Since the first element is greater than 1 we know its not in the Set.</span>
</span><span class='line'><span class="no">Set</span><span class="o">.</span><span class="n">member?</span><span class="p">(</span><span class="no">HashSet</span><span class="o">.</span><span class="n">new</span> <span class="p">[</span><span class="m">2</span><span class="p">,</span> <span class="m">3</span><span class="p">,</span> <span class="m">4</span><span class="p">,</span> <span class="m">5</span><span class="p">],</span> <span class="m">1</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Order in the list is not maintained in the data structure but in the insertion/put:</p>

<h3>Putting elements into a Bucket</h3>

<p>Before we jump into some Elixir code its important to understand that the order of functions in Elixir is important. We start from the top function and if this function matches a criteria we call it otherwise we try the function below and so on. If we find no function that matches that&rsquo;s a error and execution aborts.</p>

<p>Here is the Elixir code for inserting a member into a bucket.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='elixir'><span class='line'><span class="c1"># We have found the place to insert the new member.</span>
</span><span class='line'><span class="k">defp</span> <span class="n">bucket_put</span><span class="p">([</span><span class="n">m</span><span class="o">|</span><span class="n">_</span><span class="p">]</span><span class="o">=</span><span class="n">bucket</span><span class="p">,</span> <span class="n">member</span><span class="p">)</span> <span class="ow">when</span> <span class="n">m</span> <span class="o">&gt;</span> <span class="n">member</span> <span class="k">do </span>
</span><span class='line'><span class="k">  </span><span class="p">{</span> <span class="p">[</span><span class="n">member</span><span class="o">|</span><span class="n">bucket</span><span class="p">],</span> <span class="m">1</span> <span class="p">}</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Member is already in the set, we don&#39;t added it. (notice how member is being used to pattern match here).</span>
</span><span class='line'><span class="c1"># Its the same as writing: `defp bucket_put([m|bucket], member) when m == member do</span>
</span><span class='line'><span class="k">defp</span> <span class="n">bucket_put</span><span class="p">([</span><span class="n">member</span><span class="o">|</span><span class="n">bucket</span><span class="p">],</span> <span class="n">member</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'><span class="k">  </span><span class="p">{</span> <span class="p">[</span><span class="n">member</span><span class="o">|</span><span class="n">bucket</span><span class="p">],</span> <span class="m">0</span> <span class="p">}</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Recursive case, keep calling bucket_put as this is not the point to insert.</span>
</span><span class='line'><span class="k">defp</span> <span class="n">bucket_put</span><span class="p">([</span><span class="n">e</span><span class="o">|</span><span class="n">bucket</span><span class="p">],</span> <span class="n">member</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'><span class="k">  </span><span class="p">{</span> <span class="n">rest</span><span class="p">,</span> <span class="n">count</span> <span class="p">}</span> <span class="o">=</span> <span class="n">bucket_put</span><span class="p">(</span><span class="n">bucket</span><span class="p">,</span> <span class="n">member</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span> <span class="p">[</span><span class="n">e</span><span class="o">|</span><span class="n">rest</span><span class="p">],</span> <span class="n">count</span> <span class="p">}</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Empty set, insert the number</span>
</span><span class='line'><span class="k">defp</span> <span class="n">bucket_put</span><span class="p">([],</span> <span class="n">member</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'><span class="k">  </span><span class="p">{</span> <span class="p">[</span><span class="n">member</span><span class="p">],</span> <span class="m">1</span> <span class="p">}</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Expanding into a Trie</h2>

<p>Upon reaching a threshold the Set changes the internal representation into a Trie (What the hell is a <a href="http://en.wikipedia.org/wiki/Trie">trie</a>).</p>

<p>Why a Trie?</p>

<blockquote><p>For a Trie the time required for insert, delete and find operations is almost identical.
As a result, for situations where code is inserting, deleting and finding in equal measure, tries can handily beat binary search trees.</p></blockquote>

<p>In a Trie we don&rsquo;t store any keys or hashes, instead a elements position in the tree defines the key with which it is associated.</p>

<p>Hence we can take advantage of Erlangs fast <a href="http://www.erlang.org/doc/reference_manual/data_types.html#id65673">tuples</a> to model the trie. A multi-depth trie is just tuples inside tuples.</p>

<h3>Buckets growing into Tries</h3>

<p>Lets work through an example. For simplicity we will assume the expansion happens at the very small size of 5 elements:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='elixir'><span class='line'><span class="n">set</span> <span class="o">=</span> <span class="no">Set</span><span class="o">.</span><span class="n">new</span> <span class="p">[</span><span class="m">0</span><span class="p">,</span> <span class="m">1</span><span class="p">,</span> <span class="m">2</span><span class="p">,</span> <span class="m">3</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Apply an operation that forces the internal structure to change</span>
</span><span class='line'><span class="n">set</span> <span class="o">=</span> <span class="no">Set</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">set</span><span class="p">,</span> <span class="m">4</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<h4>Create a new Erlang Tuple</h4>

<p><img alt="bucket to trie" src="/images/trie_step1.png"/></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='elixir'><span class='line'>  <span class="ss">:erlang</span><span class="o">.</span><span class="n">make_tuple</span><span class="p">(</span><span class="n">node_size</span> <span class="o">=</span> <span class="m">4</span><span class="p">,</span> <span class="p">[])</span>
</span></code></pre></td></tr></table></div></figure>


<h4>Redistribute the bucket elements into the Tuple</h4>

<p><img alt="bucket to trie" src="/images/trie_step2.png"/></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='elixir'><span class='line'><span class="c1"># This returns the index that a set value should have in the tuple.</span>
</span><span class='line'><span class="k">defp</span> <span class="n">bucket_nth_index</span><span class="p">(</span><span class="n">set_value</span><span class="p">,</span> <span class="n">trie_depth</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'><span class="k">  </span><span class="n">node_shift</span> <span class="o">=</span> <span class="m">2</span>
</span><span class='line'>  <span class="n">node_bitmap</span> <span class="o">=</span> <span class="m">0b0011</span>
</span><span class='line'>
</span><span class='line'>  <span class="p">(</span><span class="ss">:erlang</span><span class="o">.</span><span class="n">phash2</span><span class="p">(</span><span class="n">set_value</span><span class="p">)</span> <span class="o">&gt;&gt;&gt;</span> <span class="p">(</span><span class="n">node_shift</span> <span class="o">*</span> <span class="n">trie_depth</span><span class="p">))</span> <span class="o">&amp;&amp;</span><span class="err">&amp;</span> <span class="n">node_bitmap</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Create a new node or add to an existing node.</span>
</span><span class='line'><span class="c1"># Based on the bucket_nth_index of the set member put it into a bucket at that index in the tuple.</span>
</span><span class='line'><span class="k">defp</span> <span class="n">node_relocate</span><span class="p">(</span><span class="n">node</span> <span class="o">//</span> <span class="ss">:erlang</span><span class="o">.</span><span class="n">make_tuple</span><span class="p">(</span><span class="n">node_size</span> <span class="o">=</span> <span class="m">4</span><span class="p">,</span> <span class="p">[]),</span> <span class="n">bucket</span><span class="p">,</span> <span class="n">depth</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'><span class="k">  </span><span class="ss">:lists</span><span class="o">.</span><span class="n">foldl</span> <span class="k">fn</span> <span class="n">member</span><span class="p">,</span> <span class="n">new_node</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="n">position_in_tuple</span> <span class="o">=</span> <span class="n">bucket_nth_index</span><span class="p">(</span><span class="n">member</span><span class="p">,</span> <span class="n">depth</span><span class="p">)</span>
</span><span class='line'>    <span class="n">set_elem</span><span class="p">(</span><span class="n">new_node</span><span class="p">,</span> <span class="n">position_in_tuple</span><span class="p">,</span> <span class="n">bucket_put</span><span class="p">(</span><span class="n">elem</span><span class="p">(</span><span class="n">new_node</span><span class="p">,</span> <span class="n">position_in_tuple</span><span class="p">),</span> <span class="n">member</span><span class="p">))</span>
</span><span class='line'>  <span class="k">end</span><span class="p">,</span> <span class="n">new_node</span><span class="p">,</span> <span class="n">bucket</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h4>Finally add the new set member into the Trie</h4>

<p><img alt="bucket to trie" src="/images/trie_step3.png"/></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='elixir'><span class='line'><span class="c1"># Base case. We have found the right bucket, just insert the new member into it.</span>
</span><span class='line'><span class="k">defp</span> <span class="n">node_put</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">member</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'><span class="k">  </span><span class="n">position</span> <span class="o">=</span> <span class="n">bucket_index</span><span class="p">(</span><span class="n">member</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span> <span class="n">new</span><span class="p">,</span> <span class="n">count</span> <span class="p">}</span> <span class="o">=</span> <span class="n">bucket_put</span><span class="p">(</span><span class="n">elem</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">position</span><span class="p">),</span> <span class="n">member</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span> <span class="n">set_elem</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">position</span><span class="p">,</span> <span class="n">new</span><span class="p">),</span> <span class="n">count</span> <span class="p">}</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Recursive case. Keeping trying to find the right bucket.</span>
</span><span class='line'><span class="k">defp</span> <span class="n">node_put</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">member</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'><span class="k">  </span><span class="n">position</span> <span class="o">=</span> <span class="n">bucket_index</span><span class="p">(</span><span class="n">member</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span> <span class="n">new</span><span class="p">,</span> <span class="n">count</span> <span class="p">}</span> <span class="o">=</span> <span class="n">node_put</span><span class="p">(</span><span class="n">elem</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">position</span><span class="p">),</span> <span class="n">depth</span> <span class="o">-</span> <span class="m">1</span><span class="p">,</span> <span class="n">bucket_next</span><span class="p">(</span><span class="n">hash</span><span class="p">),</span> <span class="n">member</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span> <span class="n">set_elem</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">position</span><span class="p">,</span> <span class="n">new</span><span class="p">),</span> <span class="n">count</span> <span class="p">}</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># The bucket index of this member</span>
</span><span class='line'><span class="k">defp</span> <span class="n">bucket_index</span><span class="p">(</span><span class="n">member</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'><span class="k">  </span><span class="n">node_bitmap</span> <span class="o">=</span> <span class="m">0b0011</span>
</span><span class='line'>  <span class="n">hash</span> <span class="o">=</span> <span class="ss">:erlang</span><span class="o">.</span><span class="n">phash2</span><span class="p">(</span><span class="n">member</span><span class="p">)</span>
</span><span class='line'>  <span class="n">hash</span> <span class="o">&amp;&amp;</span><span class="err">&amp;</span> <span class="n">node_bitmap</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># The bucket index of this element with depth + 1.</span>
</span><span class='line'><span class="k">defp</span> <span class="n">bucket_next</span><span class="p">(</span><span class="n">member</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'><span class="k">  </span><span class="n">node_shift</span> <span class="o">=</span> <span class="m">2</span>
</span><span class='line'>  <span class="n">hash</span> <span class="o">=</span> <span class="ss">:erlang</span><span class="o">.</span><span class="n">phash2</span><span class="p">(</span><span class="n">member</span><span class="p">)</span>
</span><span class='line'>  <span class="n">hash</span> <span class="o">&gt;&gt;&gt;</span> <span class="n">node_shift</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Notice while we have a more complicated data structure with a trie the leaves are always plain old buckets. Hence insertion with a trie is a case of finding the right bucket and then just reusing our <code>bucket_put</code> function. Beautiful and fast :)</p>

<h4>Tries expanding into deeper Tries</h4>

<p>Things get a little more complicated with multi depth tries. If you are interested digging more into the implementation you can see all the <a href="https://github.com/elixir-lang/elixir/blob/master/lib/elixir/lib/hash_set.ex">source code of HashSet</a> on Github.</p>

<h2>Contraction</h2>

<p>We can also remove elements from a set so in much the same as we expanded we have to contract the internal representation of the set.</p>

<h1>Performance Benchmarks</h1>

<p>Here is some sample data comparing Erlang sets to Elixir Sets. Smaller is better.</p>

<p><img alt="HashSet vs :sets" src="/images/sets_vs_hashset.png"/></p>

<p>The benchmark scripts are on github (<a href="https://gist.github.com/josephwilk/5808525">https://gist.github.com/josephwilk/5808525</a>) if you are interested in running them yourself.</p>
</div>




    </article>


    <article>

  <header>

      <h1 class="entry-title"><a href="/clojure/isolating-external-dependencies-in-clojure.html">Isolating External Dependencies in Clojure</a></h1>


      <p class="meta">












<time datetime="2013-06-08T12:00:00+01:00" pubdate data-updated="true">Jun 8<span>th</span>, 2013</time>

      </p>

  </header>


  <div class="entry-content"><p>Isolating external dependencies helps make testing easier. We can focus on a specific unit of code and we can avoid slow tests calling real services or databases.</p>

<p>Clojure provides many different ways of achieving isolation. Lets explore what&rsquo;s possible:</p>

<h2>Redefining functions</h2>

<p>We can redefine vars and hence functions in a limited scope with <a href="http://clojuredocs.org/clojure_core/clojure.core/with-redefs">with-redefs</a></p>

<p>The documentation suggests its usefulness in testing:</p>

<blockquote><p>Useful for mocking out functions during testing.</p></blockquote>

<p>Lets look at an example where we want to isolate a function that logs to file:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">log-fn</span> <span class="p">[]</span> <span class="o">#</span><span class="p">(</span><span class="nf">spit</span> <span class="s">&quot;report.xml&quot;</span> <span class="nv">%</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">log</span> <span class="p">[</span><span class="nv">string</span><span class="p">]</span> <span class="p">((</span><span class="nf">log-fn</span><span class="p">)</span> <span class="nv">string</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>And the test removing the dependency on the filesytem:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">with-redefs</span> <span class="p">[</span><span class="nv">log-fn</span> <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">data</span><span class="p">]</span> <span class="nv">data</span><span class="p">)]</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">log</span> <span class="s">&quot;hello&quot;</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Its important to note that <code>with-redefs</code> are visible in <em>all threads</em> and it does not play well with concurrency:</p>

<blockquote><p>with-redefs can permanently change a var if applied concurrently:</p></blockquote>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">ten-sixty-six</span> <span class="p">[]</span> <span class="mi">1066</span><span class="p">)</span>
</span><span class='line'><span class="p">(</span><span class="nb">doall </span>
</span><span class='line'>  <span class="p">(</span><span class="nf">pmap</span> <span class="o">#</span><span class="p">(</span><span class="nf">with-redefs</span> <span class="p">[</span><span class="nv">ten-sixty-six</span> <span class="p">(</span><span class="k">fn </span><span class="p">[]</span> <span class="nv">%</span><span class="p">)]</span> <span class="p">(</span><span class="nf">ten-sixty-six</span><span class="p">))</span>
</span><span class='line'>        <span class="p">(</span><span class="nb">range </span><span class="mi">20</span> <span class="mi">100</span><span class="p">)))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">ten-sixty-six</span><span class="p">)</span> <span class="c1">; =&gt; 49 Ouch!</span>
</span></code></pre></td></tr></table></div></figure>


<p>The parallel redefs conflict with each other when setting back the var to its original value.</p>

<p>Another option is <a href="http://clojuredocs.org/clojure_core/clojure.core/alter-var-root">alter-var-root</a> which globally redefines a var and hence a function. <code>alter-var-root</code> can alter functions in other namespaces.</p>

<p>Writing our test to use <code>alter-var-root</code>:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">alter-var-root</span>
</span><span class='line'> <span class="p">(</span><span class="k">var </span><span class="nv">log-fn</span><span class="p">)</span>
</span><span class='line'> <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">real-fn</span><span class="p">]</span> <span class="c1">; We are passed the function we are about to stub.</span>
</span><span class='line'>   <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">data</span><span class="p">]</span> <span class="p">(</span><span class="nb">println </span><span class="nv">data</span><span class="p">))))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Its important to note we have to reset the var if we want to restore the system to its previous state for other tests.</p>

<h3>Redefining Dynamic Vars</h3>

<p>Using dynamic vars we can rebind the value and hence we can use this as an injection point. Again if we can rebind vars we can rebind functions. Note though that we have to mark those functions as dynamic:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="c1">;The real http request</span>
</span><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="o">^</span><span class="ss">:dynamic</span> <span class="nv">http-get-request</span> <span class="p">[</span><span class="nv">url</span><span class="p">]</span> <span class="nv">http/get</span> <span class="nv">url</span><span class="p">)</span>
</span><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nb">get </span><span class="p">[</span><span class="nv">url</span><span class="p">]</span> <span class="p">(</span><span class="nf">http-get-request</span> <span class="p">[</span><span class="nv">url</span><span class="p">]))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">fake-http-get</span> <span class="p">[</span><span class="nv">url</span><span class="p">]</span> <span class="s">&quot;{}&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">fact</span> <span class="s">&quot;make a http get request&quot;</span>
</span><span class='line'>  <span class="p">(</span><span class="nb">binding </span><span class="p">[</span><span class="nv">http-get-request</span> <span class="nv">fake-http-get</span><span class="p">]</span>
</span><span class='line'>    <span class="p">(</span><span class="nb">get </span><span class="s">&quot;/some-resource&quot;</span><span class="p">))</span> <span class="nv">=&gt;</span> <span class="s">&quot;{}&quot;</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Unlike <code>alter-var-root</code> and <code>with-redefs</code> dynamic vars are bound at a thread-local level. So the stubbings would only be visible in that thread. Which makes this safe for tests being run concurrently!</p>

<h3>Atoms &amp; Refs (Global vars in disguise)</h3>

<p>While insidious, evil, malicious and ugly we could use atom or refs to contain a dependency.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">cache</span> <span class="p">(</span><span class="nf">atom</span> <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">method</span>, <span class="o">&amp;</span> <span class="nv">args</span><span class="p">]</span> <span class="p">(</span><span class="nb">apply </span><span class="p">(</span><span class="nb">resolve </span><span class="p">(</span><span class="nb">symbol </span><span class="p">(</span><span class="nb">str </span><span class="s">&quot;memcache/&quot;</span> <span class="nv">method</span><span class="p">)))</span> <span class="nv">args</span><span class="p">))))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nb">get </span><span class="p">[</span><span class="nv">key</span><span class="p">]</span> <span class="p">(</span><span class="err">@</span><span class="nv">cache</span> <span class="nb">get </span><span class="nv">key</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>And in our test:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">reset!</span> <span class="nv">cache</span> <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">method</span>, <span class="o">&amp;</span> <span class="nv">args</span><span class="p">]</span> <span class="p">(</span><span class="nb">apply </span><span class="p">(</span><span class="nb">resolve </span><span class="p">(</span><span class="nb">symbol </span><span class="p">(</span><span class="nb">str </span><span class="s">&quot;fake-cache/&quot;</span> <span class="nv">method</span><span class="p">)))</span> <span class="nv">args</span><span class="p">)))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Yuck, lets never speak of that again.</p>

<h3>Midje</h3>

<p>The <a href="https://github.com/marick/Midje">Midje</a> testing framework provides stubbing methods through <code>provided</code>. In the core of Midje this uses our previously visited <code>alter-var-root</code>.</p>

<p>Lets see how our example would look using Midje:</p>

<p>The code:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">log-fn</span> <span class="p">[]</span> <span class="o">#</span><span class="p">(</span><span class="nf">spit</span> <span class="s">&quot;report.xml&quot;</span> <span class="nv">%</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">log</span> <span class="p">[</span><span class="nv">string</span><span class="p">]</span> <span class="p">((</span><span class="nf">log-fn</span><span class="p">)</span> <span class="nv">string</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>And our test that uses <code>provided</code>:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">fact</span> <span class="s">&quot;it should spit out strings&quot;</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">log</span> <span class="s">&quot;hello&quot;</span><span class="p">)</span> <span class="nv">=&gt;</span> <span class="s">&quot;hello&quot;</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">provided</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">log-fn</span><span class="p">)</span> <span class="nv">=&gt;</span> <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">data</span><span class="p">]</span> <span class="nv">data</span><span class="p">)))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Its important to note that the <code>provided</code> is scoped in effect. It is only active during the form before the Midje &ldquo;=>&rdquo; assertion arrow.</p>

<p>Conceptually think of it like this:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">provided</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">log-fn</span><span class="p">)</span> <span class="nv">=&gt;</span> <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">data</span><span class="p">]</span> <span class="p">(</span><span class="nb">println </span><span class="nv">data</span><span class="p">))</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">captured-output</span> <span class="p">(</span><span class="nf">log</span> <span class="s">&quot;hello&quot;</span><span class="p">)))</span> <span class="nv">=&gt;</span> <span class="p">(</span><span class="nf">contains</span> <span class="s">&quot;hello&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<h4>Flexibility</h4>

<p>Midjes <code>provided</code> gives very fine grained control of when a stub is used:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">do</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">log</span> <span class="s">&quot;mad hatter&quot;</span><span class="p">)</span>   <span class="c1">;will use the stub</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">log</span> <span class="s">&quot;white rabbit&quot;</span><span class="p">)</span> <span class="c1">;will not use the stub</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'><span class="p">(</span><span class="nf">provided</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">log</span> <span class="s">&quot;mad hatter&quot;</span><span class="p">)</span> <span class="nv">=&gt;</span> <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">data</span><span class="p">]</span> <span class="p">(</span><span class="nb">println </span><span class="nv">data</span><span class="p">)))</span>
</span></code></pre></td></tr></table></div></figure>


<p>And we can go further and define argument matcher functions giving huge flexibility in when a stub should be run.</p>

<h4>Safety</h4>

<p>Midje validates your stubs and checks your not doing anything too crazy which would fundamentally break everything.</p>

<h2>Higher order functions</h2>

<p>We can isolate dependencies by passing in functions which wrap that dependency. This abstracts the details of the dependency and provides a point where we can inject our own functions which bypasses the dependency.</p>

<p>For example:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">extract-urn</span> <span class="p">[</span><span class="nv">data</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">urn-getter</span> <span class="o">#</span><span class="p">(</span><span class="ss">:urn</span> <span class="nv">data</span><span class="p">)]</span>
</span><span class='line'> <span class="p">(</span><span class="nf">do-it</span> <span class="nv">urn-getter</span><span class="p">)))</span>
</span></code></pre></td></tr></table></div></figure>


<p>In our tests:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'>  <span class="p">(</span><span class="nf">do-it</span> <span class="p">(</span><span class="k">fn </span><span class="p">[]</span> <span class="mi">10</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Simple and beautiful.</p>

<h2>Substituting namespaces</h2>

<p>We can switch the namespace that a block of functions are evaluated in. Hence we can swap in a completely new implementation (such as a fake) by changing the namespace.</p>

<p>An example faking out a key value store:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">get-it</span> <span class="p">[</span><span class="nv">arg</span> <span class="o">&amp;</span> <span class="p">[</span><span class="nv">namespace</span><span class="p">]]</span>
</span><span class='line'>  <span class="p">((</span><span class="nb">ns-resolve </span><span class="p">(</span><span class="nb">or namespace </span><span class="nv">*ns*</span><span class="p">)</span> <span class="ss">&#39;get</span><span class="p">)</span> <span class="nv">arg</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>A fake implementation of this service:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">ns </span><span class="nv">test.cache.fake</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">cache</span> <span class="p">(</span><span class="nf">atom</span> <span class="p">{}))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nb">get </span><span class="p">[</span><span class="nv">arg</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="err">@</span><span class="nv">cache</span> <span class="nv">arg</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">put</span> <span class="p">[</span><span class="nv">arg</span> <span class="nv">value</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">reset!</span> <span class="err">@</span><span class="nv">cache</span> <span class="p">(</span><span class="nb">assoc </span><span class="err">@</span><span class="nv">cache</span> <span class="nv">arg</span> <span class="nv">value</span><span class="p">)))</span>
</span></code></pre></td></tr></table></div></figure>


<p>And our test:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">fact</span> <span class="s">&quot;it should do something useful&quot;</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">get-it</span> <span class="s">&quot;1234&quot;</span> <span class="ss">&#39;test.cache.fake</span><span class="p">)</span> <span class="nv">=&gt;</span> <span class="s">&quot;1234&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Alternatively if we don&rsquo;t want the mess of injecting new namespaces into our functions we could change namespace aliases to achieve the same effect:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">ns </span><span class="nv">example</span>
</span><span class='line'>  <span class="p">(</span><span class="ss">:require</span> <span class="p">[</span><span class="nv">cache.memcache</span> <span class="ss">:as</span> <span class="nv">memcache</span><span class="p">]))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nb">when </span><span class="p">(</span><span class="nb">= </span><span class="p">(</span><span class="nf">System/getenv</span> <span class="s">&quot;ENV&quot;</span><span class="p">)</span> <span class="s">&quot;TEST&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">ns-unalias</span> <span class="ss">&#39;example</span> <span class="ss">&#39;memcache</span><span class="p">)</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">require</span> <span class="ss">&#39;test.cache.fake</span><span class="p">)</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">alias</span> <span class="ss">&#39;memcache</span> <span class="ss">&#39;test.cache.fake</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nb">get </span><span class="p">[</span><span class="nv">arg</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">memcache/get</span> <span class="nv">arg</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="c1">; ...</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nb">when </span><span class="p">(</span><span class="nb">= </span><span class="p">(</span><span class="nf">System/getenv</span> <span class="s">&quot;ENV&quot;</span><span class="p">)</span> <span class="s">&quot;TEST&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="c1">;Cleanup our rebinding of memcache alias</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">ns-unalias</span> <span class="ss">&#39;memcache</span> <span class="ss">&#39;example</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>When running our tests we mutate the behaviour of the system by setting the ENV environment variable to TEST.</p>

<h2>Runtime Polymorphism</h2>

<p>Switch behaviour based on a the type of an argument. During testing we can inject a specific type which will behave differently from the real system.</p>

<p>Clojure gives us <a href="http://clojure.org/protocols">protocols</a> and <a href="http://clojure.org/multimethods">multimethods</a> to achieve this:</p>

<h3>Protocols</h3>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="ss">:require</span> <span class="p">[[</span><span class="nv">fake-service</span> <span class="ss">:as</span> <span class="nv">fake</span><span class="p">]</span>
</span><span class='line'>           <span class="p">[</span><span class="nv">service</span>      <span class="ss">:as</span> <span class="nv">service</span><span class="p">]])</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defprotocol </span><span class="nv">Service</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">do-get</span> <span class="p">[</span><span class="nv">this</span> <span class="nv">arg</span><span class="p">]))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">deftype </span><span class="nv">FakeService</span> <span class="p">[]</span>
</span><span class='line'>  <span class="nv">Service</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">do-get</span> <span class="p">[</span><span class="nv">this</span> <span class="nv">arg</span><span class="p">]</span> <span class="p">(</span><span class="nf">fake/do-get</span> <span class="nv">arg</span><span class="p">)))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">deftype </span><span class="nv">RealService</span> <span class="p">[]</span>
</span><span class='line'>  <span class="nv">Service</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">do-get</span> <span class="p">[</span><span class="nv">this</span> <span class="nv">arg</span><span class="p">]</span> <span class="p">(</span><span class="nf">service/do-get</span> <span class="nv">arg</span><span class="p">)))</span>
</span></code></pre></td></tr></table></div></figure>


<p>And in our test:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">do-get</span> <span class="p">(</span><span class="nf">FakeService.</span><span class="p">)</span> <span class="s">&quot;cheshire&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Multimethods</h3>

<p>Similar we can use the type of arguments to indicate different behaviour.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="ss">:require</span> <span class="p">[[</span><span class="nv">fake-service</span> <span class="ss">:as</span> <span class="nv">fake</span><span class="p">]</span>
</span><span class='line'>           <span class="p">[</span><span class="nv">service</span>      <span class="ss">:as</span> <span class="nv">service</span><span class="p">]])</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defmulti </span><span class="nv">do-get</span> <span class="p">(</span><span class="k">fn </span><span class="p">[</span><span class="nv">service</span> <span class="nv">param</span><span class="p">]</span> <span class="p">[(</span><span class="ss">:Service</span> <span class="nv">service</span><span class="p">)</span> <span class="nv">param</span><span class="p">]))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defmethod </span><span class="nv">do-get</span> <span class="p">[</span><span class="ss">:FakeService</span><span class="p">]</span> <span class="p">[</span><span class="nv">service</span> <span class="nv">param</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">fake/do-get</span> <span class="nv">param</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defmethod </span><span class="nv">do-get</span> <span class="p">[</span><span class="ss">:RealService</span><span class="p">]</span> <span class="p">[</span><span class="nv">service</span> <span class="nv">param</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">service/do-get</span> <span class="nv">param</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>And in our test:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">do-get</span> <span class="p">(</span><span class="nf">FakeService.</span><span class="p">)</span> <span class="s">&quot;rabbit&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Defining functions at Runtime</h2>

<p>Using environment variables its possible to switch what functions are defined at runtime. <code>def</code> always defines a method at the top level of a namespace.</p>

<p>Here is an example inspired from Midje&rsquo;s source code:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">init!</span> <span class="p">[]</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">case</span> <span class="p">(</span><span class="nf">System/getenv</span> <span class="s">&quot;ENV&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="s">&quot;TEST&quot;</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">do</span>
</span><span class='line'>      <span class="p">(</span><span class="k">def </span><span class="nb">get </span><span class="p">[</span><span class="nv">key</span><span class="p">]</span>       <span class="p">(</span><span class="nf">fake/get</span> <span class="nv">key</span><span class="p">))</span>
</span><span class='line'>      <span class="p">(</span><span class="k">def </span><span class="nb">set </span><span class="p">[</span><span class="nb">key </span><span class="nv">value</span><span class="p">]</span> <span class="p">(</span><span class="nf">fake/set</span> <span class="nb">key </span><span class="nv">value</span><span class="p">))</span>
</span><span class='line'>    <span class="c1">;; else</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">do</span>
</span><span class='line'>      <span class="p">(</span><span class="k">def </span><span class="nb">get </span><span class="p">[</span><span class="nv">key</span><span class="p">]</span>       <span class="p">(</span><span class="nf">memcache/get</span> <span class="nv">key</span><span class="p">))</span>
</span><span class='line'>      <span class="p">(</span><span class="k">def </span><span class="nb">set </span><span class="p">[</span><span class="nb">key </span><span class="nv">value</span><span class="p">]</span> <span class="p">(</span><span class="nf">memcache/set</span> <span class="nb">key </span><span class="nv">value</span><span class="p">))))))</span>
</span></code></pre></td></tr></table></div></figure>


<p>We would run our tests with <code>ENV=test lein test</code>.</p>

<h1>How should I isolate dependencies in Clojure?</h1>

<p>Having explored what we can do, what should we do?</p>

<p>There are a number of choices and a lot depends on you&rsquo;re programming and testing style:</p>

<h3>The Purest form of isolation</h3>

<p>Passing a function, functions that wrap our dependencies means we do not have to mutate the code under test. This is the ideal form of isolating. This is where we want to be.</p>

<p>But sometimes either aesthetics or control might make us look elsewhere.</p>

<p>Functions with many parameters can become ugly and cumbersome to use.</p>

<p>Using external libraries where we cannot have design the way we want it (though we can try by wrapping the heck out of any library).</p>

<p>Finally integration tests are hard if not impossible to do with this form of dependency isolation.</p>

<h3>The Aesthetic small touch form of isolation</h3>

<p><code>var-alter-root</code> is (very) scary, but the guard rails of Midje make it an easy way to isolate dependencies. It also supports flexibility in how we stub functions based on the arguments they are called with (or completely ignore the arguments). This flexibility is extremely powerful and is a big plus for Midjes <code>provided</code>.</p>

<p>The danger ever present with this form of isolation is ignoring your tests telling you about a problem in your design.</p>

<h3>The Simple small touch form of isolation</h3>

<p>While Midje provides lots of power and flexibly it does so at the cost of slightly awkward syntax and a lot of crazy macros (I say this having stared into the heart of Midje). For example parallel functions do not work with <code>provided</code>.</p>

<p><code>with-redefs</code>, <code>binding</code> and <code>var-alter-root</code> provide flexibly to handle different testing scenarios. and no prior knowledge of an external tool is required.</p>

<p>If you don&rsquo;t need the power of Midje or fear its complexity you can happily use nothing but Clojure&rsquo;s standard library. Maybe you will even learn something about how Clojure works!</p>

<h3>The Java small touch form of isolation.</h3>

<p>Since Clojure supports java interop its always possible to fall back to using Java, OO and dependency injection. If you love Java, this is a good path.</p>

<h3>The Crazy Large touch form of isolation</h3>

<p>Namespace switching is a shortcut to having to stub out every single method. In one sweep we redefine all the functions of a namespace. This might be more useful for integration tests than unit tests.</p>

<p>That shortcut does come at a cost, we still have to maintain our fake ns every time something changes in the real namespace and our production code is left wrapped in <code>ns-resolve</code> or a ugly switch based on Environment settings. Ugly!</p>

<p>I don&rsquo;t recommend using this form of isolation regularly but in edge cases it can be very convenient, though people will still think you are crazy.</p>
</div>




    </article>


    <article>

  <header>

      <h1 class="entry-title"><a href="/presentations/a-developers-guide-to-creating-presentations.html">A Developers Guide to Creating Presentations</a></h1>


      <p class="meta">












<time datetime="2012-12-19T14:58:12+00:00" pubdate data-updated="true">Dec 19<span>th</span>, 2012</time>

      </p>

  </header>


  <div class="entry-content"><p>So your talk got selected. Great!</p>

<p>Oh Crap! Now hits the panic, you have to actually create a presentation.</p>

<p>Every presenter wants to give the best possible presentation they can that sticks in peoples minds.</p>

<p>Here are some hard earned lessons for getting the best out of your presentation.</p>

<h3>Accept that most of our preconceptions of how we learn are wrong.</h3>

<p>Forget those high information dense, black and whiteacetateslides with professorsdroningon about solving the towers of Hanoi while you scribble your own notes while downing your fifth coffee.</p>

<blockquote><p>&ldquo;Attending a lecture is a passive experience for the student.Of all teaching events, the lecture is most likely to promote<a href="http://www.learningandteaching.info/teaching/groups_bad.htm">basic assumption dependence</a> and sleep&rdquo;</p></blockquote>

<p><a href="http://www.dailyprincetonian.com/2009/10/15/24142/"><img src="/images/blog/2012/12/jmontalb_sleep-massive-300x219.png" alt="" /></a></p>

<p><a href="http://www.dailyprincetonian.com/2009/10/15/24142/">http://www.dailyprincetonian.com/2009/10/15/24142/</a></p>

<h3><strong>The good news</strong></h3>

<p>That does not mean you cannot give a super dense, deeply detailed presentation. It means if you want people to get the most out of your presentation you need to think outside a boring lecture.LuckilyFun, humor, creativity, color, interaction, invokingemotions are a key part of helping people learn effectively. Think back to your favourite teacher, why were they your favourite? I&rsquo;m guessing they introduced some of those things in their teaching.</p>

<h2>Creating a presentation</h2>

<p>Lets look at some general ideas to help make your presentation great:</p>

<h3>1. Dedicate time</h3>

<p>Creating a presentation, content, theme, styling, finding pictures, practicing all take time. As you get better you can speed up and hone your tactics for presentations.</p>

<p>My first presentation took 3 months. Make sure you start early and give yourself enough time!</p>

<h3>2. Research the current state of the art</h3>

<p>Doing a talk onContinuousDeployment? Search for every ContinuousDeploymentpresentation thathas been given. Watch them all, steal the good ideas and throw away the bad. Try and make sure you are saying something new or presenting a different slant on the topic.</p>

<ul>
<li><p><a href="http://www.confreaks.com/videos">Confreaks</a> &ndash; presentation videos</p></li>
<li><p><a href="https://speakerdeck.com/">Speaker Deck</a> &ndash; Presentations</p></li>
</ul>


<h3>3. Don&rsquo;t be on your own</h3>

<p>Experiencedspeakers have developed arepertoireof little tricks, ideas and thoughts for presentations. They have also sat through a lot of presentations and have good experience of being the audience. Don&rsquo;t be shy finding someone who has spoken before for some advice, even finding someone who would be happy to be your mentor.</p>

<p>If nothing else watch some of the most popular speakers on<a href="http://www.confreaks.com/videos">Confreaks</a> and see what tricks/styles they use.</p>

<p>Conferences are not very good at helping get the best out of you when it comes to creating your talk.Once your talk is submitted and accepted you are often left on your own until the day of your talk. I believe this is somethingfundamentallybroken with conferences today. Realise this and find someone to be your mentor.</p>

<h3>4. Practice frees the subconscious</h3>

<p>Practicing a presentation is an important part of getting better and more confident at giving presentations. Practicewhereverand whenever you can, at work, at your local meetup and in the shower (yes I&rsquo;ve done this). Don&rsquo;t forget you are not learning if you don&rsquo;t get feedback from your audience.</p>

<p>There is however another secret reason to practice.</p>

<p>When you know a presentation and are confident in giving it you become freer to improvise, to play to the crowd, to react to the room. Your mind is no longer concerned with messing it up, its free to improvise and be creative. Understand what I mean? Watch any of <a href="http://www.confreaks.com/videos/374-rubyconf2010-the-polite-programmer-s-guide-to-ruby-etiquette">Jim Weirich talks</a>.</p>

<h3>5. Borrow confidence from the Samurais</h3>

<p>The hard truth is its easier to pay attention to someone who seems confident about what they are saying than someone who is very nervous. There is an old andsecrettrick I learnt to calm nerves before a presentation:</p>

<blockquote><p>&ldquo;When faced with a crisis, if one puts some spittle on his earlobe and exhales deeply through hisnose, he will overcome anything at hand. This is a secret matter.&rdquo;</p></blockquote>

<p>Bushido: The Way of the Samurai</p>

<p><img src="/images/blog/2012/12/bushido-300x246.jpg" alt="" /></p>

<p>While it sounds a little silly, I found this trick to be very useful. It gives you something to focus on to calmyourself, a ritual with which you find a sense of comfort and deeply breathing is a well know way of increasing oxygen to reduce stress.</p>

<h3>6. Talk to your audience</h3>

<p>If you want to engage your audience you need to talk to them, not your notes or your laptop. Look around the audience as you speak.This engenders engagement with the whole audience, eye contact draws us into a conversation and draws the audience into your story.</p>

<p>Going further always try and remove anyobstaclesbetween you and the audience like those peskylecternsor table. You want the audience to connect with you and associate you as one of them. This can help encourage people to listen to what you have to say. Barriers create aseparationbetween you and the audience, and while that can be overcome why add the challenge in the first place.</p>

<h3>7. Time</h3>

<p>If you have a 40 minute slot for talking, you do not have to fill it. In fact most peoples attention span dips massively towards that figure. Personally I believe 30 minutes is the sweet spot for a presentation. Though you should not feel pressured to pad your talk. Use what time you need to get your point across in the most concise way you can.</p>

<h3>8. The final curtain, end you presentation</h3>

<p>The end of the presentation is one of the most powerful moments to set the mood of the room and help fire thediscussionin the after talk chit chat. You have done all the hard work to get here, don&rsquo;t wimper out with a quiet &ldquo;thats all&rdquo; or a jarring quick finish.</p>

<p><img src="/images/blog/2012/12/curtain-300x225.jpg" alt="" /></p>

<p>You want too leave a short summary of the ideas of your presentation, big questions the audience can discuss afterwards. The best presentations leave the room alive with discussions.</p>

<h2>Creating your slides</h2>

<p>Now lets take a deeper look at some ideas to help you create great slides:</p>

<h3>1. Learn your tools</h3>

<p>You know your developers tools right? Spend any time practicing and getting sharper with your IDE?</p>

<p>If you want to make great presentations you have to invest time in mastering your presentation tools.</p>

<p>Have you ever watched the Keynote tutorials? How about spending an hour playing with animations and find out whats possible. Why not look and see what is possible with presentation tools from<a href="https://speakerdeck.com/">watching other peoples talks.</a></p>

<h3>2. Shape first, design later</h3>

<p>Before getting too caught up in making your slides beautiful and full of pictures of cats, first think out the flow, order and shape of your presentation. A good presentation has a natural flow where each slide leads into the other.</p>

<p>I usually start first by brain storming all the ideas I have about a presentation on sticky notes. No need for each sticky to contain exact details, just words, ideas or thoughts.Leaving a mass of mess on the wall.</p>

<p><a href="/images/blog/2012/12/post-it-mess.jpg"><img src="/images/blog/2012/12/post-it-mess-225x300.jpg" alt="" /></a></p>

<p>Then on another wall try and extract a story putting the stickies into a beginning, middle and end</p>

<p><img src="/images/blog/2012/12/cards.jpeg" alt="" /></p>

<h3>3. Deviate from the default</h3>

<p>Keynote and Powerpointprovidelots of nice default (boring) themes. Default themes are good way to knock something together quickly. But if you use a default theme its hardto stand out from the crowd.</p>

<p><img src="/images/blog/2012/11/Screen-Shot-2012-11-21-at-14.30.17-300x227.png" alt="" /></p>

<p>Do you want your presentation to stand out and be memorable?Do you want people leaving your presentation remembering the funny use ofstar warsLego characters.</p>

<h3>4. Experiment with design</h3>

<p>Don&rsquo;t be afraid to play around with the design of your slides. Experiment lots until you start to like what you have. I spend the most time on the first slide and I usually have hundreds of different designs until I&rsquo;m happy.</p>

<p><img src="/images/blog/2012/12/Screen-Shot-2012-12-17-at-20.14.50.png" alt="" /><img src="/images/blog/2012/12/Screen-Shot-2012-12-17-at-20.12.491.png" alt="" /><img src="/images/blog/2012/12/Screen-Shot-2012-12-17-at-20.13.01.png" alt="" /><img src="/images/blog/2012/12/Screen-Shot-2012-12-17-at-20.13.59.png" alt="" /><img src="/images/blog/2012/12/Screen-Shot-2012-12-17-at-20.14.29.png" alt="" /><img src="/images/blog/2012/12/Screen-Shot-2012-12-17-at-20.14.15.png" alt="" /></p>

<h3>5. Pick an original theme</h3>

<p>Pick a theme/style for your presentation. Try and choose a theme that hassufficientmaterial so you can find lots of pictures.Look to other peoples presentations for ideas.</p>

<p>Examples:</p>

<h4>Street art</h4>

<p><img src="/images/blog/2012/03/Screen-Shot-2012-03-06-at-17.06.40-300x225.png" alt="" /></p>

<h4>Tv Programs / Mad Men</h4>

<h3><img src="/images/blog/2012/03/Screen-Shot-2012-03-06-at-17.03.201-300x224.png" alt="" /></h3>

<h4>Silent Movies</h4>

<p><img src="/images/blog/2012/03/Screen-Shot-2012-03-06-at-17.01.26-300x224.png" alt="" /></p>

<h3>6. Kill them with your first slide</h3>

<p>Your very first slide will probably be looked at longer than any of your other slides. You want to immediately capture the audiences attention and excite them. Show them how you are going to tell them the story of your presentation, introducing your theme.</p>

<p>Which of these first slides would most engage you?</p>

<p><img src="/images/blog/2012/03/Screen-Shot-2012-03-06-at-16.36.16.png" alt="" /><img src="/images/blog/2012/03/Screen-Shot-2012-03-06-at-16.33.17.png" alt="" /></p>

<h3>7. Fonts make the theme</h3>

<p><img src="/images/blog/2012/03/Screen-Shot-2012-03-06-at-16.25.03.png" alt="" /></p>

<p>Default fonts can work in a presentation if you have little text on the slide or you have very powerful images/colours. If you want to make your presentation standout try different fonts. There are<a href="http://www.dafont.com/">thousands of readable fonts free to download</a>. Explore which ones work for your presentation and your theme.</p>

<p>For example this slide uses a font which fits very well with its DIY/tools theme:</p>

<p><img src="/images/blog/2012/11/Screen-Shot-2012-11-21-at-14.32.31-300x225.png" alt="" /></p>

<p>Always remember to pick a font that does not compromise the readability of your content. Use that font consistently throughout your whole presentation.</p>

<h3>8. Live and die by your theme</h3>

<p>Maintain consistency of your theme throughout. The more daring andoriginalthe theme the harder it can be to find media. With great risk can come great reward.</p>

<h3>9. Invest time or money into images</h3>

<p>There are two paths to great images that help make your presentation stand out.</p>

<p><strong>Buy images</strong></p>

<p><strong> </strong>On average I spend 拢100 per presentation on buying images (Mostly on<a href="http://www.istockphoto.com">http://www.istockphoto.com</a>). That is one of my key secrets for standing out in a presentation. Spending money buys you great, high resolution and original images.</p>

<p><strong>Hunt or create images</strong></p>

<p>There are lots of free sources of images on the Internet such as <a href="http://www.flickr.com/">flickr</a>. It can take more time to hunt around and find the right images but its possible. Or create your own images to give your presentation that personal, unique touch.</p>

<h3>10. Minimalism is king with content</h3>

<p>When we first start a presentation we often overfill the slides with content. It makes sense as we are thinking out what we are going to talk about. As you practice your presentation, slowly that content sinks into your brain (or your notes) allowing you to ween out as much content as possible from the slides. Leaving theminimalpossible text on the slide. The audience is left listening to you rather than trying to read overly detailed, complex slides.</p>

<h3>Anti-patterns of presentations</h3>

<p>There are some common anti-patterns in presentations. Lets look at some with examples:</p>

<h3>1.Bullet points of death</h3>

<p><img src="/images/blog/2012/03/Screen-Shot-2012-03-06-at-16.17.53.png" alt="" /></p>

<p>You can get away with a few of these slides mixed into an interesting presentation. Rely on them too much and it gets boring quick.</p>

<p>Do you want to keep my attention?</p>

<h3>2. Breaking continuity of images, text and content</h3>

<p>One of the hardest challenges of adding images to your presentation is ensuring they feel part of the presentation, fitting with your content and style.</p>

<p>Lets look at an example where images do not fit in the presentation:</p>

<p><img src="/images/blog/2012/11/Screen-Shot-2012-11-21-at-13.32.59-300x224.png" alt="" /></p>

<p>Now improve that slide by making the image feel less jarring with the rest of the content.</p>

<p><img src="/images/blog/2012/11/Screen-Shot-2012-11-21-at-13.55.51-300x224.png" alt="" /></p>

<p>Using framing or picture frames is a easy way to help a image fit in a presentation.</p>

<p>Without a frame:</p>

<p><img src="/images/blog/2012/12/Screen-Shot-2012-12-18-at-20.24.19-300x225.png" alt="" /></p>

<p>With a frame:</p>

<p><img src="/images/blog/2012/12/Screen-Shot-2012-12-18-at-20.24.27-300x225.png" alt="" /></p>

<h3>3. Inconsistent design</h3>

<p>If you want to make your presentation beautiful having consistency in design is important.</p>

<p>Consider how the diagrams in this presentation break consistency.</p>

<p>We have non-shaded, hard edged blocks of colour in one diagram.</p>

<p><img src="/images/blog/2012/11/Screen-Shot-2012-11-21-at-13.39.07-300x187.png" alt="" /></p>

<p>Then in following diagrams we have round blocks with shading.</p>

<p><img src="/images/blog/2012/11/Screen-Shot-2012-11-21-at-13.38.55-300x188.png" alt="" /></p>

<h3>4. The death of colour</h3>

<p>Colour stimulates my brain. Do you want to stimulate it or send it to sleep?</p>

<h2><img src="/images/blog/2012/03/Screen-Shot-2012-03-06-at-17.15.57-300x121.png" alt="" /></h2>

<h3>5. Live code demo fail</h3>

<p>You have 30ish minutes of my time. I don&rsquo;t want to spend that time watching you make typos anddebuggingan error. You immediately make me lose myconcentration, I&rsquo;ll start flicking through my twitter feed. You have been working hard through your presentation to engage me, why throw it away?</p>

<p>Either practice a heck of a lot or pre-record your demos. Ipersonally use<a href="http://www.araelium.com/screenflick">Screenflick</a> for all my recorded demos.</p>

<h3>6. Black and white code.</h3>

<p>How often do you read source code without syntax highlighting?</p>

<p><img src="/images/blog/2012/12/Screen-Shot-2012-12-17-at-20.50.56-300x221.png" alt="" /></p>

<p>For me, that&rsquo;s never. Highlighting code is also a great excuse to add some colour and life to your slides.</p>

<p>Its not tricky, for example extracting syntax highlighting from<a href="http://blog.pastie.org/2008/06/textmate-to-key.html">Textmate to Keynote</a>.</p>

<h3>7. Hello my name is</h3>

<p>The slides where you tell me who you are, what company you work for, what open source projects you work on, your cats name, your dogs name, and what you ate for breakfast.</p>

<p><img src="/images/blog/2012/12/Screen-Shot-2012-12-17-at-14.36.40-300x228.png" alt="" /></p>

<p>Earn me wanting to know who you are through giving a stimulating presentation.</p>

<p><a href="http://blog.josephwilk.net/conferences/conferences-and-the-cult-of-celebrity.html">Content over character</a>.</p>

<p>Avoid breaking the flow of the presentation with a slide which has nothing to do with your topic or content.</p>

<h2>Final words</h2>

<p>Creating a presentation is hard work. Creating a great presentation is lots and lots of work and even then you are never sure if your audience will think its great. Public speaking is stressful and takes a lot of concentration and confidence.</p>

<p>No matter what happens with your talk, be proud of yourself. You decided to put yourself out there, up on stage trying to explain your ideas to people. This is already a great achievement. Don&rsquo;t be too disheartenor critical of yourself if you are not happy with your talk.</p>

<p>Take a moment in thateuphoricbuzz of theapplause to enjoy yourself.</p>

<p><img src="/images/blog/2012/12/70765937applause-300x249.jpg" alt="" /></p>

<p>Then work out how you can do better!</p>

<p>Good luck!</p>
</div>




    </article>


    <article>

  <header>

      <h1 class="entry-title"><a href="/software-craftmanship/the-aesthetics-of-density.html">The Aesthetics of Density</a></h1>


      <p class="meta">












<time datetime="2012-12-14T11:02:48+00:00" pubdate data-updated="true">Dec 14<span>th</span>, 2012</time>

      </p>

  </header>


  <div class="entry-content"><p>Programming languages can be described as Dense.</p>

<p>What does dense mean?</p>

<blockquote><p>Closely compacted in substance.
Having the constituent parts crowded closely together:</p></blockquote>

<p><img src="/images/blog/2012/12/density_model-284x300.jpg" alt="" /></p>

<p>What does it mean for a programming language to be dense?</p>

<p>I consider there are two axis for the density of programming languages:</p>

<blockquote><p><strong>Density of syntax</strong>
The syntax is very dense/compact.</p></blockquote>

<p>For example Assembly has a very dense syntax, abbreviate commands, small register names, etc&hellip; It takes a lot to express simple expressions</p>

<p>A simple &ldquo;for&rdquo; loop in Assembly</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>mov cx, 3
</span><span class='line'>startloop:
</span><span class='line'>   cmp cx, 0
</span><span class='line'>   jz endofloop
</span><span class='line'>   push cx
</span><span class='line'>loopy:
</span><span class='line'>   Call ClrScr
</span><span class='line'>   pop cx
</span><span class='line'>   dec cx
</span><span class='line'>   jmp startloop
</span><span class='line'>endofloop:
</span><span class='line'>   ; Loop ended
</span><span class='line'>   ; Do what ever you have to do here</span></code></pre></td></tr></table></div></figure>


<blockquote><p><strong>Density of expression</strong>
The means of expressing simple concepts or solutions is very compact.</p></blockquote>

<p>This is a little fuzzier than syntax, it can depend on what you are trying to express and languages often provide many different ways to express something. For example string processing in Erlang is a lot messier than say, Ruby. Paul Graham measures this form of density by <a href="http://www.paulgraham.com/power.html">the number of elements</a></p>

<p>As an example PROLOG scores highly in expressive density. One of the main reasons why is when you give up control of execution (imperative style) and describe the problem (declarative style) you increase the expressive density.</p>

<p>The towers of hanoi in Prolog:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='prolog'><span class='line'><span class="nf">move</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="nv">X</span><span class="p">,</span><span class="nv">Y</span><span class="p">,</span><span class="k">_</span><span class="p">)</span> <span class="p">:-</span>
</span><span class='line'>    <span class="nf">write</span><span class="p">(</span><span class="s-Atom">&#39;Move top disk from &#39;</span><span class="p">),</span>
</span><span class='line'>    <span class="nf">write</span><span class="p">(</span><span class="nv">X</span><span class="p">),</span>
</span><span class='line'>    <span class="nf">write</span><span class="p">(</span><span class="s-Atom">&#39; to &#39;</span><span class="p">),</span>
</span><span class='line'>    <span class="nf">write</span><span class="p">(</span><span class="nv">Y</span><span class="p">),</span>
</span><span class='line'>    <span class="s-Atom">nl</span><span class="p">.</span>
</span><span class='line'><span class="nf">move</span><span class="p">(</span><span class="nv">N</span><span class="p">,</span><span class="nv">X</span><span class="p">,</span><span class="nv">Y</span><span class="p">,</span><span class="nv">Z</span><span class="p">)</span> <span class="p">:-</span>
</span><span class='line'>    <span class="nv">N</span><span class="o">&gt;</span><span class="m">1</span><span class="p">,</span>
</span><span class='line'>    <span class="nv">M</span> <span class="o">is</span> <span class="nv">N</span><span class="o">-</span><span class="m">1</span><span class="p">,</span>
</span><span class='line'>    <span class="nf">move</span><span class="p">(</span><span class="nv">M</span><span class="p">,</span><span class="nv">X</span><span class="p">,</span><span class="nv">Z</span><span class="p">,</span><span class="nv">Y</span><span class="p">),</span>
</span><span class='line'>    <span class="nf">move</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="nv">X</span><span class="p">,</span><span class="nv">Y</span><span class="p">,</span><span class="k">_</span><span class="p">),</span>
</span><span class='line'>    <span class="nf">move</span><span class="p">(</span><span class="nv">M</span><span class="p">,</span><span class="nv">Z</span><span class="p">,</span><span class="nv">Y</span><span class="p">,</span><span class="nv">X</span><span class="p">).</span>
</span></code></pre></td></tr></table></div></figure>


<p>Programming languagesfit along a spectrum within these forms of density. Ruby provides the means to express concepts verysyntactically densely. Just look at <a href="http://rubysource.com/ruby-golf">Ruby Golf</a> (solving a problem with the smallest possible number of characters) for example:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">fizzbuzz</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
</span><span class='line'><span class="n">n</span><span class="o">%</span><span class="mi">3</span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&amp;&amp;</span><span class="n">f</span><span class="o">=</span><span class="s2">&quot;Fizz&quot;</span><span class="p">;</span><span class="n">n</span><span class="o">%</span><span class="mi">5</span><span class="o">&lt;</span><span class="mi">1</span><span class="o">?</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">f</span><span class="si">}</span><span class="s2">Buzz&quot;</span><span class="ss">:f</span><span class="o">||</span><span class="n">n</span><span class="o">.</span><span class="n">to_s</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>It is also always posible to build a DSL within a programming language to maximise density.</p>

<h2>Where does Density fit with Literate Programming?</h2>

<p>Dense syntax moves code away from being an easily accessible form of documentation.</p>

<p>Density of expression <strong>can</strong> move code away from being easily accessible as documentation. For example do you understand how that PROLOG towers of hanoi works?</p>

<p>The more focused alanguageis on expressive/syntactical density the further it moves the art of programming away from Literate programming where we focus on our code being the documentation. Much like writing an essay:</p>

<blockquote><p>Instead of writing code containing documentation, the literate programmer writes documentation containing code.</p></blockquote>

<p>Ross Williams. FunnelWeb Tutorial Manual, pg 4.</p>

<p>The readability of the code to humans is the priority.</p>

<blockquote><p>Under the literate programming paradigm, the central activity of programming becomes that of conveying meaning to other intelligent beings rather than merely convincing the computer to behave in a particular way.</p></blockquote>

<p>Ross Williams. FunnelWeb Tutorial Manual, pg 4.</p>

<h3>Density within our heads</h3>

<p><img src="/images/blog/2012/12/head-in-hands-150x150.jpg" alt="" /></p>

<p>One could argue that dense code can still be literate in style. Its just that you have to fit all the programming languages syntax into your head. Its not unrealistic to ask developers to know the syntax/api of their language. Though holding it all in memory when its particularly dense can be challenging.</p>

<p>If your a Clojure programmer you might have a good understanding of this code as documentation:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="k">def </span><span class="o">^</span><span class="p">{</span><span class="ss">:dynamic</span> <span class="nv">true</span>
</span><span class='line'>       <span class="ss">:doc</span> <span class="s">&quot;some doc here&quot;</span><span class="p">}</span>
</span><span class='line'>     <span class="nv">*allow-default-prerequisites*</span> <span class="nv">false</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>And if you&rsquo;re a Ruby or Perl programming you might read this with ease:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="vg">$!</span><span class="o">.</span><span class="n">is_a?</span><span class="p">(</span><span class="no">MonkeyError</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Can dense languages be a good idea?</h2>

<blockquote><p>&ldquo;The quantity of meaning compressed into a small space by algebraic signs, is another circumstance that facilitates the reasonings we are accustomed to carry on by their aid.&rdquo;</p></blockquote>

<ul>
<li>Charles Babbage, quoted in Iverson&rsquo;s Turing Award Lecture</li>
</ul>


<p>Is there a trade-off in moving to a more dense form of expression in helping shape the way we think and the kind of thoughts we have?</p>

<p>How easy is it to hold a dense language in our heads, remembering all the syntax in order to easily read code?</p>

<h2>Regular Expressions</h2>

<p>While regular expressions are not a programming language they are one of the best examples of a very dense language bothsyntacticallyand expressively that has persisted in its syntax through many programming languages.</p>

<p>Is that a sign that regular expressions have succeeded in encoding pattern matching text?</p>

<h3>Write Once</h3>

<p>Do you understand this pattern?</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='perl'><span class='line'><span class="sr">/^[\w]$/</span>
</span></code></pre></td></tr></table></div></figure>


<p>How about we push the complexity level and try some of the more esoteric symbols in regular expressions:</p>

<p>Do you know what this does?</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='perl'><span class='line'><span class="sr">/\b[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,4}\b/i</span>
</span></code></pre></td></tr></table></div></figure>


<p>How about this?</p>

<p><a href="http://www.ex-parrot.com/pdw/Mail-RFC822-Address.html">Full email detection regular expression (RFC822)</a></p>

<p>While regular expressions are very well suited to small patterns, with a very dense language our ability to parse complex statements is reduced.</p>

<p>Which has a knock on effect for maintenance, its read-only and even then its not easy to read.</p>

<h3>Readability</h3>

<p>In fact its considered bad practice to write a regular expression of the form above. Its understood that its hard to read and hence programmers have to add to the dense language to increase readability:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='perl'><span class='line'><span class="o">/</span>
</span><span class='line'><span class="o">^</span>                                             <span class="c1"># start of string</span>
</span><span class='line'><span class="p">(</span>                                             <span class="c1"># first group start</span>
</span><span class='line'>  <span class="p">(?:</span>
</span><span class='line'>    <span class="p">(?:[</span><span class="o">^</span><span class="p">?</span><span class="o">+*</span><span class="p">{}()[</span><span class="o">\</span><span class="p">]</span><span class="o">\\|</span><span class="p">]</span><span class="o">+</span>                      <span class="c1"># literals and ^, $</span>
</span><span class='line'>     <span class="o">|</span> <span class="o">\\.</span>                                    <span class="c1"># escaped characters</span>
</span><span class='line'>     <span class="o">|</span> <span class="o">\</span><span class="p">[</span> <span class="p">(?:</span> <span class="o">\^</span><span class="p">?</span><span class="o">\\.</span> <span class="o">|</span> <span class="o">\^</span><span class="p">[</span><span class="o">^\\</span><span class="p">]</span> <span class="o">|</span> <span class="p">[</span><span class="o">^\\^</span><span class="p">]</span> <span class="p">)</span>     <span class="c1"># character classes</span>
</span><span class='line'>          <span class="p">(?:</span> <span class="p">[</span><span class="o">^\</span><span class="p">]</span><span class="o">\\</span><span class="p">]</span><span class="o">+</span> <span class="o">|</span> <span class="o">\\.</span> <span class="p">)</span><span class="o">*</span> <span class="o">\</span><span class="p">]</span>
</span><span class='line'>     <span class="o">|</span> <span class="o">\</span><span class="p">(</span> <span class="p">(?:</span><span class="o">\</span><span class="p">?[:</span><span class="o">=!</span><span class="p">]</span><span class="o">|\</span><span class="p">?</span><span class="sr">&lt;[=!]|\?&gt;</span><span class="p">)?</span> <span class="p">(?</span><span class="mi">1</span><span class="p">)??</span> <span class="o">\</span><span class="p">)</span>  <span class="c1"># parenthesis, with recursive content</span>
</span><span class='line'>     <span class="o">|</span> <span class="o">\</span><span class="p">(</span><span class="o">\</span><span class="p">?</span> <span class="p">(?:</span><span class="n">R</span><span class="o">|</span><span class="p">[</span><span class="o">+-</span><span class="p">]?</span><span class="o">\</span><span class="n">d</span><span class="o">+</span><span class="p">)</span> <span class="o">\</span><span class="p">)</span>                 <span class="c1"># recursive matching</span>
</span><span class='line'>     <span class="p">)</span>
</span><span class='line'>    <span class="p">(?:</span> <span class="p">(?:[?</span><span class="o">+*</span><span class="p">]</span><span class="o">|\</span><span class="p">{</span><span class="o">\</span><span class="n">d</span><span class="o">+</span><span class="p">(?:,</span><span class="o">\</span><span class="n">d</span><span class="o">*</span><span class="p">)?</span><span class="o">\</span><span class="p">})</span> <span class="p">[?</span><span class="o">+</span><span class="p">]?</span> <span class="p">)?</span>   <span class="c1"># quantifiers</span>
</span><span class='line'>  <span class="o">|</span> <span class="o">\|</span>                                        <span class="c1"># alternative</span>
</span><span class='line'>  <span class="p">)</span><span class="o">*</span>                                          <span class="c1"># repeat content</span>
</span><span class='line'><span class="p">)</span>                                             <span class="c1"># end first group</span>
</span><span class='line'><span class="nv">$</span>                                             <span class="err">#</span> <span class="nv">end</span> <span class="n">of</span> <span class="n">string</span>
</span><span class='line'><span class="o">/</span>
</span></code></pre></td></tr></table></div></figure>


<p>This is definitely not literate programming, comments and code are clearly separate things.</p>

<p>Named captures groups are also an optional feature to improve and document the readability.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">user_regexp</span> <span class="o">=</span> <span class="sr">%r{</span>
</span><span class='line'><span class="sr">   (?&lt;username&gt; [a-z]+ ){0}</span>
</span><span class='line'>
</span><span class='line'><span class="sr">   (?&lt;ip_number&gt; [0-9]{1,3} ){0}</span>
</span><span class='line'><span class="sr">   (?&lt;ip_address&gt; (\g&lt;ip_number&gt;\.){3}\g&lt;ip_number&gt; ){0}</span>
</span><span class='line'>
</span><span class='line'><span class="sr">   (?&lt;admin&gt; true | false ){0}</span>
</span><span class='line'>
</span><span class='line'><span class="sr">   \g&lt;username&gt;:\g&lt;ip_address&gt;:\g&lt;admin&gt;</span>
</span><span class='line'><span class="sr"> }x</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Mnemonics</h3>

<p>Our memory also struggles to find mnemonics or associations to remember the full vocabary of regexps:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='perl'><span class='line'><span class="c1">#Some easy ones</span>
</span><span class='line'><span class="o">/</span><span class="n">w</span> <span class="c1">#word</span>
</span><span class='line'><span class="o">/</span><span class="n">s</span> <span class="c1">#space</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#Harder ones</span>
</span><span class='line'><span class="p">(?</span><span class="o">&lt;!</span><span class="n">pat</span><span class="p">)</span>
</span><span class='line'><span class="p">(?</span><span class="o">&lt;=</span><span class="n">pat</span><span class="p">)</span>
</span><span class='line'><span class="p">(?</span><span class="o">!</span><span class="n">pat</span><span class="p">)</span>
</span><span class='line'><span class="p">(?</span><span class="o">=</span><span class="n">pat</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Reducing the Density of Regular Expressions</h2>

<p>Creating a DSL for parsing text is a huge domain. The power of regular expressions is very clear.</p>

<p>Yet there have been attempts in various languages to move regular expressions towards a more verbose form to improve readability.</p>

<h3>Regexp::English</h3>

<p>The Perl community has attempted to provide a more English, verbose syntax for regular expressions:</p>

<blockquote><p><a href="http://search.cpan.org/~chromatic/Regexp-English-1.01/lib/Regexp/English.pm">Regexp::English</a> provides an alternate regular expression syntax, one that is slightly more verbose than the standard mechanisms</p></blockquote>

<p>Lets look at an example:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='perl'><span class='line'>        <span class="k">use</span> <span class="nn">Regexp::</span><span class="n">English</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">my</span> <span class="nv">$re</span> <span class="o">=</span> <span class="nn">Regexp::</span><span class="n">English</span>
</span><span class='line'>                <span class="o">-&gt;</span> <span class="n">start_of_line</span>
</span><span class='line'>                <span class="o">-&gt;</span> <span class="n">literal</span><span class="p">(</span><span class="s">&#39;Flippers&#39;</span><span class="p">)</span>
</span><span class='line'>                <span class="o">-&gt;</span> <span class="n">literal</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">)</span>
</span><span class='line'>                <span class="o">-&gt;</span> <span class="n">optional</span>
</span><span class='line'>                        <span class="o">-&gt;</span> <span class="n">whitespace_char</span>
</span><span class='line'>                <span class="o">-&gt;</span> <span class="n">end</span>
</span><span class='line'>                <span class="o">-&gt;</span> <span class="n">remember</span>
</span><span class='line'>                        <span class="o">-&gt;</span> <span class="n">multiple</span>
</span><span class='line'>                                <span class="o">-&gt;</span> <span class="n">digit</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">while</span> <span class="p">(</span><span class="o">&lt;</span><span class="n">input</span> <span class="o">/&gt;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">if</span> <span class="p">(</span><span class="k">my</span> <span class="nv">$match</span> <span class="o">=</span> <span class="nv">$re</span><span class="o">-&gt;</span><span class="n">match</span><span class="p">(</span><span class="nv">$_</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>                        <span class="k">print</span> <span class="s">&quot;$match\n&quot;</span><span class="p">;</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Better?</p>

<h2>Loving the Density of Regular Expressions</h2>

<p>Clearly there has been some recognition among developers that regexp could be improved by being more verbose. Its interesting that these attempts are considered failures. It would imply the majority of developers prefer dense regexps.</p>

<blockquote><p>&ldquo;you can document them with comments, named capture groups, composing them from well-named variables. of course, no one does those things.&rdquo;
Tom Stuart</p></blockquote>

<p>In the Perl community some people have given up completely on the humans and their dense, hard to maintain regular expressions.
They create tools to decode the density automatically:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='perl'><span class='line'><span class="k">use</span> <span class="nn">YAPE::Regex::</span><span class="n">Explain</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">print</span> <span class="nn">YAPE::Regex::</span><span class="n">Explain</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span><span class="sx">qr/this.*(?:that)?(?!another)/</span><span class="p">)</span>
</span><span class='line'>      <span class="o">-&gt;</span><span class="n">explain</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Outputs:</p>

<pre><code>The regular expression:

(?-imsx:this.*(?:that)?(?!another))

matches as follows:

NODE                     EXPLANATION
----------------------------------------------------------------------
(?-imsx:                 group, but do not capture (case-sensitive)
                         (with ^ and $ matching normally) (with . not
                         matching \n) (matching whitespace and #
                         normally):
----------------------------------------------------------------------
  this                     'this'
----------------------------------------------------------------------
  .*                       any character except \n (0 or more times
                           (matching the most amount possible))
----------------------------------------------------------------------
  (?:                      group, but do not capture (optional
                           (matching the most amount possible)):
----------------------------------------------------------------------
    that                     'that'
----------------------------------------------------------------------
  )?                       end of grouping
----------------------------------------------------------------------
  (?!                      look ahead to see if there is not:
----------------------------------------------------------------------
    another                  'another'
----------------------------------------------------------------------
  )                        end of look-ahead
----------------------------------------------------------------------
)                        end of grouping
----------------------------------------------------------------------
</code></pre>

<p>Some snippets on developers thoughts about regular expressions:</p>

<blockquote><p>&ldquo;Love them, probably because theyre a form of arcane magic and they make me feel special for being able to control them&rdquo;</p>

<p>&ldquo;I think they are geek candy &hellip; sometimes used to show off maximum geekness&rdquo;</p>

<p>&ldquo;Love them because they make me look clever and LIKE A H4XX0rrrrr!&rdquo;</p></blockquote>

<h2>The Aesthetics of Density</h2>

<p>Regular expressions have succeeded and they are one of the few very dense languages to have done so.</p>

<p>The density of regular expressions make the initial barrier to getting started and moving to expert high. They are far from what we imagine in a literate programming style, yet once you have the syntax in your head, movement becomes fluid, you think in regular expressions. Dense languages with a very limited common syntax set allow experimenting rapidly. Without practice dense languages quickly drop from your mind and you struggle to fit the problem into the right expressive form.</p>

<p>There is an undeniable beauty in the density of regular expressions, in both syntax and expression.</p>

<p>Finding prime numbers using a single  Regexp:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='perl'><span class='line'><span class="sr">/^1?$|^(11+?)\1+$/</span>
</span></code></pre></td></tr></table></div></figure>


<p>It&rsquo;s also drink absinthe and cut off your own ear crazy.</p>

<p><img src="/images/blog/2012/12/Vincent-Van-Gogh-001-150x150.jpg" alt="" /></p>

<p>I wrote this <a href="https://github.com/josephwilk/iwfms/blob/master/cgi-bin/planner/eventCalculusPlanner.pl">PROLOG code for my thesis</a>. I have no idea how it works now and it would take me about a month of playing with it to get back to a state where the dense language was back in my head and I could express ideas in the PROLOG way.</p>

<p>I spent over a month adding nothing more than a single &ldquo;!&rdquo; mark in the code.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='prolog'><span class='line'><span class="nf">abdemo_holds_ats</span><span class="p">([</span><span class="nf">holds_at</span><span class="p">(</span><span class="nv">F</span><span class="p">,</span><span class="nv">T</span><span class="p">)|</span><span class="nv">Gs</span><span class="p">],</span><span class="nv">R1</span><span class="p">,</span><span class="nv">R3</span><span class="p">,</span><span class="nv">N1</span><span class="p">,</span><span class="nv">N3</span><span class="p">,</span><span class="nv">D</span><span class="p">)</span> <span class="p">:-</span>
</span><span class='line'>     <span class="p">!,</span>
</span><span class='line'>     <span class="nf">abdemo</span><span class="p">([</span><span class="nf">holds_at</span><span class="p">(</span><span class="nv">F</span><span class="p">,</span><span class="nv">T</span><span class="p">)],</span><span class="nv">R1</span><span class="p">,</span><span class="nv">R2</span><span class="p">,</span><span class="nv">N1</span><span class="p">,</span><span class="nv">N2</span><span class="p">,</span><span class="nv">D</span><span class="p">),</span>
</span><span class='line'>
</span><span class='line'>     <span class="c1">%cut added Joseph Wilk 16/03/2004</span>
</span><span class='line'>     <span class="p">!,</span>
</span><span class='line'>     <span class="nf">abdemo_holds_ats</span><span class="p">(</span><span class="nv">Gs</span><span class="p">,</span><span class="nv">R2</span><span class="p">,</span><span class="nv">R3</span><span class="p">,</span><span class="nv">N2</span><span class="p">,</span><span class="nv">N3</span><span class="p">,</span><span class="nv">D</span><span class="p">).</span>
</span></code></pre></td></tr></table></div></figure>


<p>I still feel its some of the most beautiful code I&rsquo;ve written. Why?</p>

<p>I revel in the expressive density. Bending my brain to express my thoughts in the densely expressive PROLOG way.</p>

<p>I guiltily dip into the syntactical density because it&rsquo;s like the detailing on the brush strokes of a painting.</p>

<p><img src="/images/blog/2012/12/Grunge-Brush-Strokes-Banner-150x150.jpg" alt="" /></p>

<p>Would I ever write this code in a production system that developers would have to maintain? Hell no.</p>

<p>Would I consider this literate programming? Hell no. Just look at the 100 of lines of comments.</p>

<p>But for the sake of art and realising a form of flow I&rsquo;ve not encountered since, I would happily revel in the aesthetics of density.</p>

<p><img src="/images/blog/2012/12/6751247749_4f91cb69f2_z.jpg" alt="" />
Michael Wolf Architecture of Density no.36: <a href="http://www.flickr.com/photos/worldeconomicforum/6751247749">http://www.flickr.com/photos/worldeconomicforum/6751247749/</a></p>
</div>




    </article>


    <article>

  <header>

      <h1 class="entry-title"><a href="/rhetorical-programming/why-are-you-shouting-programmer.html">Why Are You SHOUTING Programmer?</a></h1>


      <p class="meta">












<time datetime="2012-11-19T00:00:51+00:00" pubdate data-updated="true">Nov 19<span>th</span>, 2012</time>

      </p>

  </header>


  <div class="entry-content"><p>Being shouted at is not a lot of fun. So why do we shout in code?</p>

<p><img src="/images/blog/2012/11/image1-201x300.jpg" alt="" /></p>

<h2>Shouting code</h2>

<p>Compare</p>

<pre><code>"how_many_monkeys_can_a_monkey_eat_before_it_explodes"
</code></pre>

<p>and:</p>

<pre><code>"HOW_MANY_MONKEYS_CAN_A_MONKEY_EAT_BEFORE_IT_EXPLODES"
</code></pre>

<p>How do you read those differently in your head?</p>

<p>We associate capital letters with someone shouting.</p>

<p>Now lets turn to two functionally equivalent pieces of Ruby code:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Monkey</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">capacity</span>
</span><span class='line'>    <span class="mi">10</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">stomach</span>
</span><span class='line'>      <span class="s2">&quot;I can fit </span><span class="si">#{</span><span class="n">capacity</span><span class="si">}</span><span class="s2"> monkeys in my belly&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>And</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Monkey</span>
</span><span class='line'>  <span class="no">CAPACITY</span> <span class="o">=</span> <span class="mi">10</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">stomach</span>
</span><span class='line'>    <span class="s2">&quot;I can fit </span><span class="si">#{</span><span class="no">CAPACITY</span><span class="si">}</span><span class="s2"> monkeys in my belly&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Constants are shouted. Why do we shout? Because:</p>

<ul>
<li><p>We are angry</p></li>
<li><p>We have something we think is important and we want everyone to hear it.</p></li>
</ul>


<p>Why in Ruby are constants uppercase? Well they don&rsquo;t have to be, Ruby constrains us to ensuring the first letter is a capital.
We get warnings if we try and reassign their value but ultimately they are just Fixnums. In order to stick with our Ruby naming convention we use &lsquo;_&rsquo; and all caps.</p>

<p>So its a combination or <strong>telling the compiler that this value is a constant</strong> and <strong>fitting with the naming scheme</strong> in Ruby.</p>

<p>We shout because society indicates to us thats the normal behaviour and we all want to be nice citizens of the Ruby republic.</p>

<p>As a side effect constants feel like they are more important than the other variables or methods. They should take our attention first.</p>

<h2>Reading uppercase is slow</h2>

<p>What wait a minute isn&rsquo;t uppercase text harder to read? There is evidence [1] to show that all-caps is less legible and less readable than lower case. So constants are harder for us to read.</p>

<blockquote><p>lowercase permits reading by word units, while all capitals tend to be read letter by letter</p></blockquote>

<h2>Numbers, letters and uppercase</h2>

<p>A common use of shouting case is constants used to remove magic numbers from calculations.</p>

<pre><code>1000 * 667895 / LIMIT + 475436
</code></pre>

<p>The brain recognises numbers and letters very differently. The brain in general can recognise words faster than a sequence of digits since with a word we do not need to read each character in order to recognise the word.</p>

<p>To see for yourself try and read the following:</p>

<blockquote><p>The hmaun mind does not raed eervy letter by istlef but the word as aa woelh.</p></blockquote>

<p>Compare how much more time it takes you to read the numbers.</p>

<blockquote><p>124 3456 3234 5443 3342 55334 66554 47567</p></blockquote>

<p>By uppercasing the constant we are slowing down this natural ability to read words.</p>

<p>Compare again:</p>

<pre><code>1000 * 667895 / LIMIT + 475436
</code></pre>

<p>With:</p>

<pre><code>1000 * 667895 / limit + 475436
</code></pre>

<p>Do we really need this further uppercase difference? With the instinctive separation between words and letters the further effort and cognitive slow down has little value.</p>

<h3>Immutability vs Mutability</h3>

<p>A legitimate case were it does become useful to use shouting case is where you want to distinguish between variables/functions and constants. Expressing that a value is immutable in comparison to a mutable variable is important in a language like Ruby were immutability is not the norm.</p>

<pre><code>1000 * 667895 + scale / LIMIT + 475436 - radius
</code></pre>

<h2>Shouting in technicolor</h2>

<p>Editors often provide color markup for words in uppercase. For example for Ruby in Textmate:</p>

<p><img src="/images/blog/2012/11/Screen-Shot-2012-11-17-at-15.00.41.png" alt="" /></p>

<p>Though they also provide the difference between variables/function and numbers.
Shouting provides us with a discernible way to see all constants within the code at glance based on colour.</p>

<h2>History of shouting in code</h2>

<p>How or where did this convention of uppercasing constants come from?
Why is it a convention?
When did we start shouting in our code?</p>

<p>What made us so mad?</p>

<h4>Assembly</h4>

<p>It started with assembly,  the convention was to uppercase variables names and lowercase instructions.</p>

<pre><code>ADCTL  = 0x30
staa ADCTL,X
</code></pre>

<p>Variable names were limited in length, so often variable names were acronyms, which in English are often capitalised (we just skipped the dot). Registers, memory &amp; caches all had nice acronyms which you could reference in your assembly.</p>

<p><img src="/images/blog/2012/11/image5-150x150.jpg" alt="" /></p>

<p>Assembly was more machine centric than human centric. Not quite shouting as we know it now (though its understandable we were angry with all that ugly code).</p>

<h4>FLOW-MATIC</h4>

<p>The birth of programming in English. It was not a pretty birth, this thing was born shouting very loudly. EVERYTHING is in capitals, even the programming languages name!</p>

<pre><code>INPUT  INVENTORY FILE=A
 PRICE FILE=B,
 OUTPUT PRICED-INV FILE=C
 UNPRICED-INV FILE=D,
 HSP D.
</code></pre>

<p>Flow-Matic had the builtin inconstant ZERO. Our first example of a Constant but where everything is capitalised so it is not distinguished from other code.</p>

<h4>FORTRAN</h4>

<p>FORTRAN was a confused language when it came to shouting. The use of lowercase letters in keywords was strictly nonstandard.</p>

<pre><code>IF (IA+IC-IB) 777,777,705
IF (IB+IC-IA) 777,777,799
STOP 1
C USING HERON'S FORMULA WE CALCULATE THE
C AREA OF THE TRIANGLE
S = FLOATF (IA + IB + IC) / 2.0
AREA = SQRT( S * (S - FLOATF(IA)) * (S - FLOATF(IB)) + (S - FLOATF(IC)))
WRITE OUTPUT TAPE 6, 601, IA, IB,
STOP
END
</code></pre>

<p>But then the liberation came and after a bloody battle FORTRAN was renamed Fortran.</p>

<p><img src="/images/blog/2012/11/fist-150x150.png" alt="" /></p>

<p>In this new post revolution age Fortran&rsquo;s compiler was a liberal one, not caring about shouting or case at all.</p>

<pre><code>program helloworld
     print *, "Hello, world."
end program helloworld
</code></pre>

<p>The society on the other hand was still very keen to tell its citizens when they should shout. It was a social coding convention that local variables be in lowercase and language keywords be in uppercase.</p>

<p>Language keywords were more important and hence shouted. Far more important than those pesky human named local variables. This inverted the previous Assembly conventions on the use of case.</p>

<h4>LISP</h4>

<p>Common Lisp is case sensitive but the Common Lisp reader converts all uppercase to lower case:</p>

<pre><code>(defun hi () "Hi!)
(hi) ;; outputs "Hi"
(HI) ;; outputs "Hi"
(Hi) ;; outputs "Hi"
</code></pre>

<p>LISP had a social convention to only use lowercase (one might think to avoid confusing situations like the one above). Did LISPeans shout at all? They did when it came to  documentation strings:</p>

<blockquote><p>&ldquo;In a documentation string, when you need to refer to function arguments, names of classes, or other lisp objects, write these names in all uppercase, so that they are easy to find&rdquo;</p></blockquote>

<p>This was to help humans easily find them and because documentation generation tools could detect them.</p>

<p>Shouting the references in unstructured text made them clearly visible to both machines and humans.</p>

<h4>COBOL</h4>

<p>COBOL is another of those shouting languages which liked everything in uppercase. Which makes reading a COBOL program akin to having someone shout very loudly in your face. Until you cry. Lots.</p>

<p><img src="/images/blog/2012/11/image6-150x150.jpg" alt="" /></p>

<pre><code>01 RECORD-NAME.
02 DATA-NAME-1-ALPHA PIC X(2).
02 DATA-NAME-2.
03 DATA-NAME-3-NUMERIC PIC 99.
03 DATA-NAME-4.
04 DATA-NAME-5-ALPHA PIC X(2).
04 DATA-NAME-6-NUMERIC PIC 9(5).
02 DATA-NAME-7-ALPHA PIC X(6).
</code></pre>

<p>The only thing that was not upper case was comments.</p>

<blockquote><p>It helps if all comments are in lower-case, to differentiate from actual commands which should always be in upper-case</p></blockquote>

<p>Comments where not important, so no need to shout them. Which in turn makes them easier to read. Perhaps there is an understanding here that shouting makes code hard to read. Comments which might contain a lot of text should also be easier to read.</p>

<p>If you were still in doubt about COBOL&rsquo;s evilness: user defined constants were distinguished by using a <strong>single character variable name</strong>. MAD. YES THAT WAS WORTH SHOUTING.</p>

<h4>Basic</h4>

<p>In basic keywords were capitalised to distinguish between variables names. The case is insignificant, it&rsquo;s for the humans not the compiler.</p>

<pre><code>LET m = 2
LET a = 4
LET force = m*a
PRINT force
END
</code></pre>

<p>Keys words are important, so shout them. But in turn make it easier to read the user named variables by leaving them lower case.</p>

<h4>C</h4>

<p>C uses uppercase by convention for object-like Macros which get replaced during pre-processing.</p>

<pre><code>#define BUFFER_SIZE 1024
foo = (char *) malloc (BUFFER_SIZE);
</code></pre>

<p>Uppercase is used to defined a templating language within C, which we can quickly distinguish from the code. It also makes the job of the pre-processor easier, parsing macros.</p>

<h2>So is shouting a bad thing?</h2>

<p>When it comes to expressing ideas in nothing but text we use everything we can to provide structure and separation to help improve clarity. Shouting or uppercasing words provides a very powerful way of rapidly distinguishing certain aspects of text.</p>

<p>How programming languages spend this limited currency of instinctive separation reflects the languages understanding of readability (i&rsquo;m looking at you COBOL) and what they find to be important enough to earn shouting case.</p>

<p>However most modern languages provide you with the choice of shouting. In Ruby we can skip it all together.</p>

<p>Try not shouting for a while. See how it makes you feel.</p>

<p><img src="/images/blog/2012/11/shhh1-150x150.png" alt="" /></p>

<p>And always:</p>

<p>TRY AND AVOID SHOUTING FOR TOO LONG AS IT IS HARD TO READ.</p>

<p>Keep it <strong>sharp</strong>, <strong>short</strong> and <strong>loud</strong>.</p>

<h2>References</h2>

<p>[1] <a href="http://www.amazon.co.uk/gp/product/0962489158/ref=as_li_ss_tl?ie=UTF8&amp;camp=1634&amp;creative=19450&amp;creativeASIN=0962489158&amp;linkCode=as2&amp;tag=joswilblo-21">Type and Layout: How Topography and Design Can Get Your Message Across &ndash; Or get in the Way</a></p>
</div>




    </article>


    <article>

  <header>

      <h1 class="entry-title"><a href="/ruby/recurrent-neural-networks-in-ruby.html">Recurrent Neural Networks in Ruby</a></h1>


      <p class="meta">












<time datetime="2012-10-29T14:00:30+00:00" pubdate data-updated="true">Oct 29<span>th</span>, 2012</time>

      </p>

  </header>


  <div class="entry-content"><p>We look at how neural networks work, what is different about a recurrent networks and a library which allows us to use recurrent networks in Ruby (<a href="https://github.com/josephwilk/tlearn-rb">tlearn-rb</a>).</p>

<h2>What the heck is a Recurrent Network?</h2>

<p>First lets look briefly at how a neural network works:</p>

<h2>Neural Networks</h2>

<p>Neural networks use the model of neurones in the human brain. Put very simply the artifical neuron given some inputs (the dendrites) sums them to produce an output (the neuron&rsquo;s axon) which is usually passed through some non-linear function. The sum of the nodes is usually weighted.</p>

<p><img src="/images/blog/2012/10/image1.jpg" alt="" /></p>

<p>By taking a set of training data we can teach a neural network such that it can be applied to new data outside of the training set. For example we could have as inputs the states of a chess board and the output as a rank for how good the position is for white. We could after training, input an unseen board state and as output get a rank for how effective the position is for white.</p>

<p>As a neural network is trained it builds up the set of weights for the connections between nodes. Through many training iterations comparing expected outputs and the inputs these weights are built up.</p>

<h4>Feedforward Neural Network</h4>

<p><img src="/images/blog/2012/10/neural_network1.png" alt="" /></p>

<p>In some problems the order in which the inputs arrive at the network is important. A normal network fails at this as there is no explicit sense of the relationships between sets of inputs.</p>

<p>Lets consider an example. A network that is trained to detect how satisfying a word sounds to children.</p>

<p>We feed our network all the syllables of a word and get an output:</p>

<pre><code>["mon", "key"]
["o", "key", "do", "key"]
</code></pre>

<p>When we feed the syllable <em>&ldquo;key&rdquo; </em>into the neural network it will always return the same output irrelevant of what came before it. This misses a relationship between the syllables of the word.</p>

<p>A recurrent network aims to solve this problem by using both the input layer and the output layer to devise weights of the hidden layer.</p>

<h4>Recurrent Network</h4>

<p><img src="/images/blog/2012/10/recurrent_neural_network1.png" alt="" /></p>

<p>Going back to our example:</p>

<pre><code>["mon", "key"]
["o", "key", "do", "key"]
</code></pre>

<p>When we feed <em>&ldquo;key&rdquo;</em> into the neural network the weight returned will be effected by what the previous input was, [&ldquo;mon&rdquo;] or [&ldquo;o&rdquo;, &ldquo;key&rdquo;, &ldquo;do&rdquo;].</p>

<p>So our recurrent neural network would detect that &ldquo;o-key-do-key&rdquo; has a rhythm between the syllables that is appealing to children.</p>

<p>A recurrent network allows us to decided when to wipe the previous output and start again. So in our example we would reset the output layer after we have fed in all the syllables of the word. We are interested in the relationships between syllables of a word, not syllables of different words.</p>

<p><strong>So all this is a complicated way of saying Recurrent networks have state. Yes.</strong></p>

<h2>Recurrent Networks in Ruby</h2>

<p>There was no Ruby library that support Recurrent Networks. There was an <a href="http://leenissen.dk/fann/forum/viewtopic.php?t=47">attempt to add Recurrent networks</a> to <a href="http://leenissen.dk/fann/wp">FANN</a> (which has a <a href="http://ruby-fann.rubyforge.org/">ruby-fann gem</a> with bindings) but it was never merged in.</p>

<p>So I adapted the <a href="http://crl.ucsd.edu/innate/tlearn.html">TLearn C library</a> which supports Recurrent Neural Networks and wrapped it in Ruby Love.</p>

<p>It&rsquo;s having some trouble coming to terms with its new found rubyness, so there is a big alpha warning hanging on the door.</p>

<h3>Installing TLearn</h3>

<pre><code>gem install tlearn
</code></pre>

<h3>Using TLearn</h3>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;tlearn&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">tlearn</span> <span class="o">=</span> <span class="ss">TLearn</span><span class="p">:</span><span class="ss">:Run</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:number_of_nodes</span> <span class="o">=&gt;</span> <span class="mi">10</span><span class="p">,</span>
</span><span class='line'>                    <span class="ss">:&#39;output_nodes&#39;</span>    <span class="o">=&gt;</span> <span class="mi">5</span><span class="o">.</span><span class="n">.</span><span class="mi">6</span><span class="p">,</span>
</span><span class='line'>                    <span class="ss">:linear</span>          <span class="o">=&gt;</span> <span class="mi">7</span><span class="o">.</span><span class="n">.</span><span class="mi">10</span><span class="p">,</span>
</span><span class='line'>                    <span class="ss">:weight_limit</span>    <span class="o">=&gt;</span> <span class="mi">1</span><span class="o">.</span><span class="mo">00</span><span class="p">,</span>
</span><span class='line'>                    <span class="ss">:connections</span>     <span class="o">=&gt;</span> <span class="o">[</span><span class="p">{</span><span class="mi">1</span><span class="o">.</span><span class="n">.</span><span class="mi">6</span>   <span class="o">=&gt;</span> <span class="mi">0</span><span class="p">},</span>
</span><span class='line'>                                         <span class="p">{</span><span class="mi">1</span><span class="o">.</span><span class="n">.</span><span class="mi">4</span>   <span class="o">=&gt;</span> <span class="ss">:i1</span><span class="o">.</span><span class="n">.</span><span class="ss">:i3</span><span class="p">},</span>
</span><span class='line'>                                         <span class="p">{</span><span class="mi">1</span><span class="o">.</span><span class="n">.</span><span class="mi">4</span>  <span class="o">=&gt;</span> <span class="mi">7</span><span class="o">.</span><span class="n">.</span><span class="mi">10</span><span class="p">},</span>
</span><span class='line'>                                         <span class="p">{</span><span class="mi">5</span><span class="o">.</span><span class="n">.</span><span class="mi">6</span>   <span class="o">=&gt;</span> <span class="mi">1</span><span class="o">.</span><span class="n">.</span><span class="mi">4</span><span class="p">},</span>
</span><span class='line'>                                         <span class="p">{</span><span class="mi">7</span><span class="o">.</span><span class="n">.</span><span class="mi">10</span>  <span class="o">=&gt;</span> <span class="o">[</span><span class="mi">1</span><span class="o">.</span><span class="n">.</span><span class="mi">4</span><span class="p">,</span> <span class="p">{</span><span class="ss">:min</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="p">,</span> <span class="ss">:max</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="p">},</span> <span class="ss">:fixed</span><span class="p">,</span> <span class="ss">:&#39;one_to_one&#39;</span><span class="p">}</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'><span class="n">training_data</span> <span class="o">=</span> <span class="o">[</span><span class="p">{</span><span class="o">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="o">]</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="o">]</span><span class="p">}</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'>                 <span class="o">[</span><span class="p">{</span><span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="o">]</span>  <span class="o">=&gt;</span> <span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="o">]</span><span class="p">}</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'><span class="n">tlearn</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">training_data</span><span class="p">,</span> <span class="n">sweeps</span> <span class="o">=</span> <span class="mi">200</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">tlearn</span><span class="o">.</span><span class="n">fitness</span><span class="p">(</span><span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="o">]</span><span class="p">,</span> <span class="n">sweeps</span> <span class="o">=</span> <span class="mi">200</span><span class="p">)</span>
</span><span class='line'><span class="c1"># =&gt; [0.2, 0.9]</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Wait! What does that output mean?</h3>

<p>In our example we had 2 outputs. The result we get from running the fitness test are the final weights:</p>

<pre><code>[0.2, 0.9]
</code></pre>

<p>In this example we can think of the first output as rank 1, and the second output as rank 2. We look at which has the highest weighting in the fitness test, In this case it shows us that the input &ldquo;000&rdquo; has rank 2. So really we can map the output to many different classifications.</p>

<h3>How is state reset?</h3>

<p>Tlearn resets the state for each list of elements</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">[</span><span class="p">{</span><span class="o">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="o">]</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="o">]</span><span class="p">},</span> <span class="p">{</span><span class="o">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="o">]</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="o">]</span><span class="p">}</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'><span class="c1"># State will be reset here</span>
</span><span class='line'><span class="o">[</span><span class="p">{</span><span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="o">]</span>  <span class="o">=&gt;</span> <span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="o">]</span><span class="p">}</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Wait! What the heck does all that config mean?</h3>

<p>Part of the work of using Neural networks is finding the right configuration settings. TLearn supports a lot of different options. Lets look at what all that  configuration options means. (Checkout the <a href="https://github.com/josephwilk/tlearn-rb#configuring-tlearn-what-the-heck-does-all-that-config-mean">TLearn Github Readme</a> for full details of the config options):</p>

<pre><code>:number_of_nodes =&gt; 10
</code></pre>

<p>The total number of nodes in this network (not including input nodes)</p>

<pre><code>:'output_nodes'    =&gt; 5..6
</code></pre>

<p>Which nodes are used for output.</p>

<pre><code>:linear          =&gt; 7..10
</code></pre>

<p>Nodes 7 to 10 are linear. This defines the activation function of the nodes. The activation function is how all the weights and input are combined for a node to create an output. Linear nodes output the inner-product of the input and weight vectors.</p>

<pre><code>:weight_limit    =&gt; 1.00
</code></pre>

<p>Limit of 1.0 must not be exceeded in the random initialization of weights.</p>

<h4>Connections</h4>

<p>Connections specify how all the nodes of the neural network connect. This is the architecture of the neural network. Lets look at the connection settings:</p>

<pre><code>{1..6   =&gt; 0}
</code></pre>

<p>Node 0 feeds into node 1 to 6. Node 0 is the bias node that is always 1.</p>

<p><img src="/images/blog/2012/10/bias_node.png" alt="" /></p>

<pre><code> {1..4   =&gt; :i1..:i3}
</code></pre>

<p>The input nodes 1-3 feed into each node from 1 to 4.
<img src="/images/blog/2012/10/inputs1.png" alt="" /></p>

<pre><code>{1..4  =&gt; 7..10},
</code></pre>

<p>Nodes nodes 7-10 feed into each node from 1 to 4
<img src="/images/blog/2012/10/outout.png" alt="" /></p>

<pre><code>{5..6   =&gt; 1..4},
</code></pre>

<p>Nodes nodes 1..4 feed into each node from 5 to 6
<img src="/images/blog/2012/10/outes.png" alt="" /></p>

<pre><code> {7..10  =&gt; [1..4, {:min =&gt; 1.0, :max =&gt; 1.0}, :fixed, :'one_to_one'}]
</code></pre>

<p>This connection contains a couple of special options. Rather than node 1-4 being fed into node 7, node 1 only connects with node 7, node 2 only with node 8, node 3 only with node 9, node 4 only with node 10. The <em>:&lsquo;one_to_one&rsquo;</em> option causes this.
The weights of the connections between these nodes is <em>fixed</em> at 1.0 and never changes throughout training</p>

<p><img src="/images/blog/2012/10/ins.png" alt="" /></p>

<p>So put all these together our full neural network is:</p>

<p><img src="/images/blog/2012/10/network-out1.png" alt="" /></p>

<h3>Urmm&hellip; So how do I know what connection settings to use?</h3>

<p>When it comes to deciding how many hidden nodes to have in your network there is a general rule:</p>

<blockquote><p>The optimal number of hidden nodes is usually between the size of the input and size of the output layers</p></blockquote>

<p>When deciding what connections to specify in your neural network you can start with everything connected to everything and slowly experiment with pruning connections/nodes which will increase the performance of your network without radically affecting the output efficiency.</p>

<p>Its important to have the bias node connect to all the nodes in the hidden layer and output. This is required so a zero input to the neural network can generate outputs other than 0.</p>

<p>With recurrent networks it is important to build connections and nodes in your network to maintain state. It is quite possible with TLearn to build a plain old neural network with no state.  It can be helpful like the example given above to draw out your state, hidden layer and output layer nodes and use this to decided how the network connects.</p>

<p>How do you decide what activation functions to use? Linear, bipolar, etc.
Checkout this great paper on the effectiveness of different functions: <a href="http://www.cscjournals.org/csc/manuscript/Journals/IJAE/volume1/Issue4/IJAE-26.pdf">http://www.cscjournals.org/csc/manuscript/Journals/IJAE/volume1/Issue4/IJAE-26.pdf</a></p>

<p>One neat (crazy) experimental (crazy) path to explore is neural network toplogies generated from using a genetic algorithm to assess the effectiveness of the network: <a href="http://www.cs.ucf.edu/~kstanley/neat.html">http://www.cs.ucf.edu/~kstanley/neat.html</a>.</p>

<h3>TLearn&rsquo;s Source</h3>

<p>If you want to peer into the heart of TLearn the source code is on Github:</p>

<pre><code>git clone git://github.com/josephwilk/tlearn-rb.git
</code></pre>

<h3>Further reading</h3>

<ul>
<li><a href="http://www.amazon.co.uk/gp/product/B00845UQL6/ref=as_li_ss_tl?ie=UTF8&amp;camp=1634&amp;creative=19450&amp;creativeASIN=B00845UQL6&amp;linkCode=as2&amp;tag=joswilblo-21">Introduction to the Math of Neural Networks</a><img src="http://www.assoc-amazon.co.uk/e/ir?t=joswilblo-21&amp;l=as2&amp;o=2&amp;a=B00845UQL6" alt="" /></li>
</ul>

</div>




    </article>


    <article>

  <header>

      <h1 class="entry-title"><a href="/presentations/someone-is-wrong.html">Someone Is Wrong</a></h1>


      <p class="meta">












<time datetime="2012-09-07T23:35:45+01:00" pubdate data-updated="true">Sep 7<span>th</span>, 2012</time>

      </p>

  </header>


  <div class="entry-content"><p>Understanding Rhetoric is an essential skill for any programmer.</p>

<p>Here is my introduction talk &ldquo;Someone is wrong&rdquo;, rhetoric for programmers.</p>

<p><a href="http://programme.scottishrubyconference.com/proposals/144/video">Video from Scottish Ruby conference</a></p>

<h2>Slides</h2>

<script async class="speakerdeck-embed" data-id="4ff1e7144b8be00184011461" data-ratio="1.33333333333333" src="//speakerdeck.com/assets/embed.js"></script>


<h2>Further Reading</h2>

<ul>
<li><p><a href="http://www.amazon.co.uk/gp/product/0141032588/ref=as_li_tf_tl?ie=UTF8&amp;camp=1634&amp;creative=6738&amp;creativeASIN=0141032588&amp;linkCode=as2&amp;tag=joswilblo-21">Winning Arguments: From Aristotle to Obama &ndash; Everything You Need to Know About the Art of Persuasion</a><img src="http://www.assoc-amazon.co.uk/e/ir?t=joswilblo-21&amp;l=as2&amp;o=2&amp;a=0141032588" alt="" /></p></li>
<li><p><a href="http://www.informationisbeautiful.net/visualizations/rhetological-fallacies">Rhetological Fallacies</a></p></li>
</ul>


<h2>What people said about this talk</h2>

<p><img src="/images/blog/2012/09/what_they_said_double.png" alt="" /></p>
</div>




    </article>


    <article>

  <header>

      <h1 class="entry-title"><a href="/ruby/fake-execution.html">Fake Execution</a></h1>


      <p class="meta">












<time datetime="2012-08-30T17:51:07+01:00" pubdate data-updated="true">Aug 30<span>th</span>, 2012</time>

      </p>

  </header>


  <div class="entry-content"><p>A little RubyGem for faking out execution in your tests and inspecting afterwards what was run.</p>

<h2>Why FakeExecution?</h2>

<p>I&rsquo;ve been creating internal tools for developers to help improve productivity. These tools written in Ruby, ended up doing lots of shell scripting. These scripts started becoming fairly complicated so I wanted some test feedback. How could I easily test execution?</p>

<p>Enter FakeExecution.</p>

<h2>Installing</h2>

<pre><code>gem install fake_execution
</code></pre>

<h2>How do I use it?</h2>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;fake_execution/safe&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="no">FakeExecution</span><span class="o">.</span><span class="n">activate!</span>
</span><span class='line'>
</span><span class='line'><span class="sb">`echo *`</span> <span class="c1"># This is not executed</span>
</span><span class='line'>
</span><span class='line'><span class="sb">`git checkout git://github.com/josephwilk/fake-execution.git`</span>
</span><span class='line'><span class="sb">`touch monkeys`</span>
</span><span class='line'><span class="nb">system</span><span class="p">(</span><span class="s2">&quot;git add monkeys&quot;</span><span class="p">)</span>
</span><span class='line'><span class="nb">system</span><span class="p">(</span><span class="s1">&#39;git commit -m &quot;needs more monkeys&quot;&#39;</span><span class="p">)</span>
</span><span class='line'><span class="sb">`git push`</span>
</span><span class='line'>
</span><span class='line'><span class="no">FakeExecution</span><span class="o">.</span><span class="n">deactivate!</span>
</span><span class='line'>
</span><span class='line'><span class="n">cmds</span><span class="o">[</span><span class="mi">0</span><span class="o">].</span><span class="n">should</span> <span class="o">=~</span> <span class="sr">/echo/</span>
</span><span class='line'><span class="n">cmds</span><span class="o">[</span><span class="mi">1</span><span class="o">].</span><span class="n">should</span> <span class="o">=~</span> <span class="sr">/git checkout/</span>
</span><span class='line'><span class="n">cmds</span><span class="o">[</span><span class="mi">2</span><span class="o">].</span><span class="n">should</span> <span class="o">==</span> <span class="s1">&#39;touch monkeys&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="sb">`echo *`</span> <span class="c1"># outputs: echo *</span>
</span></code></pre></td></tr></table></div></figure>


<h2>But I use Rspec</h2>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'> <span class="nb">require</span> <span class="s1">&#39;fake_execution/spec_helper&#39;</span>
</span><span class='line'>
</span><span class='line'> <span class="n">describe</span> <span class="s2">&quot;monkeys&quot;</span> <span class="k">do</span>
</span><span class='line'>   <span class="kp">include</span> <span class="ss">FakeExecution</span><span class="p">:</span><span class="ss">:SpecHelpers</span>
</span><span class='line'>
</span><span class='line'>   <span class="n">it</span> <span class="s2">&quot;should touch the monkey&quot;</span> <span class="k">do</span>
</span><span class='line'>     <span class="sb">`touch monkey`</span>
</span><span class='line'>
</span><span class='line'>     <span class="n">cmds</span><span class="o">[</span><span class="mi">0</span><span class="o">].</span><span class="n">should</span> <span class="o">==</span> <span class="s1">&#39;touch monkey&#39;</span>
</span><span class='line'>   <span class="k">end</span>
</span><span class='line'> <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Source code</h2>

<p><a href="http://github.com/josephwilk/fake_execution">http://github.com/josephwilk/fake_execution</a></p>
</div>




    </article>


    <article>

  <header>

      <h1 class="entry-title"><a href="/conferences/conferences-and-the-cult-of-celebrity.html">Conferences and the Cult of Celebrity</a></h1>


      <p class="meta">












<time datetime="2012-06-19T13:58:56+01:00" pubdate data-updated="true">Jun 19<span>th</span>, 2012</time>

      </p>

  </header>


  <div class="entry-content"><p>How much should character be a factor for a conference talk being selected? Big names sell conference tickets. Yet I believe that we can do a lot more to help promote conferences where content takes greater weight than character and in the process help people who have never spoken before start speaking at conferences.</p>

<h2>Risk.</h2>

<p>Conferenceorganiserstake a big risk running a conference.</p>

<p>Will they cover their venue cost?</p>

<p>Which ultimately leads on to will they sell enough tickets?</p>

<p>Once they have enough tickets, will it be a good conference?</p>

<p>Other successful conferences define a pattern of how a conference islaidout. One obviously way of dealing with Risk is to follow an example of a success.</p>

<p>I really respect people who organise conferences, they are putting a lot of effort and their own time to make a successful event.</p>

<p>But I wondering if maybe we could be focusing more on content and less on character.</p>

<h2>Selling a presentation</h2>

<p>When you submit a talk an aspect ofconvincing theorganisersto allow you to talk is who you are. Persuasion by character (Ethos if you like your ancient Greek).</p>

<p>Most submissions forms give you plenty of space to sell yourself.</p>

<p><img src="/images/blog/2012/06/example_submission.png" alt="" /></p>

<h2>Content not character.</h2>

<p><img src="/images/blog/2012/06/nordicruby1.png" alt="" /></p>

<p>For NordicRuby 2012 theorganisers took a step pushing for interesting content over character. They recognised that conscious andsubconsciouspersuasion by character is a powerful means ofconvincing.</p>

<p>During most of their reviewing process <strong>they removed all the names from the proposals</strong>.</p>

<blockquote><p><em>&ldquo;Another thing were doing differently this year is that were starting out with anonymous proposals. Each card in Trello just shows the proposals title and description. No information about the speaker. We do this to avoid bias in the first stages.&rdquo;</em></p></blockquote>

<p>Talks where selected based on the content. Only later once the talks had beenwhittleddown did they introduce the speaker names. Character wasconsidered, it was just delayed to the late selection stage.</p>

<p>This tweet caught my attention as it highlighted that for Jsconf.com.au proposals are selected without names attached. Content is king, character does not matter!</p>

<p><img src="/images/blog/2012/06/tweet.png" alt="" /></p>

<p>Lonestar Ruby conference submissions, your name, your email, no big bio to sell how great you are. Content rules.</p>

<p><img src="/images/blog/2012/06/logo-adjusted-7293a1d3bfb1dac006dd14619c2efe07.png" alt="" /></p>

<p><img src="/images/blog/2012/06/Screen-Shot-2012-06-18-at-13.53.08.png" alt="" /></p>

<h2>Keynotes: where character is King</h2>

<p>The keynote of a conference is the stable diet of most conferences. Its where the big names are rolled out, luminaries of our industry share their wise thoughts with us.</p>

<p>Akin to live music, they are theheadlineact we pay for, the others are the support acts. We might skip them, or give them half of our attention.</p>

<p><strong>What effect does having two tiers of talks at a conference have?</strong></p>

<p>The keynote talk is more importantirrelevantof content because of the <strong>character of the speaker</strong>. Often we don&rsquo;t even know what they will be talking about, just that they are keynoting.</p>

<p>Some examples (I&rsquo;m not focusing any blame on these examples, I respect the conferences and the organisersinvolved. They just help illustrate my point)</p>

<p><img src="/images/blog/2012/06/Screen-Shot-2012-06-19-at-13.11.59.png" alt="" /></p>

<p><a href="/images/blog/2012/06/Screen-Shot-2012-06-18-at-14.23.55.png"><img src="/images/blog/2012/06/Screen-Shot-2012-06-18-at-14.23.55.png" alt="" /></a></p>

<p>We assume (based onauthority) that important people will have important things to tell us (and sometimes they do have important ideas to share with us).</p>

<p>Are the other, non-keynote talks of the conference of lesser importance? This is where content starts to win because all these speakers are non-keynoters, we don&rsquo;t have as many leading assumptions about their authority or character. <strong>We go to the talks where the content interests us.</strong></p>

<p>Maybe all talks should be driven by the<strong>content</strong> and less by<strong>character</strong>. Maybe all talks are as important as each other.</p>

<p>Conferences are already starting to kill of this idea of having to have a Keynote to sell your conference. FutureRuby and NordicRuby are two examples of conferences that have no Keynote yet produced conferences that are highly regarded by those who attended.</p>

<p><strong>Will a keynote really make your conference better?</strong></p>

<h2>The Content Conference</h2>

<p>Lets see if we can take this a step further and define the content conference.</p>

<ol>
<li><p>Talks authors are not revealed during review/selection. (There is <strong>no bias by character</strong>)</p></li>
<li><p>Only publish the talk titles and content on the conference website. (Sell the conference on its<strong>content not its characters</strong>.)</p></li>
<li><p>No keynotes. <strong>All talks are equal</strong>.</p></li>
</ol>


<h2>Conference Mentors</h2>

<p>If we want to focus on content and remove character (as much as possible) we have to deal with people with little experience but with great ideas. We need to help make it easier to give feedback and help mentor those people so they can best express their ideas.</p>

<p><strong>Being accepted to speak is not the end of contact its the start</strong>.</p>

<p>A group of experience speakers acting as mentors who give feedback and help people give the best presentations they can.</p>

<h2>Final Words</h2>

<p>There is a place in the conference world for events which focus on bringing big names to an audience. Looking back at the 30 conferences I&rsquo;ve spoken at so far I&rsquo;ve come to theconclusionthat the conferences I really valued where those that pushed for content over character. Conferences are popping up all the time that follow the content conference ideas and <strong>understand the concious and subconsious bias of character</strong>.</p>

<p>I feel if we try and push for content over character and improve the proposal/speaker setup we can help find newpeople with great, interesting, crazy ideas and encourage them to submit proposals and speak.</p>

<p>I hope these ideas about the content conference might help conference organisers think about how they structure their conference and proposal system.</p>

<p><strong>I am offering my time to mentor anyone who wants help writing their first conference proposal</strong>.</p>

<p>I am also happy to join any conference that wants a set ofexperiencedspeakers to help new speakers get the best out of their presentations.</p>

<p>Crazy, huh?</p>

<p>So what do you think?</p>
</div>




    </article>

  <div class="pagination">

      <a class="prev" href="/page/3/">&larr; Older</a>

    <a href="/blog/archives">Blog Archives</a>

    <a class="next" href="/">Newer &rarr;</a>

  </div>
</div>
<aside class="sidebar">

    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
  <li class="post">
    <a href="/art/emacs-as-a-musical-instrument.html">Emacs as a musical instrument</a>
  </li>


      <li class="post">
        <a href="/clojure/functions-explained-through-patterns.html">Functions Explained Through Patterns</a>
      </li>

      <li class="post">
        <a href="/art/audio-fingerprint-smudges.html">Audio Fingerprint Smudges</a>
      </li>

      <li class="post">
        <a href="/art/overtone-shader-visuals.html">Visuals with Overtone and Shadertone</a>
      </li>

      <li class="post">
        <a href="/art/emacs-animation.html">Animations with Emacs</a>
      </li>

      <li class="post">
        <a href="/clojure/clojure-and-kinesis-at-scale.html">Clojure and Kinesis at scale</a>
      </li>

      <li class="post">
        <a href="/clojure/overtone-driving-minecraft.html">Clojure and Overtone driving Minecraft</a>
      </li>

      <li class="post">
        <a href="/art/live-coding-repl-electric.html">Live Coding - Repl Electric</a>
      </li>

      <li class="post">
        <a href="/clojure/creative_machines.html">Creative Machines</a>
      </li>

      <li class="post">
        <a href="/clojure/sounds-of-the-human-brain.html">Sounds of the human brain</a>
      </li>

      <li class="post">
        <a href="/clojure/building-clojure-services-at-scale.html">Building Clojure services at scale</a>
      </li>

  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>

  <a href="https://github.com/josephwilk">@josephwilk</a> on GitHub

  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'josephwilk',
            count: 10,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>






</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2017 - Joseph Wilk -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>


<script type="text/javascript">
      var disqus_shortname = 'josephwilk';


        var disqus_script = 'count.js';

    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>











</body>
</html>
